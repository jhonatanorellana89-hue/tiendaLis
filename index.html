<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>JHONATAN ORELLANA - Finanzas Personales (index.html)</title>
  <!--
    APP SPA - ÚNICO ARCHIVO index.html
    Esta versión integra:
      - Sin cuentas visibles: Auth ANÓNIMO + "Join Code" (emparejamiento) para vincular dispositivos (PC <-> móvil).
      - Datos compartidos por ORGANIZACIÓN: todas las operaciones usan organizations/{orgId}/...
      - Funcionalidades: Transacciones, Bancos, Deudas, Gastos Fijos, Categorías, Ahorros, Export/Import, PDF.
      - Backup a Realtime Database (opcional).
      - Reglas sugeridas de Firestore / RTDB en comentarios.
      - Interfaz móvil vertical, modales que cierran al guardar y actualizan UI inmediatamente.
    Instrucciones rápidas:
      1) Habilita Firebase: Authentication (Anonymous), Cloud Firestore y Realtime Database (opcional).
      2) Pega tu firebaseConfig (ya incluido según lo que enviaste).
      3) Abre el archivo desde un servidor local (Live Server) y prueba: la primera vez crea una org y mostrará un JOIN CODE. Usa ese código en el otro dispositivo para vincular.
  -->

  <style>
    :root{
      --bg:#041018; --panel:#071421; --card:#0b1b26; --muted:#9fb1bd;
      --accent:#00b894; --accent-2:#34ace0; --danger:#ff6b6b; --glass: rgba(255,255,255,0.02);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#021018);color:#e6f6f6}
    .phone-frame{width:100%;max-width:420px;margin:12px auto;border-radius:18px;overflow:hidden;background:linear-gradient(180deg,var(--panel),#04121a);box-shadow:0 20px 60px rgba(0,0,0,0.6);min-height:88vh;display:flex;flex-direction:column}
    header.app-top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);border-bottom:1px solid rgba(255,255,255,0.02)}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001219;font-size:16px}
    .title{font-weight:800;font-size:15px}
    .subtitle{font-size:11px;color:var(--muted)}
    .header-actions{display:flex;gap:8px;align-items:center}
    .join-badge{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px;font-size:12px;color:var(--muted)}
    nav.bottom-nav{display:flex;gap:6px;padding:10px;justify-content:space-between;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.01));border-top:1px solid rgba(255,255,255,0.02)}
    nav.bottom-nav button{flex:1;background:transparent;border:0;color:var(--muted);padding:8px;border-radius:10px;font-weight:700}
    nav.bottom-nav button.active{color:var(--accent);background:rgba(255,255,255,0.02)}
    main.app-body{padding:12px;overflow:auto;flex:1}
    .card{background:linear-gradient(180deg,var(--card),#06121a);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(0,0,0,0.5)}
    h2{margin:0;font-size:16px}
    .muted{color:var(--muted);font-size:12px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:13px}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#001219;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:800}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    button.compact{padding:6px 8px;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left}
    .right{text-align:right}
    .danger{background:var(--danger);color:#1a0303;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#071421;color:#d6f6ef;padding:12px;border-radius:10px;box-shadow:0 8px 26px rgba(0,0,0,0.6);display:none;z-index:120}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:140}
    .modal{background:linear-gradient(180deg,#071421,#051017);padding:14px;border-radius:12px;max-width:420px;width:94%}
    .small-muted{font-size:11px;color:var(--muted)}
    @media (min-width:560px){ .phone-frame{max-width:420px} }
  </style>
</head>
<body>
  <div class="phone-frame" role="application" aria-label="App finanzas - vista móvil">
    <header class="app-top">
      <div class="brand">
        <div class="logo">JO</div>
        <div>
          <div class="title">JHONATAN ORELLANA</div>
          <div class="subtitle">Control profesional de finanzas</div>
        </div>
      </div>
      <div class="header-actions">
        <div id="org-join-display" class="join-badge small-muted">No vinculado</div>
        <button id="btn-manage-join" class="ghost compact">Vincular</button>
        <div class="small muted" id="uid">Sin iniciar</div>
      </div>
    </header>

    <main class="app-body" id="app-body">
      <!-- Dashboard -->
      <section id="view-dashboard" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2>Resumen</h2>
            <div class="muted">Balance, bancos y alertas</div>
          </div>
          <div class="muted" id="month-label"></div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <div style="flex:1;background:var(--glass);padding:10px;border-radius:8px">
            <div class="muted">Balance total</div>
            <div id="balance" style="font-weight:800;font-size:18px;margin-top:6px">S/ 0.00</div>
            <div id="flows" class="muted small"></div>
          </div>
          <div style="width:110px;background:var(--glass);padding:10px;border-radius:8px;text-align:center">
            <div class="muted">Activos netos</div>
            <div id="net-assets" style="font-weight:800;margin-top:6px">S/ 0.00</div>
          </div>
        </div>

        <div class="card" style="margin-top:10px;padding:10px">
          <div class="muted" style="margin-bottom:8px">Alertas</div>
          <div id="alerts" class="small muted"></div>
        </div>
      </section>

      <!-- Transactions -->
      <section id="view-transactions" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2>Transacciones</h2>
            <div class="muted">Cada transacción requiere cuenta y categoría</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="search" placeholder="Buscar..." />
            <button id="btn-add-transaction" class="primary compact">Agregar</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <div style="flex:1">
            <label>Filtrar por cuenta</label>
            <select id="filter-bank"><option value="">-- Todas --</option></select>
          </div>
          <div style="width:110px">
            <label>Desde</label><input id="filter-from" placeholder="dd/mm/yyyy" />
          </div>
          <div style="width:110px">
            <label>Hasta</label><input id="filter-to" placeholder="dd/mm/yyyy" />
          </div>
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table id="tx-table">
            <thead><tr><th>Fecha</th><th>Cuenta</th><th>Tipo</th><th>Cat.</th><th class="right">Monto</th><th>Acc.</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Banks & Debts -->
      <section id="view-banks" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2>Bancos & Deudas</h2>
            <div class="muted">Cuentas vinculadas a transacciones y pasivos</div>
          </div>
          <div style="display:flex;gap:6px">
            <button id="btn-add-bank" class="primary compact">Nueva cuenta</button>
            <button id="btn-add-debt" class="ghost compact">Nueva deuda</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <div id="banks-table"></div>
        </div>

        <div style="margin-top:10px">
          <div id="debts-table"></div>
        </div>
      </section>

      <!-- Fixed -->
      <section id="view-fixed" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2>Gastos Fijos</h2>
            <div class="muted">Pagos periódicos: pensión, alquiler, cuotas</div>
          </div>
          <div style="display:flex;gap:6px">
            <button id="btn-add-fixed" class="primary compact">Nuevo</button>
            <button id="btn-generate-fixed" class="ghost compact">Generar mes</button>
          </div>
        </div>
        <div id="fixed-table" style="margin-top:10px"></div>
      </section>

      <!-- Categories -->
      <section id="view-categories" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h2>Categorías</h2><div class="muted">Crear y establecer límite mensual</div></div>
          <div><button id="btn-new-category" class="primary compact">Nueva</button></div>
        </div>
        <div style="margin-top:10px">
          <table id="categories-table"><thead><tr><th>Nombre</th><th class="right">Límite</th><th>Acc.</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Savings -->
      <section id="view-savings" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h2>Ahorros</h2><div class="muted">Planes vinculados a cuentas</div></div>
          <div><button id="btn-new-saving" class="primary compact">Nuevo</button></div>
        </div>
        <div id="savings-table" style="margin-top:10px"></div>
      </section>

      <!-- Export -->
      <section id="view-export" class="card" style="display:none">
        <h2>Export / Import</h2>
        <div class="muted" style="margin-top:6px">Exporta CSV, JSON o PDF (reporte)</div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="export-csv" class="primary compact">CSV</button>
          <button id="export-json" class="ghost compact">JSON</button>
          <input id="import-file" type="file" accept=".csv,application/json" />
          <button id="btn-import" class="primary compact">Importar</button>
          <button id="export-pdf" class="primary compact">EXPORTAR REPORTE PDF</button>
        </div>
      </section>
    </main>

    <nav class="bottom-nav">
      <button data-view="dashboard" class="active">Resumen</button>
      <button data-view="transactions">Transacciones</button>
      <button data-view="banks">Bancos</button>
      <button data-view="categories">Categorías</button>
      <button data-view="export">Export</button>
    </nav>
  </div>

  <!-- Modal & Toast -->
  <div class="modal-backdrop" id="modal-backdrop"><div class="modal" id="modal"></div></div>
  <div class="toast" id="toast"></div>

  <!-- Reglas recomendadas (Firestore + RTDB) - Pegar en consola Firebase -->
  <!--
  Firestore rules:
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      // Solo miembros de la organización pueden leer/escribir
      match /organizations/{orgId}/{document=**} {
        allow read, write: if request.auth != null
          && exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
      }
      // perfil de usuario (opcional)
      match /users/{uid}/profile/{meta} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }
  }

  Realtime DB rules (backups):
  {
    "rules": {
      "backups": {
        "$uid": {
          ".read": "auth != null && auth.uid === $uid",
          ".write": "auth != null && auth.uid === $uid"
        }
      }
    }
  }
  -->

  <!-- Scripts (Firebase v9 modular + utilidades) -->
  <script type="module">
    /* ================== IMPORTS FIREBASE (v9 modular) ================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, setDoc, getDocs, getDoc, query, where, orderBy, deleteDoc, doc,
      updateDoc, serverTimestamp, Timestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getDatabase, ref as rtdbRef, set as rtdbSet, remove as rtdbRemove } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // Extras clientes
    const sChart = document.createElement('script'); sChart.src = 'https://cdn.jsdelivr.net/npm/chart.js'; document.head.appendChild(sChart);
    const sPDF = document.createElement('script'); sPDF.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js'; document.head.appendChild(sPDF);

    /* ================== FIREBASE CONFIG (PROPORCIONADO) ================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBVppNAicRPFXEUdErmHd24se_9bjXiqcM",
      authDomain: "jhona-1b398.firebaseapp.com",
      databaseURL: "https://jhona-1b398-default-rtdb.firebaseio.com",
      projectId: "jhona-1b398",
      storageBucket: "jhona-1b398.firebasestorage.app",
      messagingSenderId: "981136306223",
      appId: "1:981136306223:web:d8948acdb119f0facc56da",
      measurementId: "G-44TXK10R9R"
    };

    const isConfigFilled = Object.keys(firebaseConfig).length > 0;
    let app, auth, db, rtdb;
    if(isConfigFilled){
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      rtdb = getDatabase(app);
      console.log('Firebase inicializado (Firestore + RTDB).');
    } else {
      console.warn('Firebase no configurado. Funcionando en modo local (localStorage).');
    }

    /* ================== UTILIDADES ================== */
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    function fmtMoney(v){ v = Number(v)||0; return 'S/ ' + v.toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 }); }
    function parseDateDDMMYYYY(s){ if(!s) return null; const p=s.split('/'); if(p.length!==3) return null; const d=parseInt(p[0],10), m=parseInt(p[1],10)-1, y=parseInt(p[2],10); const dt=new Date(y,m,d); return isNaN(dt)?null:dt; }
    function dateToDDMMYYYY(d){ if(!d) return ''; return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear(); }
    function tsToDateStr(ts){ if(!ts) return ''; if(ts.toDate) return dateToDDMMYYYY(ts.toDate()); if(ts._seconds) return dateToDDMMYYYY(new Date(ts._seconds*1000)); return String(ts); }
    function showToast(msg, important=false){ const t = $('#toast'); t.textContent = msg; t.style.display = 'block'; t.style.background = important ? 'linear-gradient(90deg,var(--danger),#ff9a9a)' : '#071421'; clearTimeout(window.__to); window.__to = setTimeout(()=> t.style.display='none', important?7000:3500); }

    /* ================== ESTADO GLOBAL ================== */
    const state = {
      uid: null,
      currentOrgId: null,
      orgJoinCode: null,
      memberRole: null, // owner / member
      transactions: [], banks: [], debts: [], fixed: [], savings: [], categories: []
    };

    /* ================== UTIL: GENERAR JOIN CODE ================== */
    function generateJoinCode(len = 6){
      const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
      let s = '';
      for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    /* ================== PATH POR ORG (reemplaza userPath) ================== */
    function orgPath(coll){
      if(!state.currentOrgId) throw new Error('OrgId no definido. Vincula el dispositivo con un JOIN CODE.');
      return `organizations/${state.currentOrgId}/${coll}`;
    }

    /* ================== BACKUP RTDB helpers ================== */
    async function backupToRTDB(collectionName, id, data){
      if(!rtdb || !state.uid) return;
      try{
        const copy = Object.assign({}, data);
        if(copy.date && copy.date.toDate) copy.date = copy.date.toDate().toISOString();
        if(copy.createdAt && copy.createdAt.toDate) copy.createdAt = copy.createdAt.toDate().toISOString();
        copy._backupAt = new Date().toISOString();
        await rtdbSet(rtdbRef(rtdb, `backups/${state.currentOrgId}/${collectionName}/${id}`), copy);
      } catch(e){ console.warn('RTDB backup failed', e); }
    }
    async function removeRTDBBackup(collectionName, id){ if(!rtdb || !state.currentOrgId) return; try{ await rtdbRemove(rtdbRef(rtdb, `backups/${state.currentOrgId}/${collectionName}/${id}`)); } catch(e){ console.warn('RTDB remove failed', e); } }

    /* ================== SUSCRIPCIONES (USANDO orgPath) ================== */
    let unsubscribers = [];
    function clearUnsubscribers(){ unsubscribers.forEach(u=>{ try{ u(); }catch(e){} }); unsubscribers = []; }
    function subscribeToCollections(){
      if(!db || !state.currentOrgId) return;
      clearUnsubscribers();
      try{
        unsubscribers.push(onSnapshot(query(collection(db, orgPath('transactions')), orderBy('date','desc')), snap => { state.transactions = snap.docs.map(d=>({ id:d.id, ...d.data() })); renderAll(); }, e=>console.error(e)));
        unsubscribers.push(onSnapshot(query(collection(db, orgPath('banks')), orderBy('name')), snap => { state.banks = snap.docs.map(d=>({ id:d.id, ...d.data() })); renderAll(); }, e=>console.error(e)));
        unsubscribers.push(onSnapshot(query(collection(db, orgPath('debts')), orderBy('createdAt','desc')), snap => { state.debts = snap.docs.map(d=>({ id:d.id, ...d.data() })); renderAll(); }, e=>console.error(e)));
        unsubscribers.push(onSnapshot(query(collection(db, orgPath('fixedExpenses')), orderBy('name')), snap => { state.fixed = snap.docs.map(d=>({ id:d.id, ...d.data() })); renderAll(); }, e=>console.error(e)));
        unsubscribers.push(onSnapshot(query(collection(db, orgPath('savings')), orderBy('createdAt','desc')), snap => { state.savings = snap.docs.map(d=>({ id:d.id, ...d.data() })); renderAll(); }, e=>console.error(e)));
        unsubscribers.push(onSnapshot(query(collection(db, orgPath('categories')), orderBy('name')), snap => { state.categories = snap.docs.map(d=>({ id:d.id, ...d.data() })); renderAll(); }, e=>console.error(e)));
      } catch(e){ console.error('subscribeToCollections error', e); }
    }

    /* ================== CARGA INICIAL desde Firestore (si no usas onSnapshot) ================== */
    async function loadAllFromFirestore(){
      if(!db || !state.currentOrgId) return;
      try{
        const txSnap = await getDocs(query(collection(db, orgPath('transactions')), orderBy('date','desc')));
        state.transactions = txSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        const bSnap = await getDocs(query(collection(db, orgPath('banks')), orderBy('name')));
        state.banks = bSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        const dSnap = await getDocs(query(collection(db, orgPath('debts')), orderBy('createdAt','desc')));
        state.debts = dSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        const fSnap = await getDocs(query(collection(db, orgPath('fixedExpenses')), orderBy('name')));
        state.fixed = fSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        const sSnap = await getDocs(query(collection(db, orgPath('savings')), orderBy('createdAt','desc')));
        state.savings = sSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        const cSnap = await getDocs(query(collection(db, orgPath('categories')), orderBy('name')));
        state.categories = cSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderAll();
      } catch(e){ console.error('loadAllFromFirestore error', e); }
    }

    /* ================== CRUD adaptado a ORG ================== */
    async function addCategory(cat){
      if(!db){ cat.id='local-'+Math.random().toString(36).slice(2,9); state.categories.push(cat); persistLocal(); renderCategories(); showToast('Categoría creada (local)'); return cat; }
      const ref = await addDoc(collection(db, orgPath('categories')), {...cat, createdAt: serverTimestamp()});
      await backupToRTDB('categories', ref.id, { name:cat.name, limitMonthly:cat.limitMonthly, createdAt: new Date().toISOString() });
      await loadAllFromFirestore(); showToast('Categoría creada');
      return { id: ref.id, ...cat };
    }

    async function updateCategory(id, data){
      if(!db){ const c=state.categories.find(x=>x.id===id); if(c) Object.assign(c,data); persistLocal(); renderCategories(); return; }
      await updateDoc(doc(db, orgPath('categories'), id), data);
      await backupToRTDB('categories', id, Object.assign({}, data, { _syncedAt: new Date().toISOString() }));
      await loadAllFromFirestore(); showToast('Categoría actualizada');
    }

    async function deleteCategory(id){
      if(!db){ state.categories = state.categories.filter(x=>x.id!==id); persistLocal(); renderCategories(); return; }
      await deleteDoc(doc(db, orgPath('categories'), id));
      await removeRTDBBackup('categories', id);
      await loadAllFromFirestore(); showToast('Categoría eliminada');
    }

    async function addTransaction(tx){
      if(!parseDateDDMMYYYY(tx.dateStr)) throw new Error('Fecha inválida');
      const payload = {...tx, amount: Number(tx.amount)||0, date: Timestamp.fromDate(parseDateDDMMYYYY(tx.dateStr)), createdAt: serverTimestamp()};
      if(!db){
        payload.id='local-'+Math.random().toString(36).slice(2,9);
        state.transactions.unshift(payload);
        if(payload.bankId) updateBankBalanceLocal(payload.bankId, payload.type==='Egreso' ? -payload.amount : payload.amount);
        if(payload.debtId && payload.type==='Egreso'){ const d = state.debts.find(x=>x.id===payload.debtId); if(d) d.outstanding = Math.max(0, (Number(d.outstanding)||0) - payload.amount); }
        persistLocal(); renderAll(); checkCategoryLimitAfterAdd(payload); showToast('Transacción creada (local)'); return payload;
      }
      const ref = await addDoc(collection(db, orgPath('transactions')), payload);
      await backupToRTDB('transactions', ref.id, {...tx, amount: Number(tx.amount)||0, date: parseDateDDMMYYYY(tx.dateStr).toISOString(), createdAt: new Date().toISOString()});
      if(tx.bankId){ const delta = tx.type === 'Egreso' ? -tx.amount : tx.amount; await updateBankBalance(tx.bankId, delta); }
      if(tx.debtId && tx.type === 'Egreso'){ const debtRef = doc(db, orgPath('debts'), tx.debtId); const snap = await getDoc(debtRef); if(snap.exists()){ const cur = snap.data().outstanding || 0; await updateDoc(debtRef, { outstanding: Math.max(0, Number(cur) - tx.amount) }); } }
      await loadAllFromFirestore(); checkCategoryLimitAfterAdd(payload); showToast('Transacción creada');
      return { id: ref.id, ...payload };
    }

    async function addBank(bank){
      if(!db){ bank.id='local-'+Math.random().toString(36).slice(2,9); state.banks.push(bank); persistLocal(); renderBanks(); showToast('Cuenta creada (local)'); return bank; }
      const ref = await addDoc(collection(db, orgPath('banks')), {...bank, createdAt: serverTimestamp()});
      await backupToRTDB('banks', ref.id, {...bank, createdAt: new Date().toISOString()});
      await loadAllFromFirestore(); renderAll(); showToast('Cuenta creada'); return { id: ref.id, ...bank };
    }

    async function updateBank(bankId, data){
      if(!db){ const b = state.banks.find(x=>x.id===bankId); if(b) Object.assign(b,data); persistLocal(); renderBanks(); return; }
      await updateDoc(doc(db, orgPath('banks'), bankId), data);
      await backupToRTDB('banks', bankId, Object.assign({}, data, { _syncedAt: new Date().toISOString() }));
      await loadAllFromFirestore(); showToast('Cuenta actualizada');
    }

    async function deleteBank(bankId){
      if(!db){ state.banks = state.banks.filter(x=>x.id!==bankId); persistLocal(); renderBanks(); return; }
      await deleteDoc(doc(db, orgPath('banks'), bankId));
      await removeRTDBBackup('banks', bankId);
      await loadAllFromFirestore(); renderAll(); showToast('Cuenta eliminada');
    }

    async function addDebt(debt){
      if(!db){ debt.id='local-'+Math.random().toString(36).slice(2,9); state.debts.push(debt); persistLocal(); renderAll(); showToast('Deuda creada (local)'); return debt; }
      const ref = await addDoc(collection(db, orgPath('debts')), {...debt, createdAt: serverTimestamp()});
      await backupToRTDB('debts', ref.id, {...debt, createdAt: new Date().toISOString()});
      await loadAllFromFirestore(); renderAll(); showToast('Deuda creada'); return { id: ref.id, ...debt };
    }

    async function addFixedExpense(f){
      if(!db){ f.id='local-'+Math.random().toString(36).slice(2,9); state.fixed.push(f); persistLocal(); renderFixed(); showToast('Gasto fijo creado (local)'); return f; }
      const ref = await addDoc(collection(db, orgPath('fixedExpenses')), {...f, createdAt: serverTimestamp()});
      await backupToRTDB('fixedExpenses', ref.id, {...f, createdAt: new Date().toISOString()});
      await loadAllFromFirestore(); renderAll(); showToast('Gasto fijo creado'); return { id: ref.id, ...f };
    }

    async function updateBankBalance(bankId, delta){
      if(!db){ updateBankBalanceLocal(bankId, delta); return; }
      try{
        const bankDoc = doc(db, orgPath('banks'), bankId);
        const snap = await getDoc(bankDoc);
        if(!snap.exists()) return;
        const cur = snap.data().balance || 0;
        await updateDoc(bankDoc, { balance: Number(cur) + Number(delta) });
        await backupToRTDB('banks', bankId, { balance: Number(cur) + Number(delta), _syncedAt: new Date().toISOString() });
        await loadAllFromFirestore();
      } catch(e){ console.error('updateBankBalance error', e); }
    }
    function updateBankBalanceLocal(bankId, delta){ const b = state.banks.find(x=>x.id===bankId); if(b){ b.balance = (Number(b.balance)||0) + Number(delta); persistLocal(); renderBanks(); renderDashboard(); } }

    /* ================== LÍMITES/CHEQUEO ================== */
    function checkCategoryLimitAfterAdd(tx){
      const cid = tx.categoryId; if(!cid) return;
      const cat = state.categories.find(c=>c.id===cid); if(!cat || !cat.limitMonthly || Number(cat.limitMonthly) <= 0) return;
      const date = tx.date ? (tx.date.toDate ? tx.date.toDate() : parseDateDDMMYYYY(tx.dateStr||'')) : parseDateDDMMYYYY(tx.dateStr||'');
      if(!date) return;
      const month = date.getMonth(), year = date.getFullYear();
      const total = state.transactions.reduce((acc,t)=>{
        const d = t.date ? (t.date.toDate ? t.date.toDate() : parseDateDDMMYYYY(t.dateStr||tsToDateStr(t.date))) : parseDateDDMMYYYY(t.dateStr||'');
        if(!d) return acc;
        if(d.getMonth()===month && d.getFullYear()===year && t.categoryId === cid) acc += Number(t.amount)||0;
        return acc;
      },0);
      if(total > Number(cat.limitMonthly)) showToast(`Límite superado en "${cat.name}": ${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)}`, true);
      else if(total >= Number(cat.limitMonthly)*0.8) showToast(`Cuidado: "${cat.name}" cerca del límite (${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)})`);
    }

    /* ================== RENDER / UI ================== */
    function switchView(view){
      const views = ['dashboard','transactions','banks','fixed','categories','savings','export'];
      views.forEach(v=>{ const el = document.getElementById('view-'+v); if(el) el.style.display = (v===view)?'':'none'; });
      document.querySelectorAll('nav.bottom-nav button').forEach(b=>b.classList.toggle('active', b.dataset.view===view));
      $('#uid').textContent = state.uid ? state.uid : 'Sin iniciar';
    }

    function renderAll(){ renderDashboard(); renderTransactions(); renderBanks(); renderFixed(); renderCategories(); renderSavings(); populateFilters(); updateOrgDisplay(); }

    function renderDashboard(){
      let inc=0, exp=0;
      const now = new Date(), month = now.getMonth(), year = now.getFullYear();
      state.transactions.forEach(t=>{
        const d = t.date ? (t.date.toDate ? t.date.toDate() : parseDateDDMMYYYY(t.dateStr||tsToDateStr(t.date))) : parseDateDDMMYYYY(t.dateStr||'');
        if(!d) return;
        if(d.getMonth()===month && d.getFullYear()===year){
          if((t.type||'Ingreso').toLowerCase()==='egreso') exp += Number(t.amount)||0; else inc += Number(t.amount)||0;
        }
      });
      $('#balance').textContent = fmtMoney(inc - exp);
      $('#flows').textContent = `Ingresos: ${fmtMoney(inc)} · Egresos: ${fmtMoney(exp)}`;
      $('#month-label').textContent = `${now.toLocaleString('default',{month:'long'})} ${year}`;
      let assets=0, liabilities=0;
      state.banks.forEach(b=> assets += Number(b.balance)||0);
      state.debts.forEach(d=> liabilities += Number(d.outstanding)||0);
      $('#net-assets').textContent = fmtMoney(assets - liabilities);
      $('#alerts').innerHTML = (state.categories.map(cat=>{
        if(!cat.limitMonthly || Number(cat.limitMonthly)<=0) return null;
        const total = state.transactions.reduce((acc,t)=>{
          const d = t.date ? (t.date.toDate ? t.date.toDate() : parseDateDDMMYYYY(t.dateStr||tsToDateStr(t.date))) : parseDateDDMMYYYY(t.dateStr||'');
          if(!d) return acc;
          const now2 = new Date(); if(d.getMonth()===now2.getMonth() && d.getFullYear()===now2.getFullYear() && t.categoryId===cat.id) acc += Number(t.amount)||0;
          return acc;
        },0);
        if(total >= Number(cat.limitMonthly)) return `<div style="margin-bottom:6px;color:var(--danger)"><strong>${cat.name}</strong> ${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)} (Superado)</div>`;
        if(total >= Number(cat.limitMonthly)*0.8) return `<div style="margin-bottom:6px"><strong>${cat.name}</strong> ${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)} (Cerca)</div>`;
        return null;
      }).filter(Boolean).join('')) || '<div class="muted">Sin alertas</div>';
    }

    function renderTransactions(){
      const tbody = $('#tx-table tbody'); if(!tbody) return; tbody.innerHTML = '';
      const rows = applyFiltersAndSearch();
      rows.forEach(t=>{
        const date = t.date ? (t.date.toDate ? dateToDDMMYYYY(t.date.toDate()) : (t.dateStr||tsToDateStr(t.date))) : (t.dateStr||'');
        const bank = state.banks.find(b=>b.id===t.bankId);
        const cat = state.categories.find(c=>c.id===t.categoryId);
        const bankName = bank ? bank.name : '-';
        const catName = cat ? cat.name : (t.categoryName || '-');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${date}</td><td>${bankName}</td><td>${t.type}</td><td>${catName}</td><td class="right">${fmtMoney(Number(t.amount)||0)}</td><td><button class="ghost compact" data-id="${t.id}" data-act="edit">E</button> <button class="danger compact" data-id="${t.id}" data-act="del">X</button></td>`;
        tbody.appendChild(tr);
      });
      $$('#tx-table button').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.id, act = btn.dataset.act;
          if(act==='del') showConfirm('Eliminar transacción','Confirmar eliminación', async ()=>{ try{ if(!db){ state.transactions = state.transactions.filter(x=>x.id!==id); persistLocal(); renderAll(); } else { await deleteDoc(doc(db, orgPath('transactions'), id)); await removeRTDBBackup('transactions', id); await loadAllFromFirestore(); } } catch(e){ console.error(e); alert('Error: '+e.message); } });
          if(act==='edit'){ const tx = state.transactions.find(x=>x.id===id); if(tx) openTransactionModal(tx); }
        };
      });
    }

    function applyFiltersAndSearch(){
      const q = $('#search').value.trim().toLowerCase();
      const bank = $('#filter-bank').value;
      const from = $('#filter-from').value.trim();
      const to = $('#filter-to').value.trim();
      return state.transactions.filter(t=>{
        const date = t.date ? (t.date.toDate ? t.date.toDate() : parseDateDDMMYYYY(t.dateStr||tsToDateStr(t.date))) : parseDateDDMMYYYY(t.dateStr||'');
        if(from){ const f = parseDateDDMMYYYY(from); if(!f || !date || date < f) return false; }
        if(to){ const tt = parseDateDDMMYYYY(to); if(!tt || !date || date > tt) return false; }
        if(bank && t.bankId !== bank) return false;
        if(q){ const cat = state.categories.find(c=>c.id===t.categoryId); const txt = `${t.description||''} ${(cat?cat.name:'')}`.toLowerCase(); if(!txt.includes(q)) return false; }
        return true;
      });
    }

    function renderBanks(){
      const wrap = $('#banks-table'); if(!wrap) return;
      if(state.banks.length === 0) wrap.innerHTML = '<div class="muted">No hay cuentas</div>';
      else {
        wrap.innerHTML = `<table><thead><tr><th>Cuenta</th><th class="right">Saldo</th><th>Acc.</th></tr></thead><tbody>${state.banks.map(b=>`<tr><td>${b.name}<div class="muted" style="font-size:12px">${b.type||''}</div></td><td class="right">${fmtMoney(Number(b.balance)||0)}</td><td><button class="ghost compact" data-id="${b.id}" data-act="edit">E</button> <button class="danger compact" data-id="${b.id}" data-act="del">X</button></td></tr>`).join('')}</tbody></table>`;
      }
      const dwrap = $('#debts-table'); if(!dwrap) return;
      if(state.debts.length === 0) dwrap.innerHTML = '<div class="muted">No hay deudas</div>';
      else dwrap.innerHTML = `<table><thead><tr><th>Deuda</th><th>Banco</th><th class="right">Saldo</th><th class="right">Cuota</th><th>Acc.</th></tr></thead><tbody>${state.debts.map(d=>`<tr><td>${d.name}</td><td>${(state.banks.find(b=>b.id===d.bankId)||{name:'-'}).name}</td><td class="right">${fmtMoney(Number(d.outstanding)||0)}</td><td class="right">${fmtMoney(Number(d.monthlyPayment)||0)}</td><td><button class="ghost compact" data-id="${d.id}" data-act="pay">P</button> <button class="danger compact" data-id="${d.id}" data-act="del">X</button></td></tr>`).join('')}</tbody></table>`;
      $$('#banks-table button, #debts-table button').forEach(btn=>{
        const act = btn.dataset.act, id = btn.dataset.id;
        btn.onclick = ()=>{
          if(act==='edit') openBankModal(id);
          if(act==='del') showConfirm('Eliminar', 'Confirmar eliminación', async ()=>{ try{ if(!db){ state.banks = state.banks.filter(x=>x.id!==id); persistLocal(); renderAll(); } else { await deleteDoc(doc(db, orgPath('banks'), id)); await removeRTDBBackup('banks', id); await loadAllFromFirestore(); } } catch(e){ console.error(e); alert('Error: '+e.message); } });
          if(act==='pay') openDebtPaymentModal(id);
        };
      });
    }

    function renderFixed(){
      const wrap = $('#fixed-table'); if(!wrap) return;
      if(state.fixed.length === 0) wrap.innerHTML = '<div class="muted">No hay gastos fijos</div>';
      else wrap.innerHTML = `<table><thead><tr><th>Nombre</th><th>Cuenta</th><th class="right">Monto</th><th class="right">Día</th><th>Acc.</th></tr></thead><tbody>${state.fixed.map(f=>`<tr><td>${f.name}</td><td>${(state.banks.find(b=>b.id===f.bankId)||{name:'-'}).name}</td><td class="right">${fmtMoney(Number(f.amount)||0)}</td><td class="right">${f.nextDueDay}</td><td><button class="ghost compact" data-id="${f.id}" data-act="gen">G</button> <button class="danger compact" data-id="${f.id}" data-act="del">X</button></td></tr>`).join('')}</tbody></table>`;
      wrap.querySelectorAll('button').forEach(btn=>{
        const act = btn.dataset.act, id = btn.dataset.id;
        btn.onclick = async ()=> {
          if(act==='gen'){ const f = state.fixed.find(x=>x.id===id); if(f){ const todayStr = dateToDDMMYYYY(new Date()); try{ await addTransaction({ type:'Egreso', amount:f.amount, categoryId:f.categoryId, categoryName:f.categoryName, description:f.name, dateStr:todayStr, bankId:f.bankId }); showToast('Generado: '+f.name); } catch(e){ alert('Error al generar: '+e.message); } } }
          if(act==='del') showConfirm('Eliminar gasto fijo','Confirmar', async ()=>{ try{ if(!db){ state.fixed = state.fixed.filter(x=>x.id!==id); persistLocal(); renderAll(); } else { await deleteDoc(doc(db, orgPath('fixedExpenses'), id)); await removeRTDBBackup('fixedExpenses', id); await loadAllFromFirestore(); } } catch(e){ console.error(e); alert('Error: '+e.message); } });
        };
      });
    }

    function renderCategories(){
      const tbody = $('#categories-table tbody'); if(!tbody) return; tbody.innerHTML = '';
      state.categories.forEach(c=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${c.name}</td><td class="right">${c.limitMonthly ? fmtMoney(Number(c.limitMonthly)||0) : 'Sin límite'}</td><td><button class="ghost compact" data-id="${c.id}" data-act="edit">E</button> <button class="danger compact" data-id="${c.id}" data-act="del">X</button></td>`; tbody.appendChild(tr); });
      $$('#categories-table button').forEach(btn=>{ const id=btn.dataset.id, act=btn.dataset.act; btn.onclick = ()=>{ if(act==='edit') openCategoryModal(id); if(act==='del') showConfirm('Eliminar categoría','Confirmar', async ()=>{ try{ await deleteCategory(id); } catch(e){ console.error(e); alert('Error: '+e.message); } }); }; });
    }

    function renderSavings(){ const wrap = $('#savings-table'); if(!wrap) return; if(state.savings.length===0) wrap.innerHTML='<div class="muted">No hay planes</div>'; else wrap.innerHTML = `<table><thead><tr><th>Plan</th><th class="right">Objetivo</th><th>Cuenta</th><th class="right">Saldo</th></tr></thead><tbody>${state.savings.map(s=>`<tr><td>${s.name}</td><td class="right">${fmtMoney(Number(s.target)||0)}</td><td>${(state.banks.find(b=>b.id===s.bankId)||{name:'-'}).name}</td><td class="right">${fmtMoney(Number(s.balance)||0)}</td></tr>`).join('')}</tbody></table>`; }

    function populateFilters(){ const sel = $('#filter-bank'); if(!sel) return; sel.innerHTML = '<option value="">-- Todas --</option>' + state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join(''); }

    function updateOrgDisplay(){
      const el = $('#org-join-display');
      if(state.currentOrgId){
        el.textContent = `Org: ${state.currentOrgId.slice(0,6)}${state.orgJoinCode?(' · ' + state.orgJoinCode):''}`;
        el.classList.remove('small-muted');
      } else {
        el.textContent = 'No vinculado';
        el.classList.add('small-muted');
      }
    }

    /* ================== MODALES & HELPERS ================== */
    function showModal(html){ $('#modal').innerHTML = html; $('#modal-backdrop').style.display = 'flex'; }
    function closeModal(){ $('#modal').innerHTML = ''; $('#modal-backdrop').style.display = 'none'; }
    function showConfirm(title, text, onConfirm){ showModal(`<div><strong>${title}</strong><div class="muted" style="margin-top:8px">${text}</div><div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="m-cancel" class="ghost compact">Cancelar</button><button id="m-confirm" class="danger compact">Confirmar</button></div></div>`); $('#m-cancel').onclick = closeModal; $('#m-confirm').onclick = async ()=>{ try{ await onConfirm(); } catch(e){ console.error(e); alert('Error: '+e.message); } closeModal(); }; }

    /* ================== MODALES DE FORM (categorias, transacciones, bancos, deudas, fijos, ahorros) ================== */
    function openCategoryModal(editId){
      const c = state.categories.find(x=>x.id===editId) || { name:'', limitMonthly:0 };
      showModal(`<div><h3 style="margin:0">${editId ? 'Editar categoría' : 'Nueva categoría'}</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><label>Nombre</label><input id="c-name" value="${c.name}" /></div><div><label>Límite mensual (0 = sin límite)</label><input id="c-limit" value="${c.limitMonthly || 0}" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="c-cancel" class="ghost compact">Cancelar</button><button id="c-save" class="primary compact">Guardar</button></div></div>`);
      $('#c-cancel').onclick = closeModal;
      $('#c-save').onclick = async ()=>{ try{ const name = $('#c-name').value.trim(); const limit = Number($('#c-limit').value) || 0; if(!name) return alert('Nombre requerido'); if(!editId) await addCategory({ name, limitMonthly: limit }); else await updateCategory(editId, { name, limitMonthly: limit }); closeModal(); } catch(e){ console.error(e); alert('Error: '+e.message); } };
    }

    function openTransactionModal(existing){
      const catOpts = `<option value="">-- Seleccionar categoría --</option>` + state.categories.map(c=>`<option value="${c.id}">${c.name}${c.limitMonthly?` (Lím: ${fmtMoney(c.limitMonthly)})`:''}</option>`).join('');
      const bankOpts = `<option value="">-- Seleccionar cuenta --</option>` + state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      const debtOpts = `<option value="">-- Ninguna --</option>` + state.debts.map(d=>`<option value="${d.id}">${d.name} · ${fmtMoney(d.outstanding)}</option>`).join('');
      const defaults = existing || { type:'Ingreso', amount:0, categoryId:'', description:'', dateStr:dateToDDMMYYYY(new Date()), bankId:'' };
      showModal(`<div><h3 style="margin:0">${existing ? 'Editar transacción' : 'Nueva transacción'}</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><label>Tipo</label><select id="m-type"><option ${defaults.type==='Ingreso'?'selected':''}>Ingreso</option><option ${defaults.type==='Egreso'?'selected':''}>Egreso</option></select></div><div><label>Monto</label><input id="m-amount" value="${defaults.amount||0}" /></div><div><label>Cuenta</label><select id="m-bank">${bankOpts}</select></div><div><label>Categoría</label><select id="m-cat">${catOpts}</select></div><div style="grid-column:1/-1"><label>Descripción</label><input id="m-desc" value="${(defaults.description||'').replace(/"/g,'&quot;')}" /></div><div><label>Fecha (dd/mm/yyyy)</label><input id="m-date" value="${defaults.dateStr||''}" /></div><div><label>Pago a deuda (opcional)</label><select id="m-debt">${debtOpts}</select></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="m-cancel" class="ghost compact">Cancelar</button><button id="m-save" class="primary compact">Guardar</button></div></div>`);
      if(existing){ setTimeout(()=>{ if(existing.bankId) $('#m-bank').value = existing.bankId; if(existing.categoryId) $('#m-cat').value = existing.categoryId; if(existing.debtId) $('#m-debt').value = existing.debtId; if($('#m-amount')) $('#m-amount').value = Number(existing.amount)||0; },50); }
      $('#m-cancel').onclick = closeModal;
      $('#m-save').onclick = async ()=> {
        try{
          const type = $('#m-type').value;
          const amount = Number($('#m-amount').value) || 0;
          const bankId = $('#m-bank').value || null;
          const categoryId = $('#m-cat').value || null;
          const description = $('#m-desc').value.trim();
          const dateStr = $('#m-date').value.trim();
          const debtId = $('#m-debt').value || null;
          if(!amount || amount <= 0) return alert('Monto inválido');
          if(!parseDateDDMMYYYY(dateStr)) return alert('Fecha inválida (dd/mm/yyyy)');
          const categoryName = (state.categories.find(c=>c.id===categoryId)||{name:''}).name;
          await addTransaction({ type, amount, categoryId, categoryName, description, dateStr, bankId, debtId });
          closeModal();
        } catch(e){ console.error(e); alert('Error al guardar transacción: '+e.message); }
      };
    }

    function openBankModal(editId){
      const b = state.banks.find(x=>x.id===editId) || { name:'', balance:0, type:'Cuenta', currency:'PEN' };
      showModal(`<div><h3 style="margin:0">${editId ? 'Editar cuenta' : 'Nueva cuenta'}</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><label>Nombre</label><input id="b-name" value="${b.name}" /></div><div><label>Tipo</label><input id="b-type" value="${b.type}" /></div><div><label>Saldo inicial</label><input id="b-balance" value="${Number(b.balance)||0}" /></div><div><label>Moneda</label><input id="b-currency" value="${b.currency||'PEN'}" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="b-cancel" class="ghost compact">Cancelar</button><button id="b-save" class="primary compact">Guardar</button></div></div>`);
      $('#b-cancel').onclick = closeModal;
      $('#b-save').onclick = async ()=> {
        try{
          const name = $('#b-name').value.trim(); const type = $('#b-type').value.trim(); const balance = Number($('#b-balance').value)||0; const currency = $('#b-currency').value.trim()||'PEN';
          if(!name) return alert('Nombre requerido');
          if(!editId){ await addBank({ name, type, balance, currency }); } else { await updateBank(editId, { name, type, balance, currency }); }
          closeModal();
        } catch(e){ console.error(e); alert('Error al guardar cuenta: '+e.message); }
      };
    }

    function openDebtModal(){
      showModal(`<div><h3 style="margin:0">Nueva deuda</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><label>Nombre</label><input id="d-name" /></div><div><label>Banco</label><select id="d-bank"><option value="">-- Seleccionar --</option>${state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('')}</select></div><div><label>Saldo pendiente</label><input id="d-out" value="0" /></div><div><label>Cuota mensual</label><input id="d-pay" value="0" /></div><div><label>Interés (%)</label><input id="d-interest" value="0" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="d-cancel" class="ghost compact">Cancelar</button><button id="d-save" class="primary compact">Guardar</button></div></div>`);
      $('#d-cancel').onclick = closeModal;
      $('#d-save').onclick = async ()=> {
        try{
          const name = $('#d-name').value.trim(); const bankId = $('#d-bank').value || null; const outstanding = Number($('#d-out').value) || 0; const monthlyPayment = Number($('#d-pay').value) || 0; const interest = Number($('#d-interest').value) || 0;
          if(!name) return alert('Nombre requerido');
          await addDebt({ name, bankId, outstanding, monthlyPayment, interest });
          closeModal();
        } catch(e){ console.error(e); alert('Error al guardar deuda: '+e.message); }
      };
    }

    function openDebtPaymentModal(debtId){
      const d = state.debts.find(x=>x.id===debtId); if(!d) return alert('Deuda no encontrada');
      showModal(`<div><h3 style="margin:0">Pagar ${d.name}</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><label>Monto</label><input id="pay-amount" value="${Number(d.monthlyPayment)||0}" /></div><div><label>Cuenta</label><select id="pay-bank">${state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('')}</select></div><div style="grid-column:1/-1"><label>Descripción</label><input id="pay-desc" value="Pago deuda ${d.name}" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="pay-cancel" class="ghost compact">Cancelar</button><button id="pay-save" class="primary compact">Registrar pago</button></div></div>`);
      $('#pay-cancel').onclick = closeModal;
      $('#pay-save').onclick = async ()=> {
        try{
          const amount = Number($('#pay-amount').value) || 0; const bankId = $('#pay-bank').value; const desc = $('#pay-desc').value.trim();
          if(!amount || amount <= 0) return alert('Monto inválido');
          const today = dateToDDMMYYYY(new Date());
          await addTransaction({ type:'Egreso', amount, categoryId:null, categoryName:'Pago Deuda', description:desc, dateStr:today, bankId, debtId });
          closeModal();
        } catch(e){ console.error(e); alert('Error al registrar pago: '+e.message); }
      };
    }

    /* ================== EXPORT / IMPORT / PDF ================== */
    function exportTransactionsCSV(){
      const rows = state.transactions.map(t=>{ const date = t.date ? (t.date.toDate ? dateToDDMMYYYY(t.date.toDate()) : (t.dateStr||tsToDateStr(t.date))) : (t.dateStr||''); const bank = state.banks.find(b=>b.id===t.bankId); const cat = state.categories.find(c=>c.id===t.categoryId); return [date, bank?bank.name:'', t.type||'', cat?cat.name:(t.categoryName||''), (t.description||'').replace(/"/g,'""'), t.amount||0]; });
      const csv = [['fecha,cuenta,tipo,categoria,descripcion,monto'], ...rows.map(r=>r.map((c,i)=> i===4?`"${c}"`:c).join(','))].join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'transacciones.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function exportBackupJSON(){
      const data = { transactions: state.transactions, banks: state.banks, debts: state.debts, fixed: state.fixed, savings: state.savings, categories: state.categories };
      const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'backup_jo_finanzas.json'; a.click(); URL.revokeObjectURL(url);
    }

    async function importFile(file){
      if(!file) return alert('Selecciona archivo');
      const text = await file.text();
      if(file.name.toLowerCase().endsWith('.csv')){
        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        const headers = lines.shift().split(',').map(h=>h.toLowerCase());
        for(const line of lines){
          const parts = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g).map(p=>p.replace(/^"|"$/g,'').replace(/""/g,'"'));
          const obj = {}; headers.forEach((h,i)=> obj[h]=parts[i]||'');
          const bank = state.banks.find(b=>b.name === obj.cuenta);
          const cat = state.categories.find(c=>c.name === obj.categoria);
          await addTransaction({ type: obj.tipo||'Ingreso', amount: Number(obj.monto)||0, categoryId: cat?cat.id:null, categoryName: obj.categoria||'', description: obj.descripcion||'', dateStr: obj.fecha, bankId: bank?bank.id:null });
        }
        showToast('CSV importado');
      } else {
        try{
          const data = JSON.parse(text);
          if(data.categories){ for(const c of data.categories) await addCategory({ name:c.name, limitMonthly:c.limitMonthly||0 }); }
          if(data.banks){ for(const b of data.banks) await addBank(b); }
          if(data.debts){ for(const d of data.debts) await addDebt(d); }
          if(data.fixed){ for(const f of data.fixed) await addFixedExpense(f); }
          if(data.transactions){ for(const t of data.transactions) await addTransaction({ type:t.type||'Ingreso', amount:t.amount||0, categoryId:t.categoryId||null, categoryName:t.categoryName||t.category||'', description:t.description||'', dateStr:t.dateStr || (t.date && t.date._seconds ? dateToDDMMYYYY(new Date(t.date._seconds*1000)) : ''), bankId:t.bankId||null }); }
          showToast('JSON importado');
        } catch(e){ alert('JSON inválido'); }
      }
    }

    function exportReportPDF(){
      const node = document.createElement('div');
      node.style.padding = '12mm';
      node.style.background = '#fff';
      node.style.color = '#111';
      node.style.fontFamily = 'Arial, Helvetica, sans-serif';
      node.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6mm">
          <div>
            <div style="font-weight:800;font-size:12pt">Reporte Financiero - JHONATAN ORELLANA</div>
            <div style="font-size:11pt;color:#444;margin-top:2mm">Fecha: ${dateToDDMMYYYY(new Date())}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700;font-size:12pt">${$('#balance').textContent}</div>
            <div style="font-size:10pt;color:#666;margin-top:2mm"></div>
          </div>
        </div>
        <hr style="border:none;border-top:1px solid #ddd;margin-bottom:6mm">
        <div style="font-size:11pt;font-weight:700;margin-bottom:3mm">Bancos</div>
        <div style="font-size:10pt;margin-bottom:6mm">${state.banks.length ? `<ul style="margin:0 0 6mm 14px">${state.banks.map(b=>`<li style="margin-bottom:2mm">${b.name}: ${fmtMoney(Number(b.balance)||0)}</li>`).join('')}</ul>` : '<div style="color:#666">Sin cuentas registradas</div>'}</div>
        <div style="font-size:11pt;font-weight:700;margin-bottom:3mm">Deudas</div>
        <div style="font-size:10pt;margin-bottom:6mm">${state.debts.length ? `<ul style="margin:0 0 6mm 14px">${state.debts.map(d=>`<li style="margin-bottom:2mm">${d.name} (${(state.banks.find(b=>b.id===d.bankId)||{name:'-' }).name}) - Saldo: ${fmtMoney(Number(d.outstanding)||0)} - Cuota: ${fmtMoney(Number(d.monthlyPayment)||0)}</li>`).join('')}</ul>` : '<div style="color:#666">Sin deudas</div>'}</div>
        <div style="font-size:11pt;font-weight:700;margin-bottom:3mm">Últimas transacciones</div>
        <table style="width:100%;border-collapse:collapse;font-size:10pt">
          <thead><tr><th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 0">Fecha</th><th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 0">Cuenta</th><th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 0">Categoría</th><th style="text-align:right;border-bottom:1px solid #ddd;padding:6px 0">Monto</th></tr></thead>
          <tbody>
            ${state.transactions.slice(0,30).map(t=>`<tr><td style="padding:6px 0">${t.date ? (t.date.toDate ? dateToDDMMYYYY(t.date.toDate()) : (t.dateStr||tsToDateStr(t.date))) : (t.dateStr||'')}</td><td style="padding:6px 0">${(state.banks.find(b=>b.id===t.bankId)||{name:'-'}).name}</td><td style="padding:6px 0">${(state.categories.find(c=>c.id===t.categoryId)||{name:t.categoryName||'-'}).name}</td><td style="padding:6px 0;text-align:right">${fmtMoney(Number(t.amount)||0)}</td></tr>`).join('')}
          </tbody>
        </table>
        <div style="margin-top:8mm;font-size:10pt;color:#666">Generado por JHONATAN ORELLANA - App Personal</div>
      `;
      if(window.html2pdf){ html2pdf().set({ margin:10, filename:`reporte_${(new Date()).toISOString().slice(0,10)}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(node).save(); }
      else alert('html2pdf no cargado. Recarga con conexión.');
    }

    /* ================== TECLA 'N' para nueva transacción ================== */
    let modalOpen = false;
    const modalBackdrop = $('#modal-backdrop');
    const observer = new MutationObserver(()=>{ modalOpen = modalBackdrop.style.display === 'flex'; });
    observer.observe(modalBackdrop, { attributes:true, attributeFilter:['style'] });
    window.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase() === 'n' && !e.ctrlKey && !e.altKey && !e.metaKey){
        const active = document.activeElement;
        const tag = active && active.tagName ? active.tagName.toLowerCase() : '';
        if(modalOpen) return;
        if(tag === 'input' || tag === 'textarea' || tag === 'select' || active.isContentEditable) return;
        if(e.repeat) return;
        openTransactionModal();
      }
    });

    /* ================== BIND UI ================== */
    function bindUI(){
      document.querySelectorAll('nav.bottom-nav button').forEach(b => b.addEventListener('click', ()=> switchView(b.dataset.view)));
      $('#btn-add-transaction').onclick = ()=> openTransactionModal();
      $('#btn-add-bank').onclick = ()=> openBankModal();
      $('#btn-add-debt').onclick = ()=> openDebtModal();
      $('#btn-add-fixed').onclick = ()=> openFixedModal();
      $('#btn-generate-fixed').onclick = ()=> generateFixedForMonth();
      $('#btn-new-category')?.addEventListener('click', ()=> openCategoryModal());
      $('#btn-new-saving')?.addEventListener('click', ()=> openSavingModal());
      $('#export-csv').onclick = exportTransactionsCSV;
      $('#export-json').onclick = exportBackupJSON;
      $('#btn-import').onclick = ()=> importFile($('#import-file').files[0]);
      $('#export-pdf').onclick = exportReportPDF;
      $('#search').addEventListener('input', ()=> renderTransactions());
      $('#modal-backdrop').onclick = (e)=> { if(e.target.id === 'modal-backdrop') closeModal(); };
      $('#btn-manage-join').onclick = ()=> openJoinModal();
    }

    /* ================== GASTOS FIJOS (generar mes) ================== */
    async function generateFixedForMonth(){
      const today = new Date(), month = today.getMonth(), year = today.getFullYear();
      const generated = [];
      for(const f of state.fixed.filter(x=>x.active)){
        const day = Math.min(28, Number(f.nextDueDay)||1);
        const dt = new Date(year, month, day);
        const dateStr = dateToDDMMYYYY(dt);
        const exists = state.transactions.some(t=>{
          const tDate = t.date ? (t.date.toDate ? dateToDDMMYYYY(t.date.toDate()) : t.dateStr) : t.dateStr;
          return tDate === dateStr && (t.description||'') === f.name && Number(t.amount) === Number(f.amount);
        });
        if(exists) continue;
        try{ await addTransaction({ type:'Egreso', amount:f.amount, categoryId:f.categoryId, categoryName:f.categoryName, description:f.name, dateStr, bankId:f.bankId }); generated.push(f.name); } catch(e){ console.error('generate fixed error', e); }
      }
      showToast('Gastos fijos generados: ' + (generated.length ? generated.join(', ') : 'ninguno'));
    }

    async function openFixedModal(){
      const bankOpts = `<option value="">-- Seleccionar cuenta --</option>` + state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      const catOpts = `<option value="">-- Seleccionar categoría --</option>` + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      showModal(`<div><h3 style="margin:0">Nuevo gasto fijo</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><label>Nombre</label><input id="f-name" /></div><div><label>Monto</label><input id="f-amount" value="0" /></div><div><label>Cuenta</label><select id="f-bank">${bankOpts}</select></div><div><label>Día (1-28)</label><input id="f-day" value="1" /></div><div style="grid-column:1/-1"><label>Categoría</label><select id="f-cat">${catOpts}</select></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="f-cancel" class="ghost compact">Cancelar</button><button id="f-save" class="primary compact">Guardar</button></div></div>`);
      $('#f-cancel').onclick = closeModal;
      $('#f-save').onclick = async ()=> {
        try{
          const name = $('#f-name').value.trim(); const amount = Number($('#f-amount').value) || 0; const bankId = $('#f-bank').value || null; const day = Math.max(1, Math.min(28, Number($('#f-day').value) || 1)); const catId = $('#f-cat').value || null;
          if(!name) return alert('Nombre requerido'); if(!amount || amount <= 0) return alert('Monto inválido');
          const categoryName = (state.categories.find(c=>c.id===catId)||{name:''}).name;
          await addFixedExpense({ name, amount, bankId, nextDueDay: day, categoryId: catId, categoryName, active:true });
          closeModal();
        } catch(e){ console.error(e); alert('Error al guardar gasto fijo: '+e.message); }
      };
    }

    async function openSavingModal(){
      const bankOpts = `<option value="">-- Seleccionar cuenta --</option>` + state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      showModal(`<div><h3 style="margin:0">Nuevo plan de ahorro</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><label>Nombre</label><input id="s-name" /></div><div><label>Cuenta vinculada</label><select id="s-bank">${bankOpts}</select></div><div><label>Monto objetivo</label><input id="s-target" value="0" /></div><div><label>Fecha meta</label><input id="s-date" placeholder="dd/mm/yyyy" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="s-cancel" class="ghost compact">Cancelar</button><button id="s-save" class="primary compact">Crear</button></div></div>`);
      $('#s-cancel').onclick = closeModal;
      $('#s-save').onclick = async ()=> {
        try{
          const name = $('#s-name').value.trim(); const bankId = $('#s-bank').value || null; const target = Number($('#s-target').value) || 0; const date = $('#s-date').value.trim();
          if(!name) return alert('Nombre requerido'); if(!target || target <= 0) return alert('Monto objetivo inválido'); if(date && !parseDateDDMMYYYY(date)) return alert('Fecha inválida');
          if(!db){ const id='local-'+Math.random().toString(36).slice(2,9); state.savings.push({ id, name, bankId, target, date, balance:0 }); persistLocal(); renderSavings(); } else { await addDoc(collection(db, orgPath('savings')), { name, bankId, target, date, balance:0, createdAt: serverTimestamp() }); await loadAllFromFirestore(); }
          closeModal();
        } catch(e){ console.error(e); alert('Error al crear plan: '+e.message); }
      };
    }

    /* ================== AUTENTICACIÓN ANÓNIMA + ORG JOIN (core) ================== */
    // Crear org con joinCode y registrar miembro
    async function createOrgWithCode({ name = 'Org personal', createdByUid }){
      const joinCode = generateJoinCode(6);
      const orgRef = await addDoc(collection(db, 'organizations'), { name, joinCode, createdAt: serverTimestamp(), createdBy: createdByUid || null });
      const orgId = orgRef.id;
      if(createdByUid){
        await setDoc(doc(db, `organizations/${orgId}/members`, createdByUid), { uid: createdByUid, role: 'owner', joinedAt: serverTimestamp() });
      }
      return { orgId, joinCode };
    }
    async function findOrgByJoinCode(code){
      const q = query(collection(db, 'organizations'), where('joinCode', '==', code));
      const snap = await getDocs(q);
      if(snap.empty) return null;
      return { id: snap.docs[0].id, data: snap.docs[0].data() };
    }
    async function joinOrgWithCode(code, uid){
      const found = await findOrgByJoinCode(code);
      if(!found) throw new Error('Código inválido');
      const orgId = found.id;
      await setDoc(doc(db, `organizations/${orgId}/members`, uid), { uid, role: 'member', joinedAt: serverTimestamp() });
      return orgId;
    }
    async function updateOrgJoinCode(orgId){
      const newCode = generateJoinCode(6);
      await updateDoc(doc(db, 'organizations', orgId), { joinCode: newCode, updatedAt: serverTimestamp() });
      state.orgJoinCode = newCode;
      updateOrgDisplay();
      return newCode;
    }
    async function getMemberRole(orgId, uid){
      try{
        const snap = await getDoc(doc(db, `organizations/${orgId}/members`, uid));
        if(!snap.exists()) return null;
        return snap.data().role || null;
      } catch(e){ return null; }
    }

    // Al autenticar: intentar hacer auto-join por URL (join=CODE), si no -> usar profile.orgId o crear org personal
    function getJoinCodeFromUrl(){ try{ const params = new URLSearchParams(window.location.search); return params.get('join') || null; }catch(e){ return null; } }

    async function ensureOrgForDevice(user){
      if(!db) { // modo local
        state.currentOrgId = 'local-demo'; state.orgJoinCode = null; return state.currentOrgId;
      }
      const profileRef = doc(db, 'users', user.uid, 'profile', 'meta');
      const profSnap = await getDoc(profileRef);
      if(profSnap.exists()){
        const data = profSnap.data();
        if(data && data.orgId){
          state.currentOrgId = data.orgId;
          state.orgJoinCode = data.joinCode || null;
          state.memberRole = await getMemberRole(state.currentOrgId, user.uid);
          return state.currentOrgId;
        }
      }
      // No tiene org -> crear org propia
      const { orgId, joinCode } = await createOrgWithCode({ name: `Org - ${user.uid.slice(0,6)}`, createdByUid: user.uid });
      await setDoc(profileRef, { orgId, createdAt: serverTimestamp(), joinCode }, { merge: true });
      state.currentOrgId = orgId;
      state.orgJoinCode = joinCode;
      state.memberRole = 'owner';
      return orgId;
    }

    /* ================== UI: Modal para gestionar join (mostrar, ingresar código, regenerar) ================== */
    function openJoinModal(){
      showModal(`<div><h3 style="margin:0">Vincular dispositivo</h3>
        <div class="muted" style="margin-top:8px">Puedes vincular este dispositivo a una organización existente con su JOIN CODE, o ver/regenerar el código de tu organización (si eres owner).</div>
        <div style="display:grid;gap:8px;margin-top:10px">
          <div><label>Ingresar JOIN CODE</label><input id="join-code-input" placeholder="ABC123" /></div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="join-cancel" class="ghost compact">Cerrar</button>
            <button id="join-apply" class="primary compact">Unir</button>
          </div>
          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03)">
          <div><strong>Tu código actual</strong> <div id="my-join-code" class="muted" style="margin-top:6px">${state.orgJoinCode||'No disponible'}</div></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="join-copy" class="ghost compact">Copiar</button>
            <button id="join-regenerate" class="ghost compact">Regenerar</button>
          </div>
        </div></div>`);
      $('#join-cancel').onclick = closeModal;
      $('#join-apply').onclick = async ()=>{
        const code = $('#join-code-input').value.trim().toUpperCase();
        if(!code) return alert('Ingresa un código');
        try{
          await joinOrgWithCode(code, state.uid);
          // guardar en profile
          await setDoc(doc(db, 'users', state.uid, 'profile', 'meta'), { orgId: (await findOrgByJoinCode(code)).id, joinedVia: code, joinedAt: serverTimestamp() }, { merge: true });
          state.currentOrgId = (await findOrgByJoinCode(code)).id;
          state.orgJoinCode = code;
          state.memberRole = await getMemberRole(state.currentOrgId, state.uid);
          subscribeToCollections(); // suscribirse ahora que tenemos org
          showToast('Dispositivo vinculado correctamente.');
          await loadAllFromFirestore();
          closeModal();
        } catch(e){ console.error(e); alert('No se pudo unir: '+(e.message||e)); }
      };
      $('#join-copy').onclick = ()=>{
        if(state.orgJoinCode){ navigator.clipboard?.writeText(state.orgJoinCode).then(()=> showToast('Código copiado')); } else showToast('No hay código');
      };
      $('#join-regenerate').onclick = async ()=>{
        if(!state.currentOrgId) return alert('No estás en una organización');
        // permiso: solo owner puede regenerar
        const role = state.memberRole || await getMemberRole(state.currentOrgId, state.uid);
        if(role !== 'owner') return alert('Solo el propietario puede regenerar el código.');
        try{
          const newCode = await updateOrgJoinCode(state.currentOrgId);
          $('#my-join-code').textContent = newCode;
          showToast('Código regenerado: ' + newCode);
        } catch(e){ console.error(e); alert('No se pudo regenerar: '+e.message); }
      };
    }

    /* ================== LOCAL STORAGE (fallback cuando no hay Firebase) ================== */
    function persistLocal(){ const data={transactions:state.transactions,banks:state.banks,depts:state.debts,fixed:state.fixed,savings:state.savings,categories:state.categories}; localStorage.setItem('jo_finanzas_org', JSON.stringify(data)); }
    function loadLocal(){ const raw = localStorage.getItem('jo_finanzas_org'); if(!raw) return; try{ const d = JSON.parse(raw); state.transactions = d.transactions||[]; state.banks = d.banks||[]; state.debts = d.depts||[]; state.fixed = d.fixed||[]; state.savings = d.savings||[]; state.categories = d.categories||[]; }catch(e){console.error(e);} }

    /* ================== AUTH & STARTUP ================== */
    async function initAuth(){
      bindUI();
      if(!isConfigFilled){ state.uid = 'local-demo'; $('#uid').textContent = state.uid + ' (local)'; loadLocal(); renderAll(); showToast('Modo local: Firebase no configurado'); return; }
      try{ await signInAnonymously(auth); } catch(e){ console.warn('signInAnonymously error', e); }
      onAuthStateChanged(auth, async (user)=>{
        if(user){
          state.uid = user.uid; $('#uid').textContent = state.uid;
          try{
            // Intentar auto-join desde URL ?join=CODE
            const joinCode = getJoinCodeFromUrl();
            if(joinCode){
              try{
                const orgId = (await findOrgByJoinCode(joinCode))?.id;
                if(orgId){
                  await joinOrgWithCode(joinCode, user.uid);
                  await setDoc(doc(db, 'users', user.uid, 'profile', 'meta'), { orgId, joinedVia: joinCode, joinedAt: serverTimestamp() }, { merge: true });
                  state.currentOrgId = orgId;
                  state.orgJoinCode = joinCode;
                  state.memberRole = await getMemberRole(orgId, user.uid);
                } else {
                  // no se encontró org -> crear org personal
                  await ensureOrgForDevice(user);
                }
              } catch(e){ console.warn('Auto join failed', e); await ensureOrgForDevice(user); }
            } else {
              await ensureOrgForDevice(user);
            }
            // subscribe
            subscribeToCollections();
            // si subscription en tiempo real falla por permisos, fallback a loadAllFromFirestore
            await loadAllFromFirestore();
            updateOrgDisplay();
            showToast('Conectado (Firestore).');
          } catch(e){ console.error('Auth/init error', e); showToast('Error inicializando org: '+e.message, true); }
        } else {
          $('#uid').textContent = 'No autenticado';
        }
      });
    }

    (async function main(){
      await initAuth();
      if(!isConfigFilled){
        if(state.categories.length === 0){ state.categories = [{ id:'local-sal', name:'Salario', limitMonthly:0 }, { id:'local-al', name:'Alimentos', limitMonthly:0 }]; persistLocal(); }
        renderAll();
      }
      switchView('dashboard');
    })();

    // Exponer estado para debugging
    window._jo_state = state;
  </script>
</body>
</html>
