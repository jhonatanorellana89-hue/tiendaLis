<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Control Económico — RealtimeDB + AutoSign</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:0;color:#0b1220}
  .wrap{max-width:1100px;margin:18px auto;padding:14px}
  .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 24px rgba(10,20,40,0.06)}
  .grid{display:grid;grid-template-columns:240px 1fr;gap:14px}
  .menu button{display:block;width:100%;text-align:left;padding:10px;border:0;background:transparent;cursor:pointer}
  .menu button.active{background:#eefbf9}
  input,select{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px}
  .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
  .btn.primary{background:#0f766e;color:#fff}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #f1f3f6;text-align:left}
  #log{height:120px;overflow:auto;background:#0f172a;color:#fff;padding:8px;border-radius:6px;font-size:12px}
  .time-meter{position:fixed;top:12px;right:12px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 8px 20px rgba(12,16,35,0.08);z-index:1200;display:flex;gap:8px;align-items:center}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} .time-meter{position:static;margin-bottom:12px} }
</style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase compat (Realtime DB) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Control Económico — RealtimeDB</strong><div style="font-size:13px;color:#6b7280">Sincronización automática con Realtime Database</div></div>
      <div id="userDisplay" style="font-size:13px;color:#6b7280">No autenticado</div>
    </header>

    <div class="time-meter">
      <button class="btn" onclick="goPrevMonth()">◀</button>
      <div style="min-width:140px;text-align:center">
        <div id="monthName" style="font-weight:700">--</div>
        <div id="monthYear" style="color:#6b7280">----</div>
      </div>
      <button class="btn primary" onclick="goNextMonth()">▶</button>
      <button class="btn" onclick="exportPDF()">Exportar PDF</button>
      <button class="btn" onclick="triggerFlush()">Sincronizar</button>
    </div>

    <div style="height:12px"></div>

    <div class="grid">
      <aside class="card menu">
        <button onclick="show('dashboard')" id="m_dashboard" class="active">Dashboard</button>
        <button onclick="show('banks')" id="m_banks">Bancos</button>
        <button onclick="show('debts')" id="m_debts">Deudas</button>
        <button onclick="show('liabs')" id="m_liabs">Pasivos</button>
        <button onclick="show('goods')" id="m_goods">Bienes</button>
        <button onclick="show('diary')" id="m_diary">Registro Diario</button>
        <button onclick="show('assets')" id="m_assets">Activos</button>
        <button onclick="show('incomes')" id="m_incomes">Ingresos</button>
        <div style="margin-top:12px;font-size:12px;color:#6b7280">LOG:</div>
        <div id="log" class="card"></div>
      </aside>

      <main>
        <!-- Dashboard -->
        <section id="dashboard" class="card">
          <h3>Resumen</h3>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
            <div class="card"><div style="color:#6b7280">Balance</div><div id="s_balance" style="font-weight:700">S/ 0</div></div>
            <div class="card"><div style="color:#6b7280">Ahorros</div><div id="s_ahorros" style="font-weight:700">S/ 0</div></div>
            <div class="card"><div style="color:#6b7280">Deuda mensual</div><div id="s_deuda" style="font-weight:700">S/ 0</div></div>
            <div class="card"><div style="color:#6b7280">Activos valor</div><div id="s_activos" style="font-weight:700">S/ 0</div></div>
          </div>
        </section>

        <!-- Banks -->
        <section id="banks" class="card" style="display:none">
          <h3>Bancos</h3>
          <label>Nombre banco</label><input id="bank_name">
          <label>Saldo inicial</label><input id="bank_init" type="number">
          <label>Tipo</label><select id="bank_type"><option value="ahorro">Ahorro</option><option value="corriente">Corriente</option></select>
          <div style="margin-top:8px"><button class="btn primary" onclick="addBankUI()">Agregar banco</button></div>
          <div style="margin-top:12px"><table id="tblBanks"><thead><tr><th>Banco</th><th>Saldo</th><th>Tipo</th><th></th></tr></thead><tbody></tbody></table></div>
        </section>

        <!-- Debts -->
        <section id="debts" class="card" style="display:none">
          <h3>Deudas</h3>
          <label>Acreedor</label><input id="debt_cred">
          <label>Total</label><input id="debt_total" type="number">
          <label>Meses</label><input id="debt_months" type="number" value="12">
          <div style="margin-top:8px"><button class="btn primary" onclick="addDebtUI()">Agregar deuda</button></div>
          <div style="margin-top:12px"><table id="tblDebts"><thead><tr><th>Acreedor</th><th>Total</th><th>Pago/m</th><th>Remanente</th><th></th></tr></thead><tbody></tbody></table></div>
        </section>

        <!-- Liabs -->
        <section id="liabs" class="card" style="display:none">
          <h3>Pasivos (cuota mensual)</h3>
          <label>Concepto</label><input id="liab_name">
          <label>Cuota mensual</label><input id="liab_monthly" type="number">
          <div style="margin-top:8px"><button class="btn primary" onclick="addLiabUI()">Agregar pasivo</button></div>
          <div style="margin-top:12px"><table id="tblLiabs"><thead><tr><th>Concepto</th><th>Cuota/m</th><th></th></tr></thead><tbody></tbody></table></div>
        </section>

        <!-- Goods -->
        <section id="goods" class="card" style="display:none">
          <h3>Bienes</h3>
          <label>Nombre</label><input id="good_name">
          <label>Tipo</label><select id="good_type"><option value="activo">Activo</option><option value="pasivo">Pasivo</option></select>
          <label>Valor</label><input id="good_value" type="number">
          <label>Ingreso/Costo mensual</label><input id="good_monthly" type="number">
          <div style="margin-top:8px"><button class="btn primary" onclick="addGoodUI()">Agregar bien</button></div>
          <div style="margin-top:12px"><table id="tblGoods"><thead><tr><th>Bien</th><th>Tipo</th><th>Valor</th><th>Mensual</th><th></th></tr></thead><tbody></tbody></table></div>
        </section>

        <!-- Diary -->
        <section id="diary" class="card" style="display:none">
          <h3>Registro diario</h3>
          <label>Fecha</label><input id="d_date" type="date">
          <label>Descripción</label><input id="d_desc">
          <label>Monto</label><input id="d_amount" type="number">
          <div style="margin-top:8px"><button class="btn primary" onclick="addDiaryUI()">Registrar gasto</button></div>
          <div style="margin-top:12px"><table id="tblDiary"><thead><tr><th>Fecha</th><th>Desc</th><th>Monto</th><th></th></tr></thead><tbody></tbody></table></div>
        </section>

        <!-- Assets -->
        <section id="assets" class="card" style="display:none">
          <h3>Activos</h3>
          <label>Nombre</label><input id="a_name">
          <label>Ingreso mensual</label><input id="a_income" type="number">
          <div style="margin-top:8px"><button class="btn primary" onclick="addAssetUI()">Agregar activo</button></div>
          <div style="margin-top:12px"><table id="tblAssets"><thead><tr><th>Activo</th><th>Ingreso/m</th><th></th></tr></thead><tbody></tbody></table></div>
        </section>

        <!-- Incomes -->
        <section id="incomes" class="card" style="display:none">
          <h3>Ingresos</h3>
          <label>Concepto</label><input id="i_name">
          <label>Monto</label><input id="i_amount" type="number">
          <label>Frecuencia</label><select id="i_freq"><option value="mensual">Mensual</option><option value="unica">Única</option></select>
          <div style="margin-top:8px"><button class="btn primary" onclick="addIncomeUI()">Agregar ingreso</button></div>
          <div style="margin-top:12px"><table id="tblIncomes"><thead><tr><th>Ingreso</th><th>Monto</th><th>Freq</th><th></th></tr></thead><tbody></tbody></table></div>
        </section>

      </main>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
/* Tu firebaseConfig ya mostrado */
const firebaseConfig = {
  apiKey: "AIzaSyBVppNAicRPFXEUdErmHd24se_9bjXiqcM",
  authDomain: "jhona-1b398.firebaseapp.com",
  databaseURL: "https://jhona-1b398-default-rtdb.firebaseio.com", // Asegúrate de que tu Realtime DB exista y usa su URL
  projectId: "jhona-1b398",
  storageBucket: "jhona-1b398.firebasestorage.app",
  messagingSenderId: "981136306223",
  appId: "1:981136306223:web:52a7b67c22c274efcc56da",
  measurementId: "G-NVGKL0XGER"
};

/* ---------- AUTO signin (si quieres automático set true) ---------- */
const AUTO_SIGNIN = true; // si NO quieres redirect automático cambia a false

/* ---------- Init Firebase compat ---------- */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const rdb  = firebase.database();

/* ========== Estado local ========== */
const STORAGE_KEY = 'auto_sync_realtime_v1';
let state = {
  currentMonthISO: new Date().toISOString().slice(0,10),
  balance: 0,
  banks: [],
  debts: [],
  liabs: [],
  goods: [],
  diary: [],
  assets: [],
  incomes: []
};

/* ========== UI log ========== */
function logUI(msg){
  const el = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  el.innerHTML = `[${time}] ${msg}<br>` + el.innerHTML;
  console.log(msg);
}

/* ========== Utils ========== */
function uid(pref='id'){return pref+'_'+Math.random().toString(36).slice(2,8);}
function formatCur(v){ return 'S/ ' + Number(v||0).toLocaleString(); }
function show(sectionId){ ['dashboard','banks','debts','liabs','goods','diary','assets','incomes'].forEach(s=>document.getElementById(s).style.display=(s===sectionId?'block':'none')); document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active')); const el=document.getElementById('m_'+sectionId); if(el) el.classList.add('active'); }

/* ========== Local storage load/save ========== */
function loadLocal(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = JSON.parse(raw); renderAll(); logUI('Estado local cargado'); }catch(e){ logUI('Error cargando local: '+e.message); } }
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); renderAll(); localSaveToCloudIfPossible(); }

/* ========== Cloud: save state + items to Realtime DB ========== */
let _debTimer = null;
function localSaveToCloudIfPossible(){
  if(!window.__FB_UID) { enqueueOp({type:'state', payload:state}); logUI('No auth: state encolado'); return; }
  clearTimeout(_debTimer);
  _debTimer = setTimeout(()=>{
    try{
      rdb.ref(`users/${window.__FB_UID}/state/current`).set({ state: state, updatedAt: new Date().toISOString() });
      logUI('Estado guardado en Realtime DB');
    }catch(e){ logUI('Error push state: '+e.message); enqueueOp({type:'state', payload:state}); }
  }, 700);
}

async function addCloudItem(uid, path, payload){
  try{
    const newRef = await rdb.ref(`users/${uid}/${path}`).push(Object.assign({}, payload, { createdAt: new Date().toISOString() }));
    logUI(`Cloud ${path} creado id:${newRef.key}`);
    return newRef.key;
  }catch(e){
    logUI('Error push cloud item: '+ e.message);
    enqueueOp({type:'subcol', subcol: path, payload});
    return null;
  }
}

/* ========== Queue offline ops ========== */
const PENDING_KEY = 'rtdb_pending_ops_v1';
function enqueueOp(op){
  try{
    const raw = localStorage.getItem(PENDING_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    arr.push(op);
    localStorage.setItem(PENDING_KEY, JSON.stringify(arr));
    logUI('Op encolada: ' + (op.type || op.subcol));
  }catch(e){ console.error(e); }
}
async function flushQueue(){
  try{
    const raw = localStorage.getItem(PENDING_KEY); if(!raw) { logUI('Cola vacía'); return; }
    const arr = JSON.parse(raw); if(!arr.length) { localStorage.removeItem(PENDING_KEY); logUI('Cola vacía'); return; }
    const uid = window.__FB_UID; if(!uid) { logUI('No auth: no puedo vaciar cola'); return; }
    for(const op of arr){
      try{
        if(op.type==='state') await rdb.ref(`users/${uid}/state/current`).set({ state: op.payload, updatedAt: new Date().toISOString() });
        else if(op.type==='subcol') await rdb.ref(`users/${uid}/${op.subcol}`).push(Object.assign({}, op.payload, { createdAt: new Date().toISOString() }));
        logUI('Op enviada: ' + (op.type || op.subcol));
      }catch(e){ logUI('Error enviando op: '+ e.message); return; }
    }
    localStorage.removeItem(PENDING_KEY);
    logUI('Cola sincronizada correctamente');
  }catch(e){ console.error(e); logUI('flushQueue error: '+ e.message); }
}

/* ========== Realtime listeners (start on login) ========== */
let listeners = [];
function startRealtime(uid){
  stopRealtime();
  try{
    // state/current
    const sRef = rdb.ref(`users/${uid}/state/current`);
    const sListener = sRef.on('value', snap => {
      if(!snap.exists()) return;
      const remote = snap.val().state;
      // adopt remote as authoritative
      state = remote;
      saveLocal(); // will re-render
      logUI('Estado remoto recibido y aplicado');
    }, err => logUI('Error listening state: '+ err.message));
    listeners.push({ ref: sRef, ev: 'value' });

    // collections: banks, debts, liabs, goods, diary, assets, incomes
    ['banks','debts','liabs','goods','diary','assets','incomes'].forEach(path=>{
      const ref = rdb.ref(`users/${uid}/${path}`);
      const listener = ref.on('value', snap=>{
        const arr = [];
        snap.forEach(child => { const d = child.val(); d._remoteId = child.key; arr.push(d); });
        state[path] = arr;
        saveLocal();
        logUI(`Subcolección remota '${path}' sincronizada (${arr.length})`);
      }, err=> logUI('Error listening '+path+': '+err.message));
      listeners.push({ ref, ev: 'value' });
    });

    logUI('Realtime listeners iniciados');
  }catch(e){ logUI('startRealtime error: '+ e.message); }
}
function stopRealtime(){
  try{
    listeners.forEach(l=> l.ref.off(l.ev));
    listeners = [];
    logUI('Realtime listeners detenidos');
  }catch(e){ console.error(e); }
}

/* ========== Render ========= */
function renderAll(){
  // KPIs
  document.getElementById('s_balance').innerText = formatCur(state.balance);
  document.getElementById('s_ahorros').innerText = formatCur(state.banks.reduce((s,b)=>s+Number(b.balance||0),0));
  document.getElementById('s_deuda').innerText = formatCur(state.debts.reduce((s,d)=>s+Number(d.monthly||0),0));
  document.getElementById('s_activos').innerText = formatCur(state.goods.filter(g=>g.type==='activo').reduce((s,g)=>s+Number(g.valor||0),0));

  // tables
  const tbB = document.querySelector('#tblBanks tbody'); if(tbB){ tbB.innerHTML=''; state.banks.forEach(b=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${b.name}</td><td>${formatCur(b.balance)}</td><td>${b.type}</td><td><button onclick="delBank('${b.id}')" class="btn">Eliminar</button></td>`; tbB.appendChild(tr); }); }
  const tbD = document.querySelector('#tblDebts tbody'); if(tbD){ tbD.innerHTML=''; state.debts.forEach(d=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${d.creditor}</td><td>${formatCur(d.total)}</td><td>${formatCur(d.monthly)}</td><td>${formatCur(d.remaining)}</td><td><button onclick="delDebt('${d.id}')" class="btn">Eliminar</button></td>`; tbD.appendChild(tr); }); }
  const tbL = document.querySelector('#tblLiabs tbody'); if(tbL){ tbL.innerHTML=''; state.liabs.forEach(l=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.name}</td><td>${formatCur(l.monthly)}</td><td><button onclick="delLiab('${l.id}')" class="btn">Eliminar</button></td>`; tbL.appendChild(tr); }); }
  const tbG = document.querySelector('#tblGoods tbody'); if(tbG){ tbG.innerHTML=''; state.goods.forEach(g=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${g.name}</td><td>${g.type}</td><td>${formatCur(g.valor)}</td><td>${formatCur(g.monthly)}</td><td><button onclick="delGood('${g.id}')" class="btn">Eliminar</button></td>`; tbG.appendChild(tr); }); }
  const tbDi = document.querySelector('#tblDiary tbody'); if(tbDi){ tbDi.innerHTML=''; state.diary.slice().reverse().forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${e.date}</td><td>${e.desc}</td><td>${formatCur(e.amount)}</td><td><button onclick="delDiary('${e.id}')" class="btn">Eliminar</button></td>`; tbDi.appendChild(tr); }); }
  const tbA = document.querySelector('#tblAssets tbody'); if(tbA){ tbA.innerHTML=''; state.assets.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.name}</td><td>${formatCur(a.income)}</td><td><button onclick="delAsset('${a.id}')" class="btn">Eliminar</button></td>`; tbA.appendChild(tr); }); }
  const tbI = document.querySelector('#tblIncomes tbody'); if(tbI){ tbI.innerHTML=''; state.incomes.forEach(i=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i.name}</td><td>${formatCur(i.amount)}</td><td>${i.freq}</td><td><button onclick="delIncome('${i.id}')" class="btn">Eliminar</button></td>`; tbI.appendChild(tr); }); }

  // month UI
  const d = new Date(state.currentMonthISO);
  const MONTHS = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SETIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
  document.getElementById('monthName').innerText = MONTHS[d.getMonth()];
  document.getElementById('monthYear').innerText = d.getFullYear();
}

/* ========== CRUD UI functions (do NOT clear inputs) ========== */
function addBankUI(){
  const name = document.getElementById('bank_name').value.trim();
  const bal  = Number(document.getElementById('bank_init').value||0);
  const type = document.getElementById('bank_type').value;
  if(!name) return alert('Nombre requerido');
  const o = { id: uid('b'), name, balance: bal, type };
  state.banks.push(o);
  saveLocal();
  if(window.__FB_UID) addCloudItem(window.__FB_UID,'banks', o).catch(()=>enqueueOp({type:'subcol',subcol:'banks',payload:o}));
  else enqueueOp({type:'subcol',subcol:'banks',payload:o});
  logUI('Banco agregado (local) — inputs NO se vaciaron');
}

function addDebtUI(){
  const cred = document.getElementById('debt_cred').value.trim();
  const total = Number(document.getElementById('debt_total').value||0);
  const months = Number(document.getElementById('debt_months').value||1);
  if(!cred || total<=0 || months<=0) return alert('Completa campos válidos');
  const monthly = +(total/months).toFixed(2);
  const o = { id:uid('d'), creditor:cred, total, months, monthly, remaining: total };
  state.debts.push(o);
  saveLocal();
  if(window.__FB_UID) addCloudItem(window.__FB_UID,'debts', o).catch(()=>enqueueOp({type:'subcol',subcol:'debts',payload:o}));
  else enqueueOp({type:'subcol',subcol:'debts',payload:o});
  logUI('Deuda agregada (local)');
}

function addLiabUI(){
  const name = document.getElementById('liab_name').value.trim();
  const monthly = Number(document.getElementById('liab_monthly').value||0);
  if(!name || monthly<=0) return alert('Datos invalidos');
  const o = { id:uid('l'), name, monthly };
  state.liabs.push(o);
  saveLocal();
  if(window.__FB_UID) addCloudItem(window.__FB_UID,'liabs', o).catch(()=>enqueueOp({type:'subcol',subcol:'liabs',payload:o}));
  else enqueueOp({type:'subcol',subcol:'liabs',payload:o});
  logUI('Pasivo agregado (local)');
}

function addGoodUI(){
  const name = document.getElementById('good_name').value.trim();
  const type = document.getElementById('good_type').value;
  const valor = Number(document.getElementById('good_value').value||0);
  const monthly = Number(document.getElementById('good_monthly').value||0);
  if(!name) return alert('Nombre requerido');
  const o = { id:uid('g'), name, type, valor, monthly };
  state.goods.push(o);
  saveLocal();
  if(window.__FB_UID) addCloudItem(window.__FB_UID,'goods', o).catch(()=>enqueueOp({type:'subcol',subcol:'goods',payload:o}));
  else enqueueOp({type:'subcol',subcol:'goods',payload:o});
  logUI('Bien agregado (local)');
}

function addDiaryUI(){
  const date = document.getElementById('d_date').value || new Date().toISOString().slice(0,10);
  const desc = document.getElementById('d_desc').value.trim();
  const amount = Number(document.getElementById('d_amount').value||0);
  if(amount<=0) return alert('Monto > 0');
  const o = { id:uid('di'), date, desc, amount };
  state.diary.push(o);
  state.balance -= amount;
  saveLocal();
  if(window.__FB_UID) addCloudItem(window.__FB_UID,'diary', o).catch(()=>enqueueOp({type:'subcol',subcol:'diary',payload:o}));
  else enqueueOp({type:'subcol',subcol:'diary',payload:o});
  logUI('Registro diario agregado (local)');
}

function addAssetUI(){
  const name = document.getElementById('a_name').value.trim();
  const income = Number(document.getElementById('a_income').value||0);
  if(!name) return alert('Nombre requerido');
  const o = { id:uid('a'), name, income };
  state.assets.push(o);
  saveLocal();
  if(window.__FB_UID) addCloudItem(window.__FB_UID,'assets', o).catch(()=>enqueueOp({type:'subcol',subcol:'assets',payload:o}));
  else enqueueOp({type:'subcol',subcol:'assets',payload:o});
  logUI('Activo agregado (local)');
}

function addIncomeUI(){
  const name = document.getElementById('i_name').value.trim();
  const amount = Number(document.getElementById('i_amount').value||0);
  const freq = document.getElementById('i_freq').value;
  if(!name || amount<=0) return alert('Datos invalidos');
  const o = { id:uid('in'), name, amount, freq };
  state.incomes.push(o);
  state.balance += amount;
  saveLocal();
  if(window.__FB_UID) addCloudItem(window.__FB_UID,'incomes', o).catch(()=>enqueueOp({type:'subcol',subcol:'incomes',payload:o}));
  else enqueueOp({type:'subcol',subcol:'incomes',payload:o});
  logUI('Ingreso agregado (local)');
}

/* ========== Delete helpers ========== */
function delBank(id){ state.banks = state.banks.filter(b=>b.id!==id); saveLocal(); logUI('Banco eliminado (local)'); }
function delDebt(id){ state.debts = state.debts.filter(d=>d.id!==id); saveLocal(); logUI('Deuda eliminada (local)'); }
function delLiab(id){ state.liabs = state.liabs.filter(l=>l.id!==id); saveLocal(); logUI('Pasivo eliminado (local)'); }
function delGood(id){ state.goods = state.goods.filter(g=>g.id!==id); saveLocal(); logUI('Bien eliminado (local)'); }
function delDiary(id){ const e = state.diary.find(x=>x.id===id); if(e) state.balance += Number(e.amount); state.diary = state.diary.filter(d=>d.id!==id); saveLocal(); logUI('Registro diario eliminado (local)'); }
function delAsset(id){ state.assets = state.assets.filter(a=>a.id!==id); saveLocal(); logUI('Activo eliminado (local)'); }
function delIncome(id){ state.incomes = state.incomes.filter(i=>i.id!==id); saveLocal(); logUI('Ingreso eliminado (local)'); }

/* ========== Month navigation ========== */
function goNextMonth(){ const cur = new Date(state.currentMonthISO); const next = new Date(cur.getFullYear(), cur.getMonth()+1, 1); state.currentMonthISO = next.toISOString().slice(0,10); saveLocal(); logUI('Mes avanzado'); }
function goPrevMonth(){ const cur = new Date(state.currentMonthISO); const prev = new Date(cur.getFullYear(), cur.getMonth()-1, 1); state.currentMonthISO = prev.toISOString().slice(0,10); saveLocal(); }

/* ========== Export PDF ========== */
function exportPDF(){ const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40; doc.setFontSize(14); doc.text('Resumen Control Económico',40,y); y+=20; doc.setFontSize(10); doc.text('Balance: ' + formatCur(state.balance),40,y); doc.save('resumen_ce_'+ new Date().toISOString().slice(0,10)+'.pdf'); logUI('PDF generado'); }

/* ========== Manual flush trigger ========== */
function triggerFlush(){ if(window.__FB_UID) { flushQueue(); } else alert('Inicia sesión para sincronizar'); }

/* ========== Auth logic: auto sign-in & handling ========== */
(function authInit(){
  // small auth buttons
  const div = document.createElement('div'); div.style.position='fixed'; div.style.bottom='12px'; div.style.right='12px'; div.style.zIndex=9999;
  div.innerHTML = '<button id="btnLogin" class="btn primary">Ingresar Google</button> <button id="btnLogout" class="btn" style="display:none">Salir</button>';
  document.body.appendChild(div);
  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    try{ await auth.signInWithPopup(provider); }catch(e){ logUI('Popup falló: '+(e.message||e)); try{ await auth.signInWithRedirect(provider); }catch(err){ logUI('Redirect también falló: '+(err.message||err)); } }
  });
  document.getElementById('btnLogout').addEventListener('click', ()=> auth.signOut());
})();

// Try automatic redirect result handling + optional auto redirect sign-in
// If AUTO_SIGNIN true and no current user, we'll start redirect sign-in automatically.
window.addEventListener('load', async ()=>{
  // handle redirect result (if coming back from Google)
  try{
    const result = await auth.getRedirectResult();
    if(result && result.user) logUI('Redirect sign-in finalizado: ' + (result.user.email || result.user.uid));
  }catch(e){ logUI('getRedirectResult error: ' + (e.message||e)); }

  // If user already signed in, onAuthStateChanged will handle; else optionally auto sign in
  if(AUTO_SIGNIN && !auth.currentUser){
    // If you prefer NOT auto-redirect, set AUTO_SIGNIN=false at top of file
    logUI('AUTO_SIGNIN activo — intentaremos signInWithRedirect si no hay sesión');
    const provider = new firebase.auth.GoogleAuthProvider();
    try{ await auth.signInWithRedirect(provider); }catch(e){ logUI('Auto redirect fallo: '+(e.message||e)); }
  }
});

auth.onAuthStateChanged(user=>{
  const ud = document.getElementById('userDisplay');
  const loginBtn = document.getElementById('btnLogin');
  const logoutBtn = document.getElementById('btnLogout');
  if(user){
    window.__FB_UID = user.uid;
    ud.innerText = (user.displayName || user.email) + ' (' + user.uid.slice(0,6) + ')';
    if(loginBtn) loginBtn.style.display='none';
    if(logoutBtn) logoutBtn.style.display='inline-block';
    logUI('Usuario autenticado: ' + (user.email || user.uid));
    // start listeners & flush
    startRealtime(user.uid);
    flushQueue();
    // push current local state to cloud once
    localSaveToCloudIfPossible();
  } else {
    window.__FB_UID = null;
    ud.innerText = 'No autenticado';
    if(loginBtn) loginBtn.style.display='inline-block';
    if(logoutBtn) logoutBtn.style.display='none';
    logUI('Sesión cerrada');
    stopRealtime();
  }
});

/* ========== Start app ========== */
loadLocal();
renderAll();
document.getElementById('d_date').value = new Date().toISOString().slice(0,10);
logUI('App lista. Si tu dominio GitHub está agregado como dominio autorizado y AUTO_SIGNIN=true, la app intentará iniciar sesión automáticamente (redirect).');

</script>
</body>
</html>


