<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JHONATAN ORELLANA - Finanzas Personales (index.html)</title>

  <!--
    APP SPA - JHONATAN ORELLANA (UN SOLO ARCHIVO)
    Cambios solicitados:
      - Registro de categor√≠as (CRUD) y vinculaci√≥n a transacciones/fijos
      - Tecla "N" abre nueva transacci√≥n (controlado; no se repite ni interfiere)
      - Exportar reporte PDF (html2pdf.js)
      - Establecer l√≠mites por categor√≠a y notificar si se supera (por mes)
    Instrucciones:
      1) Crear proyecto Firebase + Firestore y pegar firebaseConfig abajo.
      2) Habilitar Authentication (an√≥nimo o tu m√©todo preferido).
      3) Abrir este archivo en Live Server o servidor local para que funcionen importaciones por m√≥dulo.
  -->

  <style>
    :root{
      --bg:#07101a; --card:#0f172a; --accent:#00b894; --accent-2:#34ace0;
      --muted:#9aa6b2; --glass: rgba(255,255,255,0.03); --danger:#ff6b6b;
      --radius:12px; font-family: Inter, Roboto, Arial, sans-serif; color:#e6eef6;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#07101a,#03101a);-webkit-font-smoothing:antialiased}
    .container{max-width:1200px;margin:18px auto;padding:18px;display:flex;gap:18px;align-items:flex-start}
    aside.sidebar{width:300px;background:linear-gradient(180deg,#071421,#051017);border-radius:12px;padding:16px;position:sticky;top:18px;height:calc(100vh - 36px);overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001219;font-size:20px}
    nav.main-nav{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    nav.main-nav button{background:transparent;border:0;color:var(--muted);text-align:left;padding:10px;border-radius:10px;cursor:pointer;font-weight:700}
    nav.main-nav button.active{background:rgba(255,255,255,0.02);color:var(--accent)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);font-weight:700}
    main{flex:1;min-width:0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{grid-column:span 12;background:linear-gradient(180deg,#0b1622,#07121a);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    h2{margin:0;font-size:18px}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#001219;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:800}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .compact{padding:6px 8px;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02)}
    .danger{background:var(--danger);color:#120103;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .toast{position:fixed;right:18px;bottom:18px;background:#071421;color:#d6f6ef;padding:12px;border-radius:10px;box-shadow:0 8px 26px rgba(0,0,0,0.6);display:none;z-index:120}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:110}
    .modal{background:linear-gradient(180deg,#071421,#051017);padding:14px;border-radius:12px;max-width:720px;width:94%}
    @media (max-width:1000px){.container{flex-direction:column;padding:12px}aside.sidebar{width:100%;height:auto;position:static}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container" role="application">
    <aside class="sidebar" aria-label="Navegaci√≥n">
      <div class="brand">
        <div class="logo">JO</div>
        <div>
          <div style="font-weight:800">JHONATAN ORELLANA</div>
          <div class="muted" style="font-size:13px">Control ordenado y profesional</div>
        </div>
      </div>

      <nav class="main-nav" id="nav">
        <button data-view="dashboard" class="active">üìä Resumen</button>
        <button data-view="transactions">üßæ Transacciones</button>
        <button data-view="banks">üè¶ Bancos & Deudas</button>
        <button data-view="fixed">üîÅ Gastos Fijos</button>
        <button data-view="categories">üè∑Ô∏è Categor√≠as</button>
        <button data-view="savings">üíº Ahorros</button>
        <button data-view="export">‚¨áÔ∏è Export / Import</button>
      </nav>

      <div style="margin-top:12px">
        <div class="muted">UID</div>
        <div id="uid" class="pill">Sin iniciar</div>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Atajos</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button id="btn-new-trans" class="ghost compact">Nueva transacci√≥n (N)</button>
          <button id="btn-new-cat" class="ghost compact">Nueva categor√≠a</button>
          <button id="btn-export-pdf" class="ghost compact">Exportar reporte PDF</button>
        </div>
      </div>
    </aside>

    <main>
      <div class="grid">
        <!-- DASHBOARD -->
        <section id="view-dashboard" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2>Resumen</h2>
              <div class="muted">Balance, bancos y alertas de presupuesto</div>
            </div>
            <div class="muted" id="month-label"></div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px">
            <div style="background:var(--glass);padding:12px;border-radius:8px">
              <div class="muted">Balance total</div>
              <div id="balance" style="font-size:20px;font-weight:800;margin-top:6px">S/ 0.00</div>
              <div id="flows" class="muted"></div>
            </div>
            <div style="background:var(--glass);padding:12px;border-radius:8px">
              <div class="muted">Activos netos</div>
              <div id="net-assets" style="font-size:20px;font-weight:800;margin-top:6px">S/ 0.00</div>
              <div id="assets-break" class="muted"></div>
            </div>
            <div style="background:var(--glass);padding:12px;border-radius:8px">
              <div class="muted">Alertas</div>
              <div id="alerts" style="margin-top:8px"></div>
            </div>
          </div>

        </section>

        <!-- TRANSACTIONS -->
        <section id="view-transactions" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2>Transacciones</h2>
              <div class="muted">Cada transacci√≥n debe estar vinculada a una cuenta y categor√≠a</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="search" placeholder="Buscar..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
              <button id="btn-add-transaction" class="primary compact">Agregar</button>
            </div>
          </div>

          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Filtrar por cuenta</label>
              <select id="filter-bank"><option value="">-- Todas --</option></select>
            </div>
            <div style="width:160px">
              <label>Desde (dd/mm/yyyy)</label><input id="filter-from" />
            </div>
            <div style="width:160px">
              <label>Hasta (dd/mm/yyyy)</label><input id="filter-to" />
            </div>
            <div style="width:120px;align-self:flex-end">
              <button id="btn-apply-filters" class="ghost compact">Aplicar</button>
            </div>
          </div>

          <div style="margin-top:12px;overflow:auto">
            <table id="tx-table">
              <thead><tr><th>Fecha</th><th>Cuenta</th><th>Tipo</th><th>Categoria</th><th>Descripci√≥n</th><th class="right">Monto</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- BANKS & DEBTS -->
        <section id="view-banks" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2>Bancos & Deudas</h2>
              <div class="muted">Cuenta bancaria vinculada a transacciones y deudas</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="btn-add-bank" class="primary compact">Nueva cuenta</button>
              <button id="btn-add-debt" class="ghost compact">Nueva deuda</button>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div id="banks-table"></div>
            <div id="debts-table"></div>
          </div>
        </section>

        <!-- FIXED EXPENSES -->
        <section id="view-fixed" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2>Gastos Fijos</h2>
              <div class="muted">Pagos mensuales como pensi√≥n, cuotas, alquiler</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="btn-add-fixed" class="primary compact">Nuevo gasto fijo</button>
              <button id="btn-generate-fixed" class="ghost compact">Generar mes</button>
            </div>
          </div>

          <div id="fixed-table" style="margin-top:12px"></div>
        </section>

        <!-- CATEGORIES -->
        <section id="view-categories" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2>Categor√≠as</h2><div class="muted">Crear, editar y establecer l√≠mites mensuales</div></div>
            <div><button id="btn-new-category" class="primary compact">Nueva categor√≠a</button></div>
          </div>

          <div style="margin-top:12px;overflow:auto">
            <table id="categories-table">
              <thead><tr><th>Nombre</th><th class="right">L√≠mite mensual</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="muted" style="margin-top:8px">Al superar el l√≠mite de una categor√≠a recibir√°s una notificaci√≥n.</div>
          </div>
        </section>

        <!-- SAVINGS -->
        <section id="view-savings" class="card" style="display:none">
          <h2>Ahorros</h2>
          <div id="savings-table" style="margin-top:12px"></div>
        </section>

        <!-- EXPORT -->
        <section id="view-export" class="card" style="display:none">
          <h2>Export / Import</h2>
          <div class="muted">Exporta CSV, JSON o PDF (reporte bien dise√±ado)</div>
          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button id="export-csv" class="primary compact">Exportar transacciones (CSV)</button>
            <button id="export-json" class="ghost compact">Backup JSON</button>
            <input id="import-file" type="file" accept=".csv,application/json" />
            <button id="btn-import" class="primary compact">Importar</button>
            <button id="export-pdf" class="primary compact">Exportar REPORTE PDF</button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- MODAL & TOAST -->
  <div class="modal-backdrop" id="modal-backdrop"><div class="modal" id="modal"></div></div>
  <div class="toast" id="toast"></div>

  <!-- Firestore example rules (comentadas):
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId}/{doc=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  -->

  <!-- LIBRER√çAS: Firebase v9 modular (CDN) + Chart.js + html2pdf -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc,
      updateDoc, serverTimestamp, Timestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Chart.js + html2pdf
    const scriptChart = document.createElement('script'); scriptChart.src = 'https://cdn.jsdelivr.net/npm/chart.js'; document.head.appendChild(scriptChart);
    const scriptPdf = document.createElement('script'); scriptPdf.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js'; document.head.appendChild(scriptPdf);

    /*************** CONFIGURAR FIREBASE AQU√ç (REEMPLAZAR) ****************/
    const firebaseConfig = {
      // apiKey: "TU_API_KEY",
      // authDomain: "TU_PROJECT.firebaseapp.com",
      // projectId: "TU_PROJECT_ID",
      // storageBucket: "TU_PROJECT.appspot.com",
      // messagingSenderId: "XXXXX",
      // appId: "1:XXXXX:web:XXXXX"
    };
    const isConfigFilled = Object.keys(firebaseConfig).length > 0;
    let app, auth, db;
    if (isConfigFilled) { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } else { console.warn('Firebase no configurado. Modo local.'); }

    /************************ UTILIDADES ************************/
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    function fmtMoney(v){ v = Number(v)||0; return 'S/ '+v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function parseDateDDMMYYYY(s){ if(!s) return null; const p=s.split('/'); if(p.length!==3) return null; const d=parseInt(p[0]), m=parseInt(p[1])-1, y=parseInt(p[2]); const dt=new Date(y,m,d); return isNaN(dt)?null:dt; }
    function dateToDDMMYYYY(d){ if(!d) return ''; return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear(); }
    function tsToDateStr(ts){ if(!ts) return ''; if(ts.toDate) return dateToDDMMYYYY(ts.toDate()); if(ts._seconds) return dateToDDMMYYYY(new Date(ts._seconds*1000)); return String(ts); }

    /************************ ESTADO CENTRAL ************************/
    const state = {
      uid: null,
      transactions: [],
      banks: [],
      debts: [],
      fixed: [],
      savings: [],
      categories: [] // { id?, name, limitMonthly (number, 0 = no limite) }
    };

    /************************ FIRESTORE HELPERS ************************/
    function userPath(coll){ if(!state.uid) throw new Error('UID no disponible'); return `users/${state.uid}/${coll}`; }

    async function loadAllFromFirestore(){
      if(!db) return;
      const txSnap = await getDocs(query(collection(db, userPath('transactions')), orderBy('date','desc')));
      state.transactions = txSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      const bSnap = await getDocs(query(collection(db, userPath('banks')), orderBy('name')));
      state.banks = bSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      const dSnap = await getDocs(query(collection(db, userPath('debts')), orderBy('createdAt','desc')));
      state.debts = dSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      const fSnap = await getDocs(query(collection(db, userPath('fixedExpenses')), orderBy('name')));
      state.fixed = fSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      const sSnap = await getDocs(query(collection(db, userPath('savings')), orderBy('createdAt','desc')));
      state.savings = sSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      const cSnap = await getDocs(query(collection(db, userPath('categories')), orderBy('name')));
      state.categories = cSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    }

    /************************ LOCAL STORAGE fallback ************************/
    function persistLocal(){ const data={transactions:state.transactions,banks:state.banks,depts:state.debts,fixed:state.fixed,savings:state.savings,categories:state.categories}; localStorage.setItem('jo_finanzas_v2', JSON.stringify(data)); }
    function loadLocal(){ const raw=localStorage.getItem('jo_finanzas_v2'); if(!raw) return; try{ const d=JSON.parse(raw); state.transactions=d.transactions||[]; state.banks=d.banks||[]; state.debts=d.debts||[]; state.fixed=d.fixed||[]; state.savings=d.savings||[]; state.categories=d.categories||[]; }catch(e){console.error(e)} }

    /************************ CRUD & L√≥gica ************************/
    async function addCategory(cat){
      // cat: {name, limitMonthly}
      if(!db){ cat.id='local-'+Math.random().toString(36).slice(2,9); state.categories.push(cat); persistLocal(); renderCategories(); return cat; }
      const ref = await addDoc(collection(db, userPath('categories')), {...cat, createdAt: serverTimestamp()});
      await loadAllFromFirestore(); renderAll(); return { id: ref.id, ...cat };
    }
    async function updateCategory(id, data){
      if(!db){ const c=state.categories.find(x=>x.id===id); if(c){ Object.assign(c,data); persistLocal(); renderCategories(); } return; }
      await updateDoc(doc(db, userPath('categories'), id), data); await loadAllFromFirestore(); renderAll();
    }
    async function deleteCategory(id){
      if(!db){ state.categories=state.categories.filter(x=>x.id!==id); persistLocal(); renderCategories(); return; }
      await deleteDoc(doc(db, userPath('categories'), id)); await loadAllFromFirestore(); renderAll();
    }

    async function addTransaction(tx){
      // tx: {type, amount, categoryId, categoryName, description, dateStr, bankId, debtId}
      if(!parseDateDDMMYYYY(tx.dateStr)) throw new Error('Fecha inv√°lida');
      const payload={...tx, amount: Number(tx.amount)||0, date: Timestamp.fromDate(parseDateDDMMYYYY(tx.dateStr)), createdAt: serverTimestamp()};
      if(!db){
        payload.id='local-'+Math.random().toString(36).slice(2,9);
        state.transactions.unshift(payload);
        // update bank balance locally
        if(payload.bankId) { const delta = (payload.type==='Egreso')? -payload.amount : payload.amount; updateBankBalanceLocal(payload.bankId, delta); }
        // update debt if linked
        if(payload.debtId && payload.type==='Egreso'){ const d=state.debts.find(x=>x.id===payload.debtId); if(d){ d.outstanding = Math.max(0, (Number(d.outstanding)||0) - payload.amount); } }
        persistLocal(); renderAll();
        checkCategoryLimitAfterAdd(payload);
        return payload;
      }
      const ref = await addDoc(collection(db, userPath('transactions')), payload);
      // update bank balance server-side
      if(payload.bankId){ const delta=(payload.type==='Egreso')? -payload.amount : payload.amount; await updateBankBalance(payload.bankId, delta); }
      if(payload.debtId && payload.type==='Egreso'){ const debtRef = doc(db, userPath('debts'), payload.debtId); const snap = await getDoc(debtRef); if(snap.exists()){ const cur = snap.data().outstanding||0; await updateDoc(debtRef, { outstanding: Math.max(0, Number(cur)-payload.amount) }); } }
      await loadAllFromFirestore(); renderAll();
      checkCategoryLimitAfterAdd(payload);
      return { id: ref.id, ...payload };
    }

    // Bank helpers (local)
    function updateBankBalanceLocal(bankId, delta){
      const b = state.banks.find(x=>x.id===bankId); if(b) { b.balance = (Number(b.balance)||0) + Number(delta); persistLocal(); }
    }
    async function updateBankBalance(bankId, delta){
      if(!db){ updateBankBalanceLocal(bankId, delta); renderBanks(); renderDashboard(); return; }
      const ref = doc(db, userPath('banks'), bankId);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const cur = snap.data().balance || 0;
      await updateDoc(ref, { balance: Number(cur) + Number(delta) });
      await loadAllFromFirestore(); renderAll();
    }

    /************************ ALERTAS DE L√çMITES POR CATEGOR√çA ************************/
    function checkCategoryLimitAfterAdd(tx){
      // If tx has categoryId and category has limitMonthly > 0, compute month sum and compare
      const cid = tx.categoryId;
      if(!cid) return;
      const cat = state.categories.find(c => c.id === cid);
      if(!cat || !cat.limitMonthly || Number(cat.limitMonthly) <= 0) return;
      const date = tx.date ? (tx.date.toDate ? tx.date.toDate() : parseDateDDMMYYYY(tx.dateStr||'')) : parseDateDDMMYYYY(tx.dateStr||'');
      if(!date) return;
      const month = date.getMonth(), year = date.getFullYear();
      const total = state.transactions.reduce((acc,t)=>{
        const d = t.date ? (t.date.toDate ? t.date.toDate() : parseDateDDMMYYYY(t.dateStr||tsToDateStr(t.date))) : parseDateDDMMYYYY(t.dateStr||'');
        if(!d) return acc;
        if(d.getMonth()===month && d.getFullYear()===year && t.categoryId === cid) acc += Number(t.amount)||0;
        return acc;
      }, 0);
      if(total > Number(cat.limitMonthly)){
        showToast(`L√≠mite superado en "${cat.name}": ${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)}`, true);
      }
    }

    /************************ RENDER / UI ************************/
    function switchView(view){
      const views = ['dashboard','transactions','banks','fixed','categories','savings','export'];
      views.forEach(v => { const el = document.getElementById('view-'+v); if(el) el.style.display = (v===view)?'':'none'; });
      $$('#nav button').forEach(b => b.classList.toggle('active', b.dataset.view === view));
    }

    function renderAll(){
      renderDashboard(); renderTransactions(); renderBanks(); renderFixed(); renderCategories(); renderSavings(); populateFilters();
    }

    function renderDashboard(){
      let inc=0, exp=0;
      const now=new Date(), month=now.getMonth(), year=now.getFullYear();
      state.transactions.forEach(t=>{
        const d = t.date ? (t.date.toDate ? t.date.toDate() : parseDateDDMMYYYY(t.dateStr||tsToDateStr(t.date))) : parseDateDDMMYYYY(t.dateStr||'');
        if(!d) return;
        if(d.getMonth()===month && d.getFullYear()===year){
          if((t.type||'Ingreso').toLowerCase()==='egreso') exp += Number(t.amount)||0; else inc += Number(t.amount)||0;
        }
      });
      $('#balance').textContent = fmtMoney(inc - exp);
      $('#flows').textContent = `Ingresos: ${fmtMoney(inc)} ¬∑ Egresos: ${fmtMoney(exp)}`;
      $('#month-label').textContent = `${now.toLocaleString('default',{month:'long'})} ${year}`;

      let assets=0, liabilities=0;
      state.banks.forEach(b=> assets += Number(b.balance)||0);
      state.debts.forEach(d=> liabilities += Number(d.outstanding)||0);
      $('#net-assets').textContent = fmtMoney(assets - liabilities);
      $('#assets-break').textContent = `Activos: ${fmtMoney(assets)} ¬∑ Pasivos: ${fmtMoney(liabilities)}`;

      // Alerts summary for categories near/over limit
      const alerts = state.categories.map(cat => {
        if(!cat.limitMonthly || Number(cat.limitMonthly) <= 0) return null;
        // sum month
        const now2 = new Date(), m = now2.getMonth(), y = now2.getFullYear();
        const total = state.transactions.reduce((acc,t)=>{
          const d = t.date ? (t.date.toDate ? t.date.toDate() : parseDateDDMMYYYY(t.dateStr||tsToDateStr(t.date))) : parseDateDDMMYYYY(t.dateStr||'');
          if(!d) return acc;
          if(d.getMonth()===m && d.getFullYear()===y && t.categoryId === cat.id) acc += Number(t.amount)||0;
          return acc;
        },0);
        if(total >= Number(cat.limitMonthly)) return `<div style="margin-bottom:8px"><strong style="color:var(--danger)">${cat.name}</strong> ¬∑ ${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)} (L√≠mite superado)</div>`;
        if(total >= Number(cat.limitMonthly)*0.8) return `<div style="margin-bottom:8px"><strong>${cat.name}</strong> ¬∑ ${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)} (Cerca del l√≠mite)</div>`;
        return null;
      }).filter(Boolean);
      $('#alerts').innerHTML = alerts.length ? alerts.join('') : '<div class="muted">Sin alertas</div>';
    }

    function renderTransactions(){
      const tbody = $('#tx-table tbody'); if(!tbody) return; tbody.innerHTML = '';
      const rows = applyFiltersAndSearch();
      rows.forEach(t=>{
        const date = t.date ? (t.date.toDate ? dateToDDMMYYYY(t.date.toDate()) : (t.dateStr||tsToDateStr(t.date))) : (t.dateStr||'');
        const bank = state.banks.find(b=>b.id===t.bankId);
        const cat = state.categories.find(c=>c.id===t.categoryId);
        const bankName = bank ? bank.name : '-';
        const catName = cat ? cat.name : (t.categoryName||'-');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${date}</td><td>${bankName}</td><td>${t.type}</td><td>${catName}</td><td>${t.description||''}</td><td class="right">${fmtMoney(t.amount)}</td><td><button class="ghost compact" data-id="${t.id}" data-act="edit">Editar</button> <button class="danger compact" data-id="${t.id}" data-act="del">Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
      // bind
      $$('#tx-table button').forEach(btn=>{
        btn.onclick = async ()=> {
          const id = btn.dataset.id, act = btn.dataset.act;
          if(act==='del') showConfirm('Eliminar transacci√≥n','Confirma eliminar', async ()=>{ if(!db){ state.transactions = state.transactions.filter(x=>x.id!==id); persistLocal(); renderAll(); } else { await deleteDoc(doc(db, userPath('transactions'), id)); await loadAllFromFirestore(); renderAll(); } });
          if(act==='edit'){ const tx = state.transactions.find(x=>x.id===id); if(tx) openTransactionModal(tx); }
        }
      });
    }

    function applyFiltersAndSearch(){
      const q = $('#search').value.trim().toLowerCase();
      const bank = $('#filter-bank').value;
      const from = $('#filter-from').value.trim();
      const to = $('#filter-to').value.trim();
      return state.transactions.filter(t=>{
        const date = t.date ? (t.date.toDate ? t.date.toDate() : parseDateDDMMYYYY(t.dateStr||tsToDateStr(t.date))) : parseDateDDMMYYYY(t.dateStr||'');
        if(from){ const f = parseDateDDMMYYYY(from); if(!f || !date || date < f) return false; }
        if(to){ const tt = parseDateDDMMYYYY(to); if(!tt || !date || date > tt) return false; }
        if(bank && t.bankId !== bank) return false;
        if(q){
          const cat = state.categories.find(c=>c.id===t.categoryId);
          const txt = `${t.description||''} ${(cat?cat.name:'')}`.toLowerCase();
          if(!txt.includes(q)) return false;
        }
        return true;
      });
    }

    function renderBanks(){
      const wrap = $('#banks-table'); if(!wrap) return;
      if(state.banks.length === 0) wrap.innerHTML = '<div class="muted">No hay cuentas</div>'; else {
        wrap.innerHTML = `<table><thead><tr><th>Cuenta</th><th class="right">Saldo</th><th>Acciones</th></tr></thead><tbody>${state.banks.map(b=>`<tr><td>${b.name}<div class="muted" style="font-size:12px">${b.type||''}</div></td><td class="right">${fmtMoney(b.balance)}</td><td><button class="ghost compact" data-id="${b.id}" data-act="edit">Editar</button> <button class="danger compact" data-id="${b.id}" data-act="del">Eliminar</button></td></tr>`).join('')}</tbody></table>`;
      }
      // Debts
      const dwrap = $('#debts-table'); if(!dwrap) return;
      if(state.debts.length === 0) dwrap.innerHTML = '<div class="muted">No hay deudas</div>'; else {
        dwrap.innerHTML = `<table><thead><tr><th>Deuda</th><th>Banco</th><th class="right">Saldo</th><th class="right">Cuota</th><th>Acciones</th></tr></thead><tbody>${state.debts.map(d=>`<tr><td>${d.name}</td><td>${(state.banks.find(b=>b.id===d.bankId)||{name:'-'}).name}</td><td class="right">${fmtMoney(d.outstanding)}</td><td class="right">${fmtMoney(d.monthlyPayment)}</td><td><button class="ghost compact" data-id="${d.id}" data-act="pay">Pagar</button> <button class="danger compact" data-id="${d.id}" data-act="del">Eliminar</button></td></tr>`).join('')}</tbody></table>`;
      }

      // bind actions
      $$('#banks-table button, #debts-table button').forEach(btn=>{
        const act = btn.dataset.act, id = btn.dataset.id;
        btn.onclick = ()=>{
          if(act==='edit') openBankModal(id);
          if(act==='del') showConfirm('Eliminar cuenta','Confirma eliminar', async ()=>{ if(!db){ state.banks = state.banks.filter(x=>x.id!==id); persistLocal(); renderAll(); } else { await deleteDoc(doc(db, userPath('banks'), id)); await loadAllFromFirestore(); renderAll(); } });
          if(act==='pay') openDebtPaymentModal(id);
        }
      });
    }

    function renderFixed(){
      const wrap = $('#fixed-table'); if(!wrap) return;
      if(state.fixed.length === 0) wrap.innerHTML = '<div class="muted">No hay gastos fijos</div>'; else {
        wrap.innerHTML = `<table><thead><tr><th>Nombre</th><th>Cuenta</th><th class="right">Monto</th><th class="right">D√≠a</th><th>Acciones</th></tr></thead><tbody>${state.fixed.map(f=>`<tr><td>${f.name}</td><td>${(state.banks.find(b=>b.id===f.bankId)||{name:'-'}).name}</td><td class="right">${fmtMoney(f.amount)}</td><td class="right">${f.nextDueDay}</td><td><button class="ghost compact" data-id="${f.id}" data-act="gen">Generar</button> <button class="danger compact" data-id="${f.id}" data-act="del">Eliminar</button></td></tr>`).join('')}</tbody></table>`;
      }
      wrap.querySelectorAll('button').forEach(btn=>{
        const act = btn.dataset.act, id = btn.dataset.id;
        btn.onclick = async ()=> {
          if(act==='gen'){ const f = state.fixed.find(x=>x.id===id); if(f){ const todayStr = dateToDDMMYYYY(new Date()); await addTransaction({ type:'Egreso', amount:f.amount, categoryId:f.categoryId, categoryName:f.categoryName, description:f.name, dateStr:todayStr, bankId:f.bankId }); alert('Generado'); } }
          if(act==='del') showConfirm('Eliminar fijo','Confirmar', async ()=>{ if(!db){ state.fixed = state.fixed.filter(x=>x.id!==id); persistLocal(); renderAll(); } else { await deleteDoc(doc(db, userPath('fixedExpenses'), id)); await loadAllFromFirestore(); renderAll(); } });
        };
      });
    }

    function renderCategories(){
      const tbody = $('#categories-table tbody'); if(!tbody) return; tbody.innerHTML = '';
      state.categories.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name}</td><td class="right">${c.limitMonthly ? fmtMoney(c.limitMonthly) : 'Sin l√≠mite'}</td><td><button class="ghost compact" data-id="${c.id}" data-act="edit">Editar</button> <button class="danger compact" data-id="${c.id}" data-act="del">Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
      // bind
      $$('#categories-table button').forEach(btn=>{
        const id = btn.dataset.id, act = btn.dataset.act;
        btn.onclick = ()=> {
          if(act==='edit') openCategoryModal(id);
          if(act==='del') showConfirm('Eliminar categor√≠a','Confirmar eliminaci√≥n (las transacciones no se borran)', async ()=>{ await deleteCategory(id); });
        };
      });
    }

    function renderSavings(){ const wrap = $('#savings-table'); if(!wrap) return; if(state.savings.length===0) wrap.innerHTML='<div class="muted">Sin planes</div>'; else { wrap.innerHTML = `<table><thead><tr><th>Plan</th><th class="right">Objetivo</th><th>Cuenta</th><th class="right">Saldo</th></tr></thead><tbody>${state.savings.map(s=>`<tr><td>${s.name}</td><td class="right">${fmtMoney(s.target)}</td><td>${(state.banks.find(b=>b.id===s.bankId)||{name:'-'}).name}</td><td class="right">${fmtMoney(s.balance||0)}</td></tr>`).join('')}</tbody></table>`; } }

    function populateFilters(){
      const sel = $('#filter-bank'); if(!sel) return;
      sel.innerHTML = '<option value="">-- Todas --</option>' + state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      // also enable category select in transaction modal dynamically when opened
    }

    /************************ MODALES ************************/
    function showModal(html){ $('#modal').innerHTML = html; $('#modal-backdrop').style.display = 'flex'; }
    function closeModal(){ $('#modal').innerHTML=''; $('#modal-backdrop').style.display = 'none'; }

    function showConfirm(title, text, onConfirm){
      showModal(`<div><strong>${title}</strong><div class="muted" style="margin-top:8px">${text}</div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="m-cancel" class="ghost compact">Cancelar</button><button id="m-confirm" class="danger compact">Confirmar</button></div></div>`);
      $('#m-cancel').onclick = closeModal;
      $('#m-confirm').onclick = async ()=>{ await onConfirm(); closeModal(); };
    }

    /************************ FORMULARIOS MODALES ************************/
    function openCategoryModal(editId){
      const c = state.categories.find(x=>x.id===editId) || { name:'', limitMonthly:0 };
      showModal(`<div>
        <h3>${editId ? 'Editar categor√≠a' : 'Nueva categor√≠a'}</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div><label>Nombre</label><input id="c-name" value="${c.name}" /></div>
          <div><label>L√≠mite mensual (0 = sin l√≠mite)</label><input id="c-limit" value="${c.limitMonthly||0}" /></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="c-cancel" class="ghost compact">Cancelar</button>
          <button id="c-save" class="primary compact">Guardar</button>
        </div>
      </div>`);
      $('#c-cancel').onclick = closeModal;
      $('#c-save').onclick = async ()=>{
        const name = $('#c-name').value.trim(); const limit = Number($('#c-limit').value) || 0;
        if(!name) return alert('Nombre requerido');
        if(!editId) await addCategory({ name, limitMonthly: limit }); else await updateCategory(editId, { name, limitMonthly: limit });
        closeModal();
      };
    }

    function openTransactionModal(existing){
      // Build category options from state.categories
      const catOpts = `<option value="">-- Seleccionar categor√≠a --</option>` + state.categories.map(c=>`<option value="${c.id}">${c.name}${c.limitMonthly?` (L√≠m: ${fmtMoney(c.limitMonthly)})`:''}</option>`).join('');
      const bankOpts = `<option value="">-- Seleccionar cuenta --</option>` + state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      const defaults = existing || { type:'Ingreso', amount:0, categoryId:'', description:'', dateStr:dateToDDMMYYYY(new Date()), bankId:'' };
      showModal(`<div>
        <h3>${existing ? 'Editar transacci√≥n' : 'Nueva transacci√≥n'}</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div><label>Tipo</label><select id="m-type"><option ${defaults.type==='Ingreso'?'selected':''}>Ingreso</option><option ${defaults.type==='Egreso'?'selected':''}>Egreso</option></select></div>
          <div><label>Monto</label><input id="m-amount" value="${defaults.amount||0}" /></div>
          <div><label>Cuenta</label><select id="m-bank">${bankOpts}</select></div>
          <div><label>Categor√≠a</label><select id="m-cat">${catOpts}</select></div>
          <div style="grid-column:1/-1"><label>Descripci√≥n</label><input id="m-desc" value="${defaults.description||''}" /></div>
          <div><label>Fecha (dd/mm/yyyy)</label><input id="m-date" value="${defaults.dateStr||''}" /></div>
          <div><label>Pago a deuda (opcional)</label><select id="m-debt"><option value="">-- Ninguna --</option>${state.debts.map(d=>`<option value="${d.id}">${d.name} ¬∑ ${fmtMoney(d.outstanding)}</option>`).join('')}</select></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="m-cancel" class="ghost compact">Cancelar</button>
          <button id="m-save" class="primary compact">Guardar</button>
        </div>
      </div>`);
      // Preselect if existing
      if(existing){ setTimeout(()=>{ if(existing.bankId) $('#m-bank').value = existing.bankId; if(existing.categoryId) $('#m-cat').value = existing.categoryId; if(existing.debtId) $('#m-debt').value = existing.debtId; },50); }
      $('#m-cancel').onclick = closeModal;
      $('#m-save').onclick = async ()=>{
        const type = $('#m-type').value;
        const amount = Number($('#m-amount').value) || 0;
        const bankId = $('#m-bank').value || null;
        const categoryId = $('#m-cat').value || null;
        const description = $('#m-desc').value.trim();
        const dateStr = $('#m-date').value.trim();
        const debtId = $('#m-debt').value || null;
        if(!amount || amount <= 0) return alert('Monto inv√°lido');
        if(!parseDateDDMMYYYY(dateStr)) return alert('Fecha inv√°lida');
        const categoryName = (state.categories.find(c=>c.id===categoryId)||{name:''}).name;
        await addTransaction({ type, amount, categoryId, categoryName, description, dateStr, bankId, debtId });
        closeModal();
      };
    }

    function openBankModal(editId){
      const b = state.banks.find(x=>x.id===editId) || { name:'', balance:0, type:'Cuenta', currency:'PEN' };
      showModal(`<div>
        <h3>${editId ? 'Editar cuenta' : 'Nueva cuenta bancaria'}</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div><label>Nombre</label><input id="b-name" value="${b.name}" /></div>
          <div><label>Tipo</label><input id="b-type" value="${b.type}" /></div>
          <div><label>Saldo inicial</label><input id="b-balance" value="${b.balance||0}" /></div>
          <div><label>Moneda</label><input id="b-currency" value="${b.currency||'PEN'}" /></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="b-cancel" class="ghost compact">Cancelar</button><button id="b-save" class="primary compact">Guardar</button></div>
      </div>`);
      $('#b-cancel').onclick = closeModal;
      $('#b-save').onclick = async ()=>{
        const name = $('#b-name').value.trim(); const type = $('#b-type').value.trim(); const balance = Number($('#b-balance').value)||0; const currency = $('#b-currency').value.trim()||'PEN';
        if(!name) return alert('Nombre requerido');
        if(!editId){ if(!db){ const id='local-'+Math.random().toString(36).slice(2,9); state.banks.push({ id, name, type, balance, currency }); persistLocal(); renderAll(); } else { await addDoc(collection(db, userPath('banks')), { name, type, balance, currency, createdAt: serverTimestamp() }); await loadAllFromFirestore(); renderAll(); } } else { if(!db){ const bb = state.banks.find(x=>x.id===editId); if(bb){ bb.name=name; bb.type=type; bb.balance=balance; bb.currency=currency; persistLocal(); renderAll(); } } else { await updateDoc(doc(db, userPath('banks'), editId), { name, type, balance, currency }); await loadAllFromFirestore(); renderAll(); } }
        closeModal();
      };
    }

    function openDebtModal(){
      showModal(`<div>
        <h3>Nueva deuda</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div><label>Nombre</label><input id="d-name" /></div>
          <div><label>Banco</label><select id="d-bank"><option value="">-- Seleccionar --</option>${state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('')}</select></div>
          <div><label>Saldo pendiente</label><input id="d-out" value="0" /></div>
          <div><label>Cuota mensual</label><input id="d-pay" value="0" /></div>
          <div><label>Inter√©s (%)</label><input id="d-interest" value="0" /></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="d-cancel" class="ghost compact">Cancelar</button><button id="d-save" class="primary compact">Guardar</button></div>
      </div>`);
      $('#d-cancel').onclick = closeModal;
      $('#d-save').onclick = async ()=>{ const name=$('#d-name').value.trim(); const bankId=$('#d-bank').value||null; const outstanding=Number($('#d-out').value)||0; const monthlyPayment=Number($('#d-pay').value)||0; const interest=Number($('#d-interest').value)||0; if(!name) return alert('Nombre requerido'); if(!db){ const id='local-'+Math.random().toString(36).slice(2,9); state.debts.push({ id, name, bankId, outstanding, monthlyPayment, interest }); persistLocal(); renderAll(); } else { await addDoc(collection(db, userPath('debts')), { name, bankId, outstanding, monthlyPayment, interest, createdAt: serverTimestamp() }); await loadAllFromFirestore(); renderAll(); } closeModal(); };
    }

    function openDebtPaymentModal(debtId){
      const d = state.debts.find(x=>x.id===debtId); if(!d) return alert('Deuda no encontrada');
      showModal(`<div>
        <h3>Pagar ${d.name}</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div><label>Monto</label><input id="pay-amount" value="${d.monthlyPayment||0}" /></div>
          <div><label>Cuenta</label><select id="pay-bank">${state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('')}</select></div>
          <div style="grid-column:1/-1"><label>Descripci√≥n</label><input id="pay-desc" value="Pago deuda ${d.name}" /></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="pay-cancel" class="ghost compact">Cancelar</button><button id="pay-save" class="primary compact">Registrar pago</button></div>
      </div>`);
      $('#pay-cancel').onclick = closeModal;
      $('#pay-save').onclick = async ()=>{ const amount = Number($('#pay-amount').value)||0; const bankId = $('#pay-bank').value; const desc = $('#pay-desc').value.trim(); if(!amount || amount<=0) return alert('Monto inv√°lido'); const today = dateToDDMMYYYY(new Date()); await addTransaction({ type:'Egreso', amount, categoryId:null, categoryName:'Pago Deuda', description:desc, dateStr:today, bankId, debtId }); closeModal(); };
    }

    /************************ IMPORT / EXPORT / PDF ************************/
    function exportTransactionsCSV(){
      const rows = state.transactions.map(t=>{ const date = t.date ? (t.date.toDate ? dateToDDMMYYYY(t.date.toDate()) : (t.dateStr||tsToDateStr(t.date))) : (t.dateStr||''); const bank = state.banks.find(b=>b.id===t.bankId); const cat = state.categories.find(c=>c.id===t.categoryId); return [date, bank?bank.name:'', t.type||'', cat?cat.name:(t.categoryName||''), (t.description||'').replace(/"/g,'""'), t.amount||0]; });
      const csv = [['fecha,cuenta,tipo,categoria,descripcion,monto'], ...rows.map(r=>r.map((c,i)=> i===4?`"${c}"`:c).join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='transacciones.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function exportBackupJSON(){
      const data = { transactions: state.transactions, banks: state.banks, debts: state.debts, fixed: state.fixed, savings: state.savings, categories: state.categories };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='backup_jo_finanzas.json'; a.click(); URL.revokeObjectURL(url);
    }

    async function importFile(file){
      if(!file) return alert('Selecciona un archivo');
      const text = await file.text();
      if(file.name.toLowerCase().endsWith('.csv')){ const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const headers = lines.shift().split(',').map(h=>h.toLowerCase()); for(const line of lines){ const parts = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g).map(p=>p.replace(/^"|"$/g,'').replace(/""/g,'"')); const obj={}; headers.forEach((h,i)=> obj[h]=parts[i]||''); const bank = state.banks.find(b=>b.name === obj.cuenta); const cat = state.categories.find(c=>c.name === obj.categoria); await addTransaction({ type: obj.tipo||'Ingreso', amount: Number(obj.monto)||0, categoryId: cat?cat.id:null, categoryName: obj.categoria||'', description: obj.descripcion||'', dateStr: obj.fecha, bankId: bank?bank.id:null }); } alert('CSV importado'); } else { try{ const data = JSON.parse(text); if(data.categories){ for(const c of data.categories) await addCategory({ name:c.name, limitMonthly:c.limitMonthly||0 }); } if(data.banks){ for(const b of data.banks) { if(!db){ b.id = 'local-'+Math.random().toString(36).slice(2,9); state.banks.push(b); } else await addDoc(collection(db, userPath('banks')), b); } } if(data.transactions){ for(const t of data.transactions){ await addTransaction({ type: t.type||'Ingreso', amount: t.amount||0, categoryId: t.categoryId||null, categoryName: t.categoryName||t.category||'', description: t.description||'', dateStr: t.dateStr || (t.date && t.date._seconds ? dateToDDMMYYYY(new Date(t.date._seconds*1000)) : ''), bankId: t.bankId||null }); } } alert('JSON importado'); }catch(e){ alert('JSON inv√°lido'); } }
    }

    function exportReportPDF(){
      // create a report DOM node
      const node = document.createElement('div');
      node.style.padding = '18px';
      node.style.background = '#fff';
      node.style.color = '#111';
      node.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><h2>Reporte Financiero - JHONATAN ORELLANA</h2><div>Fecha: ${dateToDDMMYYYY(new Date())}</div></div><div style="text-align:right"><div style="font-weight:800">${$('#balance').textContent}</div><div style="color:#666">${$('#assets-break').textContent}</div></div></div><hr style="margin:12px 0">`;
      // banks summary
      node.innerHTML += `<h3>Bancos</h3><ul>${state.banks.map(b=>`<li>${b.name}: ${fmtMoney(b.balance)}</li>`).join('')}</ul>`;
      // debts
      node.innerHTML += `<h3>Deudas</h3><ul>${state.debts.length? state.debts.map(d=>`<li>${d.name} (${(state.banks.find(b=>b.id===d.bankId)||{name:'-' }).name}) - Saldo: ${fmtMoney(d.outstanding)} - Cuota: ${fmtMoney(d.monthlyPayment)}</li>`).join('') : '<li>Sin deudas</li>'}</ul>`;
      // top transactions (last 20)
      node.innerHTML += `<h3>Ultimas transacciones</h3><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left">Fecha</th><th style="text-align:left">Cuenta</th><th style="text-align:left">Categoria</th><th style="text-align:right">Monto</th></tr></thead><tbody>${state.transactions.slice(0,20).map(t=>`<tr><td>${t.date? (t.date.toDate?dateToDDMMYYYY(t.date.toDate()):t.dateStr):t.dateStr}</td><td>${(state.banks.find(b=>b.id===t.bankId)||{name:'-' }).name}</td><td>${(state.categories.find(c=>c.id===t.categoryId)||{name: t.categoryName||'-'}).name}</td><td style="text-align:right">${fmtMoney(t.amount)}</td></tr>`).join('')}</tbody></table>`;
      // Wait html2pdf loaded
      if(window.html2pdf){
        const opt = { margin: 10, filename: `reporte_financiero_${(new Date()).toISOString().slice(0,10)}.pdf`, html2canvas: { scale:1.3 }, jsPDF: { unit:'mm', format:'a4', orientation:'portrait' } };
        html2pdf().set(opt).from(node).save();
      } else {
        alert('html2pdf no cargado. Aseg√∫rate de tener conexi√≥n a internet.');
      }
    }

    /************************ TOAST ************************/
    let toastTimer;
    function showToast(msg, important = false){
      const t = $('#toast'); t.textContent = msg; t.style.display = 'block'; if(important) t.style.background = 'linear-gradient(90deg,var(--danger),#ff9a9a)'; else t.style.background = '#071421';
      clearTimeout(toastTimer); toastTimer = setTimeout(()=>{ t.style.display = 'none'; t.style.background = '#071421'; }, important ? 7000 : 3500);
    }

    /************************ TECLADO 'N' (CONTROLADO) ************************/
    let modalOpen = false;
    // observe modal backdrop
    const modalBackdrop = $('#modal-backdrop');
    const observer = new MutationObserver(()=>{ modalOpen = modalBackdrop.style.display === 'flex'; });
    observer.observe(modalBackdrop, { attributes: true, attributeFilter: ['style'] });

    window.addEventListener('keydown', (e)=>{
      // abrir nueva transacci√≥n con 'n' SOLO si:
      // - tecla simple (sin ctrl/alt/meta)
      // - no hay modal abierto
      // - el foco NO est√° en un input, textarea o select (evitar while typing)
      if(e.key.toLowerCase() === 'n' && !e.ctrlKey && !e.altKey && !e.metaKey){
        const active = document.activeElement;
        const tag = active && active.tagName ? active.tagName.toLowerCase() : '';
        if(modalOpen) return; // si modal abierto no hacer nada
        if(tag === 'input' || tag === 'textarea' || tag === 'select' || active.isContentEditable) return;
        // prevenir repeticiones por mantener presionada la tecla
        if (e.repeat) return;
        // open modal
        openTransactionModal();
      }
    });

    /************************ BIND UI ************************/
    function bindUI(){
      $$('#nav button').forEach(b => b.addEventListener('click', ()=> switchView(b.dataset.view)));
      $('#btn-new-trans').onclick = ()=> { switchView('transactions'); openTransactionModal(); };
      $('#btn-add-transaction').onclick = ()=> openTransactionModal();
      $('#btn-add-bank').onclick = ()=> openBankModal();
      $('#btn-add-debt').onclick = ()=> openDebtModal();
      $('#btn-add-fixed').onclick = ()=> openFixedModal();
      $('#btn-generate-fixed').onclick = ()=> generateFixedForMonth();
      $('#btn-new-category').onclick = ()=> openCategoryModal();
      $('#btn-new-cat').onclick = ()=> openCategoryModal();
      $('#btn-export-pdf').onclick = exportReportPDF;
      $('#export-csv').onclick = exportTransactionsCSV;
      $('#export-json').onclick = exportBackupJSON;
      $('#btn-import').onclick = ()=> importFile($('#import-file').files[0]);
      $('#export-pdf').onclick = exportReportPDF;
      $('#btn-apply-filters').onclick = ()=> renderTransactions();
      $('#search').addEventListener('input', ()=> renderTransactions());
      $('#modal-backdrop').onclick = (e)=> { if(e.target.id === 'modal-backdrop') closeModal(); };
    }

    /************************ GENERAR GASTOS FIJOS ************************/
    async function generateFixedForMonth(){
      const today = new Date(), month=today.getMonth(), year=today.getFullYear();
      const generated = [];
      for(const f of state.fixed.filter(x=>x.active)){
        const day = Math.min(28, Number(f.nextDueDay)||1);
        const dt = new Date(year, month, day);
        const dateStr = dateToDDMMYYYY(dt);
        const exists = state.transactions.some(t=>{
          const tDate = t.date ? (t.date.toDate?dateToDDMMYYYY(t.date.toDate()):t.dateStr) : t.dateStr;
          return tDate === dateStr && (t.description||'') === f.name && Number(t.amount) === Number(f.amount);
        });
        if(exists) continue;
        await addTransaction({ type:'Egreso', amount:f.amount, categoryId:f.categoryId, categoryName:f.categoryName, description:f.name, dateStr, bankId:f.bankId });
        generated.push(f.name);
      }
      showToast('Gastos fijos generados: ' + (generated.length?generated.join(', '):'ninguno'));
    }

    /************************ VENTANAS MODALES (helper para fixed creation) ************************/
    function openFixedModal(){
      const bankOpts = `<option value="">-- Seleccionar cuenta --</option>` + state.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      const catOpts = `<option value="">-- Seleccionar categor√≠a --</option>` + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      showModal(`<div>
        <h3>Nuevo gasto fijo</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div><label>Nombre</label><input id="f-name" /></div>
          <div><label>Monto</label><input id="f-amount" value="0" /></div>
          <div><label>Cuenta</label><select id="f-bank">${bankOpts}</select></div>
          <div><label>D√≠a (1-28)</label><input id="f-day" value="1" /></div>
          <div style="grid-column:1/-1"><label>Categor√≠a</label><select id="f-cat">${catOpts}</select></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="f-cancel" class="ghost compact">Cancelar</button><button id="f-save" class="primary compact">Guardar</button></div>
      </div>`);
      $('#f-cancel').onclick = closeModal;
      $('#f-save').onclick = async ()=>{ const name=$('#f-name').value.trim(); const amount=Number($('#f-amount').value)||0; const bankId=$('#f-bank').value||null; const day=Math.max(1,Math.min(28,Number($('#f-day').value)||1)); const catId=$('#f-cat').value||null; if(!name) return alert('Nombre requerido'); if(!amount || amount<=0) return alert('Monto inv√°lido'); const categoryName = (state.categories.find(c=>c.id===catId)||{name:''}).name; if(!db){ const id='local-'+Math.random().toString(36).slice(2,9); state.fixed.push({ id, name, amount, bankId, nextDueDay:day, categoryId:catId, categoryName, active:true }); persistLocal(); renderAll(); } else { await addDoc(collection(db, userPath('fixedExpenses')), { name, amount, bankId, nextDueDay:day, categoryId:catId, categoryName, active:true, createdAt: serverTimestamp() }); await loadAllFromFirestore(); renderAll(); } closeModal(); };
    }

    /************************ INICIALIZACI√ìN ************************/
    async function initAuth(){
      if(!isConfigFilled){ state.uid = 'local-demo'; $('#uid').textContent = state.uid + ' (local)'; loadLocal(); renderAll(); showToast('Modo local: Firebase no configurado'); return; }
      signInAnonymously(getAuth()).catch(e=>console.error('Anon auth error', e));
      onAuthStateChanged(getAuth(), async (user)=>{ if(user){ state.uid = user.uid; $('#uid').textContent = state.uid; await loadAllFromFirestore(); renderAll(); } else { $('#uid').textContent = 'No autenticado'; } });
    }

    /************************ ARRANQUE ************************/
    (async function main(){
      bindUI();
      await initAuth();
      // ensure categories exist (seed)
      if(state.categories.length === 0){ const defaults = [{name:'Salario', limitMonthly:0},{name:'Alimentos', limitMonthly:0},{name:'Transporte', limitMonthly:0},{name:'Varios', limitMonthly:0}]; if(!db){ defaults.forEach(d=>d.id='local-'+Math.random().toString(36).slice(2,9)); state.categories = defaults; persistLocal(); } else { for(const d of defaults) await addDoc(collection(db, userPath('categories')), { name:d.name, limitMonthly:d.limitMonthly, createdAt: serverTimestamp() }); await loadAllFromFirestore(); } renderCategories(); }
      // initial render if local mode
      if(!isConfigFilled) renderAll();
      // protective: prevent multiple accidental opens by focusing inputs; handled in keydown logic
    })();

    // Expose for debugging
    window._jo_state = state;
    window.showToast = showToast;
    // END MODULE
  </script>
</body>
</html>

