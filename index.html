<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control Económico — Shared (Realtime DB)</title>
<link href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css" rel="stylesheet">
<style>
  :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--accent:#0f766e}
  body{font-family:Inter,system-ui,Arial;background:var(--bg);margin:0;color:#0f172a}
  .wrap{max-width:1100px;margin:18px auto;padding:14px}
  .grid{display:grid;grid-template-columns:260px 1fr;gap:14px}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(12,16,35,0.06)}
  .menu button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer}
  .menu button.active{background:#eefbf9}
  .menu{position:sticky;top:18px}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px}
  .row{display:flex;gap:8px}
  .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #f1f3f6;text-align:left}
  .time-meter{position:fixed;top:18px;right:18px;background:var(--card);padding:8px;border-radius:10px;box-shadow:0 8px 20px rgba(12,16,35,0.08);z-index:1200;display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  #notifications{position:fixed;left:18px;bottom:18px;z-index:1300}
  .notif{background:#0f766e;color:#fff;padding:8px;border-radius:8px;margin-top:6px;box-shadow:0 4px 10px rgba(0,0,0,0.08)}
  @media (max-width:880px){.grid{grid-template-columns:1fr}.menu{position:relative}}
</style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:center" class="card">
      <div><strong>Control Económico — Shared DB</strong><div class="muted">Nodo compartido: /shared/miCuenta</div></div>
      <div class="muted" id="syncStatus">Conectando...</div>
    </header>

    <div class="time-meter" id="timeMeter">
      <button class="btn" id="btnPrevMonth">◀</button>
      <div style="min-width:140px;text-align:center"><div class="muted">Mes</div><div id="tmCurrent" style="font-weight:700">--</div></div>
      <button class="btn primary" id="btnNextMonth">▶</button>
      <button class="btn" id="btnUndo">↶</button>
    </div>

    <div class="grid" style="margin-top:14px">
      <aside class="card menu">
        <button id="mDashboard" class="active">Dashboard</button>
        <button id="mBanks">Bancos</button>
        <button id="mCategories">Categorías</button>
        <button id="mDiary">Registro Diario</button>
        <button id="mAssets">Activos</button>
        <button id="mLiabs">Pasivos</button>
        <button id="mIncomes">Ingresos</button>
      </aside>

      <main>
        <!-- (Todas las secciones están incluidas igual que en tu versión anterior) -->
        <!-- Dashboard -->
        <section id="sDashboard" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0">Dashboard</h3><div class="muted">Resumen rápido</div></div>
            <div class="row"><div class="muted">Mes: <span id="currentMonth"></span></div><button class="btn primary" id="btnAdvance">Avanzar mes</button></div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px">
            <div class="card"><div class="muted">Balance</div><div id="kBalance" style="font-weight:700">S/ 0</div></div>
            <div class="card"><div class="muted">Ahorros</div><div id="kSavings" style="font-weight:700">S/ 0</div></div>
            <div class="card"><div class="muted">Ingreso pasivo</div><div id="kPassive" style="font-weight:700">S/ 0</div></div>
            <div class="card"><div class="muted">Gastos fijos</div><div id="kFixed" style="font-weight:700">S/ 0</div></div>
          </div>
        </section>

        <!-- Banks -->
        <section id="sBanks" class="card" style="display:none">
          <h3>Bancos</h3>
          <div class="muted">Agregar cuentas bancarias</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Nombre</label><input id="bankName">
              <label>Saldo inicial</label><input id="bankInit" type="number">
              <label>Tipo</label><select id="bankType"><option value="ahorro">Ahorro</option><option value="corriente">Corriente</option></select>
              <div style="margin-top:8px"><button class="btn primary" id="btnAddBank">Agregar banco</button></div>
            </div>
            <div style="flex:1;overflow:auto;height:220px">
              <table id="tblBanks"><thead><tr><th>Banco</th><th>Saldo</th><th>Tipo</th><th></th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </section>

        <!-- Categories -->
        <section id="sCategories" class="card" style="display:none">
          <h3>Categorías</h3>
          <div class="muted">Definir presupuesto por categoría</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Nombre categoría</label><input id="catName">
              <label>Presupuesto mensual</label><input id="catBudget" type="number">
              <div style="margin-top:8px"><button class="btn primary" id="btnAddCat">Agregar categoría</button></div>
            </div>
            <div style="flex:1;overflow:auto;height:220px" id="catList"></div>
          </div>
        </section>

        <!-- Diary -->
        <section id="sDiary" class="card" style="display:none">
          <h3>Registro diario</h3>
          <div class="muted">Registrar gasto por categoría (afecta saldo banco si se asigna)</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Fecha</label><input id="dDate" type="date">
              <label>Categoría</label><select id="dCategory"></select>
              <label>Monto</label><input id="dAmount" type="number">
              <label>Banco (opcional)</label><select id="dBank"></select>
              <div style="margin-top:8px"><button class="btn primary" id="btnAddDiary">Registrar gasto</button></div>
            </div>
            <div style="flex:1;overflow:auto;height:220px"><table id="tblDiary"><thead><tr><th>Fecha</th><th>Cat</th><th>Monto</th><th>Banco</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </section>

        <!-- Assets -->
        <section id="sAssets" class="card" style="display:none">
          <h3>Activos</h3>
          <div class="muted">Ingreso pasivo por activos</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Nombre</label><input id="aName">
              <label>Ingreso mensual</label><input id="aIncome" type="number">
              <div style="margin-top:8px"><button class="btn primary" id="btnAddAsset">Agregar</button></div>
            </div>
            <div style="flex:1;overflow:auto;height:160px"><table id="tblAssets"><thead><tr><th>Activo</th><th>Ingreso/m</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </section>

        <!-- Liabs -->
        <section id="sLiabs" class="card" style="display:none">
          <h3>Pasivos</h3>
          <div class="muted">Registrar deudas y vincular banco</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Concepto</label><input id="lName">
              <label>Cuota mensual</label><input id="lMonthly" type="number">
              <label>Banco</label><select id="lBank"></select>
              <div style="margin-top:8px"><button class="btn primary" id="btnAddLiab">Agregar pasivo</button></div>
            </div>
            <div style="flex:1;overflow:auto;height:160px"><table id="tblLiabs"><thead><tr><th>Pasivo</th><th>Cuota/m</th><th>Banco</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </section>

        <!-- Incomes -->
        <section id="sIncomes" class="card" style="display:none">
          <h3>Ingresos</h3>
          <div class="muted">Registrar ingresos y asignar banco</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Concepto</label><input id="iName">
              <label>Monto</label><input id="iAmount" type="number">
              <label>Frecuencia</label><select id="iFreq"><option value="mensual">Mensual</option><option value="unica">Única</option></select>
              <label>Banco</label><select id="iBank"></select>
              <div style="margin-top:8px"><button class="btn primary" id="btnAddIncome">Agregar ingreso</button></div>
            </div>
            <div style="flex:1;overflow:auto;height:160px"><table id="tblIncomes"><thead><tr><th>Ingreso</th><th>Monto</th><th>Freq</th><th>Banco</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <div id="notifications"></div>

<!-- Firebase SDK modular (v9+) -->
<script type="module">
  // -------------------- CONFIG (TU CONFIG) --------------------
  const firebaseConfig = {
    apiKey: "AIzaSyBVppNAicRPFXEUdErmHd24se_9bjXiqcM",
    authDomain: "jhona-1b398.firebaseapp.com",
    databaseURL: "https://jhona-1b398-default-rtdb.firebaseio.com",
    projectId: "jhona-1b398",
    storageBucket: "jhona-1b398.appspot.com",
    messagingSenderId: "981136306223",
    appId: "1:981136306223:web:52a7b67c22c274efcc56da",
    measurementId: "G-NVGKL0XGER"
  };
  // -------------------------------------------------------------------

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
  import { getDatabase, ref, set, onValue, off, get } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

  // Inicializa Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Ruta compartida: cambia 'miCuenta' por el id que quieras compartir
  const SHARED_ID = 'miCuenta';
  const SHARED_PATH = `shared/${SHARED_ID}`;

  // Clave localStorage
  const KEY = 'ce_fix_shared_rtdb';

  // Estado inicial
  let state = {
    currentDate: new Date().toISOString().slice(0,10),
    balance:0,
    banks:[],
    categories:[{id:'cat_food',name:'Alimentos',budget:300}],
    diary:[],
    assets:[],
    liabs:[],
    incomes:[],
    history:[]
  };

  let userUid = null;
  let remoteRef = null;
  let remoteListener = null;
  let syncing = false;

  // util
  function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
  function notify(txt){ const n=document.createElement('div'); n.className='notif'; n.innerText=txt; document.getElementById('notifications').prepend(n); setTimeout(()=>n.remove(),5000); }
  function formatCurrency(v){ return 'S/ '+Number(v||0).toLocaleString(); }
  function formatMonth(iso){ const d=new Date(iso); return d.toLocaleString('es-PE',{month:'long',year:'numeric'}); }
  function pushHistory(){ state.history = state.history || []; state.history.push(JSON.stringify(state)); if(state.history.length>48) state.history.shift(); localSave(); }

  // localStorage
  function localLoad(){ const raw = localStorage.getItem(KEY); if(raw) { try{ state = JSON.parse(raw); }catch(e){ console.warn('local parse error', e); } } renderAll(); }
  function localSave(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // Escrita a Realtime DB (sobrescribe el objeto state completo en /shared/miCuenta)
  async function writeRemote(){
    if(!remoteRef) return;
    try{
      // mantén el campo owner si ya existe; el servidor validará permisos por reglas
      // Escribimos: { owner, state, updatedAt }
      // Note: set() reemplaza todo el objeto en remoteRef, por eso primero leemos owner si existe
      const snap = await get(remoteRef);
      const owner = snap && snap.exists() && snap.val().owner ? snap.val().owner : userUid;
      await set(remoteRef, { owner: owner, state: state, updatedAt: new Date().toISOString() });
      document.getElementById('syncStatus').innerText = 'Sincronizado';
      syncing = true;
    }catch(e){
      console.error('writeRemote error', e);
      document.getElementById('syncStatus').innerText = 'Error sync';
      notify('Error al sincronizar con la nube');
    }
  }

  // Escuchar cambios remotos y reemplazar local (remoto gana)
  function listenRemote(){
    if(!remoteRef) return;
    if(remoteListener) off(remoteRef, 'value', remoteListener);
    remoteListener = onValue(remoteRef, (snapshot) => {
      const val = snapshot.val();
      if(!val || !val.state) return;
      const remoteState = val.state;
      const localJson = JSON.stringify(state);
      const remoteJson = JSON.stringify(remoteState);
      if(localJson !== remoteJson){
        state = remoteState;
        localSave();
        renderAll();
        notify('Datos actualizados desde la nube');
      }
      // muestra owner info en status
      const owner = val.owner || '(sin owner)';
      document.getElementById('syncStatus').innerText = `Sincronizado • owner: ${owner}`;
      syncing = true;
    }, (err)=>{
      console.error('listenRemote error', err);
      document.getElementById('syncStatus').innerText = 'Desconectado';
      syncing = false;
    });
  }

  // Inicializar auth anonymous y ref compartido
  async function initAuthAndDB(){
    document.getElementById('syncStatus').innerText = 'Autenticando...';
    try{
      await signInAnonymously(auth);
    }catch(e){
      console.error('signInAnonymously error', e);
      document.getElementById('syncStatus').innerText = 'Auth error';
      notify('Error autenticando en Firebase');
    }
    onAuthStateChanged(auth, async (user) => {
      if(user){
        userUid = user.uid;
        remoteRef = ref(db, SHARED_PATH);
        // lee una vez: si no existe, crea y se asigna como owner
        try{
          const snap = await get(remoteRef);
          if(!snap.exists()){
            // primer creador -> establece owner = userUid y sube el estado local
            await set(remoteRef, { owner: userUid, state: state, updatedAt: new Date().toISOString() });
            notify('Nodo compartido creado. Eres el owner.');
          } else {
            const val = snap.val();
            if(val.owner && val.owner !== userUid){
              notify(`Conectado al nodo compartido. Owner actual: ${val.owner}`);
            } else if(val.owner === userUid){
              notify('Conectado como owner del nodo compartido.');
            }
            // si hay estado remoto, lo usaremos (listenRemote lo aplicará)
          }
        }catch(e){
          console.error('init read error', e);
        }
        listenRemote();
        document.getElementById('syncStatus').innerText = 'Conectado';
      } else {
        document.getElementById('syncStatus').innerText = 'No autenticado';
      }
    });
  }

  /* ---------- Renderers y lógica (idéntico a tu versión con saves remotas) ---------- */

  function renderAll(){
    document.getElementById('currentMonth').innerText = formatMonth(state.currentDate);
    document.getElementById('tmCurrent').innerText = formatMonth(state.currentDate);
    document.getElementById('kBalance').innerText = formatCurrency(state.balance);
    document.getElementById('kSavings').innerText = formatCurrency(state.banks.reduce((s,b)=>s + Number(b.balance||0),0));
    document.getElementById('kPassive').innerText = formatCurrency(state.assets.reduce((s,a)=>s + Number(a.income||0),0));
    document.getElementById('kFixed').innerText = formatCurrency(state.liabs.reduce((s,l)=>s + Number(l.monthly||0),0) + state.expensesSum || 0);

    const tb = document.querySelector('#tblBanks tbody'); tb.innerHTML='';
    const bankSelects = ['dBank','iBank','lBank'];
    state.banks.forEach(b=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${b.name}</td><td>${Number(b.balance).toLocaleString()}</td><td>${b.type}</td><td><button class="btn" data-id="${b.id}">Eliminar</button></td>`;
      tb.appendChild(tr);
    });
    document.querySelectorAll('#tblBanks button[data-id]').forEach(btn=>{
      btn.onclick = async ()=>{ const id=btn.dataset.id; state.banks = state.banks.filter(x=>x.id!==id); await localSaveAndSync(); notify('Banco eliminado'); }
    });

    bankSelects.forEach(selId=>{
      const sel = document.getElementById(selId); if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = '<option value="">-- Ninguno --</option>';
      state.banks.forEach(b=>{ const o=document.createElement('option'); o.value=b.id; o.textContent = `${b.name} (S/ ${Number(b.balance||0).toLocaleString()})`; sel.appendChild(o); });
      sel.value = prev || '';
    });

    const catList = document.getElementById('catList'); catList.innerHTML='';
    state.categories.forEach(c=>{
      const div = document.createElement('div');
      const spent = state.diary.filter(d=>{
        const dd = new Date(d.date); const cur = new Date(state.currentDate);
        return dd.getFullYear()===cur.getFullYear() && dd.getMonth()===cur.getMonth() && d.category===c.id;
      }).reduce((s,i)=>s+i.amount,0);
      div.innerHTML = `<strong>${c.name}</strong> • Presupuesto S/ ${Number(c.budget).toLocaleString()} • Gastado S/ ${Number(spent).toLocaleString()}`;
      catList.appendChild(div);
    });
    const dCat = document.getElementById('dCategory'); dCat.innerHTML=''; state.categories.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; dCat.appendChild(o); });

    const tD = document.querySelector('#tblDiary tbody'); tD.innerHTML='';
    state.diary.slice().reverse().forEach(entry=>{
      const b = state.banks.find(x=>x.id===entry.bankId); const bn = b?b.name:'';
      const c = state.categories.find(x=>x.id===entry.category); const cn = c?c.name:'';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${entry.date}</td><td>${cn}</td><td>${Number(entry.amount).toLocaleString()}</td><td>${bn}</td><td><button class="btn" data-id="${entry.id}">Eliminar</button></td>`;
      tD.appendChild(tr);
    });
    document.querySelectorAll('#tblDiary button[data-id]').forEach(btn=>{ btn.onclick = async ()=>{ const id=btn.dataset.id; const e = state.diary.find(x=>x.id===id); if(e){ state.balance += Number(e.amount); if(e.bankId){ const b = state.banks.find(x=>x.id===e.bankId); if(b) b.balance = Number(b.balance) + Number(e.amount); } } state.diary = state.diary.filter(x=>x.id!==id); await localSaveAndSync(); notify('Registro diario eliminado'); } });

    const tA = document.querySelector('#tblAssets tbody'); tA.innerHTML='';
    state.assets.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.name}</td><td>${Number(a.income).toLocaleString()}</td><td><button class="btn" data-id="${a.id}">Eliminar</button></td>`; tA.appendChild(tr); });
    document.querySelectorAll('#tblAssets button[data-id]').forEach(b=>{ b.onclick=async ()=>{ state.assets = state.assets.filter(x=>x.id!==b.dataset.id); await localSaveAndSync(); notify('Activo eliminado'); } });

    const tL = document.querySelector('#tblLiabs tbody'); tL.innerHTML='';
    state.liabs.forEach(l=>{ const b = state.banks.find(x=>x.id===l.bankId); const bn = b?b.name:''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.name}</td><td>${Number(l.monthly).toLocaleString()}</td><td>${bn}</td><td><button class="btn" data-id="${l.id}">Eliminar</button></td>`; tL.appendChild(tr); });
    document.querySelectorAll('#tblLiabs button[data-id]').forEach(b=>{ b.onclick=async ()=>{ state.liabs = state.liabs.filter(x=>x.id!==b.dataset.id); await localSaveAndSync(); notify('Pasivo eliminado'); } });

    const tI = document.querySelector('#tblIncomes tbody'); tI.innerHTML='';
    state.incomes.forEach(i=>{ const b = state.banks.find(x=>x.id===i.bankId); const bn = b?b.name:''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${i.name}</td><td>${Number(i.amount).toLocaleString()}</td><td>${i.freq}</td><td>${bn}</td><td><button class="btn" data-id="${i.id}">Eliminar</button></td>`; tI.appendChild(tr); });
    document.querySelectorAll('#tblIncomes button[data-id]').forEach(b=>{ b.onclick=async ()=>{ state.incomes = state.incomes.filter(x=>x.id!==b.dataset.id); await localSaveAndSync(); notify('Ingreso eliminado'); } });
  }

  async function localSaveAndSync(){
    localSave();
    if(remoteRef) await writeRemote();
    renderAll();
  }

  // Wiring events and actions
  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('mDashboard').onclick = ()=> showSection('sDashboard');
    document.getElementById('mBanks').onclick = ()=> showSection('sBanks');
    document.getElementById('mCategories').onclick = ()=> showSection('sCategories');
    document.getElementById('mDiary').onclick = ()=> showSection('sDiary');
    document.getElementById('mAssets').onclick = ()=> showSection('sAssets');
    document.getElementById('mLiabs').onclick = ()=> showSection('sLiabs');
    document.getElementById('mIncomes').onclick = ()=> showSection('sIncomes');

    document.getElementById('btnAddBank').onclick = async ()=>{
      const n = document.getElementById('bankName').value.trim(); const b = Number(document.getElementById('bankInit').value)||0; const t = document.getElementById('bankType').value;
      if(!n) return alert('Nombre requerido');
      state.banks.push({id:uid('b'),name:n,balance:b,type:t});
      document.getElementById('bankName').value=''; document.getElementById('bankInit').value='';
      await localSaveAndSync(); notify('Banco agregado');
    };

    document.getElementById('btnAddCat').onclick = async ()=>{
      const n = document.getElementById('catName').value.trim(); const b = Number(document.getElementById('catBudget').value)||0;
      if(!n) return alert('Nombre requerido');
      state.categories.push({id:uid('cat'),name:n,budget:b});
      document.getElementById('catName').value=''; document.getElementById('catBudget').value='';
      await localSaveAndSync(); notify('Categoría agregada');
    };

    document.getElementById('btnAddDiary').onclick = async ()=>{
      const date = document.getElementById('dDate').value || new Date().toISOString().slice(0,10);
      const cat = document.getElementById('dCategory').value;
      const amt = Number(document.getElementById('dAmount').value)||0;
      const bankId = document.getElementById('dBank').value || null;
      if(!cat) return alert('Selecciona categoría');
      if(amt<=0) return alert('Monto mayor que 0');
      const catObj = state.categories.find(c=>c.id===cat);
      const spent = state.diary.filter(d=>{
        const dd = new Date(d.date); const cur = new Date(state.currentDate);
        return dd.getFullYear()===cur.getFullYear() && dd.getMonth()===cur.getMonth() && d.category===cat;
      }).reduce((s,i)=>s+i.amount,0);
      if(catObj && (spent + amt) > catObj.budget){
        if(!confirm(`Este gasto excede presupuesto de ${catObj.name} por S/ ${(spent+amt - catObj.budget).toFixed(2)}. Registrar igual?`)) return;
      }
      state.diary.push({id:uid('d'),date,category:cat,amount:amt,bankId,notes:''});
      state.balance -= amt;
      if(bankId){
        const b = state.banks.find(x=>x.id===bankId); if(b) b.balance = Number(b.balance) - amt;
      }
      document.getElementById('dAmount').value=''; await localSaveAndSync(); notify('Gasto registrado');
    };

    document.getElementById('btnAddAsset').onclick = async ()=>{
      const n=document.getElementById('aName').value.trim(); const inc=Number(document.getElementById('aIncome').value)||0;
      if(!n) return alert('Nombre requerido');
      state.assets.push({id:uid('a'),name:n,income:inc}); document.getElementById('aName').value=''; document.getElementById('aIncome').value=''; await localSaveAndSync(); notify('Activo agregado');
    };

    document.getElementById('btnAddLiab').onclick = async ()=>{
      const n=document.getElementById('lName').value.trim(); const mon=Number(document.getElementById('lMonthly').value)||0; const bankId=document.getElementById('lBank').value || null;
      if(!n) return alert('Nombre requerido');
      state.liabs.push({id:uid('l'),name:n,monthly:mon,bankId}); document.getElementById('lName').value=''; document.getElementById('lMonthly').value=''; await localSaveAndSync(); notify('Pasivo agregado');
    };

    document.getElementById('btnAddIncome').onclick = async ()=>{
      const n=document.getElementById('iName').value.trim(); const amt=Number(document.getElementById('iAmount').value)||0; const freq=document.getElementById('iFreq').value; const bankId=document.getElementById('iBank').value||null;
      if(!n) return alert('Nombre requerido');
      state.incomes.push({id:uid('in'),name:n,amount:amt,freq,bankId});
      if(bankId){ const b = state.banks.find(x=>x.id===bankId); if(b) b.balance = Number(b.balance) + amt; } else state.balance += amt;
      document.getElementById('iName').value=''; document.getElementById('iAmount').value=''; await localSaveAndSync(); notify('Ingreso agregado');
    };

    document.getElementById('btnNextMonth').onclick = ()=>{ pushHistory(); advanceMonth(); localSaveAndSync(); };
    document.getElementById('btnPrevMonth').onclick = ()=>{ if(confirm('Deshacer último avance?')) undoHistory(); };
    document.getElementById('btnUndo').onclick = ()=>{ if(confirm('Deshacer último avance?')) undoHistory(); };
    document.getElementById('btnAdvance').onclick = ()=>{ pushHistory(); advanceMonth(); localSaveAndSync(); };

    // carga local inicialmente
    localLoad();
    // inicia auth + DB listener
    initAuthAndDB();
  });

  // monthly processing
  function advanceMonth(){
    const cur = new Date(state.currentDate); const next = new Date(cur.getFullYear(), cur.getMonth()+1, 1); state.currentDate = next.toISOString().slice(0,10);
    const incomeMonthly = state.incomes.reduce((s,i)=> s + ((i.freq==='mensual')?Number(i.amount||0):0),0);
    const passive = state.assets.reduce((s,a)=> s + Number(a.income||0),0);
    const total = incomeMonthly + passive;
    state.balance += total;
    state.liabs.forEach(l=>{
      state.balance -= Number(l.monthly||0);
      if(l.bankId){ const b = state.banks.find(x=>x.id===l.bankId); if(b) b.balance = Number(b.balance) - Number(l.monthly||0); }
    });
    notify(`Mes avanzado: ingresos S/ ${total.toFixed(2)} aplicado`);
  }

  // undo
  function undoHistory(){ if(!state.history || state.history.length===0){ notify('No hay historial'); return } const snap = state.history.pop(); state = JSON.parse(snap); localSave(); renderAll(); notify('Deshecho'); }

  Object.defineProperty(state, 'expensesSum', { get: function(){ return state.liabs.reduce((s,l)=>s+Number(l.monthly||0),0); }, configurable:true });

  // function showSection (helper)
  function showSection(id){
    ['sDashboard','sBanks','sCategories','sDiary','sAssets','sLiabs','sIncomes'].forEach(s=>document.getElementById(s).style.display = (s===id? 'block':'none'));
    document.querySelectorAll('.menu button').forEach(btn=>btn.classList.remove('active'));
    const map = { sDashboard:'mDashboard', sBanks:'mBanks', sCategories:'mCategories', sDiary:'mDiary', sAssets:'mAssets', sLiabs:'mLiabs', sIncomes:'mIncomes' };
    const btnId = map[id];
    if(btnId) document.getElementById(btnId).classList.add('active');
  }

</script>
</body>
</html>
