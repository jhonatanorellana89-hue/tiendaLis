<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Prueba botones — Sync RTDB</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:0;color:#111}
  .wrap{max-width:980px;margin:18px auto;padding:14px}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 8px 20px rgba(12,16,35,0.06)}
  label{display:block;margin-top:8px;color:#555}
  input,select{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px}
  .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:#0f766e;color:#fff;margin-top:8px}
  .btn.secondary{background:#6b7280}
  #log{height:160px;overflow:auto;background:#0b1220;color:#fff;padding:8px;border-radius:6px;margin-top:12px;font-size:13px}
  .row{display:flex;gap:12px}
  .col{flex:1}
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <h2>Prueba funcional — botones y sincronización</h2>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="userInfo">No autenticado</strong><br><small style="color:#666">Prueba simple</small>
        </div>
        <div>
          <button id="btnLogin" class="btn">Ingresar Google</button>
          <button id="btnLogout" class="btn secondary" style="display:none">Salir</button>
        </div>
      </div>

      <hr style="margin:12px 0">

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="card">
          <h4>Bancos</h4>
          <label>Nombre banco</label><input id="bankName" placeholder="Ej. BCP">
          <label>Saldo inicial</label><input id="bankBalance" type="number" value="0">
          <button onclick="testAddBank()" class="btn">Guardar banco</button>
        </div>

        <div class="card">
          <h4>Deudas</h4>
          <label>Acreedor</label><input id="debtCred" placeholder="Ej. Banco X">
          <label>Total S/</label><input id="debtTotal" type="number" value="0">
          <label>Meses</label><input id="debtMonths" type="number" value="12">
          <button onclick="testAddDebt()" class="btn">Guardar deuda</button>
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1" class="card">
          <h4>Gastos</h4>
          <label>Descripción</label><input id="expDesc" placeholder="Desayuno">
          <label>Monto</label><input id="expAmount" type="number" value="0">
          <button onclick="testAddExpense()" class="btn">Registrar gasto</button>
        </div>
        <div style="width:220px" class="card">
          <h4>Controles</h4>
          <button onclick="viewLocal()" class="btn secondary">Ver estado local</button>
          <button onclick="flushQueue()" class="btn secondary">Forzar sincronización</button>
        </div>
      </div>

      <div id="log" aria-live="polite"></div>
    </div>
  </div>

<script>
/* ============ CONFIG FIREBASE ============
 Replace databaseURL if your Realtime DB URL is different.
 You must create a Realtime Database in Firebase console.
=========================================== */
const firebaseConfig = {
  apiKey: "AIzaSyBVppNAicRPFXEUdErmHd24se_9bjXiqcM",
  authDomain: "jhona-1b398.firebaseapp.com",
  databaseURL: "https://jhona-1b398-default-rtdb.firebaseio.com",
  projectId: "jhona-1b398",
  storageBucket: "jhona-1b398.firebasestorage.app",
  messagingSenderId: "981136306223",
  appId: "1:981136306223:web:52a7b67c22c274efcc56da",
  measurementId: "G-NVGKL0XGER"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const rdb = firebase.database();

const LOCAL_KEY = 'test_buttons_state_v1';
const QUEUE_KEY = 'test_buttons_queue_v1';

let STATE = { banks: [], debts: [], expenses: [] };
let UID = null;

/* ========== Logging helper ========== */
function log(msg){
  const el = document.getElementById('log');
  const t = new Date().toLocaleTimeString();
  el.innerHTML = `[${t}] ${msg}<br>` + el.innerHTML;
  console.log(msg);
}

/* ========== Global error capture ========== */
window.onerror = function(msg, src, line, col, err){
  log('ERROR: ' + msg + (err && err.stack ? ' — ' + err.stack : ''));
};

/* ========== Local save/load ========== */
function saveLocalState(){
  localStorage.setItem(LOCAL_KEY, JSON.stringify(STATE));
  log('Estado guardado localmente');
}
function loadLocalState(){
  const raw = localStorage.getItem(LOCAL_KEY);
  if(raw) STATE = JSON.parse(raw);
  log('Estado cargado desde local');
}

/* ========== Queue operations ========== */
function enqueue(op){
  const raw = localStorage.getItem(QUEUE_KEY);
  const arr = raw ? JSON.parse(raw) : [];
  arr.push(op);
  localStorage.setItem(QUEUE_KEY, JSON.stringify(arr));
  log('Operación encolada: ' + op.type);
}
async function flushQueue(){
  const raw = localStorage.getItem(QUEUE_KEY);
  if(!raw){ log('Cola vacía'); return; }
  const arr = JSON.parse(raw);
  if(!arr.length){ localStorage.removeItem(QUEUE_KEY); log('Cola vacía'); return; }
  if(!UID){ log('No autenticado: no puedo vaciar cola'); return; }
  for(const op of arr){
    try{
      if(op.type === 'push'){
        await rdb.ref(`users/${UID}/${op.path}`).push(Object.assign({}, op.payload, { createdAt: Date.now() }));
        log('Op enviada a cloud: ' + op.path);
      } else if(op.type === 'state'){
        await rdb.ref(`users/${UID}/state/current`).set({ state: op.payload, updatedAt: Date.now() });
        log('Estado enviado a cloud');
      }
    } catch(e){
      log('Error enviando op: ' + e.message);
      return;
    }
  }
  localStorage.removeItem(QUEUE_KEY);
  log('Cola sincronizada correctamente');
}

/* ========== Test actions called by buttons (guaranteed global) ========== */
function testAddBank(){
  try{
    const name = document.getElementById('bankName').value.trim() || 'Banco prueba';
    const balance = Number(document.getElementById('bankBalance').value||0);
    const item = { id: 'b_' + Math.random().toString(36).slice(2,8), name, balance };
    STATE.banks.push(item);
    saveLocalState();
    // try cloud push
    if(UID){
      rdb.ref(`users/${UID}/banks`).push(Object.assign({}, item, { createdAt: Date.now() }))
        .then(ref => { log('Banco enviado a RTDB id=' + ref.key); })
        .catch(e => { log('Error push banco: ' + e.message); enqueue({ type:'push', path:'banks', payload: item }); });
    } else {
      enqueue({ type:'push', path:'banks', payload: item });
      log('No auth — banco encolado');
    }
  }catch(e){ log('testAddBank error: ' + e.message); }
}

function testAddDebt(){
  try{
    const creditor = document.getElementById('debtCred').value.trim() || 'Acreedor prueba';
    const total = Number(document.getElementById('debtTotal').value||0);
    const months = Number(document.getElementById('debtMonths').value||1);
    const monthly = +(total / months).toFixed(2);
    const item = { id: 'd_' + Math.random().toString(36).slice(2,8), creditor, total, months, monthly, remaining: total };
    STATE.debts.push(item);
    saveLocalState();
    if(UID){
      rdb.ref(`users/${UID}/debts`).push(Object.assign({}, item, { createdAt: Date.now() }))
        .then(ref => log('Deuda enviada a RTDB id=' + ref.key))
        .catch(e => { log('Error push deuda: ' + e.message); enqueue({ type:'push', path:'debts', payload: item }); });
    } else { enqueue({ type:'push', path:'debts', payload: item }); log('No auth — deuda encolada'); }
  }catch(e){ log('testAddDebt error: ' + e.message); }
}

function testAddExpense(){
  try{
    const desc = document.getElementById('expDesc').value.trim() || 'Gasto prueba';
    const amount = Number(document.getElementById('expAmount').value||0);
    const item = { id: 'e_' + Math.random().toString(36).slice(2,8), date: new Date().toISOString().slice(0,10), desc, amount };
    STATE.expenses.push(item);
    saveLocalState();
    if(UID){
      rdb.ref(`users/${UID}/expenses`).push(Object.assign({}, item, { createdAt: Date.now() }))
        .then(ref => log('Gasto enviado a RTDB id=' + ref.key))
        .catch(e => { log('Error push gasto: ' + e.message); enqueue({ type:'push', path:'expenses', payload: item }); });
    } else { enqueue({ type:'push', path:'expenses', payload: item }); log('No auth — gasto encolado'); }
  }catch(e){ log('testAddExpense error: ' + e.message); }
}

/* ========== View local state (debug) ========== */
function viewLocal(){
  alert('Estado local (console)\n\n' + JSON.stringify(STATE, null, 2));
  console.log('Estado local:', STATE);
  log('Estado local mostrado en consola');
}

/* ========== Auth wiring (login/logout) ========== */
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    await auth.signInWithPopup(provider);
  }catch(e){
    log('Login popup error: ' + e.message);
    try{ await auth.signInWithRedirect(provider); } catch(err){ log('Redirect also failed: ' + (err.message||err)); }
  }
});
document.getElementById('btnLogout').addEventListener('click', ()=> auth.signOut());

auth.onAuthStateChanged(user => {
  if(user){
    UID = user.uid;
    document.getElementById('userInfo').innerText = (user.displayName || user.email) + ' (' + UID.slice(0,6) + ')';
    document.getElementById('btnLogin').style.display='none';
    document.getElementById('btnLogout').style.display='inline-block';
    log('Usuario autenticado: ' + (user.email || UID));
    // try flush queue
    flushQueue();
    // create a listener so remote changes update local
    rdb.ref(`users/${UID}/state/current`).on('value', snap => {
      if(!snap.exists()) return;
      log('Estado remoto detectado (no lo sobrescribimos automáticamente en esta prueba)');
    });
  } else {
    UID = null;
    document.getElementById('userInfo').innerText = 'No autenticado';
    document.getElementById('btnLogin').style.display='inline-block';
    document.getElementById('btnLogout').style.display='none';
    log('Sesión cerrada');
  }
});

/* ========== Init: load local state ======== */
loadLocalState();
log('Prueba iniciada: prueba botones y revisa LOG/Console.');
</script>
</body>
</html>



