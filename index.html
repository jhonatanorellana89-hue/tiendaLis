<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>JHONATAN ORELLANA — Finanzas PRO (UI Mejorada)</title>

<!-- Fuente -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<!-- Librerías CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
  /* =========================
     Estilos modernos y responsivos
     - Mejor movilidad: transiciones, sidebar colapsable, FAB, modales deslizantes
     - Diseño pensado para escritorio + móvil
     ========================= */
  :root{
    --bg-900:#031218; --bg-800:#042025; --panel:#062b2c; --card:#053033; --muted:#9fb1bd;
    --accent:#10b981; --accent-2:#06b6d4; --danger:#ff6b6b; --glass: rgba(255,255,255,0.03);
    --max-w:1200px;
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-900),#021216);color:#eafaf5;overflow:hidden}
  img{max-width:100%;height:auto}
  /* App container */
  .app-wrap{height:100vh;display:flex;align-items:center;justify-content:center;padding:12px}
  .app{width:calc(100% - 24px);max-width:var(--max-w);height:calc(100vh - 24px);display:grid;grid-template-columns:280px 1fr;gap:16px;border-radius:14px;padding:14px;background:linear-gradient(180deg,#042b2f,#021617);box-shadow:0 18px 60px rgba(0,0,0,0.6);overflow:hidden;transition:all .28s ease}
  /* Collapsed */
  .app.collapsed{grid-template-columns:88px 1fr}
  /* Sidebar */
  .sidebar{background:linear-gradient(180deg,#032b2f,#021617);padding:14px;border-radius:12px;display:flex;flex-direction:column;gap:12px;transition:width .25s ease;min-height:0;overflow:auto}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001;padding:6px;font-size:20px;box-shadow:0 6px 18px rgba(6,182,212,0.08)}
  .title{font-weight:800;font-size:15px}
  nav.side{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  nav.side button{background:transparent;border:0;color:var(--muted);text-align:left;padding:10px;border-radius:10px;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:10px;transition:all .18s ease}
  nav.side button svg{opacity:.9}
  nav.side button:hover{transform:translateX(6px);color:#fff}
  nav.side button.active{color:var(--accent);background:linear-gradient(90deg, rgba(16,185,129,0.06), rgba(6,182,212,0.02))}
  .sidebar .meta{margin-top:auto;display:flex;flex-direction:column;gap:8px}
  .small{font-size:12px;color:var(--muted)}
  /* Main area */
  .main{display:flex;flex-direction:column;gap:12px;height:100%;overflow:hidden}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;font-size:13px;transition:transform .12s ease, box-shadow .12s ease}
  .btn:active{transform:scale(.99)}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#002b2b;box-shadow:0 8px 22px rgba(16,185,129,0.08)}
  .btn.ghost{background:transparent;border:1px solid var(--glass);color:var(--muted)}
  .btn.warn{background:linear-gradient(90deg,#f97316,#f59e0b);color:#071421}
  .card{background:linear-gradient(180deg,var(--card),#082f31);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);height:100%;overflow:auto;box-shadow:0 6px 18px rgba(3,9,12,0.6)}
  .mini-card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;color:#eafaf5}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  td.right{text-align:right}
  /* Floating Action Button (FAB) */
  .fab{position:fixed;right:20px;bottom:24px;width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#002b2b;box-shadow:0 18px 48px rgba(6,182,212,0.12);cursor:pointer;z-index:1200;border:none}
  .fab small{display:block;font-size:11px;color:#003;padding-top:4px}
  /* Modal (slide in) */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:flex-end;justify-content:center;z-index:9999;padding:16px}
  .panel{width:860px;max-width:100%;background:#021a1b;border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);transform:translateY(20px);opacity:0;transition:all .24s cubic-bezier(.2,.9,.22,1)}
  .overlay.show{display:flex}
  .overlay.show .panel{transform:translateY(0);opacity:1}
  /* Bottom nav for mobile */
  .bottom-nav{display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:linear-gradient(180deg,#021617,#031a1a);padding:6px;border-radius:999px;gap:8px;box-shadow:0 10px 40px rgba(0,0,0,0.5);z-index:1100}
  .bottom-nav button{background:transparent;border:0;color:var(--muted);padding:10px;border-radius:10px}
  /* Login screen */
  .login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.85));z-index:10000}
  .login-card{width:420px;padding:22px;border-radius:12px;background:linear-gradient(180deg,#042b2f,#021617);border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.7)}
  .login-card h2{font-size:20px;margin:0 0 6px 0}
  .login-note{font-size:13px;color:var(--muted);margin-bottom:12px}
  .flex-col{display:flex;flex-direction:column;gap:10px}
  input,select,textarea{background:#062a2c;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:#eafaf5;font-size:14px;outline:none;transition:box-shadow .12s ease, transform .08s}
  input:focus, select:focus, textarea:focus{box-shadow:0 6px 20px rgba(6,182,212,0.08);transform:translateY(-2px)}
  /* Responsive */
  @media (max-width:1100px){ .app{grid-template-columns:220px 1fr} .logo{width:48px;height:48px} .app.collapsed{grid-template-columns:72px 1fr} }
  @media (max-width:800px){
    .app{grid-template-columns:1fr;height:100vh;padding:10px;border-radius:0}
    .sidebar{display:flex;flex-direction:row;gap:8px;padding:10px;height:82px;border-radius:10px;align-items:center;overflow:auto}
    .main{height:calc(100vh - 100px);overflow:auto}
    .bottom-nav{display:flex}
    .fab{display:none}
    .overlay{align-items:center}
  }
  /* Micro interactions */
  .card:hover{transform:translateY(-4px);transition:transform .18s}
  .muted{color:var(--muted)}
  /* Tiny utility */
  .hide{display:none}
</style>
</head>
<body>
  <!--
    Archivo único index.html
    --- Mejoras principales solicitadas:
    * Cloud automático: la app intenta conectar y mantener un listener en tiempo real.
    * Inicio de sesión obligatorio (local) antes de cargar la app.
    * Diseño más móvil/fluido: transiciones, sidebar colapsable, FAB, bottom nav.
    * Activos registran ganancias y guardan registros vinculados a transacciones.
    * Todas las ventanas y botones mantienen su funcionalidad.
    * Reglas sugeridas de Firestore incluidas al final en comentarios.
  -->

  <!-- Pantalla de login obligatorio -->
  <div id="loginScreen" class="login-screen" aria-hidden="false">
    <div class="login-card" role="dialog" aria-modal="true">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001">JO</div>
        <div>
          <h2>JHONATAN ORELLANA</h2>
          <div class="login-note">Acceso obligatorio. Usuario y contraseña locales para abrir la app.</div>
        </div>
      </div>

      <div class="flex-col">
        <label class="small muted">Usuario</label>
        <input id="loginUser" autocomplete="off" autocapitalize="none" spellcheck="false" />
        <label class="small muted">Contraseña</label>
        <input id="loginPass" type="password" autocomplete="new-password" />
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small muted">Usuario: <strong>JHONATAN</strong> · Pass: <strong>JHONATAN</strong></div>
          <div style="display:flex;gap:8px">
            <button id="loginBtn" class="btn primary">Entrar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- App (oculto hasta login) -->
  <div id="appWrap" class="app-wrap" style="display:none">
    <div id="app" class="app" role="application" aria-label="App Finanzas PRO">
      <!-- Sidebar -->
      <aside class="sidebar" aria-label="Panel lateral">
        <div class="brand">
          <div class="logo">JO</div>
          <div>
            <div class="title">JHONATAN ORELLANA</div>
            <div class="small muted">Finanzas · UNA DATA</div>
          </div>
        </div>

        <nav class="side" aria-label="Navegación">
          <button data-view="dashboard" class="active"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M3 13h8V3H3v10zM3 21h8v-6H3v6zM13 21h8V11h-8v10zM13 3v6h8V3h-8z" fill="currentColor" /></svg><span class="label">Resumen</span></button>
          <button data-view="transactions"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M3 6h18" stroke="currentColor" stroke-width="2"/><path d="M6 10h12v8H6z" fill="currentColor"/></svg><span class="label">Transacciones</span></button>
          <button data-view="banks"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 3l9 4v2H3V7l9-4z" fill="currentColor"/></svg><span class="label">Bancos</span></button>
          <button data-view="assets"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5" fill="currentColor"/></svg><span class="label">Activos / Pasivos</span></button>
          <button data-view="businesses"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M3 13h18v8H3z" fill="currentColor"/></svg><span class="label">Empresas</span></button>
          <button data-view="fixed"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 2v6" stroke="currentColor" stroke-width="2"/><path d="M4 7h16v11H4z" fill="currentColor"/></svg><span class="label">Gastos Mensuales</span></button>
          <button data-view="debts"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 2v20" stroke="currentColor" stroke-width="2"/><path d="M3 6h18" stroke="currentColor" stroke-width="2"/></svg><span class="label">Deudas</span></button>
          <button data-view="categories"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 2a4 4 0 100 8 4 4 0 000-8zM4 14a4 4 0 100 8 4 4 0 000-8zM20 14a4 4 0 100 8 4 4 0 000-8z" fill="currentColor"/></svg><span class="label">Categorías</span></button>
          <button data-view="export"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 2v12" stroke="currentColor" stroke-width="2"/><path d="M5 12l7 7 7-7" fill="currentColor"/></svg><span class="label">Export / Cloud</span></button>
        </nav>

        <div class="meta">
          <div class="small muted">orgId: <strong id="orgBadge">oxIgjNwqNPiAneP5alpM</strong></div>
          <div style="display:flex;gap:8px">
            <button id="sidebarToggle" class="btn ghost" title="Colapsar menú">≡</button>
            <button id="btnLogout" class="btn ghost">Cerrar sesión</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center;justify-content:space-between">
            <div class="small muted">Cloud:</div>
            <div id="cloudModeBadge" class="small muted">—</div>
          </div>
          <div class="small muted">Estado sync: <span id="syncStatus">idle</span></div>
        </div>
      </aside>

      <!-- Main -->
      <main class="main">
        <div class="topbar">
          <div>
            <h2 style="margin:0;font-size:18px">Panel · <span id="orgShort" style="font-weight:700">oxIgjNwqNPiAneP5alpM</span></h2>
            <div class="small muted">Usuario: <span id="currentUser">Invitado</span></div>
          </div>
          <div class="controls">
            <button id="btnQuickTx" class="btn primary" title="Nueva transacción (N)">+ Transacción</button>
            <button id="btnTransfer" class="btn ghost">Transferencia</button>
            <button id="btnSyncNow" class="btn ghost" title="Forzar sincronización">Sync ahora</button>
          </div>
        </div>

        <!-- Dashboard -->
        <section id="view-dashboard" class="card" style="min-height:320px">
          <div style="display:flex;gap:14px;align-items:flex-start">
            <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <h3 style="margin:0;font-size:16px">Resumen Ejecutivo</h3>
                  <div class="small muted">Indicadores, alertas y límites</div>
                </div>
                <div style="text-align:right">
                  <div class="small muted">Fecha</div>
                  <div id="todayDate" style="font-weight:900"></div>
                </div>
              </div>

              <div class="grid3" style="margin-top:12px">
                <div class="mini-card">
                  <div class="small muted">Saldo líquido</div>
                  <div id="balance" style="font-weight:900;font-size:20px;margin-top:6px;transition:all .4s">S/ 0.00</div>
                  <div class="small muted" id="liquidityRatio">Ratio: -</div>
                </div>

                <div class="mini-card">
                  <div class="small muted">Patrimonio Neto</div>
                  <div id="netWorth" style="font-weight:900;font-size:20px;margin-top:6px">S/ 0.00</div>
                  <div class="small muted" id="assetsSummary">Activos / Pasivos</div>
                </div>

                <div class="mini-card">
                  <div class="small muted">Gastos mensuales</div>
                  <div id="avgExpenses" style="font-weight:900;font-size:20px;margin-top:6px">S/ 0.00</div>
                  <div class="small muted" id="runway">Runway: - meses</div>
                </div>
              </div>

              <div style="display:flex;gap:12px;margin-top:12px">
                <div style="flex:1" class="mini-card"><div class="small muted">Top categorías</div><div id="topCategories" class="small" style="margin-top:8px">—</div></div>
                <div style="width:360px" class="mini-card"><div class="small muted">Saldo por cuenta</div><div id="bankBreakdown" class="small" style="margin-top:8px">—</div></div>
              </div>

              <div style="margin-top:12px" class="mini-card"><div class="small muted">Alertas y límites</div><div id="alertsArea" style="margin-top:8px" class="small muted">Sin alertas</div></div>
            </div>

            <div style="width:420px">
              <h4 style="margin:0;font-size:14px">Ingresos vs Egresos (12 meses)</h4>
              <canvas id="chartFlows" height="260" style="margin-top:10px;border-radius:8px;background:transparent"></canvas>
            </div>
          </div>
        </section>

        <!-- Transacciones -->
        <section id="view-transactions" class="card" style="display:none;min-height:380px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0;font-size:16px">Transacciones</h3><div class="small muted">Vincula cuenta y opcionalmente un activo. Al guardar, la ventana se cierra automáticamente.</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="search" placeholder="Buscar descripción, categoría o activo..." style="width:260px" />
              <select id="filterAccount" style="min-width:180px"><option value="">Todas cuentas</option></select>
              <button id="btnAddTx" class="btn primary">Agregar</button>
            </div>
          </div>
          <div style="margin-top:12px;overflow:auto;height:280px">
            <table id="txTable"><thead><tr><th>Fecha</th><th>Cuenta</th><th>Tipo</th><th>Categoría / Activo</th><th class="right">Monto</th><th>Acciones</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <!-- Bancos -->
        <section id="view-banks" class="card" style="display:none;min-height:380px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0;font-size:16px">Bancos</h3><div class="small muted">Cuentas, transferencias y origen de fondos</div></div>
            <div style="display:flex;gap:8px">
              <button id="btnAddBank" class="btn primary">Nueva cuenta</button>
              <button id="btnExportBanks" class="btn ghost">Export</button>
            </div>
          </div>
          <div id="banksArea" style="margin-top:12px;overflow:auto;height:320px"></div>
        </section>

        <!-- Activos / Pasivos -->
        <section id="view-assets" class="card" style="display:none;min-height:380px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0;font-size:16px">Activos / Pasivos</h3><div class="small muted">Registra subtipos, ganancias y vínculos con transacciones</div></div>
            <div style="display:flex;gap:8px">
              <button id="btnAddAsset" class="btn primary">Nuevo activo</button>
              <button id="btnAddLiability" class="btn ghost">Nuevo pasivo</button>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1;overflow:auto;height:300px" id="assetsArea"></div>
            <div style="width:420px;overflow:auto;height:300px" id="liabilitiesArea"></div>
          </div>
        </section>

        <!-- Otras secciones (empresas, fijos, deudas, categorias, export) -->
        <section id="view-businesses" class="card" style="display:none;min-height:260px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0;font-size:16px">Empresas / Proyectos</h3><div class="small muted">Registra rol, aportes y estimaciones</div></div>
            <div><button id="btnAddBiz" class="btn primary">Nueva empresa</button></div>
          </div>
          <div id="businessesArea" style="margin-top:12px;overflow:auto;height:240px"></div>
        </section>

        <section id="view-fixed" class="card" style="display:none;min-height:260px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0;font-size:16px">Gastos Mensuales</h3><div class="small muted">Pensión, alquiler, cuotas</div></div>
            <div style="display:flex;gap:8px">
              <button id="btnAddFixed" class="btn primary">Agregar fijo</button>
              <button id="btnApplyFixed" class="btn ghost">Aplicar ahora</button>
            </div>
          </div>
          <div id="fixedArea" style="margin-top:12px;overflow:auto;height:240px"></div>
        </section>

        <section id="view-debts" class="card" style="display:none;min-height:260px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0;font-size:16px">Deudas</h3><div class="small muted">Créditos vinculados a bancos</div></div>
            <div><button id="btnAddDebt" class="btn primary">Nueva deuda</button></div>
          </div>
          <div id="debtsArea" style="margin-top:12px;overflow:auto;height:240px"></div>
        </section>

        <section id="view-categories" class="card" style="display:none;min-height:260px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0;font-size:16px">Categorías</h3><div class="small muted">Registra categorías y límites</div></div>
            <div><button id="btnAddCategory" class="btn primary">Nueva categoría</button></div>
          </div>
          <div id="categoriesArea" style="margin-top:12px;overflow:auto;height:240px"></div>
        </section>

        <section id="view-export" class="card" style="display:none;min-height:260px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 style="margin:0;font-size:16px">Export / Import / PDF</h3><div class="small muted">PDF técnico (títulos 12pt, subtítulos 11pt, normal 10pt)</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="btnExportCSV" class="btn primary">Export CSV</button>
              <button id="btnExportJSON" class="btn ghost">Export JSON</button>
              <input id="fileImport" type="file" accept=".csv,application/json" />
              <button id="btnImport" class="btn primary">Importar</button>
              <button id="btnExportPDF" class="btn primary">Generar PDF</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Floating Action Button para acceso rápido -->
  <button id="fabAdd" class="fab" title="Agregar transacción">
    ➕
  </button>

  <!-- Bottom nav (mobile) -->
  <div class="bottom-nav" id="bottomNav">
    <button data-view="dashboard">Resumen</button>
    <button data-view="transactions">Trans.</button>
    <button data-view="banks">Bancos</button>
    <button id="mobileAdd" title="Nueva transacción">+</button>
  </div>

  <!-- Overlay modal root -->
  <div id="overlay" class="overlay" aria-hidden="true"><div class="panel" id="panelRoot"></div></div>

  <!-- Toast -->
  <div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#072a2f;padding:10px;border-radius:8px;display:none;z-index:1000;color:#cff6ef"></div>

  <!-- FIREBASE CONFIG -->
  <script>
    /* ================== FIREBASE CONFIG (PONER AQUÍ si desea cambiar) ================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBVppNAicRPFXEUdErmHd24se_9bjXiqcM",
      authDomain: "jhona-1b398.firebaseapp.com",
      databaseURL: "https://jhona-1b398-default-rtdb.firebaseio.com",
      projectId: "jhona-1b398",
      storageBucket: "jhona-1b398.firebasestorage.app",
      messagingSenderId: "981136306223",
      appId: "1:981136306223:web:d8948acdb119f0facc56da",
      measurementId: "G-44TXK10R9R"
    };
    const JOIN_CODE = "JGSQPV";
    const ORG_ID = "oxIgjNwqNPiAneP5alpM";
    const LOCAL_LOGIN = { user: "JHONATAN", pass: "JHONATAN" };
  </script>

  <!-- APP LOGIC -->
  <script type="module">
  // ------------------------------
  // Helpers & estado
  // ------------------------------
  const $ = (s,r=document)=> r.querySelector(s);
  const $$ = (s,r=document)=> Array.from((r||document).querySelectorAll(s));
  const nowISO = ()=> new Date().toISOString();
  function uid(pref){ return `${pref}_${Date.now()}_${Math.floor(Math.random()*90000)}`; }
  function fmtMoney(v){ v = Number(v)||0; return 'S/ ' + v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function parseDateDDMMYYYY(s){ if(!s) return null; const p=s.split('/'); if(p.length!==3) return null; const d=Number(p[0]), m=Number(p[1])-1, y=Number(p[2]); const D=new Date(y,m,d); return isNaN(D)?null:D; }
  function toDDMMYYYY(d){ if(!d) return ''; return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear(); }
  function showToast(msg,strong=false){ const t=$('#toast'); t.textContent = msg; t.style.display='block'; t.style.background = strong ? 'linear-gradient(90deg,#ff6b6b,#ff9a9a)' : '#072a2f'; clearTimeout(window.__to); window.__to = setTimeout(()=> t.style.display='none', strong?7000:3500); }

  // App state
  const STORAGE_KEY = 'jona_single_data_v5_ui';
  const state = {
    logged:false, user:null,
    firebaseApp:null, firestore:null, fsHelpers:null, unsubscribeRealtime:null,
    data: { transactions:[], banks:[], debts:[], fixed:[], categories:[], assets:[], liabilities:[], businesses:[], meta:{ updatedAt:null } },
    pushing:false
  };

  // ------------------------------
  // Local persistence
  // ------------------------------
  function loadLocal(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) try { const parsed = JSON.parse(raw); state.data = parsed; } catch(e){ console.warn('parse local fail', e); }
    // ensure arrays
    state.data.transactions = state.data.transactions || [];
    state.data.banks = state.data.banks || [];
    state.data.debts = state.data.debts || [];
    state.data.fixed = state.data.fixed || [];
    state.data.categories = state.data.categories || [];
    state.data.assets = state.data.assets || [];
    state.data.liabilities = state.data.liabilities || [];
    state.data.businesses = state.data.businesses || [];
  }
  function persistLocal(){
    state.data.meta.updatedAt = nowISO();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
  }

  // ------------------------------
  // Firestore dynamic init & helpers (v9 modular via CDN imports)
  // ------------------------------
  async function initFirestore(cfg){
    if(state.fsHelpers) return;
    try{
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
      const { getFirestore, doc, getDoc, setDoc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
      state.firebaseApp = initializeApp(cfg);
      state.firestore = getFirestore(state.firebaseApp);
      state.fsHelpers = { doc, getDoc, setDoc, onSnapshot, firestore: state.firestore };
    } catch(e){ throw e; }
  }
  async function fsFetch(){
    if(!state.fsHelpers) throw new Error('Firestore no init');
    const { doc, getDoc, firestore } = state.fsHelpers;
    const ref = doc(firestore, 'organizations', ORG_ID, 'DATA', 'DATA');
    const snap = await getDoc(ref);
    if(!snap.exists()) return { data:null, updatedAt:null };
    const payload = snap.data();
    return { data: payload.data || null, updatedAt: payload.updatedAt || null };
  }
  async function fsSave(data){
    if(!state.fsHelpers) throw new Error('Firestore no init');
    const { doc, setDoc, firestore } = state.fsHelpers;
    const ref = doc(firestore, 'organizations', ORG_ID, 'DATA', 'DATA');
    const updatedAt = nowISO();
    await setDoc(ref, { data, updatedAt }, { merge: true });
    return updatedAt;
  }

  // Setup realtime listener to auto-merge changes from cloud into local
  function startRealtimeListener(){
    if(!state.fsHelpers) return;
    const { doc, onSnapshot, firestore } = state.fsHelpers;
    const ref = doc(firestore, 'organizations', ORG_ID, 'DATA', 'DATA');
    if(state.unsubscribeRealtime) { try{ state.unsubscribeRealtime(); }catch(e){} }
    state.unsubscribeRealtime = onSnapshot(ref, snap => {
      if(!snap.exists()) return;
      const payload = snap.data();
      if(!payload) return;
      const remote = payload.data || null;
      if(remote){
        state.data = mergeDatasets(state.data, remote);
        persistLocal();
        renderAll();
        showToast('Sincronizado automáticamente desde la nube');
      }
    }, err => {
      console.warn('onSnapshot err', err);
    });
  }

  // ------------------------------
  // Merge logic (union by id - remote wins if newer)
  // ------------------------------
  function mergeCollections(localArr=[], remoteArr=[], timeField='createdAt'){
    const map = new Map();
    (localArr || []).forEach(item => { if(!item) return; if(!item.id) item.id = uid('x'); map.set(item.id, item); });
    (remoteArr || []).forEach(r => {
      if(!r) return;
      if(!r.id) r.id = uid('x');
      const existing = map.get(r.id);
      if(!existing){ map.set(r.id, r); return; }
      const tLocal = existing[timeField] ? Date.parse(existing[timeField]) : 0;
      const tRemote = r[timeField] ? Date.parse(r[timeField]) : 0;
      if(tRemote >= tLocal) map.set(r.id, r);
    });
    return Array.from(map.values()).sort((a,b)=> (b[timeField] ? Date.parse(b[timeField]) : 0) - (a[timeField] ? Date.parse(a[timeField]) : 0));
  }
  function mergeDatasets(local, remote){
    if(!remote) return JSON.parse(JSON.stringify(local || {}));
    const merged = {};
    merged.transactions = mergeCollections(local.transactions, remote.transactions, 'createdAt');
    merged.banks = mergeCollections(local.banks, remote.banks, 'createdAt');
    merged.debts = mergeCollections(local.debts, remote.debts, 'createdAt');
    merged.fixed = mergeCollections(local.fixed, remote.fixed, 'createdAt');
    merged.categories = mergeCollections(local.categories, remote.categories, 'createdAt');
    merged.assets = mergeCollections(local.assets, remote.assets, 'createdAt');
    merged.liabilities = mergeCollections(local.liabilities, remote.liabilities, 'createdAt');
    merged.businesses = mergeCollections(local.businesses, remote.businesses, 'createdAt');
    merged.meta = { updatedAt: nowISO() };
    return merged;
  }

  // ------------------------------
  // Auto-push (debounced) to cloud
  // ------------------------------
  let pushTimer = null;
  function schedulePushToCloud(delay=900){
    if(!state.fsHelpers) return;
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(async ()=>{
      try{
        $('#syncStatus').textContent = 'pushing';
        await fsSave(state.data);
        $('#syncStatus').textContent = 'idle';
        showToast('Cambios subidos automáticamente a la nube');
      } catch(e){
        console.error('push err', e); showToast('Error al subir: '+(e.message||e), true); $('#syncStatus').textContent = 'idle';
      }
    }, delay);
  }

  // ------------------------------
  // CRUD y lógica de negocio
  // ------------------------------
  function pushAndRender(mut){
    mut(state.data);
    persistLocal();
    renderAll();
    if(state.fsHelpers) schedulePushToCloud();
  }
  function addBank(obj){ obj.id=uid('b'); obj.balance = Number(obj.balance)||0; obj.createdAt = nowISO(); pushAndRender(d=> d.banks.unshift(obj)); }
  function addCategory(obj){ obj.id=uid('cat'); obj.createdAt = nowISO(); pushAndRender(d=> d.categories.unshift(obj)); }
  function addAsset(obj){ obj.id=uid('asset'); obj.estimatedValue = Number(obj.estimatedValue)||0; obj.accumulatedGain = Number(obj.accumulatedGain)||0; obj.incomeRecords = obj.incomeRecords || []; obj.createdAt = nowISO(); pushAndRender(d=> d.assets.unshift(obj)); }
  function addLiability(obj){ obj.id=uid('liab'); obj.amount = Number(obj.amount)||0; obj.createdAt = nowISO(); pushAndRender(d=> d.liabilities.unshift(obj)); }
  function addBusiness(obj){ obj.id=uid('biz'); obj.estimateValue = Number(obj.estimateValue)||0; obj.createdAt = nowISO(); pushAndRender(d=> d.businesses.unshift(obj)); }
  function addFixed(obj){ obj.id=uid('fix'); obj.amount = Number(obj.amount)||0; obj.createdAt = nowISO(); pushAndRender(d=> d.fixed.unshift(obj)); }
  function addDebt(obj){ obj.id=uid('debt'); obj.outstanding = Number(obj.outstanding)||0; obj.monthlyPayment = Number(obj.monthlyPayment)||0; obj.createdAt = nowISO(); pushAndRender(d=> d.debts.unshift(obj)); }

  async function addTransaction(tx){
    if(!parseDateDDMMYYYY(tx.dateStr)) throw new Error('Fecha inválida (dd/mm/yyyy)');
    if(!tx.bankId) throw new Error('Seleccione una cuenta bancaria');
    tx.id = uid('t'); tx.amount = Number(tx.amount)||0; tx.createdAt = nowISO();
    pushAndRender(d=>{
      d.transactions.unshift(tx);
      const bank = d.banks.find(b=>b.id===tx.bankId);
      if(bank) bank.balance = (Number(bank.balance)||0) + (tx.type === 'Egreso' ? -tx.amount : tx.amount);
      if(tx.debtId && tx.type === 'Egreso'){ const debt = d.debts.find(x=>x.id===tx.debtId); if(debt) debt.outstanding = Math.max(0, (Number(debt.outstanding)||0) - tx.amount); }
      if(tx.assetId && tx.type === 'Ingreso'){ const asset = d.assets.find(a=>a.id===tx.assetId); if(asset){ asset.accumulatedGain = (Number(asset.accumulatedGain)||0) + tx.amount; asset.incomeRecords = asset.incomeRecords || []; asset.incomeRecords.unshift({ id: uid('ag'), txId: tx.id, dateStr: tx.dateStr, amount: tx.amount, desc: tx.description||'' }); } }
    });
  }

  function transferBetweenBanks(fromId,toId,amount,dateStr,note){
    amount = Number(amount)||0; if(amount <= 0) throw new Error('Monto inválido');
    pushAndRender(d=>{
      const from = d.banks.find(b=>b.id===fromId), to = d.banks.find(b=>b.id===toId);
      if(from) from.balance = (Number(from.balance)||0) - amount;
      if(to) to.balance = (Number(to.balance)||0) + amount;
      const out = { id: uid('t'), type:'Egreso', dateStr, amount, bankId: fromId, description:'Transferencia a ' + (to?to.name:''), createdAt:nowISO(), meta:{transferTo:toId} };
      const inc = { id: uid('t'), type:'Ingreso', dateStr, amount, bankId: toId, description:'Transferencia desde ' + (from?from.name:''), createdAt:nowISO(), meta:{transferFrom:fromId} };
      d.transactions.unshift(inc); d.transactions.unshift(out);
    });
  }

  function applyMonthlyFixed(){
    const today = toDDMMYYYY(new Date());
    pushAndRender(d=>{
      d.fixed.forEach(f=>{
        const tx = { id: uid('t'), type:'Egreso', dateStr: today, amount: Number(f.amount)||0, bankId: f.bankId||null, categoryId: f.categoryId||null, description: 'Gasto fijo: ' + f.name, createdAt: nowISO(), meta:{fromFixed:f.id} };
        d.transactions.unshift(tx);
        if(f.bankId){ const b = d.banks.find(x=>x.id===f.bankId); if(b) b.balance = (Number(b.balance)||0) - tx.amount; }
      });
    });
    showToast('Gastos fijos aplicados');
  }

  // ------------------------------
  // Export / Import / PDF
  // ------------------------------
  function exportCSV(){
    const rows = state.data.transactions.map(t=>{ const b = state.data.banks.find(b=>b.id===t.bankId); const c = state.data.categories.find(c=>c.id===t.categoryId); const a = state.data.assets.find(a=>a.id===t.assetId); return [t.dateStr||'', b?b.name:'', t.type||'', c?c.name:(t.categoryName||''), a?('ACT:'+a.name):'', (t.description||'').replace(/"/g,'""'), t.amount||0]; });
    const csv = ['fecha,cuenta,tipo,categoria,activo,descripcion,monto', ...rows.map(r=> r.map((c,i)=> i===5?`"${c}"`:c).join(',') )].join('\n');
    const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='transacciones.csv'; a.click(); URL.revokeObjectURL(url);
  }
  function exportJSON(){ const blob = new Blob([JSON.stringify(state.data,null,2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='backup.json'; a.click(); URL.revokeObjectURL(url); }

  async function importFile(file){
    if(!file) return alert('Selecciona archivo'); const text = await file.text();
    if(file.name.toLowerCase().endsWith('.csv')){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const headers = lines.shift().split(',').map(h=>h.toLowerCase());
      for(const ln of lines){
        const parts = ln.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g).map(p=>p.replace(/^"|"$/g,'').replace(/""/g,'"'));
        const obj = {}; headers.forEach((h,i)=> obj[h]=parts[i]||'');
        const bank = state.data.banks.find(b=>b.name===obj.cuenta);
        const cat = state.data.categories.find(c=>c.name===obj.categoria);
        const asset = state.data.assets.find(a=> obj.activo && obj.activo.includes(a.name));
        try{ await addTransaction({ type: obj.tipo||'Ingreso', amount: Number(obj.monto)||0, bankId: bank?bank.id:null, categoryId: cat?cat.id:null, assetId: asset?asset.id:null, categoryName: obj.categoria||'', description: obj.descripcion||'', dateStr: obj.fecha }); } catch(e){ console.warn('import tx fail', e); }
      }
      showToast('CSV importado');
    } else {
      try{ const d = JSON.parse(text); state.data = mergeDatasets(state.data, d); persistLocal(); if(state.fsHelpers) schedulePushToCloud(500); renderAll(); showToast('JSON importado y fusionado'); } catch(e){ alert('JSON inválido'); }
    }
  }

  async function exportPDF(){
    const banksTotal = state.data.banks.reduce((s,b)=>s + (Number(b.balance)||0),0);
    const assetsTotal = state.data.assets.reduce((s,a)=>s + (Number(a.estimatedValue)||0),0);
    const debtsTotal = state.data.debts.reduce((s,d)=>s + (Number(d.outstanding)||0),0);
    let chartImg = null;
    try{ if(window.flowsChart) chartImg = window.flowsChart.toBase64Image(); } catch(e){ chartImg = null; }
    const node = document.createElement('div'); node.style.padding='12mm'; node.style.background='#fff'; node.style.color='#111'; node.style.fontFamily='Arial,Helvetica,sans-serif';
    node.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900;font-size:12pt">REPORTE FINANCIERO — JHONATAN ORELLANA</div>
        <div style="font-size:10pt">${toDDMMYYYY(new Date())}</div>
      </div>
      <hr style="border:none;border-top:1px solid #ddd;margin:8px 0"/>
      <section><div style="font-size:11pt;font-weight:700">Resumen ejecutivo</div>
        <div style="font-size:10pt;margin-top:6px">Saldo líquido: <strong>${fmtMoney(banksTotal)}</strong> · Patrimonio neto: <strong>${fmtMoney(assetsTotal + banksTotal - debtsTotal)}</strong></div>
      </section>
      <hr style="border:none;border-top:1px solid #ddd;margin:8px 0"/>
      <section><div style="font-size:11pt;font-weight:700">Gráfica</div>
        ${chartImg ? `<div style="margin-top:8px;text-align:center"><img src="${chartImg}" style="max-width:100%;height:auto;border:1px solid #ddd"/></div>` : '<div style="font-size:10pt;margin-top:6px">Gráfica no disponible.</div>'}
      </section>
      <hr style="border:none;border-top:1px solid #ddd;margin:8px 0"/>
      <section><div style="font-size:11pt;font-weight:700">Bancos</div>
        <table style="width:100%;font-size:10pt;border-collapse:collapse;margin-top:6px"><thead><tr><th style="text-align:left;border-bottom:1px solid #ddd">Cuenta</th><th style="text-align:right;border-bottom:1px solid #ddd">Saldo</th></tr></thead><tbody>${state.data.banks.map(b=>`<tr><td style="padding:6px 0">${b.name}</td><td style="text-align:right;padding:6px 0">${fmtMoney(b.balance)}</td></tr>`).join('')}</tbody></table>
      </section>
      <div style="margin-top:8px;font-size:9pt;color:#666">Generado por JHONATAN ORELLANA — App PRO</div>
    `;
    if(window.html2pdf) html2pdf().set({ margin:10, filename:`reporte_${(new Date()).toISOString().slice(0,10)}.pdf`, html2canvas:{scale:2} }).from(node).save();
    else alert('html2pdf no cargado');
  }

  // ------------------------------
  // Charts & Dashboard
  // ------------------------------
  let flowsChart = null;
  window.flowsChart = null;
  function renderFlowsChart(){
    if(!document.getElementById('chartFlows')) return;
    const labels=[], incData=[], egData=[];
    const now = new Date();
    for(let i=11;i>=0;i--){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      labels.push(d.toLocaleString('es-PE',{month:'short',year:'2-digit'}));
      let inc=0, eg=0;
      state.data.transactions.forEach(t=>{ const td=parseDateDDMMYYYY(t.dateStr||''); if(!td) return; if(td.getMonth()===d.getMonth() && td.getFullYear()===d.getFullYear()){ if(t.type==='Egreso') eg += Number(t.amount)||0; else inc += Number(t.amount)||0; }});
      incData.push(inc); egData.push(eg);
    }
    const ctx = document.getElementById('chartFlows');
    const data = { labels, datasets:[ { label:'Ingresos', data:incData, backgroundColor:'#10b981', borderColor:'#10b981' }, { label:'Egresos', data:egData, backgroundColor:'#ff6b6b', borderColor:'#ff6b6b' } ] };
    if(flowsChart){ flowsChart.data = data; flowsChart.update(); } else { flowsChart = new Chart(ctx,{ type:'bar', data, options:{ responsive:true, maintainAspectRatio:true, plugins:{legend:{display:true}}, scales:{ x:{ stacked:false }, y:{ beginAtZero:true } } } }); window.flowsChart = flowsChart; }
  }

  function dashboardMetrics(){
    const now = new Date(), month = now.getMonth();
    const banksTotal = state.data.banks.reduce((s,b)=>s + (Number(b.balance)||0),0);
    const assetsTotal = state.data.assets.reduce((s,a)=>s + (Number(a.estimatedValue)||0),0);
    const liabilitiesTotal = state.data.liabilities.reduce((s,l)=>s + (Number(l.amount)||0),0);
    const debtsTotal = state.data.debts.reduce((s,d)=>s + (Number(d.outstanding)||0),0);
    const monthly=[]; for(let i=1;i<=6;i++){ const d=new Date(now.getFullYear(), now.getMonth()-i+1,1); let total=0; state.data.transactions.forEach(t=>{ const td=parseDateDDMMYYYY(t.dateStr||''); if(!td) return; if(td.getMonth()===d.getMonth() && td.getFullYear()===d.getFullYear() && t.type==='Egreso') total += Number(t.amount)||0; }); monthly.push(total); }
    const avgExpenses = monthly.length ? (monthly.reduce((a,b)=>a+b,0)/monthly.length) : 0;
    const liquidityRatio = debtsTotal ? (banksTotal / debtsTotal).toFixed(2) : '∞';
    const runway = avgExpenses > 0 ? (banksTotal / avgExpenses).toFixed(1) : '∞';
    const catSums = {};
    state.data.transactions.forEach(t=>{ const td=parseDateDDMMYYYY(t.dateStr||''); if(!td) return; if(td.getMonth()===month && td.getFullYear()===now.getFullYear() && t.type==='Egreso'){ const cid = t.categoryId || t.categoryName || 'Sin categoría'; catSums[cid] = (catSums[cid]||0) + (Number(t.amount)||0); }});
    const topCats = Object.entries(catSums).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=> `${k}: ${fmtMoney(v)}`).join('<br/>') || '—';
    const bankBreak = state.data.banks.map(b=>`${b.name}: ${fmtMoney(b.balance)}`).join('<br/>') || '—';
    const alerts = [];
    state.data.categories.forEach(cat=>{ if(!cat.limitMonthly || Number(cat.limitMonthly)<=0) return; const spent = state.data.transactions.reduce((acc,t)=>{ const td=parseDateDDMMYYYY(t.dateStr||''); if(!td) return acc; if(td.getMonth()===month && td.getFullYear()===now.getFullYear() && t.categoryId===cat.id) acc += Number(t.amount)||0; return acc; },0); if(spent > Number(cat.limitMonthly)) alerts.push(`<strong style="color:#ff8b8b">${cat.name}</strong> superó límite ${fmtMoney(spent)} / ${fmtMoney(cat.limitMonthly)}`); else if(spent >= Number(cat.limitMonthly)*0.8) alerts.push(`<strong>${cat.name}</strong> cerca del límite ${fmtMoney(spent)} / ${fmtMoney(cat.limitMonthly)}`); });
    state.data.banks.forEach(b=>{ if(Number(b.balance) < 0) alerts.push(`<strong style="color:#ff8b8b">${b.name}</strong> saldo negativo ${fmtMoney(b.balance)}`); });
    $('#balance').textContent = fmtMoney(banksTotal);
    $('#netWorth').textContent = fmtMoney(assetsTotal + banksTotal - (liabilitiesTotal + debtsTotal));
    $('#avgExpenses').textContent = fmtMoney(avgExpenses);
    $('#liquidityRatio').textContent = `Ratio liquidez: ${liquidityRatio}`;
    $('#assetsSummary').textContent = `Activos: ${fmtMoney(assetsTotal)} · Pasivos: ${fmtMoney(liabilitiesTotal)}`;
    $('#runway').textContent = `Runway: ${runway} meses`;
    $('#topCategories').innerHTML = topCats;
    $('#bankBreakdown').innerHTML = bankBreak;
    $('#alertsArea').innerHTML = alerts.length ? alerts.join('<br/>') : '<span class="muted">Sin alertas</span>';
  }

  // ------------------------------
  // Render lists & UI
  // ------------------------------
  function renderTransactions(){
    const tbody = $('#txTable tbody'); if(!tbody) return; tbody.innerHTML = '';
    const q = ($('#search') && $('#search').value || '').trim().toLowerCase();
    const filterBank = $('#filterAccount') ? $('#filterAccount').value : '';
    const rows = state.data.transactions.filter(t=>{ if(filterBank && t.bankId !== filterBank) return false; if(q){ const cat = state.data.categories.find(c=>c.id===t.categoryId); const asset = state.data.assets.find(a=>a.id===t.assetId); const text = `${t.description||''} ${cat?cat.name:''} ${asset?asset.name:''}`.toLowerCase(); if(!text.includes(q)) return false; } return true; });
    rows.forEach(t=>{ const bank = state.data.banks.find(b=>b.id===t.bankId); const cat = state.data.categories.find(c=>c.id===t.categoryId); const asset = state.data.assets.find(a=>a.id===t.assetId); const tr=document.createElement('tr'); tr.innerHTML = `<td>${t.dateStr||''}</td><td>${bank?bank.name:'-'}</td><td>${t.type}</td><td>${cat?cat.name:(asset?('ACT: '+asset.name): (t.categoryName||'-'))}</td><td class="right">${fmtMoney(t.amount)}</td><td><button data-id="${t.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${t.id}" data-act="del" class="btn" style="background:#ff7b7b">X</button></td>`; tbody.appendChild(tr); });
    $$('#txTable button').forEach(btn=> btn.onclick = ()=> { const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar transacción?')){ state.data.transactions = state.data.transactions.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } } if(act==='edit'){ const tx=state.data.transactions.find(x=>x.id===id); if(tx) openTxModal(tx); } });
  }

  function renderBanks(){
    const wrap = $('#banksArea'); if(!wrap) return;
    if(state.data.banks.length === 0){ wrap.innerHTML = '<div class="small muted">No hay cuentas registradas</div>'; return; }
    const rows = state.data.banks.map(b=>`<tr><td><strong>${b.name}</strong><div class="small muted">${b.type||''}</div></td><td class="right">${fmtMoney(Number(b.balance)||0)}</td><td><button data-id="${b.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${b.id}" data-act="del" class="btn" style="background:#ff7b7b">X</button></td></tr>`).join('');
    wrap.innerHTML = `<table><thead><tr><th>Cuenta</th><th class="right">Saldo</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`;
    $$('#banksArea button').forEach(btn=> btn.onclick = ()=> { const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar cuenta?')){ state.data.banks = state.data.banks.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } } if(act==='edit'){ const b=state.data.banks.find(x=>x.id===id); openBankModal(b); } });
    $('#filterAccount').innerHTML = '<option value="">Todas cuentas</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
  }

  function renderAssets(){
    const wrap = $('#assetsArea'); if(!wrap) return;
    if(state.data.assets.length === 0){ wrap.innerHTML = '<div class="small muted">Sin activos registrados</div>'; return; }
    const rows = state.data.assets.map(a=>`<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${a.name}</strong><div class="small muted">${a.subtype||'-'} · Valor: ${fmtMoney(a.estimatedValue)} · Ganancias: ${fmtMoney(a.accumulatedGain||0)}</div></div><div style="display:flex;gap:8px"><button data-id="${a.id}" data-act="view" class="btn ghost">Ver</button><button data-id="${a.id}" data-act="edit" class="btn ghost">E</button><button data-id="${a.id}" data-act="del" class="btn" style="background:#ff7b7b">X</button></div></div></div>`).join('');
    wrap.innerHTML = `<div>${rows}</div>`;
    $$('#assetsArea button').forEach(btn=> btn.onclick = ()=> { const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar activo?')){ state.data.assets = state.data.assets.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } } if(act==='edit'){ const a=state.data.assets.find(x=>x.id===id); openAssetModal(a); } if(act==='view'){ openAssetViewModal(state.data.assets.find(x=>x.id===id)); } });
  }

  function renderLiabilities(){
    const wrap = $('#liabilitiesArea'); if(!wrap) return;
    if(state.data.liabilities.length === 0){ wrap.innerHTML = '<div class="small muted">Sin pasivos</div>'; return; }
    const rows = state.data.liabilities.map(l=>`<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)"><div style="display:flex;justify-content:space-between"><div><strong>${l.name}</strong><div class="small muted">Tasa: ${l.interestRate||0}% · Venc: ${l.maturityDate||'-'}</div></div><div style="display:flex;gap:8px"><button data-id="${l.id}" data-act="edit" class="btn ghost">E</button><button data-id="${l.id}" data-act="del" class="btn" style="background:#ff7b7b">X</button></div></div></div>`).join('');
    wrap.innerHTML = rows;
    $$('#liabilitiesArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar pasivo?')){ state.data.liabilities = state.data.liabilities.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } } if(act==='edit'){ const l=state.data.liabilities.find(x=>x.id===id); openLiabilityModal(l); } });
  }

  function renderBusinesses(){ const wrap = $('#businessesArea'); if(!wrap) return; if(state.data.businesses.length === 0){ wrap.innerHTML = '<div class="small muted">Sin empresas registradas</div>'; return; } const rows = state.data.businesses.map(b=>`<tr><td><strong>${b.name}</strong><div class="small muted">Rol: ${b.role||'-'}</div></td><td class="right">${fmtMoney(Number(b.estimateValue)||0)}</td><td>${b.notes||''}</td><td><button data-id="${b.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${b.id}" data-act="del" class="btn" style="background:#ff7b7b">X</button></td></tr>`).join(''); wrap.innerHTML = `<table><thead><tr><th>Empresa</th><th class="right">Valor estimado</th><th>Notas</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`; $$('#businessesArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar empresa?')){ state.data.businesses = state.data.businesses.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } } if(act==='edit'){ const bz=state.data.businesses.find(x=>x.id===id); openBusinessModal(bz); } }); }

  function renderFixed(){ const wrap = $('#fixedArea'); if(!wrap) return; if(state.data.fixed.length===0){ wrap.innerHTML = '<div class="small muted">Sin gastos fijos</div>'; return; } const rows = state.data.fixed.map(f=>`<tr><td>${f.name}</td><td class="right">${fmtMoney(Number(f.amount)||0)}</td><td>${(state.data.banks.find(b=>b.id===f.bankId)||{name:'-'}) .name}</td><td><button data-id="${f.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${f.id}" data-act="del" class="btn" style="background:#ff7b7b">X</button></td></tr>`).join(''); wrap.innerHTML = `<table><thead><tr><th>Nombre</th><th class="right">Monto</th><th>Cuenta</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`; $$('#fixedArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar gasto fijo?')){ state.data.fixed = state.data.fixed.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } } if(act==='edit'){ const f=state.data.fixed.find(x=>x.id===id); openFixedModal(f); } }); }

  function renderDebts(){ const wrap = $('#debtsArea'); if(!wrap) return; if(state.data.debts.length===0){ wrap.innerHTML = '<div class="small muted">Sin deudas</div>'; return; } const rows = state.data.debts.map(d=>`<tr><td>${d.name}</td><td>${(state.data.banks.find(b=>b.id===d.bankId)||{name:'-'}) .name}</td><td class="right">${fmtMoney(Number(d.outstanding)||0)}</td><td class="right">${fmtMoney(Number(d.monthlyPayment)||0)}</td><td><button data-id="${d.id}" data-act="pay" class="btn primary">Pagar</button> <button data-id="${d.id}" data-act="del" class="btn" style="background:#ff7b7b">X</button></td></tr>`).join(''); wrap.innerHTML = `<table><thead><tr><th>Deuda</th><th>Banco</th><th class="right">Saldo</th><th class="right">Cuota</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`; $$('#debtsArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar deuda?')){ state.data.debts = state.data.debts.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } } if(act==='pay'){ const d=state.data.debts.find(x=>x.id===id); openDebtPayModal(d); } }); }

  function renderCategories(){ const wrap = $('#categoriesArea'); if(!wrap) return; if(state.data.categories.length===0){ wrap.innerHTML = '<div class="small muted">Sin categorías</div>'; return; } const rows = state.data.categories.map(c=>`<tr><td>${c.name}</td><td class="right">${c.limitMonthly?fmtMoney(Number(c.limitMonthly)||0):'Sin límite'}</td><td><button data-id="${c.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${c.id}" data-act="del" class="btn" style="background:#ff7b7b">X</button></td></tr>`).join(''); wrap.innerHTML = `<table><thead><tr><th>Categoría</th><th class="right">Límite</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`; $$('#categoriesArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar categoría?')){ state.data.categories = state.data.categories.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } } if(act==='edit'){ const c=state.data.categories.find(x=>x.id===id); openCategoryModal(c); } }); }

  function renderAll(){
    $('#todayDate').textContent = toDDMMYYYY(new Date());
    renderFlowsChart();
    dashboardMetrics();
    renderTransactions(); renderBanks(); renderAssets(); renderLiabilities(); renderBusinesses(); renderFixed(); renderDebts(); renderCategories();
    $('#cloudModeBadge').textContent = (state.fsHelpers ? 'CLOUD' : 'LOCAL');
    $('#currentUser').textContent = state.user || 'Invitado';
    $('#orgBadge').textContent = ORG_ID; $('#orgShort').textContent = ORG_ID;
  }

  // ------------------------------
  // Modal helper (panel)
  // ------------------------------
  function showPanel(html){
    $('#panelRoot').innerHTML = html;
    $('#overlay').classList.add('show');
    $('#overlay').setAttribute('aria-hidden','false');
  }
  function closePanel(){ $('#panelRoot').innerHTML=''; $('#overlay').classList.remove('show'); $('#overlay').setAttribute('aria-hidden','true'); }

  // ------------------------------
  // Modales de CRUD (transacción, banco, activo, etc.)
  // - Al guardar: cierra la ventana y actualiza la UI (solicitado)
  // ------------------------------
  function openTxModal(existing){
    const bankOpt = '<option value="">-- seleccionar cuenta --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const catOpt = '<option value="">-- categoría --</option>' + state.data.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    const assetOpt = '<option value="">-- Ninguno --</option>' + state.data.assets.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    const def = existing || { type:'Egreso', amount:0, dateStr: toDDMMYYYY(new Date()), bankId:'', categoryId:'', assetId:'', description:'' };
    const body = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><label class="small muted">Tipo</label><select id="txType"><option ${def.type==='Ingreso'?'selected':''}>Ingreso</option><option ${def.type==='Egreso'?'selected':''}>Egreso</option></select></div>
        <div><label class="small muted">Monto</label><input id="txAmount" type="number" value="${def.amount||0}" /></div>
        <div style="grid-column:1/3"><label class="small muted">Cuenta</label><select id="txBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label class="small muted">Categoría</label><select id="txCat">${catOpt}</select></div>
        <div><label class="small muted">Activo (opcional)</label><select id="txAsset">${assetOpt}</select></div>
        <div><label class="small muted">Fecha (dd/mm/yyyy)</label><input id="txDate" value="${def.dateStr}" /></div>
        <div style="grid-column:1/3"><label class="small muted">Descripción</label><input id="txDesc" value="${(def.description||'').replace(/"/g,'&quot;')}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="txCancel" class="btn ghost">Cancelar</button><button id="txSave" class="btn primary">Guardar</button></div>
    `;
    showPanel(body);
    setTimeout(()=>{ if(existing){ $('#txBank').value = existing.bankId||''; $('#txCat').value = existing.categoryId||''; $('#txAsset').value = existing.assetId||''; } },40);
    $('#txCancel').onclick = closePanel;
    $('#txSave').onclick = async ()=> {
      try{
        const type = $('#txType').value; const amount = Number($('#txAmount').value)||0; const bankId = $('#txBank').value || null; const categoryId = $('#txCat').value || null; const assetId = $('#txAsset').value || null; const dateStr = $('#txDate').value.trim(); const desc = $('#txDesc').value.trim();
        if(!amount || amount <= 0) return alert('Monto inválido');
        if(!parseDateDDMMYYYY(dateStr)) return alert('Fecha inválida (dd/mm/yyyy)');
        await addTransaction({ type, amount, bankId, categoryId, assetId, description: desc, dateStr });
        closePanel(); // <- se cierra al guardar (solicitado)
      } catch(e){ console.error(e); alert('Error: '+(e.message||e)); }
    };
  }

  function openBankModal(b){
    const def = b || { name:'', balance:0, type:'Cuenta', notes:'' };
    const body = `<div class="flex-col"><label class="small muted">Nombre</label><input id="bName" value="${def.name}" /><label class="small muted">Tipo</label><input id="bType" value="${def.type}" /><label class="small muted">Saldo inicial</label><input id="bBalance" type="number" value="${Number(def.balance)||0}" /><label class="small muted">Notas</label><input id="bNotes" value="${(def.notes||'').replace(/"/g,'&quot;')}" /><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="bCancel" class="btn ghost">Cancelar</button><button id="bSave" class="btn primary">Guardar cuenta</button></div></div>`;
    showPanel(body);
    $('#bCancel').onclick = closePanel;
    $('#bSave').onclick = ()=> { const name=$('#bName').value.trim(), type=$('#bType').value.trim(), balance=Number($('#bBalance').value)||0, notes=$('#bNotes').value.trim(); if(!name) return alert('Nombre requerido'); if(b){ Object.assign(b,{name,type,balance,notes}); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } else addBank({name,type,balance,notes}); closePanel(); };
  }

  function openAssetModal(a){
    const subtypes = ['Inmueble','Maquinaria','Inversión','Patrimonio','Vehículo','Otro'];
    const bankOpt = '<option value="">-- Ninguna --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = a || { name:'', estimatedValue:0, subtype:'Inmueble', purchaseDate:'', depreciationRate:0, usefulLife:0, salvageValue:0, linkedBankId:'', notes:'', accumulatedGain:0 };
    const body = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label class="small muted">Nombre</label><input id="aName" value="${def.name}" /></div>
      <div><label class="small muted">Subtipo</label><select id="aSubtype">${subtypes.map(s=>`<option ${def.subtype===s?'selected':''}>${s}</option>`).join('')}</select></div>
      <div><label class="small muted">Valor estimado</label><input id="aValue" type="number" value="${Number(def.estimatedValue)||0}" /></div>
      <div><label class="small muted">Fecha compra (dd/mm/yyyy)</label><input id="aPurchase" value="${def.purchaseDate||''}" /></div>
      <div><label class="small muted">Depreciación anual (%)</label><input id="aDep" type="number" value="${Number(def.depreciationRate)||0}" /></div>
      <div><label class="small muted">Vida útil (años)</label><input id="aLife" type="number" value="${Number(def.usefulLife)||0}" /></div>
      <div style="grid-column:1/3"><label class="small muted">Valor residual</label><input id="aSalvage" type="number" value="${Number(def.salvageValue)||0}" /></div>
      <div style="grid-column:1/3"><label class="small muted">Vinculado a cuenta</label><select id="aBank">${bankOpt}</select></div>
      <div style="grid-column:1/3"><label class="small muted">Notas</label><textarea id="aNotes">${(def.notes||'')}</textarea></div>
      <div style="grid-column:1/3"><label class="small muted">Ganancia acumulada</label><input id="aGain" value="${fmtMoney(def.accumulatedGain||0)}" disabled /></div>
    </div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="aCancel" class="btn ghost">Cancelar</button><button id="aSave" class="btn primary">Guardar activo</button></div>`;
    showPanel(body);
    setTimeout(()=>{ if(a) $('#aBank').value = a.linkedBankId||''; },40);
    $('#aCancel').onclick = closePanel;
    $('#aSave').onclick = ()=> {
      const name=$('#aName').value.trim(), subtype=$('#aSubtype').value, val=Number($('#aValue').value)||0, purchase=$('#aPurchase').value.trim(), dep=Number($('#aDep').value)||0, life=Number($('#aLife').value)||0, salvage=Number($('#aSalvage').value)||0, bankId=$('#aBank').value||null, notes=$('#aNotes').value.trim();
      if(!name) return alert('Nombre requerido');
      const obj = { name, subtype, estimatedValue:val, purchaseDate:purchase, depreciationRate:dep, usefulLife:life, salvageValue:salvage, linkedBankId:bankId, notes, accumulatedGain: a ? a.accumulatedGain : 0, incomeRecords: a ? a.incomeRecords : [] };
      if(a){ Object.assign(a,obj); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } else addAsset(obj);
      closePanel();
    };
  }

  function openAssetViewModal(a){
    if(!a) return alert('Activo no encontrado');
    const incomeHtml = (a.incomeRecords||[]).slice(0,20).map(r=>`<li>${r.dateStr} · ${fmtMoney(r.amount)} · ${r.desc||''}</li>`).join('');
    const body = `<div><h3>${a.name}</h3><div class="small muted">${a.subtype || '-'}</div><div style="margin-top:8px">Valor estimado: <strong>${fmtMoney(a.estimatedValue)}</strong></div><div style="margin-top:8px">Ganancia acumulada: <strong>${fmtMoney(a.accumulatedGain||0)}</strong></div><div style="margin-top:8px"><strong>Registros de ganancia</strong><ul style="margin-top:6px">${incomeHtml || '<li class="muted">Sin registros</li>'}</ul></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="avClose" class="btn ghost">Cerrar</button></div></div>`;
    showPanel(body);
    $('#avClose').onclick = closePanel;
  }

  // Liability/Business/Fixed/Category/Debt modals - implementations similar to above
  function openLiabilityModal(l){
    const subtypes=['Préstamo Bancario','Hipoteca','Tarjeta','Proveedor','Garantía','Otro'];
    const bankOpt = '<option value="">-- Ninguna --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = l || { name:'', amount:0, subtype:'Préstamo Bancario', interestRate:0, maturityDate:'', collateral:'', linkedBankId:'', notes:'' };
    const body = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label class="small muted">Nombre</label><input id="liName" value="${def.name}" /></div><div><label class="small muted">Subtipo</label><select id="liSubtype">${subtypes.map(s=>`<option ${def.subtype===s?'selected':''}>${s}</option>`).join('')}</select></div><div><label class="small muted">Monto</label><input id="liAmount" type="number" value="${Number(def.amount)||0}" /></div><div><label class="small muted">Tasa interés (%)</label><input id="liInterest" type="number" value="${Number(def.interestRate)||0}" /></div><div><label class="small muted">Fecha vencimiento (dd/mm/yyyy)</label><input id="liMaturity" value="${def.maturityDate||''}" /></div><div><label class="small muted">Colateral</label><input id="liCollateral" value="${(def.collateral||'')}" /></div><div style="grid-column:1/3"><label class="small muted">Vinculado a cuenta</label><select id="liBank">${bankOpt}</select></div><div style="grid-column:1/3"><label class="small muted">Notas</label><textarea id="liNotes">${(def.notes||'')}</textarea></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="liCancel" class="btn ghost">Cancelar</button><button id="liSave" class="btn primary">Guardar pasivo</button></div>`;
    showPanel(body);
    if(l) setTimeout(()=> $('#liBank').value = l.linkedBankId||'',40);
    $('#liCancel').onclick = closePanel;
    $('#liSave').onclick = ()=> {
      const name=$('#liName').value.trim(), subtype=$('#liSubtype').value, amount=Number($('#liAmount').value)||0, interest=Number($('#liInterest').value)||0, maturity=$('#liMaturity').value.trim(), collateral=$('#liCollateral').value.trim(), bankId=$('#liBank').value||null, notes=$('#liNotes').value.trim();
      if(!name) return alert('Nombre requerido');
      const obj = { name, subtype, amount, interestRate:interest, maturityDate:maturity, collateral, linkedBankId:bankId, notes };
      if(l){ Object.assign(l,obj); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } else addLiability(obj);
      closePanel();
    };
  }

  function openBusinessModal(bz){
    const def = bz || { name:'', estimateValue:0, contribution:0, role:'Propietario', notes:'' };
    const body = `<div class="flex-col"><label class="small muted">Nombre negocio</label><input id="bzName" value="${def.name}" /><label class="small muted">Rol</label><input id="bzRole" value="${def.role}" /><label class="small muted">Valor estimado</label><input id="bzValue" type="number" value="${Number(def.estimateValue)||0}" /><label class="small muted">Aporte</label><input id="bzContribution" type="number" value="${Number(def.contribution)||0}" /><label class="small muted">Notas</label><textarea id="bzNotes">${(def.notes||'')}</textarea><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="bzCancel" class="btn ghost">Cancelar</button><button id="bzSave" class="btn primary">Guardar empresa</button></div></div>`;
    showPanel(body);
    $('#bzCancel').onclick=closePanel;
    $('#bzSave').onclick=()=>{ const name=$('#bzName').value.trim(), role=$('#bzRole').value, val=Number($('#bzValue').value)||0, contrib=Number($('#bzContribution').value)||0, notes=$('#bzNotes').value.trim(); if(!name) return alert('Nombre requerido'); const obj={name,estimateValue:val,contribution:contrib,role,notes}; if(bz){ Object.assign(bz,obj); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } else addBusiness(obj); closePanel(); };
  }

  function openFixedModal(f){
    const def = f || { name:'', amount:0, bankId:'', categoryId:'', frequency:'monthly' };
    const bankOpt = '<option value="">-- Ninguna --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const catOpt = '<option value="">-- Ninguna --</option>' + state.data.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    const body = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label class="small muted">Nombre</label><input id="fName" value="${def.name}" /></div><div><label class="small muted">Monto</label><input id="fAmount" type="number" value="${Number(def.amount)||0}" /></div><div><label class="small muted">Cuenta</label><select id="fBank">${bankOpt}</select></div><div><label class="small muted">Categoría</label><select id="fCat">${catOpt}</select></div><div><label class="small muted">Frecuencia</label><select id="fFreq"><option ${def.frequency==='monthly'?'selected':''} value="monthly">Mensual</option><option ${def.frequency==='weekly'?'selected':''} value="weekly">Semanal</option><option ${def.frequency==='annual'?'selected':''} value="annual">Anual</option></select></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="fCancel" class="btn ghost">Cancelar</button><button id="fSave" class="btn primary">Guardar gasto fijo</button></div>`;
    showPanel(body);
    if(f) setTimeout(()=>{ $('#fBank').value=f.bankId||''; $('#fCat').value=f.categoryId||''; },50);
    $('#fCancel').onclick = closePanel;
    $('#fSave').onclick = ()=> { const name=$('#fName').value.trim(), amount=Number($('#fAmount').value)||0, bankId=$('#fBank').value||null, categoryId=$('#fCat').value||null, freq=$('#fFreq').value||'monthly'; if(!name) return alert('Nombre requerido'); if(f){ Object.assign(f,{name,amount,bankId,categoryId,frequency:freq}); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } else addFixed({name,amount,bankId,categoryId,frequency:freq}); closePanel(); };
  }

  function openCategoryModal(c){
    const def = c || { name:'', limitMonthly:0 };
    const body = `<div class="flex-col"><label class="small muted">Nombre</label><input id="catName" value="${def.name}" /><label class="small muted">Límite mensual (0 = sin límite)</label><input id="catLimit" type="number" value="${def.limitMonthly||0}" /><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="catCancel" class="btn ghost">Cancelar</button><button id="catSave" class="btn primary">Guardar categoría</button></div></div>`;
    showPanel(body);
    $('#catCancel').onclick = closePanel;
    $('#catSave').onclick = ()=>{ const name=$('#catName').value.trim(), limit=Number($('#catLimit').value)||0; if(!name) return alert('Nombre requerido'); if(c){ Object.assign(c,{name,limitMonthly:limit}); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } else addCategory({name,limitMonthly:limit}); closePanel(); };
  }

  function openDebtModal(d){
    const bankOpt = '<option value="">-- Ninguna --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = d || { name:'', bankId:'', outstanding:0, monthlyPayment:0, interestRate:0, notes:'' };
    const body = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label class="small muted">Nombre</label><input id="dName" value="${def.name}" /></div><div><label class="small muted">Banco</label><select id="dBank">${bankOpt}</select></div><div><label class="small muted">Saldo pendiente</label><input id="dOut" type="number" value="${Number(def.outstanding)||0}" /></div><div><label class="small muted">Cuota mensual</label><input id="dPay" type="number" value="${Number(def.monthlyPayment)||0}" /></div><div><label class="small muted">Tasa interés (%)</label><input id="dInterest" type="number" value="${Number(def.interestRate)||0}" /></div><div style="grid-column:1/3"><label class="small muted">Notas</label><input id="dNotes" value="${(def.notes||'').replace(/"/g,'&quot;')}" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="dCancel" class="btn ghost">Cancelar</button><button id="dSave" class="btn primary">Guardar deuda</button></div>`;
    showPanel(body);
    if(d) setTimeout(()=> $('#dBank').value = d.bankId||'',40);
    $('#dCancel').onclick = closePanel;
    $('#dSave').onclick = ()=> { const name=$('#dName').value.trim(), bankId=$('#dBank').value||null, out=Number($('#dOut').value)||0, pay=Number($('#dPay').value)||0, interest=Number($('#dInterest').value)||0, notes=$('#dNotes').value.trim(); if(!name) return alert('Nombre requerido'); if(d){ Object.assign(d,{name,bankId,outstanding:out,monthlyPayment:pay,interestRate:interest,notes}); persistLocal(); if(state.fsHelpers) schedulePushToCloud(); renderAll(); } else addDebt({name,bankId,outstanding:out,monthlyPayment:pay,interestRate:interest,notes}); closePanel(); };
  }

  function openDebtPayModal(debt){
    if(!debt) return alert('Deuda no encontrada');
    const bankOpt = state.data.banks.map(b=>`<option value="${b.id}">${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const body = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label class="small muted">Monto</label><input id="payAmount" type="number" value="${Math.min(Number(debt.monthlyPayment)||0, Number(debt.outstanding)||0)}" /></div><div><label class="small muted">Cuenta</label><select id="payBank">${bankOpt}</select></div><div style="grid-column:1/3"><label class="small muted">Descripción</label><input id="payDesc" value="Pago deuda ${debt.name}" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="payCancel" class="btn ghost">Cancelar</button><button id="paySave" class="btn primary">Registrar pago</button></div>`;
    showPanel(body);
    $('#payCancel').onclick = closePanel;
    $('#paySave').onclick = async ()=> { const amt=Number($('#payAmount').value)||0; const bankId=$('#payBank').value; const desc=$('#payDesc').value.trim(); if(!amt||amt<=0) return alert('Monto inválido'); await addTransaction({ type:'Egreso', amount:amt, bankId, debtId:debt.id, dateStr: toDDMMYYYY(new Date()), description: desc }); closePanel(); };
  }

  // ------------------------------
  // UI bindings (navigation, buttons, keyboard)
  // ------------------------------
  function bindUI(){
    // Navigation
    $$('nav.side button').forEach(b=> b.addEventListener('click', ()=> { $$('nav.side button').forEach(x=> x.classList.toggle('active', x===b)); document.querySelectorAll('main section').forEach(s=> s.style.display='none'); const view=document.getElementById('view-'+b.dataset.view); if(view) view.style.display='block'; }));
    // Bottom nav
    $$('#bottomNav button[data-view]').forEach(btn=> btn.addEventListener('click', ()=> { const v=btn.dataset.view; document.querySelector(`nav.side button[data-view="${v}"]`)?.click(); }));
    // Buttons
    $('#btnQuickTx').onclick = ()=> openTxModal(null);
    $('#fabAdd').onclick = ()=> openTxModal(null);
    $('#mobileAdd').onclick = ()=> openTxModal(null);
    $('#btnAddTx')?.addEventListener('click', ()=> openTxModal(null));
    $('#btnAddBank').onclick = ()=> openBankModal(null);
    $('#btnAddAsset').onclick = ()=> openAssetModal(null);
    $('#btnAddLiability').onclick = ()=> openLiabilityModal(null);
    $('#btnAddBiz').onclick = ()=> openBusinessModal(null);
    $('#btnAddFixed').onclick = ()=> openFixedModal(null);
    $('#btnAddDebt').onclick = ()=> openDebtModal(null);
    $('#btnAddCategory').onclick = ()=> openCategoryModal(null);
    $('#btnTransfer').onclick = ()=> openTransferModal();
    $('#btnApplyFixed').onclick = ()=> { if(confirm('Aplicar gastos fijos del mes?')) applyMonthlyFixed(); };
    $('#btnExportCSV').onclick = exportCSV;
    $('#btnExportJSON').onclick = exportJSON;
    $('#btnImport').onclick = ()=> importFile($('#fileImport').files[0]);
    $('#btnExportPDF').onclick = exportPDF;
    $('#fileImport').onchange = e => importFile(e.target.files[0]);
    $('#search')?.addEventListener('input', renderTransactions);
    $('#btnLogout').onclick = ()=> { if(confirm('Cerrar sesión y volver al login?')){ state.logged=false; state.user=null; $('#appWrap').style.display='none'; $('#loginScreen').style.display='flex'; showToast('Sesión cerrada'); } };
    $('#sidebarToggle').onclick = ()=> { const appEl = $('#app'); appEl.classList.toggle('collapsed'); };

    $('#btnSyncNow').onclick = async ()=>{
      $('#syncStatus').textContent='syncing';
      try{
        if(!state.fsHelpers){ await initFirestore(firebaseConfig); startRealtimeListener(); showToast('Firestore activado'); }
        const remote = await fsFetch();
        if(remote.data){
          state.data = mergeDatasets(state.data, remote.data);
          persistLocal();
          await fsSave(state.data);
          showToast('Sincronización manual completa');
        } else { await fsSave(state.data); showToast('Nube inicializada con datos locales'); }
      } catch(e){ console.error(e); showToast('Error sync: '+(e.message||e), true); } finally{ $('#syncStatus').textContent='idle'; renderAll(); }
    };

    $('#overlay').addEventListener('click', (e)=> { if(e.target.id === 'overlay') closePanel(); });

    // Keyboard: N -> nueva transacción
    window.addEventListener('keydown', (e)=> { if(e.key.toLowerCase()==='n' && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) openTxModal(null); });
  }

  function openTransferModal(){
    if(state.data.banks.length < 2) return alert('Necesitas al menos 2 cuentas');
    const opts = state.data.banks.map(b=>`<option value="${b.id}">${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const body = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div><label class="small muted">Desde</label><select id="trFrom">${opts}</select></div><div><label class="small muted">Hacia</label><select id="trTo">${opts}</select></div><div><label class="small muted">Monto</label><input id="trAmount" type="number" value="0" /></div><div><label class="small muted">Fecha</label><input id="trDate" value="${toDDMMYYYY(new Date())}" /></div><div style="grid-column:1/3"><label class="small muted">Nota</label><input id="trNote" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button id="trCancel" class="btn ghost">Cancelar</button><button id="trSave" class="btn primary">Transferir</button></div>`;
    showPanel(body);
    $('#trCancel').onclick = closePanel;
    $('#trSave').onclick = ()=> { const from=$('#trFrom').value, to=$('#trTo').value, amt=Number($('#trAmount').value)||0, dateStr=$('#trDate').value.trim(), note=$('#trNote').value.trim(); if(from===to) return alert('Elija cuentas distintas'); if(amt<=0) return alert('Monto inválido'); if(!parseDateDDMMYYYY(dateStr)) return alert('Fecha inválida'); transferBetweenBanks(from,to,amt,dateStr,note); closePanel(); };
  }

  // ------------------------------
  // Login flow (obligatorio)
  // - Al ingresar: intenta inicializar Firestore automáticamente y hace merge/push
  // ------------------------------
  function attachLogin(){
    $('#loginBtn').onclick = async ()=>{
      const u = $('#loginUser').value.trim(), p = $('#loginPass').value;
      if(u === LOCAL_LOGIN.user && p === LOCAL_LOGIN.pass){
        state.logged = true; state.user = u;
        $('#loginScreen').style.display = 'none'; $('#appWrap').style.display = 'flex';
        loadLocal();
        bindUI();
        renderAll();
        showToast('Sesión iniciada: ' + u);
        // Intentar conectar Firestore y sincronizar automáticamente
        try{
          await initFirestore(firebaseConfig);
          startRealtimeListener();
          $('#syncStatus').textContent = 'syncing';
          const remote = await fsFetch();
          if(remote.data){
            state.data = mergeDatasets(state.data, remote.data);
            persistLocal();
            await fsSave(state.data);
            showToast('Sincronización automática completa');
          } else {
            await fsSave(state.data);
            showToast('Nube inicializada con datos locales');
          }
        } catch(e){
          console.warn('Firestore init fail', e);
          showToast('No se pudo activar la nube automáticamente (modo local)', true);
        } finally { $('#syncStatus').textContent = 'idle'; renderAll(); }
      } else {
        alert('Credenciales incorrectas');
      }
    };
  }

  // ------------------------------
  // Inicio
  // ------------------------------
  (function init(){
    $('#appWrap').style.display = 'none';
    attachLogin();
    loadLocal();
    // seed small defaults if empty to improve UX
    if(!state.data.categories || state.data.categories.length===0){
      state.data.categories = [{ id: uid('cat'), name:'Alimentos', limitMonthly:1500, createdAt: nowISO() }, { id: uid('cat'), name:'Transporte', limitMonthly:400, createdAt: nowISO() }, { id: uid('cat'), name:'Servicios', limitMonthly:800, createdAt: nowISO() }];
      persistLocal();
    }
    // Keep UI minimal until login
  })();

  // ------------------------------
  // Reglas recomendadas Firestore (COMENTADAS)
  // - Ruta: organizations/{orgId}/DATA/DATA
  // ------------------------------
  /*
    // Reglas (recomendado): requiere auth + claim orgId
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /organizations/{orgId}/DATA/DATA {
          allow read, write: if request.auth != null && request.auth.token.orgId == orgId;
        }
      }
    }

    // Desarrollo (NO recomendado): abierto (solo para pruebas)
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /organizations/{orgId}/DATA/DATA {
          allow read, write: if true; // PELIGRO: abierto al mundo
        }
      }
    }

    // Si deseas restringir a UID específico (necesita auth):
    allow read, write: if request.auth != null && request.auth.uid == 'x9k6xvQAqGdS4MrIuivaLqPFbHR2';
  */
  </script>
</body>
</html>

