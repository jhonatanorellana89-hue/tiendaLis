<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control Económico — v3 (Todas mejoras)</title>
  <link href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css" rel="stylesheet">
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--muted:#6b7280;--accent:#0f766e}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); margin:0; color:#0f172a}
    .wrap{max-width:1200px;margin:18px auto;padding:14px}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:14px;margin-top:14px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(12,16,35,0.06)}
    .menu button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer}
    .menu button.active{background:#eefbf9}
    .menu{position:sticky;top:18px}
    label{display:block;font-size:13px;margin-top:8px;color:var(--muted)}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #f1f3f6;text-align:left}
    th.sortable{cursor:pointer}
    .row{display:flex;gap:8px}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f8f6;font-weight:600}
    .kpi{display:flex;gap:12px;align-items:center}
    .kpi .value{font-size:18px;font-weight:700}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:1px solid #e6e9ef}
    footer{margin-top:14px;font-size:13px;color:var(--muted)}
    .notif{padding:8px;border-radius:8px;background:#fff7ed;border:1px solid #ffe1b8;font-size:13px}
    .progress{height:12px;border-radius:999px;background:#f1f3f5;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#0f766e,#34d399)}
    .time-meter{position:fixed;top:18px;right:18px;background:var(--card);padding:8px;border-radius:10px;box-shadow:0 8px 20px rgba(12,16,35,0.08);z-index:1200;display:flex;gap:8px;align-items:center}
    .time-meter .small{font-size:13px;color:var(--muted)}
    .badge{display:inline-block;padding:6px 8px;border-radius:6px;background:#eefbf9;color:#055e52;font-weight:700;margin-right:6px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center}
    .modal{background:#fff;padding:16px;border-radius:12px;max-width:520px;width:90%}
    @media (max-width:880px){.grid{grid-template-columns:1fr} .menu{position:relative;top:auto}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="card" style="padding:10px;display:inline-block">
        <div style="display:flex;align-items:center;gap:8px"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 24 24'%3E%3Cpath fill='%230f766e' d='M12 2L3 7v7c0 5 3.5 9.7 9 11 5.5-1.3 9-6 9-11V7l-9-5z'/%3E%3C/svg%3E" alt="logo"><div>
          <div style="font-weight:700">Control Económico — v3</div>
          <div class="muted">Todas las mejoras: historial persistente, simulador, proyección 12 meses, recorte automático, PWA-ready</div>
        </div></div>
      </div>
      <div style="margin-left:auto" class="muted">Guardado en localStorage — exportable</div>
    </header>

    <!-- Time meter visible always -->
    <div class="time-meter" id="timeMeter">
      <button class="btn" id="prevMonth" title="Mes anterior">◀</button>
      <div style="min-width:160px;text-align:center">
        <div class="small">Mes</div>
        <div id="tmCurrent" style="font-weight:700">--</div>
        <div id="tmSub" class="small">Balance: S/ 0</div>
      </div>
      <button class="btn primary" id="nextMonth" title="Siguiente mes">▶</button>
      <button class="btn ghost" id="playMonth" title="Auto-play">►</button>
      <button class="btn ghost" id="undoMonth" title="Deshacer último avance">↶</button>
    </div>

    <div class="grid">
      <aside class="card menu" style="height:fit-content">
        <button id="btnDashboard" class="active">Dashboard</button>
        <button id="btnActivos">Activos</button>
        <button id="btnPasivos">Pasivos</button>
        <button id="btnGastos">Gastos</button>
        <button id="btnIngresos">Ingresos</button>
        <button id="btnMetas">Metas / Ahorro</button>
        <button id="btnSimulador">Simulador</button>
        <button id="btnReportes">Reportes / Export</button>
        <hr>
        <div class="muted">Ajustes rápidos</div>
        <div style="margin-top:8px" class="actions">
          <button class="btn ghost" id="btnExport">Exportar JSON</button>
          <button class="btn ghost" id="btnImport">Importar JSON</button>
          <button class="btn ghost" id="btnClear">Borrar todo</button>
        </div>
      </aside>

      <main>
        <!-- Dashboard -->
        <section id="dashboard" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">Resumen mensual</h2>
              <div class="muted">Medidor de tiempo: avanza mes a mes para simular tu flujo</div>
            </div>
            <div class="row">
              <div class="muted">Mes actual: <span id="currentMonth"></span></div>
              <button class="btn primary" id="advanceMonth">Avanzar mes</button>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px">
            <div class="card" style="padding:12px">
              <div class="muted">Balance disponible</div>
              <div class="value" id="kpiBalance">S/ 0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Ahorros</div>
              <div class="value" id="kpiSavings">S/ 0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Ingreso pasivo</div>
              <div class="value" id="kpiPassive">S/ 0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Gastos fijos + Pasivos</div>
              <div class="value" id="kpiFixedOut">S/ 0</div>
            </div>
          </div>

          <div style="margin-top:12px" class="card">
            <canvas id="cashChart" height="120"></canvas>
          </div>

          <div style="margin-top:12px" id="notifications"></div>

          <div style="margin-top:12px" class="card">
            <strong>Logros</strong>
            <div id="badges" style="margin-top:8px"></div>
          </div>
        </section>

        <!-- Activos -->
        <section id="activos" class="card" style="display:none">
          <h3>Activos</h3>
          <div class="muted">Registra tus activos y el ingreso mensual que generan</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Nombre del activo</label>
              <input id="assetName" placeholder="Ej: Departamento alquiler">
              <label>Tipo</label>
              <input id="assetType" placeholder="Propiedad / Inversión">
              <label>Valor del activo</label>
              <input id="assetValue" type="number" placeholder="monto">
              <label>Ingreso mensual estimado</label>
              <input id="assetIncome" type="number" placeholder="monto mensual">
              <label>Notas</label>
              <textarea id="assetNotes" rows="2"></textarea>
              <div style="margin-top:8px"><button class="btn primary" id="addAsset">Agregar activo</button></div>
            </div>
            <div style="flex:1">
              <div style="height:320px;overflow:auto">
                <table id="tableAssets"><thead><tr><th class='sortable' data-table='assets' data-key='name'>Activo ▾</th><th class='sortable' data-table='assets' data-key='value'>Valor</th><th class='sortable' data-table='assets' data-key='income'>Ingreso/m</th><th></th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </section>

        <!-- Pasivos -->
        <section id="pasivos" class="card" style="display:none">
          <h3>Pasivos</h3>
          <div class="muted">Registra deudas, préstamos y sus cuotas mensuales</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Concepto</label>
              <input id="liabName" placeholder="Ej: Préstamo vehicular">
              <label>Valor total</label>
              <input id="liabTotal" type="number">
              <label>Cuota mensual</label>
              <input id="liabMonthly" type="number">
              <label>Fecha inicio</label>
              <input id="liabStart" type="month">
              <label>Fecha fin (opcional)</label>
              <input id="liabEnd" type="month">
              <div style="margin-top:8px"><button class="btn primary" id="addLiab">Agregar pasivo</button></div>
            </div>
            <div style="flex:1">
              <div style="height:320px;overflow:auto">
                <table id="tableLiabs"><thead><tr><th class='sortable' data-table='liabs' data-key='name'>Pasivo ▾</th><th class='sortable' data-table='liabs' data-key='total'>Total</th><th class='sortable' data-table='liabs' data-key='monthly'>Cuota/m</th><th></th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </section>

        <!-- Gastos -->
        <section id="gastos" class="card" style="display:none">
          <h3>Gastos</h3>
          <div class="muted">Registra gastos recurrentes o puntuales</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Nombre del gasto</label>
              <input id="expenseName">
              <label>Monto</label>
              <input id="expenseAmount" type="number">
              <label>Tipo</label>
              <select id="expenseType"><option value="fijo">Fijo (mensual)</option><option value="variable">Variable</option><option value="meta">Meta</option></select>
              <label>Mes inicial (para recurrente)</label>
              <input id="expenseMonthStart" type="month">
              <label>Presupuesto máximo (opcional)</label>
              <input id="expenseBudget" type="number" placeholder="limite mensual">
              <div style="margin-top:8px"><button class="btn primary" id="addExpense">Agregar gasto</button></div>
            </div>
            <div style="flex:1">
              <div style="height:320px;overflow:auto">
                <table id="tableExpenses"><thead><tr><th class='sortable' data-table='expenses' data-key='name'>Gasto ▾</th><th class='sortable' data-table='expenses' data-key='amount'>Monto</th><th class='sortable' data-table='expenses' data-key='type'>Tipo</th><th></th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </section>

        <!-- Ingresos -->
        <section id="ingresos" class="card" style="display:none">
          <h3>Ingresos</h3>
          <div class="muted">Registra ingresos mensuales (salario, freelance, ventas, o ingresos generados por activos)</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Concepto</label>
              <input id="incomeName">
              <label>Monto</label>
              <input id="incomeAmount" type="number">
              <label>Frecuencia</label>
              <select id="incomeFreq"><option value="mensual">Mensual</option><option value="unica">Única</option></select>
              <div style="margin-top:8px"><button class="btn primary" id="addIncome">Agregar ingreso</button></div>
            </div>
            <div style="flex:1">
              <div style="height:320px;overflow:auto">
                <table id="tableIncomes"><thead><tr><th class='sortable' data-table='incomes' data-key='name'>Ingreso ▾</th><th class='sortable' data-table='incomes' data-key='amount'>Monto</th><th class='sortable' data-table='incomes' data-key='freq'>Freq</th><th></th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
          <div style="margin-top:10px" class="muted">Ajustes de asignación automática al recibir un ingreso:</div>
          <div class="row" style="margin-top:6px;gap:6px">
            <label style="width:160px">% Ahorro</label><input id="settSavingsPct" type="number" value="20" style="width:80px">
            <label style="width:160px">% Reservado gastos</label><input id="settReservePct" type="number" value="10" style="width:80px">
            <label style="width:160px">% Recorte variable (si balance negativo)</label><input id="settCutPct" type="number" value="20" style="width:80px">
          </div>
        </section>

        <!-- Metas y Ahorro -->
        <section id="metas" class="card" style="display:none">
          <h3>Metas y Ahorro</h3>
          <div class="muted">Define metas de ahorro y muestra progreso</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Nombre de la meta</label>
              <input id="goalName">
              <label>Monto objetivo</label>
              <input id="goalAmount" type="number">
              <label>Fecha objetivo</label>
              <input type="date" id="goalDate">
              <label>Prioridad</label>
              <select id="goalPriority"><option value="high">Alta</option><option value="medium">Media</option><option value="low">Baja</option></select>
              <div style="margin-top:8px"><button class="btn primary" id="addGoal">Agregar meta</button></div>
            </div>
            <div style="flex:1">
              <div id="goalsList" style="height:320px;overflow:auto"></div>
            </div>
          </div>
        </section>

        <!-- Simulador -->
        <section id="simulador" class="card" style="display:none">
          <h3>Simulador de escenarios</h3>
          <div class="muted">Prueba escenarios y compara proyecciones sin tocar tus datos reales</div>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <label>Escenario</label>
              <select id="scenarioSelect"><option value="lossJob">Pérdida de empleo (N meses)</option><option value="oneExpense">Gasto imprevisto (único)</option><option value="incomeRise">Aumento de ingresos (%)</option></select>
              <label>Duración / Valor (según escenario)</label>
              <input id="scenarioValue" placeholder="p.ej: 3 (meses) o 1000 (S/)">
              <div style="margin-top:8px"><button class="btn primary" id="runScenario">Ejecutar simulación 12 meses</button></div>
            </div>
            <div style="flex:1">
              <div id="simResult" style="height:320px;overflow:auto"></div>
            </div>
          </div>
          <div style="margin-top:12px" class="card">
            <canvas id="simChart" height="150"></canvas>
          </div>
        </section>

        <!-- Reportes -->
        <section id="reportes" class="card" style="display:none">
          <h3>Reportes / Export</h3>
          <div class="muted">Exporta e importa tu base en JSON. Descarga CSV por mes y proyección 12 meses.</div>
          <div style="margin-top:8px" class="row">
            <button class="btn primary" id="downloadJSON">Descargar JSON</button>
            <button class="btn" id="downloadCSV">Descargar CSV resúmen</button>
            <button class="btn" id="downloadForecastCSV">Exportar proyección 12 meses (CSV)</button>
            <input type="file" id="fileImport" style="display:none">
          </div>
          <div style="margin-top:12px" id="reportPreview"></div>
          <div style="margin-top:12px" class="card"><canvas id="forecastChart" height="160"></canvas></div>
        </section>

        <footer class="muted">v3 — Implementa mejoras: hist. persistente, reparto por prioridad, simulador, proyecciones, recortes automáticos, atajos y más.</footer>
      </main>
    </div>
  </div>

  <!-- Modal container (reusable) -->
  <div id="modalRoot" style="display:none"></div>

<script>
// --- CONSTANTS ---
const STORAGE_KEY = 'ce_v3_app_v1';
const MAX_HISTORY = 48; // months
let playInterval = null;

// --- INITIAL STATE ---
let state = {
  balance:0,
  savings:0,
  reservedBudget:0,
  assets:[],
  liabilities:[],
  expenses:[],
  incomes:[],
  goals:[],
  settings: { savingsPct:20, reservePct:10, cutPct:20, autoplayMs:900 },
  currentDate: new Date().toISOString().slice(0,10),
  history: [] // persistent history snapshots
};

function uid(pref='id'){return pref + '_' + Math.random().toString(36).slice(2,9)}

// --- Persistence ---
function save(){localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); renderAll();}
function load(){const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = JSON.parse(raw);} 
function clearAll(){ if(!confirm('Borrar todos los datos guardados?')) return; state = { balance:0,savings:0,reservedBudget:0,assets:[],liabilities:[],expenses:[],incomes:[],goals:[],settings:{savingsPct:20,reservePct:10,cutPct:20,autoplayMs:900},currentDate:new Date().toISOString().slice(0,10),history:[] }; save(); }

// --- DOM helpers ---
function $ (id){ return document.getElementById(id); }
function formatCurrency(v){ return `S/ ${Number(v||0).toLocaleString()}`; }
function formatMonthYear(iso){ const d=new Date(iso); return d.toLocaleString('es-PE',{month:'long',year:'numeric'}); }

// --- History (persistent) ---
function pushHistorySnapshot(){ try{ const snap = JSON.stringify(state); state.history = state.history || []; state.history.push(snap); if(state.history.length > MAX_HISTORY) state.history.shift(); }catch(e){ console.error('history push',e); } }
function undoHistory(){ if(!state.history || state.history.length===0){ addNotification('No hay historial para deshacer'); return; } const snap = state.history.pop(); try{ state = JSON.parse(snap); addNotification('Se deshizo el último avance de mes (historial persistente)'); save(); }catch(e){ addNotification('Error al deshacer'); } }

// --- Notifications ---
function addNotification(txt, ttl=9000){ const n = document.createElement('div'); n.className='notif'; n.style.marginTop='8px'; n.innerText = txt; $('notifications').prepend(n); setTimeout(()=>{ try{ n.remove(); }catch(e){} }, ttl); }

// --- CRUD render functions with sorting support ---
function attachSortHeaders(){ document.querySelectorAll('th.sortable').forEach(th=>{ th.addEventListener('click',()=>{ const table = th.dataset.table; const key = th.dataset.key; sortTable(table,key); }); }); }

function sortTable(table,key){ const mapping = { assets: state.assets, liabs: state.liabilities, expenses: state.expenses, incomes: state.incomes }; const arr = mapping[table]; if(!arr) return; arr.sort((a,b)=>{ const va = (a[key]||'').toString(); const vb = (b[key]||'').toString(); if(!isNaN(Number(va)) && !isNaN(Number(vb))) return Number(va)-Number(vb); return va.localeCompare(vb); }); save(); }

function renderAssets(){ const tbody = $('tableAssets').querySelector('tbody'); tbody.innerHTML=''; state.assets.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${a.name}</td><td>${Number(a.value).toLocaleString()}</td><td>${Number(a.income).toLocaleString()}</td><td><button class='btn ghost' onclick='removeAsset("${a.id}")'>Eliminar</button></td>`; tbody.appendChild(tr); }); }
function renderLiabs(){ const tbody = $('tableLiabs').querySelector('tbody'); tbody.innerHTML=''; state.liabilities.forEach(l=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${l.name}</td><td>${Number(l.total).toLocaleString()}</td><td>${Number(l.monthly).toLocaleString()}</td><td><button class='btn ghost' onclick='removeLiab("${l.id}")'>Eliminar</button></td>`; tbody.appendChild(tr); }); }
function renderExpenses(){ const tbody = $('tableExpenses').querySelector('tbody'); tbody.innerHTML=''; state.expenses.forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${e.name}</td><td>${Number(e.amount).toLocaleString()}</td><td>${e.type}</td><td><button class='btn ghost' onclick='removeExpense("${e.id}")'>Eliminar</button></td>`; tbody.appendChild(tr); }); }
function renderIncomes(){ const tbody = $('tableIncomes').querySelector('tbody'); tbody.innerHTML=''; state.incomes.forEach(i=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i.name}</td><td>${Number(i.amount).toLocaleString()}</td><td>${i.freq}</td><td><button class='btn ghost' onclick='removeIncome("${i.id}")'>Eliminar</button></td>`; tbody.appendChild(tr); }); }
function renderGoals(){ const el = $('goalsList'); el.innerHTML=''; state.goals.forEach(g=>{ const saved = g.saved || 0; const pct = g.amount ? Math.min(100, Math.round((saved / g.amount)*100)) : 0; const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${g.name}</strong><div>${Number(saved).toLocaleString()}/${Number(g.amount).toLocaleString()}</div></div><div class='progress' style='margin-top:6px'><i style='width:${pct}%'></i></div><div class='muted' style='margin-top:6px'>Prioridad: ${g.priority || 'media'} • Objetivo: ${g.date || 'sin fecha'}</div>`; el.appendChild(div); }); }

// --- CRUD actions ---
function setupEventListeners(){ // ensure called after DOM ready
  $('addAsset').addEventListener('click',()=>{ const name=$('assetName').value.trim(); const type=$('assetType').value.trim(); const value=Number($('assetValue').value)||0; const income=Number($('assetIncome').value)||0; const notes=$('assetNotes').value; if(!name) return alert('Nombre requerido'); state.assets.push({id:uid('a'),name,type,value,income,notes}); save(); $('assetName').value='';$('assetValue').value='';$('assetIncome').value='';$('assetNotes').value=''; addNotification('Activo agregado'); });

  $('addLiab').addEventListener('click',()=>{ const name=$('liabName').value.trim(); const total=Number($('liabTotal').value)||0; const monthly=Number($('liabMonthly').value)||0; const start=$('liabStart').value; const end=$('liabEnd').value; if(!name) return alert('Nombre requerido'); state.liabilities.push({id:uid('l'),name,total,monthly,start,end}); save(); $('liabName').value='';$('liabTotal').value='';$('liabMonthly').value='';$('liabStart').value='';$('liabEnd').value=''; addNotification('Pasivo agregado'); });

  $('addExpense').addEventListener('click',()=>{ const name=$('expenseName').value.trim(); const amount=Number($('expenseAmount').value)||0; const type=$('expenseType').value; const monthStart=$('expenseMonthStart').value; const budget=Number($('expenseBudget').value)||null; if(!name) return alert('Nombre requerido'); state.expenses.push({id:uid('ex'),name,amount,type,monthStart,budget}); save(); $('expenseName').value='';$('expenseAmount').value='';$('expenseBudget').value=''; addNotification('Gasto agregado'); });

  $('addIncome').addEventListener('click',()=>{ const name=$('incomeName').value.trim(); const amount=Number($('incomeAmount').value)||0; const freq=$('incomeFreq').value; if(!name) return alert('Nombre requerido'); const incomeObj={id:uid('in'),name,amount,freq}; state.incomes.push(incomeObj);
    applyImmediateAllocation(amount); save(); $('incomeName').value='';$('incomeAmount').value=''; addNotification('Ingreso agregado y asignado'); });

  $('addGoal').addEventListener('click',()=>{ const name=$('goalName').value.trim(); const amount=Number($('goalAmount').value)||0; const date=$('goalDate').value; const priority=$('goalPriority').value; if(!name) return alert('Nombre requerido'); state.goals.push({id:uid('g'),name,amount,date,priority,saved:0}); save(); $('goalName').value='';$('goalAmount').value='';$('goalDate').value=''; addNotification('Meta agregada'); });

  $('btnExport').addEventListener('click',()=>downloadJSON());
  $('downloadJSON').addEventListener('click',()=>downloadJSON());
  function downloadJSON(){ const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='control_economico_v3_export.json'; a.click(); addNotification('Exportado JSON'); }

  $('btnImport').addEventListener('click',()=>$('fileImport').click());
  $('fileImport').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; if(!confirm('Importar reemplazará tus datos actuales, ¿continuar?')) return; const r=new FileReader(); r.onload=ev=>{ try{ state = JSON.parse(ev.target.result); addNotification('Importado con éxito'); save(); }catch(err){alert('JSON inválido'); }}; r.readAsText(f); });

  $('btnClear').addEventListener('click',()=>clearAll());

  $('downloadCSV').addEventListener('click',()=>{ const lines=['Tipo,Nombre,Monto']; state.assets.forEach(a=>lines.push(`Activo,${a.name},${a.income}`)); state.incomes.forEach(i=>lines.push(`Ingreso,${i.name},${i.amount}`)); state.expenses.forEach(e=>lines.push(`Gasto,${e.name},${e.amount}`)); state.liabilities.forEach(l=>lines.push(`Pasivo,${l.name},${l.monthly}`)); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='resumen_ce_v3.csv'; a.click(); addNotification('CSV descargado'); });

  $('downloadForecastCSV').addEventListener('click',()=>{ const forecast = simulateForecast(12); const rows = ['Mes,Balance,Ahorros,Ingreso_pasivo,Gastos_fijos']; forecast.forEach(r=> rows.push(`${r.label},${r.balance.toFixed(2)},${r.savings.toFixed(2)},${r.passive.toFixed(2)},${r.fixed.toFixed(2)}`)); const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='proyeccion_12m.csv'; a.click(); addNotification('Proyección 12 meses (CSV) descargada'); });

  // Menú anchors
  const btnMap = {btnDashboard:'dashboard',btnActivos:'activos',btnPasivos:'pasivos',btnGastos:'gastos',btnIngresos:'ingresos',btnMetas:'metas',btnSimulador:'simulador',btnReportes:'reportes'};
  Object.keys(btnMap).forEach(bid=>{ const el = $(bid); if(!el) return; el.addEventListener('click',()=>{ show(btnMap[bid]); location.hash = btnMap[bid]; }); });

  // Time meter / month controls
  $('nextMonth').addEventListener('click',()=>{ changeMonth(1); save(); });
  $('prevMonth').addEventListener('click',()=>{ if(confirm('¿Deshacer último avance?')) undoHistory(); });
  $('undoMonth').addEventListener('click',()=>{ if(confirm('¿Deshacer último avance?')) undoHistory(); });
  $('advanceMonth').addEventListener('click',()=>{ changeMonth(1); save(); });
  $('playMonth').addEventListener('click',()=>{ toggleAutoPlay(); });

  // Scenario
  $('runScenario').addEventListener('click',()=>{ runScenario(); });

  // sortable header attachment
  attachSortHeaders();

  // keyboard shortcuts
  window.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key==='ArrowRight'){ e.preventDefault(); changeMonth(1); save(); } if(e.ctrlKey && e.key==='ArrowLeft'){ e.preventDefault(); undoHistory(); } if(e.ctrlKey && (e.key==='n' || e.key==='N')){ e.preventDefault(); show('ingresos'); $('incomeName').focus(); } });
}

// --- Remove helpers (window accessible) ---
window.removeAsset = function(id){ state.assets = state.assets.filter(a=>a.id!==id); save(); addNotification('Activo eliminado'); }
window.removeLiab = function(id){ state.liabilities = state.liabilities.filter(l=>l.id!==id); save(); addNotification('Pasivo eliminado'); }
window.removeExpense = function(id){ state.expenses = state.expenses.filter(e=>e.id!==id); save(); addNotification('Gasto eliminado'); }
window.removeIncome = function(id){ state.incomes = state.incomes.filter(i=>i.id!==id); save(); addNotification('Ingreso eliminado'); }
window.removeGoal = function(id){ state.goals = state.goals.filter(g=>g.id!==id); save(); addNotification('Meta eliminada'); }

// --- Allocation & monthly processing logic ---
function applyImmediateAllocation(amount){ const sPct = state.settings.savingsPct/100; const rPct = state.settings.reservePct/100; const sAmt = amount * sPct; const rAmt = amount * rPct; state.savings += sAmt; state.reservedBudget += rAmt; state.balance += (amount - sAmt - rAmt); }

function changeMonth(delta){ if(delta>0){ for(let i=0;i<delta;i++) advanceMonthInternal(); } else { undoHistory(); } }

function advanceMonthInternal(){ pushHistorySnapshot(); const cur = new Date(state.currentDate); const next = new Date(cur.getFullYear(), cur.getMonth()+1, 1); state.currentDate = next.toISOString().slice(0,10);
  // incomes
  const monthlyIncomes = state.incomes.reduce((s,i)=> s + ((i.freq==='mensual')?Number(i.amount||0):0),0);
  const passiveFromAssets = state.assets.reduce((s,a)=> s + Number(a.income||0),0);
  const totalNewIncome = monthlyIncomes + passiveFromAssets;
  const savingsAlloc = totalNewIncome * (state.settings.savingsPct/100);
  const reservedAlloc = totalNewIncome * (state.settings.reservePct/100);
  state.savings += savingsAlloc; state.reservedBudget += reservedAlloc; state.balance += (totalNewIncome - savingsAlloc - reservedAlloc);

  // gastos fijos
  const checkDate = new Date(state.currentDate);
  let totalFixed=0;
  state.expenses.forEach(e=>{ if(e.type==='fijo'){ if(!e.monthStart) { totalFixed += Number(e.amount||0);} else { const s = new Date(e.monthStart + '-01'); if(checkDate >= s) totalFixed += Number(e.amount||0); } } });
  state.balance -= totalFixed;

  // pasivos
  const totalLiabMonthly = state.liabilities.reduce((s,l)=> s + Number(l.monthly||0),0);
  state.balance -= totalLiabMonthly;

  // aplicar recorte automático si balance < 0
  if(state.balance < 0){ const cutPct = state.settings.cutPct/100; autoCutVariables(cutPct); }

  // asignar reservas a metas por prioridad
  allocateReservedToGoals();

  addNotification(`Mes: ${formatMonthYear(state.currentDate)} — ingresos S/ ${totalNewIncome.toFixed(2)}, ahorrado S/ ${savingsAlloc.toFixed(2)}, fijos S/ ${totalFixed.toFixed(2)}, cuotas S/ ${totalLiabMonthly.toFixed(2)}`);
}

function autoCutVariables(cutPct){ // reduce gastos variables y metas (variable type) hasta intentar equilibrar
  let deficit = Math.abs(state.balance);
  const variableExpenses = state.expenses.filter(e=> e.type==='variable');
  // evenly reduce variables by cutPct
  for(const e of variableExpenses){ const reduce = e.amount * cutPct; e.amount = Math.max(0, Number(e.amount) - reduce); deficit -= reduce; }
  if(deficit>0){ // reduce reservedBudget if needed
    state.reservedBudget = Math.max(0, state.reservedBudget - deficit); deficit = 0;
  }
  state.balance = Math.max(0, state.balance + Math.abs(state.balance)); // conservative set to zero
  addNotification(`Recorte automático aplicado (${Math.round(cutPct*100)}%) a gastos variables para equilibrar`);
}

function allocateReservedToGoals(){ if(state.reservedBudget <= 0) return; const targets = state.goals.filter(g=> (g.saved || 0) < g.amount ); if(targets.length===0) return; // prioritize by priority then % faltante
  targets.sort((a,b)=>{ const pr={high:3,medium:2,low:1}; if(pr[b.priority||'medium'] !== pr[a.priority||'medium']) return pr[b.priority||'medium']-pr[a.priority||'medium']; const faltA = (a.amount - (a.saved||0))/a.amount; const faltB = (b.amount - (b.saved||0))/b.amount; return faltB - faltA; });
  let remaining = state.reservedBudget;
  for(const t of targets){ if(remaining<=0) break; const need = t.amount - (t.saved || 0); const take = Math.min(need, remaining); t.saved = (t.saved || 0) + take; remaining -= take; }
  state.reservedBudget = remaining;
}

// --- Forecast / Simulator (non-destructive) ---
function simulateForecast(months=12, baseState=null, scenario=null){ const s = JSON.parse(JSON.stringify(baseState || state)); const results = []; for(let m=0;m<months;m++){ const monthLabel = formatMonthYear(s.currentDate); const monthlyIncomes = s.incomes.reduce((sum,i)=> sum + ((i.freq==='mensual')?Number(i.amount||0):0),0); const passiveFromAssets = s.assets.reduce((sum,a)=> sum + Number(a.income||0),0); let totalNewIncome = monthlyIncomes + passiveFromAssets; if(scenario){ if(scenario.type==='lossJob' && m < (scenario.duration||0)){ totalNewIncome = passiveFromAssets; } if(scenario.type==='incomeRise'){ totalNewIncome = totalNewIncome * (1 + (scenario.value||0)/100); } }
    const savingsAlloc = totalNewIncome * (s.settings.savingsPct/100); const reservedAlloc = totalNewIncome * (s.settings.reservePct/100); s.savings = (s.savings||0) + savingsAlloc; s.reservedBudget = (s.reservedBudget||0) + reservedAlloc; s.balance = (s.balance||0) + (totalNewIncome - savingsAlloc - reservedAlloc);
    let totalFixed=0; const checkDate = new Date(s.currentDate); s.expenses.forEach(e=>{ if(e.type==='fijo'){ if(!e.monthStart) totalFixed += Number(e.amount||0); else { const st = new Date(e.monthStart+'-01'); if(checkDate >= st) totalFixed += Number(e.amount||0); } } });
    s.balance -= totalFixed;
    const totalLiabMonthly = s.liabilities.reduce((sum,l)=> sum + Number(l.monthly||0),0); s.balance -= totalLiabMonthly;
    if(s.balance < 0){ const cutPct = s.settings.cutPct/100; s.expenses.forEach(e=>{ if(e.type==='variable'){ e.amount = Math.max(0, Number(e.amount) - (e.amount*cutPct)); } }); s.balance = Math.max(0, s.balance); }
    const targets = s.goals.filter(g=> (g.saved || 0) < g.amount ); if(targets.length>0 && s.reservedBudget>0){ const per = s.reservedBudget / targets.length; targets.forEach(t=> t.saved = (t.saved||0) + per); s.reservedBudget = 0; }
    results.push({label:monthLabel, balance: s.balance, savings: s.savings, passive: passiveFromAssets, fixed: totalFixed});
    const cur = new Date(s.currentDate); const next = new Date(cur.getFullYear(), cur.getMonth()+1, 1); s.currentDate = next.toISOString().slice(0,10);
  }
  return results; }

function runScenario(){ const sel = $('scenarioSelect').value; const val = Number($('scenarioValue').value) || 0; let scenario = null; if(sel==='lossJob'){ scenario = { type:'lossJob', duration: val || 3 }; } if(sel==='oneExpense'){ scenario = { type:'oneExpense', value: val || 1000 }; } if(sel==='incomeRise'){ scenario = { type:'incomeRise', value: val || 10 }; }
  const base = JSON.parse(JSON.stringify(state)); const forecast = simulateForecast(12, base, scenario);
  const el = $('simResult'); el.innerHTML = '<table><thead><tr><th>Mes</th><th>Balance</th><th>Ahorros</th><th>Ingreso pasivo</th><th>Gastos fijos</th></tr></thead><tbody>' + forecast.map(r=>`<tr><td>${r.label}</td><td>${r.balance.toFixed(2)}</td><td>${r.savings.toFixed(2)}</td><td>${r.passive.toFixed(2)}</td><td>${r.fixed.toFixed(2)}</td></tr>`).join('') + '</tbody></table>';
  const ctx = $('simChart').getContext('2d'); if(window.simChart) window.simChart.destroy(); window.simChart = new Chart(ctx,{type:'line',data:{labels:forecast.map(f=>f.label),datasets:[{label:'Balance',data:forecast.map(f=>f.balance)},{label:'Ahorros',data:forecast.map(f=>f.savings)}]},options:{responsive:true}});
}

// --- Auto-play controls ---
function toggleAutoPlay(){ if(playInterval){ clearInterval(playInterval); playInterval = null; $('playMonth').innerText = '►'; addNotification('Auto-play detenido'); } else { playInterval = setInterval(()=>{ changeMonth(1); save(); }, state.settings.autoplayMs || 900); $('playMonth').innerText = '⏸'; addNotification('Auto-play iniciado'); } }

// --- Achievements ---
function checkAchievements(){ const badges = []; if(state.savings > 0) badges.push('Ahorro iniciado'); if(state.savings > 1000) badges.push('Ahorro > S/ 1,000'); const passive = state.assets.reduce((s,a)=> s + Number(a.income||0),0); const fixed = state.expenses.reduce((s,e)=> s + ((e.type==='fijo')?Number(e.amount||0):0),0) + state.liabilities.reduce((s,l)=> s + Number(l.monthly||0),0); if(passive > fixed) badges.push('Ingreso pasivo > gastos fijos'); const el = $('badges'); el.innerHTML = badges.map(b=>`<span class='badge'>${b}</span>`).join(''); }

// --- Dashboard rendering and chart ---
let chart=null;
function renderDashboard(){ $('currentMonth').innerText = formatMonthYear(state.currentDate); $('tmCurrent').innerText = formatMonthYear(state.currentDate); $('tmSub').innerText = `Balance: ${formatCurrency(state.balance)}`; $('kpiBalance').innerText = formatCurrency(state.balance); $('kpiSavings').innerText = formatCurrency(state.savings); const passive = state.assets.reduce((s,a)=> s + Number(a.income||0),0); $('kpiPassive').innerText = formatCurrency(passive); const fixed = state.expenses.reduce((s,e)=> s + ((e.type==='fijo')?Number(e.amount||0):0),0) + state.liabilities.reduce((s,l)=> s + Number(l.monthly||0),0); $('kpiFixedOut').innerText = formatCurrency(fixed);
  const labels = ['Balance','Ahorros','Ingreso pasivo','Fijos+Cuotas']; const data = [state.balance, state.savings, passive, fixed]; const ctx = $('cashChart').getContext('2d'); if(chart) chart.destroy(); chart = new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'S/ (resumen)',data}]}, options:{responsive:true,plugins:{legend:{display:false}}}});
  checkAchievements(); }

function renderReportPreview(){ $('reportPreview').innerHTML = `<div class='muted'>Activos: ${state.assets.length} • Ingresos: ${state.incomes.length} • Gastos: ${state.expenses.length} • Pasivos: ${state.liabilities.length} • Metas: ${state.goals.length}</div>`; const f12 = simulateForecast(12); const ctx = $('forecastChart').getContext('2d'); if(window.forecastChart) window.forecastChart.destroy(); window.forecastChart = new Chart(ctx,{type:'line',data:{labels:f12.map(r=>r.label),datasets:[{label:'Balance',data:f12.map(r=>r.balance)},{label:'Ahorros',data:f12.map(r=>r.savings)}]},options:{responsive:true}}); }

function renderAll(){ renderAssets(); renderLiabs(); renderExpenses(); renderIncomes(); renderGoals(); renderDashboard(); renderReportPreview(); $('settSavingsPct').value = state.settings.savingsPct; $('settReservePct').value = state.settings.reservePct; $('settCutPct').value = state.settings.cutPct; }

// --- Navigation ---
function show(section){ ['dashboard','activos','pasivos','gastos','ingresos','metas','simulador','reportes'].forEach(s=>{ const el=$(s); if(el) el.style.display = (s===section?'block':'none'); }); document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active')); const map={dashboard:'btnDashboard',activos:'btnActivos',pasivos:'btnPasivos',gastos:'btnGastos',ingresos:'btnIngresos',metas:'btnMetas',simulador:'btnSimulador',reportes:'btnReportes'}; const bid = map[section]; if(bid && $(bid)) $(bid).classList.add('active'); }

// --- Init ---
window.addEventListener('DOMContentLoaded',()=>{ load(); // normalize
  state.balance = Number(state.balance||0); state.savings = Number(state.savings||0); state.reservedBudget = Number(state.reservedBudget||0); if(!state.settings) state.settings={savingsPct:20,reservePct:10,cutPct:20,autoplayMs:900}; if(!state.currentDate) state.currentDate = new Date().toISOString().slice(0,10);
  setupEventListeners(); renderAll(); // attach initial view from hash
  if(location.hash){ const sec = location.hash.replace('#',''); if(['dashboard','activos','pasivos','gastos','ingresos','metas','simulador','reportes'].includes(sec)) show(sec); }
});

// quick save on unload
window.addEventListener('beforeunload',()=>save());

</script>
</body>
</html>



