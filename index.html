<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>JHONATAN ORELLANA — Finanzas (Cashflow-style)</title>

<!--
  ÚNICO ARCHIVO index.html
  Versión: Mejorada (transferencias, patrimonio, gastos mensuales, empresas, diseño)
  Nota importante:
    - Esta versión **NO** usa Firebase Auth en cliente.
    - Requiere un BACKEND (Cloud Function / Cloud Run) que exponga:
       POST /join   { joinCode } -> { ok, orgId, token, expiresAt }
       GET  /data?orgId=ID (Aut: Bearer TOKEN) -> { ok, data, updatedAt? }
       POST /data  { orgId, data } (Aut: Bearer TOKEN) -> { ok, updatedAt? }
    - Configura CLOUD_API_BASE en Export > CLOUD_API_BASE y usa Vincular (JOIN).
    - Firestore debe protegerse para que sólo el servidor admin acceda.
    - El documento único es: organizations/{ORG_ID}/DATA/DATA campo "data"
-->

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#071824; --card:#0b2630; --muted:#9fb1bd;
    --accent:#16a085; --accent-2:#2ecc71; --accent-3:#3498db;
    --danger:#ff6b6b; --glass: rgba(255,255,255,0.03);
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#021018);color:#e6f6f6;-webkit-font-smoothing:antialiased}
  .container{max-width:420px;margin:12px auto;border-radius:18px;overflow:hidden;background:linear-gradient(180deg,#06262b,#052028);min-height:88vh;box-shadow:0 22px 60px rgba(2,16,22,0.7);display:flex;flex-direction:column}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-3));display:flex;align-items:center;justify-content:center;font-weight:900;color:#001216;font-size:18px}
  .app-title{font-weight:800;font-size:16px}
  .app-sub{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;align-items:center}
  .badge{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px;font-size:12px;color:var(--muted)}
  .btn{border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-3));color:#001216}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  main{padding:12px;overflow:auto;flex:1}
  .card{background:linear-gradient(180deg,var(--card),#062a30);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 8px 26px rgba(0,0,0,0.6)}
  .row{display:flex;gap:8px;align-items:center}
  .col{flex:1}
  h2{margin:0;font-size:16px}
  p.muted{color:var(--muted);font-size:12px;margin:6px 0 0}
  input,select,textarea{width:100%;padding:9px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left;font-size:13px}
  .right{text-align:right;}
  .small{font-size:12px;color:var(--muted)}
  .muted-small{font-size:11px;color:var(--muted)}
  .danger{background:var(--danger);color:#120000;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:120}
  .modal{background:linear-gradient(180deg,#071c20,#05161a);padding:14px;border-radius:12px;max-width:420px;width:94%}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#071421;color:#d6f6ef;padding:12px;border-radius:10px;box-shadow:0 8px 26px rgba(0,0,0,0.6);display:none;z-index:130}
  nav.bottom{display:flex;gap:6px;padding:10px;background:linear-gradient(180deg,transparent,rgba(255,255,255,0.01));border-top:1px solid rgba(255,255,255,0.02)}
  nav.bottom button{flex:1;background:transparent;border:0;color:var(--muted);padding:8px;border-radius:10px;font-weight:700}
  nav.bottom button.active{color:var(--accent);background:rgba(255,255,255,0.02)}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
  /* visual emphasis */
  .accent-cta{background:linear-gradient(90deg,var(--accent-2),var(--accent-3));color:#012;}
  /* responsive: emulate mobile vertical */
  @media (min-width:720px){ .container{transform:scale(1.02);} }
  /* nicer tables */
  th{font-size:12px;color:var(--muted);font-weight:700}
  td{font-size:13px}
</style>
</head>
<body>
  <div class="container" role="application" aria-label="Jhonatan Orellana - Finanzas">
    <header>
      <div class="brand">
        <div class="logo">JO</div>
        <div>
          <div class="app-title">JHONATAN ORELLANA</div>
          <div class="app-sub">Control financiero · Cashflow style</div>
        </div>
      </div>
      <div class="actions">
        <div id="orgBadge" class="badge">No vinculado</div>
        <button id="btnLink" class="btn ghost">Vincular</button>
        <button id="btnCloud" class="btn ghost">Cloud: OFF</button>
      </div>
    </header>

    <main>
      <!-- Resumen -->
      <section id="view-dashboard" class="card">
        <div class="flex-between">
          <div>
            <h2>Resumen</h2>
            <p class="muted">Balance actual, patrimonio y cashflow estimado</p>
          </div>
          <div class="muted-small" id="monthLabel"></div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <div style="flex:1" class="card" aria-hidden>
            <div class="small">Balance líquido</div>
            <div id="balance" style="font-size:18px;font-weight:800;margin-top:6px">S/ 0.00</div>
            <div id="flows" class="muted-small" style="margin-top:6px"></div>
          </div>
          <div style="width:120px" class="card" aria-hidden>
            <div class="small">Patrimonio neto</div>
            <div id="netWorth" style="font-weight:800;margin-top:6px">S/ 0.00</div>
            <div class="small" style="margin-top:6px">Activos - Pasivos</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnSimulate" class="btn primary">Simular cashflow</button>
          <button id="btnAddQuickTx" class="btn ghost">+ Transacción rápida</button>
        </div>

        <div style="margin-top:12px" class="small muted-small" id="alertsArea">Sin alertas</div>
      </section>

      <!-- Transacciones -->
      <section id="view-transactions" class="card" style="display:none">
        <div class="flex-between">
          <div><h2>Transacciones</h2><p class="muted">Asocia siempre cuenta y categoría</p></div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="search" placeholder="Buscar..." style="width:140px" />
            <button id="btnAddTx" class="btn primary">Agregar</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <select id="filterAccount"><option value="">-- Todas cuentas --</option></select>
          <input id="filterFrom" placeholder="desde dd/mm/yyyy" style="width:120px" />
          <input id="filterTo" placeholder="hasta dd/mm/yyyy" style="width:120px" />
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table id="txTable"><thead><tr><th>Fecha</th><th>Cuenta</th><th>Tipo</th><th>Cat.</th><th class="right">Monto</th><th>Acc.</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Bancos y transferencias -->
      <section id="view-banks" class="card" style="display:none">
        <div class="flex-between">
          <div><h2>Bancos & Transferencias</h2><p class="muted">Cuentas vinculadas a tus movimientos</p></div>
          <div style="display:flex;gap:8px">
            <button id="btnAddBank" class="btn primary">Nueva cuenta</button>
            <button id="btnTransfer" class="btn ghost">Transferir</button>
          </div>
        </div>

        <div style="margin-top:8px" id="banksArea"></div>
      </section>

      <!-- Patrimonio (activos) -->
      <section id="view-assets" class="card" style="display:none">
        <div class="flex-between">
          <div><h2>Patrimonio</h2><p class="muted">Registra activos con valor estimado y vincula a bancos</p></div>
          <div><button id="btnAddAsset" class="btn primary">Nuevo activo</button></div>
        </div>

        <div style="margin-top:10px" id="assetsArea"></div>
      </section>

      <!-- Gastos mensuales (fijos y planificados) -->
      <section id="view-fixed" class="card" style="display:none">
        <div class="flex-between">
          <div><h2>Gastos mensuales</h2><p class="muted">Pagos fijos: pensión, alquiler, cuotas</p></div>
          <div><button id="btnAddFixed" class="btn primary">Nuevo gasto fijo</button></div>
        </div>
        <div style="margin-top:10px" id="fixedArea"></div>
        <div style="margin-top:8px" class="muted-small">Acción: aplicar los gastos fijos del mes como transacciones -> botón "Aplicar mes"</div>
        <div style="margin-top:8px;display:flex;gap:8px"><button id="btnApplyFixed" class="btn primary">Aplicar mes</button><button id="btnAutoApply" class="btn ghost">Auto-apply (activado)</button></div>
      </section>

      <!-- Empresas / Proyectos -->
      <section id="view-business" class="card" style="display:none">
        <div class="flex-between">
          <div><h2>Empresas & Proyectos</h2><p class="muted">Registra negocios, ingresos pasivos y simula</p></div>
          <div><button id="btnAddBiz" class="btn primary">Nueva empresa</button></div>
        </div>

        <div style="margin-top:8px" id="bizArea"></div>

        <div style="margin-top:12px">
          <h3 style="margin:0">Proyección simplificada (12 meses)</h3>
          <div class="muted-small">Selecciona una empresa y simula crecimiento</div>
          <div style="display:flex;gap:8px;margin-top:8px"><select id="bizSelect"><option value="">-- seleccionar --</option></select><button id="btnRunSim" class="btn primary">Correr simulación</button></div>
          <div id="simResult" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- Export / Sync -->
      <section id="view-export" class="card" style="display:none">
        <div class="flex-between">
          <div><h2>Export / Import / Sincronizar</h2><p class="muted">CSV, JSON, PDF. Backend requerido para sincronización entre dispositivos.</p></div>
          <div></div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="btnCSV" class="btn primary">Exportar CSV</button>
          <button id="btnJSON" class="btn ghost">Exportar JSON</button>
          <input id="fileImport" type="file" accept=".csv,application/json" />
          <button id="btnImport" class="btn primary">Importar</button>
          <button id="btnPDF" class="btn primary">Generar PDF</button>
        </div>

        <div style="margin-top:12px" class="card">
          <div class="muted-small">Backend (Cloud API)</div>
          <input id="cloudApi" placeholder="CLOUD_API_BASE (https://...)" />
          <input id="orgManual" placeholder="ORG_ID (opcional)" style="margin-top:8px" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnLinkManual" class="btn primary">Vincular (JOIN)</button>
            <button id="btnSyncNow" class="btn ghost">Sync ahora</button>
            <label class="muted-small" style="align-self:center"><input id="chkAuto" type="checkbox" /> Auto-sync 6s</label>
          </div>
          <div style="margin-top:8px" class="muted-small">Estado: <span id="syncStatus">idle</span></div>
        </div>
      </section>
    </main>

    <nav class="bottom">
      <button data-view="dashboard" class="active">Resumen</button>
      <button data-view="transactions">Transac.</button>
      <button data-view="banks">Bancos</button>
      <button data-view="assets">Patrimonio</button>
      <button data-view="fixed">Gastos</button>
      <button data-view="business">Empresas</button>
      <button data-view="export">Export</button>
    </nav>
  </div>

  <!-- modales -->
  <div class="modal-backdrop" id="modalBackdrop"><div class="modal" id="modalContent"></div></div>
  <div class="toast" id="toast"></div>

  <!-- html2pdf para export PDF -->
  <script> (function(){ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js'; document.head.appendChild(s); })(); </script>

  <script>
  /* ------------------------------------------------------------
     APP - Mejorada
     - Transferencias entre cuentas
     - Patrimonio (activos) con estimación y vinculación
     - Gastos mensuales fijos y aplicación mensual
     - Módulo de empresas/proyectos con simulación sencilla
     - Mejor diseño y UX móvil vertical
     - Persistencia local + sincronización con BACKEND (ver instrucciones)
     ------------------------------------------------------------ */

  // ---------------- UTIL ----------------
  const $ = (s,r=document)=> r.querySelector(s);
  const $$ = (s,r=document)=> Array.from(r.querySelectorAll(s));
  function showToast(msg, important=false){
    const t = $('#toast'); t.textContent = msg; t.style.display='block';
    t.style.background = important ? 'linear-gradient(90deg,var(--danger),#ff9a9a)' : '#071421';
    clearTimeout(window.__to); window.__to = setTimeout(()=> t.style.display='none', important?7000:3500, important?7000:3500);
  }
  function fmtMoney(v){ v = Number(v)||0; return 'S/ ' + v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function parseDate(s){ if(!s) return null; const p=s.split('/'); if(p.length!==3) return null; const d=parseInt(p[0],10), m=parseInt(p[1],10)-1, y=parseInt(p[2],10); const dt=new Date(y,m,d); return isNaN(dt)?null:dt; }
  function toDDMMYYYY(d){ if(!d) return ''; return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear(); }
  function uidPrefix(prefix){ return prefix + '_' + Date.now(); }

  // ---------------- STATE ----------------
  const STORAGE_KEY = 'jo_cashflow_v1';
  const SESSION_KEY = 'jo_session_v1';
  const state = {
    cloudOn: false,
    apiBase: localStorage.getItem('jo_api_base') || '',
    orgId: localStorage.getItem('jo_org_id') || '',
    session: JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'), // { token, orgId, expiresAt, lastRemoteAt }
    singleData: {
      transactions: [], // {id,type,dateStr,amount,bankId,categoryId,description,debtId,meta}
      banks: [],        // {id,name,type,balance,currency,meta}
      debts: [],        // {id,name,bankId,outstanding,monthlyPayment,interest}
      fixed: [],        // gastos mensuales fijos {id,name,amount,bankId,categoryId,dueDay}
      savings: [],
      categories: [],   // {id,name,limitMonthly}
      assets: [],       // patrimonio {id,name,estimatedValue,linkedBankId,notes}
      businesses: [],   // empresas {id,name,monthlyRevenue,monthlyExpense,ownerPercent}
      meta: { createdAt:null, updatedAt:null }
    },
    pollId: null,
    syncing: false
  };

  // load/save local
  function persistLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.singleData)); localStorage.setItem('jo_api_base', state.apiBase); localStorage.setItem('jo_org_id', state.orgId); localStorage.setItem(SESSION_KEY, JSON.stringify(state.session)); }
  function loadLocal(){ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return; try{ state.singleData = JSON.parse(raw); }catch(e){ console.error('parse local', e); } }

  // ---------------- CLOUD HELPERS ----------------
  function cloudUrl(path){ const base = state.apiBase.trim(); if(!base) throw new Error('CLOUD_API_BASE no configurado'); return base.replace(/\/+$/,'') + '/' + path.replace(/^\/+/,''); }

  async function cloudJoin(joinCode){
    const url = cloudUrl('join');
    const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({joinCode})});
    const j = await res.json();
    if(!res.ok || !j.ok) throw new Error(j?.error || 'join failed');
    state.session = { token:j.token, orgId:j.orgId, expiresAt:j.expiresAt || Date.now()+3600*1000, lastRemoteAt: null };
    state.orgId = j.orgId; persistLocal();
    showToast('Vinculado correctamente');
  }

  async function cloudGetData(){
    if(!state.session || !state.session.token) throw new Error('Sin sesión');
    const url = cloudUrl('data?orgId=' + encodeURIComponent(state.session.orgId));
    const res = await fetch(url,{headers:{'Authorization':'Bearer ' + state.session.token}});
    const j = await res.json();
    if(!res.ok || !j.ok) throw new Error(j?.error || 'no data');
    return { data: j.data || {}, updatedAt: j.updatedAt || null };
  }

  async function cloudSaveData(data){
    if(!state.session || !state.session.token) throw new Error('Sin sesión');
    const url = cloudUrl('data');
    const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer ' + state.session.token},body: JSON.stringify({ orgId: state.session.orgId, data })});
    const j = await res.json();
    if(!res.ok || !j.ok) throw new Error(j?.error || 'save failed');
    return { updatedAt: j.updatedAt || new Date().toISOString() };
  }

  // ---------------- SYNC (merge strategy: timestamp authoritative) ----------------
  function isoMs(s){ return s ? Date.parse(s) || 0 : 0; }

  async function syncFetchAndMerge(){
    if(!state.cloudOn || !state.session || state.syncing) return;
    try{
      state.syncing = true; $('#syncStatus').textContent = 'checking...';
      const { data: remoteData, updatedAt } = await cloudGetData();
      const remoteTS = isoMs(updatedAt) || isoMs(remoteData?.meta?.updatedAt) || 0;
      const localTS = isoMs(state.singleData.meta.updatedAt) || 0;

      if(remoteTS > localTS){
        // remote wins -> replace local
        state.singleData = Object.assign({
          transactions:[], banks:[], debts:[], fixed:[], savings:[], categories:[], assets:[], businesses:[], meta:{}
        }, remoteData || {});
        state.singleData.meta.updatedAt = updatedAt || state.singleData.meta.updatedAt;
        persistLocal(); renderAll(); showToast('Datos actualizados desde nube');
      } else if(localTS > remoteTS){
        // local newer -> push
        $('#syncStatus').textContent = 'pushing...';
        state.singleData.meta.updatedAt = new Date().toISOString();
        const res = await cloudSaveData(state.singleData);
        if(res && res.updatedAt) state.singleData.meta.updatedAt = res.updatedAt;
        persistLocal(); showToast('Datos enviados a nube');
      } else {
        // equal or none -> no-op
      }
      $('#syncStatus').textContent = 'idle';
    } catch(e){
      console.warn('sync error', e); $('#syncStatus').textContent = 'error';
    } finally { state.syncing = false; updateTimestamps(); }
  }

  function startAutoSync(){ stopAutoSync(); state.pollId = setInterval(()=>{ if(state.cloudOn && state.session) syncFetchAndMerge(); }, 6000); $('#syncStatus').textContent='auto'; localStorage.setItem('jo_auto_sync','on'); }
  function stopAutoSync(){ if(state.pollId) clearInterval(state.pollId); state.pollId = null; $('#syncStatus').textContent='idle'; localStorage.setItem('jo_auto_sync','off'); }

  // ---------------- CRUD OPERATIONS ----------------
  async function pushAndMaybeSync(fn){
    fn(state.singleData);
    state.singleData.meta.updatedAt = new Date().toISOString();
    persistLocal(); renderAll();
    if(state.cloudOn && state.session){
      try{ $('#syncStatus').textContent='saving'; const r = await cloudSaveData(state.singleData); if(r && r.updatedAt) state.singleData.meta.updatedAt = r.updatedAt; persistLocal(); $('#syncStatus').textContent='idle'; } catch(e){ console.warn(e); $('#syncStatus').textContent='error'; showToast('Error al guardar en nube: '+e.message,true); }
    }
  }

  // Categories
  async function addCategory(obj){ obj.id = uidPrefix('cat'); obj.createdAt = new Date().toISOString(); await pushAndMaybeSync(sd=> sd.categories.unshift(obj)); }
  async function delCategory(id){ await pushAndMaybeSync(sd=> sd.categories = sd.categories.filter(x=>x.id!==id)); }

  // Banks
  async function addBank(obj){ obj.id = uidPrefix('b'); obj.balance = Number(obj.balance)||0; obj.createdAt = new Date().toISOString(); await pushAndMaybeSync(sd=> sd.banks.unshift(obj)); showToast('Cuenta creada'); }
  async function updateBank(id, data){ await pushAndMaybeSync(sd=> sd.banks = sd.banks.map(b=> b.id===id? Object.assign(b,data):b)); }
  async function delBank(id){ await pushAndMaybeSync(sd=> { sd.banks = sd.banks.filter(b=>b.id!==id); /* also unlink assets/fixed */ sd.assets.forEach(a=>{ if(a.linkedBankId===id) a.linkedBankId = null; }); sd.fixed.forEach(f=>{ if(f.bankId===id) f.bankId = null; }); }); showToast('Cuenta eliminada'); }

  // Debts
  async function addDebt(d){ d.id = uidPrefix('debt'); d.outstanding = Number(d.outstanding)||0; await pushAndMaybeSync(sd=> sd.debts.unshift(d)); }
  async function payDebt(debtId, amount, bankId){
    await pushAndMaybeSync(sd=>{
      const d = sd.debts.find(x=>x.id===debtId); if(d) d.outstanding = Math.max(0, (Number(d.outstanding)||0) - amount);
      // update bank balance
      const b = sd.banks.find(x=>x.id===bankId); if(b) b.balance = (Number(b.balance)||0) - amount;
      // add transaction
      sd.transactions.unshift({ id: uidPrefix('t'), type:'Egreso', dateStr: toDDMMYYYY(new Date()), amount, bankId, description: 'Pago deuda: ' + (d?d.name:'') , createdAt: new Date().toISOString(), debtId });
    });
    showToast('Pago registrado');
  }

  // Fixed expenses
  async function addFixed(f){ f.id = uidPrefix('fix'); f.amount = Number(f.amount)||0; await pushAndMaybeSync(sd=> sd.fixed.unshift(f)); }
  async function applyMonthlyFixed(){
    const today = new Date(); const dateStr = toDDMMYYYY(today);
    await pushAndMaybeSync(sd=>{
      sd.fixed.forEach(f=>{
        const tx = { id: uidPrefix('t'), type:'Egreso', dateStr, amount: Number(f.amount)||0, bankId: f.bankId||null, categoryId: f.categoryId||null, description: 'Gasto fijo: '+f.name, createdAt: new Date().toISOString(), meta:{ fromFixed: f.id } };
        sd.transactions.unshift(tx);
        if(f.bankId){
          const b = sd.banks.find(x=>x.id===f.bankId); if(b) b.balance = (Number(b.balance)||0) - tx.amount;
        }
      });
    });
    showToast('Gastos fijos aplicados al mes');
  }

  // Transactions
  async function addTransaction(tx){
    if(!parseDate(tx.dateStr)) throw new Error('Fecha inválida');
    tx.id = uidPrefix('t'); tx.amount = Number(tx.amount)||0; tx.createdAt = new Date().toISOString();
    await pushAndMaybeSync(sd=>{
      sd.transactions.unshift(tx);
      if(tx.bankId){
        const b = sd.banks.find(x=>x.id===tx.bankId); if(b) b.balance = (Number(b.balance)||0) + (tx.type==='Egreso' ? -tx.amount : tx.amount);
      }
    });
    showToast('Transacción guardada');
  }
  async function delTransaction(id){ await pushAndMaybeSync(sd=> sd.transactions = sd.transactions.filter(t=>t.id!==id)); showToast('Transacción eliminada'); }

  // Transfer between own banks
  async function transferBetweenBanks(fromId, toId, amount, dateStr, note){
    amount = Number(amount)||0; if(amount<=0) throw new Error('Monto inválido');
    await pushAndMaybeSync(sd=>{
      const from = sd.banks.find(b=>b.id===fromId); const to = sd.banks.find(b=>b.id===toId);
      if(from) from.balance = (Number(from.balance)||0) - amount;
      if(to) to.balance = (Number(to.balance)||0) + amount;
      const txOut = { id: uidPrefix('t'), type:'Egreso', dateStr, amount, bankId: fromId, categoryId: null, description: 'Transferencia a ' + (to?to.name:'-') + (note?(' | '+note):''), createdAt: new Date().toISOString(), meta:{ transferTo: toId } };
      const txIn  = { id: uidPrefix('t'), type:'Ingreso', dateStr, amount, bankId: toId, categoryId: null, description: 'Transferencia desde ' + (from?from.name:'-') + (note?(' | '+note):''), createdAt: new Date().toISOString(), meta:{ transferFrom: fromId } };
      sd.transactions.unshift(txIn); sd.transactions.unshift(txOut);
    });
    showToast('Transferencia realizada');
  }

  // Assets / Patrimonio
  async function addAsset(a){ a.id = uidPrefix('asset'); a.estimatedValue = Number(a.estimatedValue)||0; await pushAndMaybeSync(sd=> sd.assets.unshift(a)); showToast('Activo registrado'); }
  async function updateAsset(id,data){ await pushAndMaybeSync(sd=> sd.assets = sd.assets.map(x=>x.id===id?Object.assign(x,data):x)); }
  async function delAsset(id){ await pushAndMaybeSync(sd=> sd.assets = sd.assets.filter(x=>x.id!==id)); }

  // Businesses
  async function addBusiness(b){ b.id = uidPrefix('biz'); b.monthlyRevenue = Number(b.monthlyRevenue)||0; b.monthlyExpense = Number(b.monthlyExpense)||0; await pushAndMaybeSync(sd=> sd.businesses.unshift(b)); showToast('Empresa creada'); }
  async function delBusiness(id){ await pushAndMaybeSync(sd=> sd.businesses = sd.businesses.filter(x=>x.id!==id)); }

  // ---------------- UI RENDER ----------------
  function switchView(view){
    const all = ['dashboard','transactions','banks','assets','fixed','business','export'];
    all.forEach(v=>{ const el = document.getElementById('view-'+v); if(el) el.style.display = (v===view)?'block':'none'; });
    document.querySelectorAll('nav.bottom button').forEach(b=> b.classList.toggle('active', b.dataset.view===view));
    updateHeader();
  }

  function updateHeader(){
    $('#orgBadge').textContent = state.orgId ? ('Org: '+state.orgId.slice(0,8)) : 'No vinculado';
    $('#btnCloud').textContent = state.cloudOn ? 'Cloud: ON' : 'Cloud: OFF';
    $('#monthLabel').textContent = (new Date()).toLocaleString('default',{month:'long',year:'numeric'});
  }

  function renderAll(){
    renderDashboard(); renderTransactions(); renderBanks(); renderAssets(); renderFixed(); renderBusinesses();
    populateSelects(); updateHeader(); updateTimestamps();
  }

  function renderDashboard(){
    // flows this month
    const now = new Date(), month = now.getMonth(), year = now.getFullYear();
    let inc=0, eg=0;
    state.singleData.transactions.forEach(t=>{
      const d = parseDate(t.dateStr||''); if(!d) return;
      if(d.getMonth()===month && d.getFullYear()===year){
        if(t.type === 'Egreso') eg += Number(t.amount)||0; else inc += Number(t.amount)||0;
      }
    });
    $('#balance').textContent = fmtMoney(inc - eg);
    $('#flows').textContent = `Ingresos: ${fmtMoney(inc)} · Egresos: ${fmtMoney(eg)}`;

    // net worth
    const assetsTotal = state.singleData.assets.reduce((a,x)=>a + (Number(x.estimatedValue)||0),0);
    const bankTotal = state.singleData.banks.reduce((a,x)=>a + (Number(x.balance)||0),0);
    const debtsTotal = state.singleData.debts.reduce((a,x)=>a + (Number(x.outstanding)||0),0);
    const net = assetsTotal + bankTotal - debtsTotal;
    $('#netWorth').textContent = fmtMoney(net);

    // alerts: limits and low balances
    let alerts = [];
    state.singleData.categories.forEach(cat=>{
      if(!cat.limitMonthly || Number(cat.limitMonthly)<=0) return;
      const total = state.singleData.transactions.reduce((acc,t)=>{
        const d = parseDate(t.dateStr||''); if(!d) return acc;
        if(d.getMonth()===month && d.getFullYear()===year && t.categoryId === cat.id) acc += Number(t.amount)||0;
        return acc;
      },0);
      if(total > Number(cat.limitMonthly)) alerts.push(`<div style="color:var(--danger)"><strong>${cat.name}</strong> superó límite: ${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)}</div>`);
      else if(total >= Number(cat.limitMonthly)*0.8) alerts.push(`<div><strong>${cat.name}</strong> cerca del límite: ${fmtMoney(total)} / ${fmtMoney(cat.limitMonthly)}</div>`);
    });
    state.singleData.banks.forEach(b=>{ if(Number(b.balance) < 0) alerts.push(`<div style="color:var(--danger)"><strong>${b.name}</strong> saldo negativo ${fmtMoney(b.balance)}</div>`); });
    $('#alertsArea').innerHTML = alerts.length ? alerts.join('') : '<div class="muted-small">Sin alertas</div>';
  }

  function renderTransactions(){
    const tbody = $('#txTable tbody'); if(!tbody) return; tbody.innerHTML = '';
    const rows = applyFilters();
    rows.forEach(t=>{
      const bank = state.singleData.banks.find(b=>b.id===t.bankId);
      const cat = state.singleData.categories.find(c=>c.id===t.categoryId);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.dateStr||''}</td><td>${bank?bank.name:'-'}</td><td>${t.type}</td><td>${cat?cat.name:(t.categoryName||'-')}</td><td class="right">${fmtMoney(t.amount)}</td><td><button data-id="${t.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${t.id}" data-act="del" class="btn danger">X</button></td>`;
      tbody.appendChild(tr);
    });
    $$('#txTable button').forEach(btn=> btn.onclick = async ()=>{ const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar transacción?')) await delTransaction(id); } if(act==='edit'){ const tx = state.singleData.transactions.find(x=>x.id===id); if(tx) openTxModal(tx); } });
  }

  function applyFilters(){
    const q = $('#search').value.trim().toLowerCase();
    const bank = $('#filterAccount').value;
    const from = $('#filterFrom').value.trim();
    const to = $('#filterTo').value.trim();
    return state.singleData.transactions.filter(t=>{
      const d = parseDate(t.dateStr||''); if(from){ const f = parseDate(from); if(!f || !d || d < f) return false; } if(to){ const tt = parseDate(to); if(!tt || !d || d > tt) return false; }
      if(bank && t.bankId !== bank) return false;
      if(q){ const txt = `${t.description||''} ${(t.categoryName||'')}`.toLowerCase(); if(!txt.includes(q)) return false; }
      return true;
    });
  }

  function renderBanks(){
    const wrap = $('#banksArea'); if(!wrap) return;
    if(!state.singleData.banks.length) { wrap.innerHTML = '<div class="muted-small">No hay cuentas registradas</div>'; return; }
    const rows = state.singleData.banks.map(b=>`<tr><td>${b.name}<div class="small muted-small">${b.type || ''}</div></td><td class="right">${fmtMoney(Number(b.balance)||0)}</td><td><button data-id="${b.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${b.id}" data-act="del" class="btn danger">X</button></td></tr>`).join('');
    wrap.innerHTML = `<table><thead><tr><th>Cuenta</th><th class="right">Saldo</th><th>Acc.</th></tr></thead><tbody>${rows}</tbody></table>`;
    $$('#banksArea button').forEach(btn=> btn.onclick = async ()=>{ const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar cuenta?')) await delBank(id); } if(act==='edit'){ const b = state.singleData.banks.find(x=>x.id===id); if(b) openBankModal(b); } });
  }

  function renderAssets(){
    const wrap = $('#assetsArea'); if(!wrap) return;
    if(!state.singleData.assets.length) { wrap.innerHTML = '<div class="muted-small">Sin activos registrados</div>'; return; }
    const rows = state.singleData.assets.map(a=>`<tr><td>${a.name}<div class="small muted-small">${a.notes||''}</div></td><td class="right">${fmtMoney(Number(a.estimatedValue)||0)}</td><td>${(state.singleData.banks.find(b=>b.id===a.linkedBankId)||{name:'-'}) .name}</td><td><button data-id="${a.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${a.id}" data-act="del" class="btn danger">X</button></td></tr>`).join('');
    wrap.innerHTML = `<table><thead><tr><th>Activo</th><th class="right">Valor</th><th>Vinculado</th><th>Acc.</th></tr></thead><tbody>${rows}</tbody></table>`;
    $$('#assetsArea button').forEach(btn=> btn.onclick = async ()=>{ const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar activo?')) await delAsset(id); } if(act==='edit'){ const a = state.singleData.assets.find(x=>x.id===id); openAssetModal(a); } });
  }

  function renderFixed(){
    const wrap = $('#fixedArea'); if(!wrap) return;
    if(!state.singleData.fixed.length) { wrap.innerHTML = '<div class="muted-small">Sin gastos fijos</div>'; return; }
    const rows = state.singleData.fixed.map(f=>`<tr><td>${f.name}<div class="small muted-small">${f.categoryId? (state.singleData.categories.find(c=>c.id===f.categoryId)||{name:''}).name : ''}</div></td><td class="right">${fmtMoney(Number(f.amount)||0)}</td><td>${(state.singleData.banks.find(b=>b.id===f.bankId)||{name:'-'}) .name}</td><td><button data-id="${f.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${f.id}" data-act="del" class="btn danger">X</button></td></tr>`).join('');
    wrap.innerHTML = `<table><thead><tr><th>Gasto</th><th class="right">Monto</th><th>Cuenta</th><th>Acc.</th></tr></thead><tbody>${rows}</tbody></table>`;
    $$('#fixedArea button').forEach(btn=> btn.onclick = async ()=>{ const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar gasto fijo?')){ state.singleData.fixed = state.singleData.fixed.filter(x=>x.id!==id); state.singleData.meta.updatedAt=new Date().toISOString(); persistLocal(); renderAll(); } } if(act==='edit'){ const f = state.singleData.fixed.find(x=>x.id===id); openFixedModal(f); } });
  }

  function renderBusinesses(){
    const wrap = $('#bizArea'); if(!wrap) return;
    if(!state.singleData.businesses.length) { wrap.innerHTML = '<div class="muted-small">Sin empresas</div>'; return; }
    const rows = state.singleData.businesses.map(b=>`<tr><td>${b.name}<div class="small muted-small">Rev: ${fmtMoney(b.monthlyRevenue)} · Costos: ${fmtMoney(b.monthlyExpense)}</div></td><td class="right">${fmtMoney(b.monthlyRevenue - b.monthlyExpense)}</td><td><button data-id="${b.id}" data-act="edit" class="btn ghost">E</button> <button data-id="${b.id}" data-act="del" class="btn danger">X</button></td></tr>`).join('');
    wrap.innerHTML = `<table><thead><tr><th>Empresa</th><th class="right">Flujo neto</th><th>Acc.</th></tr></thead><tbody>${rows}</tbody></table>`;
    $$('#bizArea button').forEach(btn=> btn.onclick = async ()=>{ const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar empresa?')) await delBusiness(id); } if(act==='edit'){ const b = state.singleData.businesses.find(x=>x.id===id); openBizModal(b); } });
    // populate bizSelect
    const sel = $('#bizSelect'); if(sel){ sel.innerHTML = '<option value="">-- seleccionar --</option>' + state.singleData.businesses.map(b=>`<option value="${b.id}">${b.name}</option>`).join(''); }
  }

  function populateSelects(){
    // accounts
    const selAcc = $('#filterAccount'); if(selAcc){ selAcc.innerHTML = '<option value="">-- Todas cuentas --</option>' + state.singleData.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join(''); }
    // cloud inputs
    $('#cloudApi').value = state.apiBase;
    $('#orgManual').value = state.orgId;
  }

  function updateTimestamps(){
    $('#syncStatus').textContent = state.syncing ? 'syncing' : 'idle';
  }

  // ---------------- MODALES & UI CONTROLS ----------------
  function showModal(html){ $('#modalContent').innerHTML = html; $('#modalBackdrop').style.display = 'flex'; }
  function closeModal(){ $('#modalContent').innerHTML=''; $('#modalBackdrop').style.display='none'; }

  // Quick transaction modal
  function openTxModal(existing){
    const banksOpt = '<option value="">-- seleccionar --</option>' + state.singleData.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const catOpt = '<option value="">-- categ. --</option>' + state.singleData.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    const def = existing || { type:'Egreso', amount:0, dateStr: toDDMMYYYY(new Date()), bankId:'', categoryId:'', description:'' };
    showModal(`<div><h3 style="margin:0">${existing ? 'Editar transacción' : 'Nueva transacción'}</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><label>Tipo</label><select id="txType"><option ${def.type==='Ingreso'?'selected':''}>Ingreso</option><option ${def.type==='Egreso'?'selected':''}>Egreso</option></select></div>
        <div><label>Monto</label><input id="txAmount" value="${def.amount||0}" /></div>
        <div><label>Cuenta</label><select id="txBank">${banksOpt}</select></div>
        <div><label>Categoría</label><select id="txCat">${catOpt}</select></div>
        <div style="grid-column:1/-1"><label>Descripción</label><input id="txDesc" value="${(def.description||'').replace(/"/g,'&quot;')}" /></div>
        <div><label>Fecha</label><input id="txDate" value="${def.dateStr}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="txCancel" class="btn ghost">Cancelar</button><button id="txSave" class="btn primary">Guardar</button></div>
    </div>`);
    if(existing) setTimeout(()=>{ if(existing.bankId) $('#txBank').value = existing.bankId; if(existing.categoryId) $('#txCat').value = existing.categoryId; },50);
    $('#txCancel').onclick = closeModal;
    $('#txSave').onclick = async ()=> {
      try{
        const type = $('#txType').value; const amount = Number($('#txAmount').value)||0; const bankId = $('#txBank').value || null; const categoryId = $('#txCat').value || null; const desc = $('#txDesc').value.trim(); const dateStr = $('#txDate').value.trim();
        if(!amount || amount<=0) return alert('Monto inválido'); if(!parseDate(dateStr)) return alert('Fecha inválida (dd/mm/yyyy)');
        await addTransaction({ type, amount, bankId, categoryId, description: desc, dateStr });
        closeModal();
      } catch(e){ console.error(e); alert('Error: '+e.message); }
    };
  }

  function openBankModal(bank){
    const def = bank || { name:'', balance:0, type:'Cuenta', currency:'PEN' };
    showModal(`<div><h3 style="margin:0">${bank ? 'Editar cuenta' : 'Nueva cuenta'}</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><div><label>Nombre</label><input id="bName" value="${def.name}" /></div><div><label>Tipo</label><input id="bType" value="${def.type}" /></div><div><label>Saldo inicial</label><input id="bBalance" value="${Number(def.balance)||0}" /></div><div><label>Moneda</label><input id="bCurr" value="${def.currency||'PEN'}" /></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="bCancel" class="btn ghost">Cancelar</button><button id="bSave" class="btn primary">Guardar</button></div></div>`);
    $('#bCancel').onclick = closeModal;
    $('#bSave').onclick = async ()=> {
      try{
        const name = $('#bName').value.trim(), type = $('#bType').value.trim(), balance = Number($('#bBalance').value)||0, currency = $('#bCurr').value.trim()||'PEN';
        if(!name) return alert('Nombre requerido');
        if(bank) await updateBank(bank.id, { name, type, balance, currency }); else await addBank({ name, type, balance, currency });
        closeModal();
      } catch(e){ console.error(e); alert('Error: '+e.message); }
    };
  }

  function openTransferModal(){
    if(state.singleData.banks.length < 2) return alert('Necesitas al menos 2 cuentas para transferir');
    const bankOpts = state.singleData.banks.map(b=>`<option value="${b.id}">${b.name} • ${fmtMoney(b.balance)}</option>`).join('');
    showModal(`<div><h3 style="margin:0">Transferencia interna</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><label>Desde</label><select id="trFrom">${bankOpts}</select></div>
        <div><label>Hacia</label><select id="trTo">${bankOpts}</select></div>
        <div><label>Monto</label><input id="trAmount" value="0" /></div>
        <div><label>Fecha</label><input id="trDate" value="${toDDMMYYYY(new Date())}" /></div>
        <div style="grid-column:1/-1"><label>Nota</label><input id="trNote" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="trCancel" class="btn ghost">Cancelar</button><button id="trSave" class="btn primary">Transferir</button></div>
    </div>`);
    $('#trCancel').onclick = closeModal;
    $('#trSave').onclick = async ()=> {
      try{
        const from = $('#trFrom').value, to = $('#trTo').value, amt = Number($('#trAmount').value)||0, dateStr = $('#trDate').value.trim(), note = $('#trNote').value.trim();
        if(from===to) return alert('Selecciona cuentas diferentes');
        if(amt<=0) return alert('Monto inválido');
        if(!parseDate(dateStr)) return alert('Fecha inválida');
        await transferBetweenBanks(from,to,amt,dateStr,note);
        closeModal();
      } catch(e){ console.error(e); alert('Error: '+e.message); }
    };
  }

  function openAssetModal(a){
    const def = a || { name:'', estimatedValue:0, linkedBankId:'', notes:'' };
    const bankOpts = '<option value="">-- Ninguna --</option>' + state.singleData.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    showModal(`<div><h3 style="margin:0">${a ? 'Editar activo' : 'Nuevo activo'}</h3>
      <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px">
        <div><label>Nombre</label><input id="aName" value="${def.name}" /></div>
        <div><label>Valor estimado</label><input id="aValue" value="${Number(def.estimatedValue)||0}" /></div>
        <div><label>Vinculado a cuenta (opcional)</label><select id="aBank">${bankOpts}</select></div>
        <div><label>Notas</label><input id="aNotes" value="${(def.notes||'').replace(/"/g,'&quot;')}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="aCancel" class="btn ghost">Cancelar</button><button id="aSave" class="btn primary">Guardar</button></div>
    </div>`);
    if(a) setTimeout(()=> $('#aBank').value = a.linkedBankId || '',50);
    $('#aCancel').onclick = closeModal;
    $('#aSave').onclick = async ()=> {
      try{
        const name = $('#aName').value.trim(), val = Number($('#aValue').value)||0, bankId = $('#aBank').value || null, notes = $('#aNotes').value.trim();
        if(!name) return alert('Nombre es requerido');
        if(a) await updateAsset(a.id, { name, estimatedValue: val, linkedBankId: bankId, notes }); else await addAsset({ name, estimatedValue: val, linkedBankId: bankId, notes });
        closeModal();
      } catch(e){ console.error(e); alert('Error: '+e.message); }
    };
  }

  function openFixedModal(f){
    const def = f || { name:'', amount:0, bankId:'', categoryId:'' };
    const banksOpt = '<option value="">-- Ninguna --</option>' + state.singleData.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const catOpt = '<option value="">-- Ninguna --</option>' + state.singleData.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    showModal(`<div><h3 style="margin:0">${f ? 'Editar gasto fijo' : 'Nuevo gasto fijo'}</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><label>Nombre</label><input id="fName" value="${def.name}" /></div>
        <div><label>Monto</label><input id="fAmount" value="${Number(def.amount)||0}" /></div>
        <div><label>Cuenta</label><select id="fBank">${banksOpt}</select></div>
        <div><label>Categoría</label><select id="fCat">${catOpt}</select></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="fCancel" class="btn ghost">Cancelar</button><button id="fSave" class="btn primary">Guardar</button></div>
    </div>`);
    if(f) setTimeout(()=>{ $('#fBank').value = f.bankId||''; $('#fCat').value = f.categoryId||''; },50);
    $('#fCancel').onclick = closeModal;
    $('#fSave').onclick = async ()=> {
      try{
        const name = $('#fName').value.trim(), amount = Number($('#fAmount').value)||0, bankId = $('#fBank').value || null, categoryId = $('#fCat').value || null;
        if(!name) return alert('Nombre requerido');
        if(f){ Object.assign(f, { name, amount, bankId, categoryId }); state.singleData.meta.updatedAt = new Date().toISOString(); persistLocal(); renderAll(); } else await addFixed({ name, amount, bankId, categoryId });
        closeModal();
      } catch(e){ console.error(e); alert('Error: '+e.message); }
    };
  }

  function openBizModal(biz){
    const def = biz || { name:'', monthlyRevenue:0, monthlyExpense:0, notes:'' };
    showModal(`<div><h3 style="margin:0">${biz ? 'Editar empresa' : 'Nueva empresa'}</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><label>Nombre</label><input id="bizName" value="${def.name}" /></div>
        <div><label>Ingreso mensual</label><input id="bizRev" value="${Number(def.monthlyRevenue)||0}" /></div>
        <div><label>Gasto mensual</label><input id="bizExp" value="${Number(def.monthlyExpense)||0}" /></div>
        <div><label>Notas</label><input id="bizNotes" value="${(def.notes||'').replace(/"/g,'&quot;')}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="bizCancel" class="btn ghost">Cancelar</button><button id="bizSave" class="btn primary">Guardar</button></div>
    </div>`);
    $('#bizCancel').onclick = closeModal;
    $('#bizSave').onclick = async ()=> {
      try{
        const name = $('#bizName').value.trim(), rev = Number($('#bizRev').value)||0, exp = Number($('#bizExp').value)||0, notes = $('#bizNotes').value.trim();
        if(!name) return alert('Nombre requerido');
        if(biz) { Object.assign(biz, { name, monthlyRevenue:rev, monthlyExpense:exp, notes }); state.singleData.meta.updatedAt = new Date().toISOString(); persistLocal(); renderAll(); }
        else await addBusiness({ name, monthlyRevenue:rev, monthlyExpense:exp, notes });
        closeModal();
      } catch(e){ console.error(e); alert('Error: '+e.message); }
    };
  }

  // ---------------- EXPORT / IMPORT / PDF ----------------
  function exportCSV(){
    const rows = state.singleData.transactions.map(t=>{
      const bank = state.singleData.banks.find(b=>b.id===t.bankId);
      const cat = state.singleData.categories.find(c=>c.id===t.categoryId);
      return [t.dateStr||'', bank?bank.name:'', t.type||'', cat?cat.name:(t.categoryName||''), (t.description||'').replace(/"/g,'""'), t.amount||0];
    });
    const csv = ['fecha,cuenta,tipo,categoria,descripcion,monto', ...rows.map(r=> r.map((c,i)=> i===4?`"${c}"`:c).join(',') )].join('\n');
    const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'transacciones.csv'; a.click(); URL.revokeObjectURL(url);
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state.singleData,null,2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'backup.json'; a.click(); URL.revokeObjectURL(url);
  }

  async function importFile(file){
    if(!file) return alert('Selecciona archivo');
    const text = await file.text();
    if(file.name.toLowerCase().endsWith('.csv')){
      // simple csv parsing
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const headers = lines.shift().split(',').map(h=>h.toLowerCase());
      for(const ln of lines){
        const parts = ln.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g).map(p=>p.replace(/^"|"$/g,'').replace(/""/g,'"'));
        const obj = {}; headers.forEach((h,i)=> obj[h]=parts[i]||'');
        const bank = state.singleData.banks.find(b=>b.name===obj.cuenta);
        const cat = state.singleData.categories.find(c=>c.name===obj.categoria);
        await addTransaction({ type: obj.tipo||'Ingreso', amount: Number(obj.monto)||0, bankId: bank?bank.id:null, categoryId: cat?cat.id:null, categoryName: obj.categoria||'', description: obj.descripcion||'', dateStr: obj.fecha });
      }
      showToast('CSV importado');
    } else {
      try{
        const data = JSON.parse(text);
        // caution: merging naive; better import items iteratively
        if(data.banks) for(const b of data.banks) await addBank(b);
        if(data.categories) for(const c of data.categories) await addCategory(c);
        if(data.assets) for(const a of data.assets) await addAsset(a);
        if(data.businesses) for(const x of data.businesses) await addBusiness(x);
        if(data.fixed) for(const f of data.fixed) await addFixed(f);
        if(data.debts) for(const d of data.debts) await addDebt(d);
        if(data.transactions) for(const t of data.transactions) await addTransaction(t);
        showToast('JSON importado');
      } catch(e){ alert('JSON inválido'); }
    }
  }

  function exportPDF(){
    const node = document.createElement('div'); node.style.padding='12mm'; node.style.background='#fff'; node.style.color='#111'; node.style.fontFamily='Arial, Helvetica, sans-serif';
    node.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800;font-size:12pt">Reporte - JHONATAN ORELLANA</div><div style="text-align:right">${toDDMMYYYY(new Date())}</div></div><hr style="margin:8px 0"><div style="font-size:11pt;font-weight:700;margin-top:6px">Balance: ${$('#balance').textContent}</div><div style="margin-top:6px;font-size:11pt;font-weight:700">Patrimonio neto: ${$('#netWorth').textContent}</div><hr style="margin:8px 0"><div style="font-size:11pt;font-weight:700">Últimas transacciones</div><table style="width:100%;font-size:10pt;border-collapse:collapse;margin-top:6px"><thead><tr><th style="text-align:left;border-bottom:1px solid #ddd">Fecha</th><th style="text-align:left;border-bottom:1px solid #ddd">Cuenta</th><th style="text-align:left;border-bottom:1px solid #ddd">Desc</th><th style="text-align:right;border-bottom:1px solid #ddd">Monto</th></tr></thead><tbody>${state.singleData.transactions.slice(0,40).map(t=>`<tr><td style="padding:6px 0">${t.dateStr||''}</td><td style="padding:6px 0">${(state.singleData.banks.find(b=>b.id===t.bankId)||{name:'-'}) .name}</td><td style="padding:6px 0">${(t.description||'')}</td><td style="padding:6px 0;text-align:right">${fmtMoney(t.amount)}</td></tr>`).join('')}</tbody></table>`;
    if(window.html2pdf) html2pdf().set({margin:10, filename:`reporte_${(new Date()).toISOString().slice(0,10)}.pdf`, html2canvas:{scale:2}}).from(node).save();
    else alert('html2pdf no cargado. Recarga con internet.');
  }

  // ---------------- SIMULACIÓN CASHFLOW / LIBERTAD FINANCIERA ----------------
  function simulateCashflow(bizId){
    const biz = state.singleData.businesses.find(b=>b.id===bizId); if(!biz) return alert('Selecciona empresa');
    // Simple projection: net monthly cash for 12 months, growth assumption small
    const monthlyNet = Number(biz.monthlyRevenue) - Number(biz.monthlyExpense);
    let projection = [], current = monthlyNet;
    for(let i=0;i<12;i++){
      // assume modest growth 1% month if positive, or reduce 0.5% if negative
      projection.push({ month:i+1, cash: current });
      if(current > 0) current *= 1.01; else current *= 0.995;
    }
    // build simple report
    const total = projection.reduce((a,p)=>a+p.cash,0);
    let html = `<div class="card"><strong>Empresa: ${biz.name}</strong><div class="muted-small">Proyección 12 meses</div><table style="width:100%;margin-top:8px"><thead><tr><th>Mes</th><th class="right">Cash</th></tr></thead><tbody>${projection.map(p=>`<tr><td>Mes ${p.month}</td><td class="right">${fmtMoney(p.cash)}</td></tr>`).join('')}</tbody></table><div style="margin-top:8px;font-weight:800">Total 12 meses: ${fmtMoney(total)}</div></div>`;
    $('#simResult').innerHTML = html;
  }

  // ---------------- EVENTS BIND ----------------
  function bindUI(){
    // nav
    $$('nav.bottom button').forEach(b=> b.onclick = ()=> switchView(b.dataset.view));

    // header buttons
    $('#btnLink').onclick = ()=> openJoinModal();
    $('#btnCloud').onclick = ()=> { state.cloudOn = !state.cloudOn; persistLocal(); updateHeader(); showToast('Cloud ' + (state.cloudOn? 'ON':'OFF')); };

    // dashboard actions
    $('#btnAddQuickTx').onclick = ()=> openTxModal();
    $('#btnSimulate').onclick = ()=> { if(!state.singleData.businesses.length) return alert('Sin empresas'); openBizModal(null); };

    // transactions
    $('#btnAddTx').onclick = ()=> openTxModal();
    $('#search').oninput = renderTransactions;

    // banks
    $('#btnAddBank').onclick = ()=> openBankModal(null);
    $('#btnTransfer').onclick = ()=> openTransferModal();

    // assets
    $('#btnAddAsset').onclick = ()=> openAssetModal(null);

    // fixed
    $('#btnAddFixed').onclick = ()=> openFixedModal(null);
    $('#btnApplyFixed').onclick = ()=> { if(confirm('Aplicar gastos fijos del mes ahora?')) applyMonthlyFixed(); };
    $('#btnAutoApply').onclick = ()=> { showToast('Auto-apply no implementado; use "Aplicar mes"'); };

    // businesses
    $('#btnAddBiz').onclick = ()=> openBizModal(null);
    $('#btnRunSim').onclick = ()=> { const id = $('#bizSelect').value; if(!id) return alert('Selecciona empresa'); simulateCashflow(id); };

    // export / import
    $('#btnCSV').onclick = exportCSV;
    $('#btnJSON').onclick = exportJSON;
    $('#btnImport').onclick = ()=> importFile($('#fileImport').files[0]);
    $('#btnPDF').onclick = exportPDF;

    // cloud controls
    $('#cloudApi').onchange = e=> { state.apiBase = e.target.value.trim(); persistLocal(); };
    $('#orgManual').onchange = e=> { state.orgId = e.target.value.trim(); persistLocal(); };
    $('#btnLinkManual').onclick = ()=> openJoinModal();
    $('#btnSyncNow').onclick = async ()=> { if(!state.cloudOn) return alert('Activa Cloud ON'); if(!state.session) return alert('Vincula primero'); try{ await syncFetchAndMerge(); } catch(e){ alert('Sync error: '+e.message); } };
    $('#chkAuto').onchange = e=> { if(e.target.checked){ startAutoSync(); } else stopAutoSync(); };

    // key "N" open new tx
    window.addEventListener('keydown', e=> { if(e.key.toLowerCase()==='n' && !e.ctrlKey && !e.metaKey && !e.altKey){ const tag = document.activeElement && document.activeElement.tagName; if(['INPUT','TEXTAREA','SELECT'].includes(tag)) return; openTxModal(null); } });
  }

  // ---------------- JOIN modal (manual) ----------------
  function openJoinModal(){
    showModal(`<div><h3 style="margin:0">Vincular dispositivo (JOIN)</h3>
      <div class="muted-small" style="margin-top:8px">Ingresa JOIN CODE proporcionado por la organización central. El backend validará y emitirá token de sesión.</div>
      <div style="margin-top:8px"><input id="joinInput" placeholder="JOINCODE" /></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="joinCancel" class="btn ghost">Cancelar</button><button id="joinDo" class="btn primary">Vincular</button></div>
    </div>`);
    $('#joinCancel').onclick = closeModal;
    $('#joinDo').onclick = async ()=> {
      const code = $('#joinInput').value.trim(); if(!code) return alert('Ingrese código'); if(!state.apiBase) return alert('Configura CLOUD_API_BASE en Export');
      try{ await cloudJoin(code); closeModal(); renderAll(); } catch(e){ console.error(e); alert('No se pudo vincular: '+e.message); }
    };
  }

  // ---------------- INITIALIZE ----------------
  (function init(){
    loadLocal(); bindUI(); renderAll();
    // auto-sync restore
    const auto = localStorage.getItem('jo_auto_sync'); if(auto === 'on'){ $('#chkAuto').checked = true; if(state.cloudOn) startAutoSync(); }
  })();

  // expose debug
  window._jo_state = state;
  window._jo_sync = syncFetchAndMerge;

  </script>
</body>
</html>
