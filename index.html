<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Suite Empresarial · Diario</title>

<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/feather-icons"></script>

<style>
:root{
  --bg:#050b18; --panel:#0c1b30; --muted:#9aabc5; --text:#e9f2ff;
  --accent:#4fc3f7; --accent-2:#7c8cff; --positive:#34d399; --warn:#f59e0b; --danger:#ef4444;
  --card-shadow:0 18px 50px rgba(4,10,25,0.35); --maxw:520px;
  font-family:'Manrope',system-ui,-apple-system,"Segoe UI",sans-serif;
}
[data-theme="light"]{
  --bg:#f5f8ff; --panel:#ffffff; --muted:#5f6470; --text:#0b172a;
  --accent:#2563eb; --accent-2:#7c8cff; --positive:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --card-shadow:0 16px 40px rgba(20,30,70,0.12);
}
*{box-sizing:border-box}
body,html{margin:0;min-height:100%;background:radial-gradient(120% 120% at 12% 12%,#0f315a 0%,#081020 50%,#050b18 100%);color:var(--text);-webkit-font-smoothing:antialiased;transition:background .25s,color .25s}
[data-theme="light"] body,[data-theme="light"] html{background:linear-gradient(180deg,#f8fbff,#eef4ff)}
.app-root{display:flex;justify-content:center;padding:18px}
.app{width:100%;max-width:var(--maxw);display:flex;flex-direction:column;gap:14px}

.header{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:18px;background:linear-gradient(135deg,rgba(79,195,247,0.18),rgba(124,140,255,0.16));box-shadow:var(--card-shadow)}
.logo{width:60px;height:60px;border-radius:16px;background:linear-gradient(135deg,#4fc3f7,#7c8cff);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:#0b1220;box-shadow:0 12px 40px rgba(79,195,247,0.35)}
.title-wrap h1{margin:0;font-size:18px}
.title-wrap p{margin:2px 0 0;font-size:12px;color:var(--muted)}
.status-bar{display:flex;gap:6px;align-items:center;margin-top:6px;font-size:12px;color:var(--muted);flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 9px;border-radius:999px;font-weight:700;font-size:11px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04)}
.badge.green{color:var(--positive);border-color:rgba(52,211,153,0.35)}
.badge.amber{color:var(--warn);border-color:rgba(245,158,11,0.4)}
.badge.red{color:var(--danger);border-color:rgba(239,68,68,0.4)}

.nav-scroll{display:flex;gap:10px;overflow:auto;padding:8px 4px;margin:-6px 0 4px}
.nav-btn{flex:1;min-width:120px;border:0;border-radius:12px;padding:11px 12px;display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--muted);background:rgba(255,255,255,0.04);font-weight:800;transition:all .12s;white-space:nowrap}
.nav-btn.active{color:var(--accent);background:rgba(79,195,247,0.14);box-shadow:0 10px 30px rgba(79,195,247,0.18);transform:translateY(-1px)}

.top-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
.btn{padding:11px 12px;border-radius:12px;border:1px solid transparent;cursor:pointer;font-weight:800;display:inline-flex;gap:8px;align-items:center;justify-content:center;color:var(--text);background:rgba(255,255,255,0.06);transition:transform .08s,box-shadow .12s}
.btn:active{transform:scale(0.98)}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));border:0;color:#0b1220;box-shadow:0 12px 28px rgba(79,195,247,0.35)}
.btn.ghost{border-color:rgba(255,255,255,0.08);color:var(--muted)}
.btn.positive{background:linear-gradient(135deg,#34d399,#0fa971);border:0;color:#0b1220;box-shadow:0 12px 28px rgba(52,211,153,0.3)}
.btn.warn{background:linear-gradient(135deg,#f59e0b,#f97316);border:0;color:#0b1220;box-shadow:0 12px 28px rgba(249,115,22,0.28)}

.card{background:var(--panel);border:1px solid rgba(255,255,255,0.04);border-radius:16px;padding:14px;box-shadow:var(--card-shadow)}
.section-title{display:flex;justify-content:space-between;align-items:center;font-weight:800;font-size:15px}

.kpigrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
.kpi{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.05);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:6px}
.kpi .label{font-size:12px;color:var(--muted)}
.kpi .value{font-weight:900;font-size:20px}
.kpi .sub{font-size:12px;color:var(--muted)}

table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:10px 6px;border-bottom:1px solid rgba(255,255,255,0.05);text-align:left}
td.right{text-align:right}
.habits-table input{max-width:80px;text-align:center}
.habits-area{font-weight:700}
.habits-table td{vertical-align:middle}
.habits-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:800;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12)}
.habits-range{font-weight:700;color:var(--muted)}
.progress-wrap{height:6px;border-radius:999px;background:rgba(255,255,255,0.08);overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}

.small{font-size:12px;color:var(--muted)}
.scroll-y{max-height:360px;overflow:auto;padding-right:4px}

.fab{position:fixed;right:18px;bottom:18px;background:linear-gradient(135deg,#7c8cff,#4fc3f7);color:#0b1220;border:0;border-radius:16px;padding:14px 16px;font-weight:900;box-shadow:0 20px 50px rgba(79,195,247,0.25);display:flex;gap:8px;align-items:center;cursor:pointer;z-index:1100}

.overlay{position:fixed;inset:0;background:rgba(5,9,18,0.7);display:none;align-items:center;justify-content:center;z-index:2000;padding:16px}
.modal{width:100%;max-width:520px;background:#0f243d;border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,0.06);box-shadow:var(--card-shadow)}
[data-theme="light"] .modal{background:#ffffff;border-color:rgba(0,0,0,0.06)}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:var(--text);font-size:14px}
[data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] textarea{border-color:rgba(0,0,0,0.08);background:rgba(0,0,0,0.02);color:#0b172a}

#chartFlows{max-height:240px}
.loader{width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,0.18);border-top-color:var(--accent);animation:spin .7s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}

@media (min-width: 821px){
  .app-root{padding:28px}
  body,html{background:radial-gradient(160% 160% at 20% 15%,#12385f 0%,#0b1220 55%,#080d18 100%)}
}
</style>
</head>
<body>
  <div class="app-root">
    <div class="app" role="application" aria-label="Suite Financiera Mejorada">
      <header class="header">
        <div class="logo">JO</div>
        <div class="title-wrap">
          <h1>JHONATAN ORELLANA</h1>
          <p>Control financiero centralizado • UNA DATA</p>
          <div class="status-bar">
            <span class="badge green" id="statusCloud">LOCAL</span>
            <span class="badge amber" id="syncStatus">idle</span>
            <span class="badge" id="netStatus">online</span>
          </div>
          <div class="small">orgId: <strong id="orgBadge">oxIgjNwqNPiAneP5alpM</strong></div>
          <div class="small" id="syncLog">Último sync: —</div>
        </div>
        <button id="themeToggle" class="btn ghost" title="Tema claro/oscuro"><i data-feather="sun"></i></button>
      </header>

      <div class="nav-scroll" aria-label="Menú">
        <button class="nav-btn active" data-view="dashboard"><i data-feather="bar-chart-2"></i>Resumen</button>
        <button class="nav-btn" data-view="transactions"><i data-feather="credit-card"></i>Transacciones</button>
        <button class="nav-btn" data-view="banks"><i data-feather="bank"></i>Bancos</button>
        <button class="nav-btn" data-view="assets"><i data-feather="layers"></i>Activos</button>
        <button class="nav-btn" data-view="debts"><i data-feather="briefcase"></i>Deudas</button>
        <button class="nav-btn" data-view="fixed"><i data-feather="calendar"></i>Mensuales</button>
        <button class="nav-btn" data-view="categories"><i data-feather="tag"></i>Categorías</button>
        <button class="nav-btn" data-view="businesses"><i data-feather="briefcase"></i>Empresas</button>
        <button class="nav-btn" data-view="habits"><i data-feather="check-square"></i>Hábitos</button>
        <button class="nav-btn" data-view="export"><i data-feather="download-cloud"></i>Export</button>
      </div>

      <div class="top-actions">
        <button id="btnNewTx" class="btn primary"><i data-feather="plus"></i> Nueva transacción</button>
        <button id="btnNewBank" class="btn ghost"><i data-feather="plus-circle"></i> Nueva cuenta</button>
        <button id="btnPDF" class="btn positive"><i data-feather="file-text"></i> Exportar PDF</button>
        <button id="btnSyncNow" class="btn ghost"><i data-feather="refresh-cw"></i> Sync ahora</button>
      </div>

      <section class="kpigrid">
        <div class="kpi"><div class="label">Dinero (Cuentas)</div><div class="value" id="kpi-money">S/ 0.00</div><div class="sub">Total disponible en bancos</div></div>
        <div class="kpi"><div class="label">Bienes (Activos + Empresas)</div><div class="value" id="kpi-goods">S/ 0.00</div><div class="sub">Valor estimado de bienes</div></div>
        <div class="kpi"><div class="label">Pasivos + Deudas</div><div class="value" id="kpi-liab">S/ 0.00</div><div class="sub">Obligaciones pendientes</div></div>
        <div class="kpi"><div class="label">Saldo Neto</div><div class="value" id="kpi-net">S/ 0.00</div><div class="sub">Dinero + Bienes - Pasivos</div></div>
      </section>

      <section id="view-dashboard" class="card" style="display:block">
        <div class="section-title">
          <div>Flujo Ingresos vs Egresos (12 meses)</div>
          <div class="small" id="todayDate">Hoy: --</div>
        </div>
        <div><canvas id="chartFlows" height="220"></canvas></div>
        <div class="card" style="margin-top:12px;background:rgba(255,255,255,0.02)">
          <div class="section-title"><div>Resumen ejecutivo</div><div class="small" id="orgShort">Org: oxIgjNwqNPiAneP5alpM</div></div>
          <div class="small">Patrimonio neto</div>
          <div style="font-weight:900;font-size:20px" id="patrimony">S/ 0.00</div>
          <div style="margin-top:10px" class="small">Alertas</div>
          <div id="alertsArea" class="small" style="margin-top:6px;color:var(--muted)">Sin alertas</div>
        </div>
        <div class="card" style="margin-top:12px;background:rgba(255,255,255,0.02)">
          <div class="section-title"><div>Últimas transacciones</div><button id="btnApplyFixedQuick" class="btn warn" style="padding:6px 10px"><i data-feather="zap"></i> Fijos hoy</button></div>
          <div id="smallTxList" class="small" style="margin-top:6px;color:var(--muted)">—</div>
        </div>
      </section>

      <section id="view-transactions" class="card" style="display:none">
        <div class="section-title">
          <div>Transacciones</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="search" placeholder="Buscar..." style="max-width:140px" />
            <select id="filterAccount" style="max-width:150px"><option value="">Todas</option></select>
            <button id="btnAddTx" class="btn primary"><i data-feather="plus"></i> Agregar</button>
          </div>
        </div>
        <div class="scroll-y">
          <table id="txTable"><thead><tr><th>Fecha</th><th>Cuenta</th><th>Tipo</th><th>Cat/Activo</th><th class="right">Monto</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="view-banks" class="card" style="display:none">
        <div class="section-title">
          <div>Cuentas Bancarias</div>
          <div style="display:flex;gap:8px">
            <button id="btnAddBankTop" class="btn primary"><i data-feather="plus"></i> Nueva</button>
            <button id="btnExportBanks" class="btn ghost"><i data-feather="download"></i> Export</button>
          </div>
        </div>
        <div id="banksArea" class="scroll-y"></div>
      </section>

      <section id="view-assets" class="card" style="display:none">
        <div class="section-title">
          <div>Activos y Pasivos</div>
          <div style="display:flex;gap:8px">
            <button id="btnAddAssetTop" class="btn primary"><i data-feather="plus-square"></i> Activo</button>
            <button id="btnAddLiabTop" class="btn ghost"><i data-feather="minus-square"></i> Pasivo</button>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div id="assetsArea" class="scroll-y"></div>
          <div id="liabilitiesArea" class="scroll-y"></div>
        </div>
      </section>

      <section id="view-debts" class="card" style="display:none">
        <div class="section-title">
          <div>Deudas</div>
          <button id="btnAddDebtTop" class="btn primary"><i data-feather="credit-card"></i> Nueva deuda</button>
        </div>
        <div id="debtsArea" class="scroll-y"></div>
      </section>

      <section id="view-fixed" class="card" style="display:none">
        <div class="section-title">
          <div>Gastos Mensuales</div>
          <div style="display:flex;gap:8px">
            <button id="btnAddFixedTop" class="btn primary"><i data-feather="clock"></i> Agregar</button>
            <button id="btnApplyFixedTop" class="btn ghost"><i data-feather="play"></i> Aplicar</button>
          </div>
        </div>
        <div id="fixedArea" class="scroll-y"></div>
      </section>

      <section id="view-categories" class="card" style="display:none">
        <div class="section-title"><div>Categorías & Límites</div><button id="btnAddCategoryTop" class="btn primary"><i data-feather="tag"></i> Nueva</button></div>
        <div id="categoriesArea" class="scroll-y"></div>
      </section>

      <section id="view-businesses" class="card" style="display:none">
        <div class="section-title"><div>Empresas / Proyectos</div><button id="btnAddBizTop" class="btn primary"><i data-feather="briefcase"></i> Nueva</button></div>
        <div id="businessesArea" class="scroll-y"></div>
      </section>

      <section id="view-habits" class="card" style="display:none">
        <div class="section-title" style="flex-wrap:wrap;gap:8px">
          <div>Hábitos diarios</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="habitsDate" type="date" style="max-width:160px" />
            <span id="habitsBadge" class="badge green">0%</span>
            <button id="btnHabitsReset" class="btn ghost"><i data-feather="refresh-cw"></i> Reset día</button>
            <button id="btnHabitsExport" class="btn primary"><i data-feather="download"></i> Export JSON</button>
          </div>
        </div>

        <div class="kpigrid" style="margin-top:10px">
          <div class="kpi"><div class="label">Puntaje logrado</div><div class="value" id="habitsScore">0/0</div><div class="sub">Suma del día</div></div>
          <div class="kpi"><div class="label">Porcentaje del día</div><div class="value" id="habitsPct">0%</div><div class="sub">Meta diaria</div></div>
          <div class="kpi"><div class="label">Racha</div><div class="value" id="habitsStreak">0</div><div class="sub">Días seguidos ≥ 70%</div></div>
        </div>

        <div class="scroll-y" style="margin-top:12px">
          <table id="habitsTable" class="habits-table">
            <thead><tr><th>Área</th><th>Hábito</th><th class="right">Rango</th><th class="right">Hoy</th><th class="right">%</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:12px;background:rgba(255,255,255,0.02)">
          <div class="section-title"><div>Historial últimos 14 días</div></div>
          <div id="habitsHistory" class="small" style="margin-top:6px;color:var(--muted)">—</div>
        </div>
      </section>

      <section id="view-export" class="card" style="display:none">
        <div class="section-title">
          <div>Export / Import / Cloud</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnExportCSV" class="btn primary"><i data-feather="download"></i> CSV</button>
            <button id="btnExportJSON" class="btn ghost"><i data-feather="cloud"></i> JSON</button>
            <input id="fileImport" type="file" accept=".csv,application/json" style="max-width:130px" />
            <button id="btnImport" class="btn primary"><i data-feather="upload"></i> Importar</button>
            <button id="btnExportPDF" class="btn positive"><i data-feather="file-text"></i> PDF</button>
          </div>
        </div>
        <div class="small" style="margin-top:8px">PDF: Título 12pt · Subtítulos 11pt · Texto 10pt</div>
      </section>
    </div>
  </div>

  <div id="overlay" class="overlay" aria-hidden="true"><div class="modal" id="panelRoot"></div></div>
  <button id="fab" class="fab" title="Nueva transacción"><i data-feather="plus"></i> Nueva Tx</button>
  <div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f243d;padding:10px 12px;border-radius:12px;display:none;z-index:1200;box-shadow:var(--card-shadow)"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBVppNAicRPFXEUdErmHd24se_9bjXiqcM",
      authDomain: "jhona-1b398.firebaseapp.com",
      databaseURL: "https://jhona-1b398-default-rtdb.firebaseio.com",
      projectId: "jhona-1b398",
      storageBucket: "jhona-1b398.firebasestorage.app",
      messagingSenderId: "981136306223",
      appId: "1:981136306223:web:d8948acdb119f0facc56da",
      measurementId: "G-44TXK10R9R"
    };
    const ORG_ID = "oxIgjNwqNPiAneP5alpM";
    const LOCAL_LOGIN = { user: "JHONATAN", pass: "JHONATAN" };
  </script>

  <script type="module">
  const $ = (s,r=document)=> r.querySelector(s);
  const $$ = (s,r=document)=> Array.from((r||document).querySelectorAll(s));
  const nowISO = ()=> new Date().toISOString();
  const THEME_KEY = 'suite_theme';
  const DEVICE_ID_KEY = 'suite_device_id';
  const DEVICE_ID = localStorage.getItem(DEVICE_ID_KEY) || (()=>{ const v='dev_'+Math.random().toString(36).slice(2,10); localStorage.setItem(DEVICE_ID_KEY,v); return v; })();
  const STORAGE_KEY = 'jona_business_single_data_v5';
  const HABITS_CFG = [
    { area:'DESARROLLO PROFESIONAL', items:[
      { key:'work', label:'WORK (bloques profundos)', max:8 },
      { key:'trabajo_extra', label:'TRABAJO EXTRA', max:6 },
      { key:'planificacion_diaria', label:'PLANIFICACIÓN DIARIA', max:4 },
      { key:'valor_economico', label:'GENERÉ VALOR ECONÓMICO HOY', max:8 },
      { key:'capacitacion', label:'CAPACITACIÓN', max:6 },
      { key:'ver_tutoriales', label:'VER TUTORIALES', max:4 },
      { key:'leer_1_hora', label:'LEER 1 HORA', max:4 }
    ]},
    { area:'SALUD Y ENERGÍA', items:[
      { key:'desayuno', label:'DESAYUNO', max:2 },
      { key:'almuerzo', label:'ALMUERZO', max:2 },
      { key:'cena', label:'CENA', max:2 },
      { key:'descansar_8_horas', label:'DORMIR 8 HORAS', max:6 },
      { key:'tomar_2_litros', label:'TOMAR 2 LITROS DE AGUA', max:3 },
      { key:'extracto_verduras', label:'EXTRACTO DE VERDURAS', max:2 },
      { key:'ejercicios', label:'EJERCICIOS', max:6 },
      { key:'azucar_control', label:'AZÚCAR CONTROLADO', max:1 }
    ]},
    { area:'ASEO Y ORDEN', items:[
      { key:'cepillarse', label:'CEPILLARSE LOS DIENTES', max:3 },
      { key:'afeitarse', label:'AFEITARSE', max:1 },
      { key:'banarse', label:'BAÑARSE (2 VECES)', max:3 },
      { key:'ordenar_cuarto', label:'ORDENAR CUARTO', max:3 },
      { key:'ropa_sucia', label:'ROPA SUCIA (≤ 5 PRENDAS)', max:2 }
    ]},
    { area:'CUIDADO PERSONAL', items:[
      { key:'minioxidil', label:'MINIOXIDIL', max:1 },
      { key:'cera_ve', label:'CERA VE', max:1 },
      { key:'movilidad', label:'MOVILIDAD / ESTIRAMIENTOS', max:2 },
      { key:'skincare', label:'CUIDADO PIEL', max:2 }
    ]},
    { area:'DISCIPLINA Y MENTAL', items:[
      { key:'no_mt', label:'NO MT', max:2 },
      { key:'sin_distracciones', label:'SIN DISTRACCIONES DIGITALES', max:5 },
      { key:'gratitud_llamar', label:'GRATITUD / LLAMAR A FAMILIA', max:3 }
    ]},
    { area:'GESTIÓN', items:[
      { key:'revision_finanzas', label:'REVISIÓN FINANCIERA DIARIA', max:4 },
      { key:'orden_digital', label:'ORDEN DIGITAL (CORREO/ARCHIVOS)', max:4 }
    ]}
  ];
  let habitsSelectedDate = null;

  function uid(pref){ return `${pref}_${Date.now()}_${Math.floor(Math.random()*90000)}`; }
  function fmtMoney(v){ v = Number(v)||0; return 'S/ ' + v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function parseDateDDMMYYYY(s){ if(!s) return null; const p=s.split('/'); if(p.length!==3) return null; const d=Number(p[0]), m=Number(p[1])-1, y=Number(p[2]); const D=new Date(y,m,d); return isNaN(D)?null:D; }
  function toDDMMYYYY(d){ if(!d) return ''; return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear(); }
  function showToast(msg,err=false){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; t.style.background= err ? '#fff1f0' : 'rgba(255,255,255,0.06)'; t.style.color = err ? 'var(--danger)' : 'var(--text)'; clearTimeout(window.__to); window.__to=setTimeout(()=> t.style.display='none', err?7000:3500); }

  function applyTheme(th){ document.documentElement.setAttribute('data-theme', th); localStorage.setItem(THEME_KEY, th); const icon = $('#themeToggle i'); if(icon){ icon.dataset.feather = th==='light' ? 'moon' : 'sun'; feather.replace(); } }
  applyTheme(localStorage.getItem(THEME_KEY)||'dark');
  $('#themeToggle').onclick = ()=> applyTheme(document.documentElement.getAttribute('data-theme')==='light'?'dark':'light');

  const state = { user:null, fsHelpers:null, unsubscribeRealtime:null,
    data:{transactions:[],banks:[],debts:[],fixed:[],categories:[],assets:[],liabilities:[],businesses:[],habitsByDate:{},meta:{updatedAt:null}},
    pendingOps:[], syncing:false };

  function clone(obj){ return (typeof structuredClone === 'function') ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)); }
  function loadLocal(){ const raw=localStorage.getItem(STORAGE_KEY); if(raw) try{ state.data=JSON.parse(raw); }catch{}; ['transactions','banks','debts','fixed','categories','assets','liabilities','businesses'].forEach(k=> state.data[k] ||= []); state.data.habitsByDate ||= {}; state.data = normalizeData(state.data); }
  function persistLocal(){ state.data.meta.updatedAt = nowISO(); localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data)); }

  const isDeleted = it => !!(it && it.deletedAt);
  const activeItems = arr => (arr||[]).filter(it=>!isDeleted(it));
  function markDeleted(it){
    if(!it || it.deletedAt) return;
    const now = nowISO();
    it.deletedAt = now;
    it.updatedAt = now;
    it.deletedBy = DEVICE_ID;
  }

  const tsVal = item => !item ? 0 : Date.parse(item.updatedAt||item.createdAt||0)||0;
  function pickPreferred(a,b){
    if(!a) return b;
    if(!b) return a;
    const aDel = isDeleted(a);
    const bDel = isDeleted(b);
    if(aDel && bDel) return tsVal(a) >= tsVal(b) ? a : b;
    if(aDel) return a;
    if(bDel) return b;
    return tsVal(a) >= tsVal(b) ? a : b;
  }
  const normalizeData = data => {
    const ensureIds = (arr, pref)=> (arr||[]).map(it=>{
      if(!it.id) it.id = uid(pref);
      if(!it.createdAt) it.createdAt = nowISO();
      if(!it.updatedAt) it.updatedAt = it.createdAt;
      if(it.deletedAt && Date.parse(it.deletedAt) > Date.parse(it.updatedAt||0)) it.updatedAt = it.deletedAt;
      if(!it.deviceId) it.deviceId = DEVICE_ID;
      return it;
    });
    data.transactions = ensureIds(data.transactions,'t');
    data.banks = ensureIds(data.banks,'b');
    data.debts = ensureIds(data.debts,'debt');
    data.fixed = ensureIds(data.fixed,'fix');
    data.categories = ensureIds(data.categories,'cat');
    data.assets = ensureIds(data.assets,'asset');
    data.liabilities = ensureIds(data.liabilities,'liab');
    data.businesses = ensureIds(data.businesses,'biz');
    data.habitsByDate = data.habitsByDate || {};
    Object.keys(data.habitsByDate).forEach(k=>{
      const rec = data.habitsByDate[k];
      if(!rec || typeof rec !== 'object'){ delete data.habitsByDate[k]; return; }
      if(!rec.updatedAt) rec.updatedAt = nowISO();
      if(rec.deletedAt && Date.parse(rec.deletedAt) > Date.parse(rec.updatedAt||0)) rec.updatedAt = rec.deletedAt;
      if(!rec.deviceId) rec.deviceId = DEVICE_ID;
      HABITS_CFG.forEach(g=> g.items.forEach(it=> { if(rec[it.key]==null || rec[it.key]==='') rec[it.key]=0; }));
    });

    const dedup = (arr,keyFn)=>{
      const m=new Map();
      (arr||[]).forEach(it=>{
        if(!it) return;
        const k=keyFn(it);
        const prev=m.get(k);
        m.set(k, pickPreferred(prev, it));
      });
      return Array.from(m.values());
    };
    data.transactions = dedup(data.transactions, t=> t.id || `${t.dateStr}|${t.type}|${t.bankId||''}|${t.amount}|${(t.description||'').trim().toLowerCase()}`);
    data.banks = dedup(data.banks, b=> b.id || b.name.toLowerCase());
    data.assets = dedup(data.assets, a=> a.id || a.name.toLowerCase());
    data.liabilities = dedup(data.liabilities, l=> l.id || l.name.toLowerCase());
    data.debts = dedup(data.debts, d=> d.id || d.name.toLowerCase());
    data.fixed = dedup(data.fixed, f=> f.id || f.name.toLowerCase());
    data.categories = dedup(data.categories, c=> c.id || c.name.toLowerCase());
    data.businesses = dedup(data.businesses, b=> b.id || b.name.toLowerCase());
    return data;
  };

  function mergeCollectionsById(localArr=[], remoteArr=[]){
    const map=new Map();
    (localArr||[]).forEach(it=>{ if(!it) return; if(!it.id) it.id=uid('x'); map.set(it.id,it); });
    (remoteArr||[]).forEach(r=>{
      if(!r) return;
      if(!r.id) r.id=uid('x');
      const e=map.get(r.id);
      map.set(r.id, pickPreferred(e, r));
    });
    return Array.from(map.values()).sort((a,b)=> tsVal(b)-tsVal(a));
  }
  function mergeHabitsByDate(localObj={}, remoteObj={}){
    const out = {};
    const keys = new Set([...(localObj?Object.keys(localObj):[]), ...(remoteObj?Object.keys(remoteObj):[])]);
    keys.forEach(k=>{
      const a = localObj ? localObj[k] : null;
      const b = remoteObj ? remoteObj[k] : null;
      out[k] = pickPreferred(a, b);
    });
    return out;
  }
  function mergeFullDatasets(remote, local){
    if(!remote) return clone(local||{});
    if(!local) return clone(remote||{});
    return normalizeData({
      transactions: mergeCollectionsById(local.transactions, remote.transactions),
      banks: mergeCollectionsById(local.banks, remote.banks),
      debts: mergeCollectionsById(local.debts, remote.debts),
      fixed: mergeCollectionsById(local.fixed, remote.fixed),
      categories: mergeCollectionsById(local.categories, remote.categories),
      assets: mergeCollectionsById(local.assets, remote.assets),
      liabilities: mergeCollectionsById(local.liabilities, remote.liabilities),
      businesses: mergeCollectionsById(local.businesses, remote.businesses),
      habitsByDate: mergeHabitsByDate(local.habitsByDate, remote.habitsByDate),
      meta:{updatedAt:nowISO()}
    });
  }

  async function initFirestore(cfg){
    if(state.fsHelpers) return;
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
    const { getFirestore, doc, getDoc, setDoc, onSnapshot, enableIndexedDbPersistence } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
    const app = initializeApp(cfg);
    const firestore = getFirestore(app);
    try{ await enableIndexedDbPersistence(firestore); }catch{}
    state.fsHelpers = { doc, getDoc, setDoc, onSnapshot, firestore };
    $('#statusCloud').textContent='CLOUD'; $('#statusCloud').classList.add('green');
  }

  async function fsFetch(){
    const {doc,getDoc,firestore}=state.fsHelpers;
    const ref=doc(firestore,'organizations',ORG_ID,'DATA','DATA');
    const snap=await getDoc(ref);
    if(!snap.exists()) return {data:null,updatedAt:null};
    const payload=snap.data();
    return {data:payload.data||null,updatedAt:payload.updatedAt||null};
  }
  async function fsSaveWithMerge(localData){
    const {doc,setDoc,getDoc,firestore}=state.fsHelpers;
    const ref=doc(firestore,'organizations',ORG_ID,'DATA','DATA');
    let remote=null; try{ const s=await getDoc(ref); if(s.exists()) remote=s.data().data||null; }catch{}
    const merged=normalizeData(mergeFullDatasets(remote, localData));
    const updatedAt=nowISO();
    await setDoc(ref,{data:merged,updatedAt},{merge:true});
    state.data=merged; persistLocal();
    const syncLog=$('#syncLog'); if(syncLog) syncLog.textContent='Último sync: '+updatedAt;
    return updatedAt;
  }

  function startRealtime(){
    if(!state.fsHelpers) return;
    const {doc,onSnapshot,firestore}=state.fsHelpers;
    const ref=doc(firestore,'organizations',ORG_ID,'DATA','DATA');
    if(state.unsubscribeRealtime) try{ state.unsubscribeRealtime(); }catch{}
    state.unsubscribeRealtime = onSnapshot(ref, snap=>{
      if(!snap.exists()) return;
      const payload=snap.data(); if(!payload||!payload.data) return;
      state.data = normalizeData(mergeFullDatasets(payload.data, state.data));
      persistLocal(); renderAll();
      const syncLog=$('#syncLog'); if(syncLog) syncLog.textContent='Último sync: '+(payload.updatedAt||nowISO());
      showToast('Datos sincronizados');
    }, err=> { console.warn('Realtime err', err); const syncLog=$('#syncLog'); if(syncLog) syncLog.textContent='Realtime error'; });
  }

  let pushTimer=null;
  function setSyncStatus(txt){
    const el=$('#syncStatus'); if(!el) return;
    if(txt==='working') el.innerHTML='<span class="loader"></span> sync';
    else el.textContent=txt;
  }
  function schedulePushDebounced(delay=800){
    if(!state.fsHelpers){ state.pendingOps.push('push'); return; }
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer=setTimeout(async()=>{
      try{ setSyncStatus('working'); await fsSaveWithMerge(state.data); showToast('Cambios subidos'); }
      catch(e){ showToast('Error al subir: '+(e.message||e),true); }
      finally{ setSyncStatus('idle'); }
    },delay);
  }
  function flushPending(){ if(!state.fsHelpers || !state.pendingOps.length) return; state.pendingOps=[]; schedulePushDebounced(200); }

  function pushAndRender(mut){ mut(state.data); persistLocal(); renderAll(); if(state.fsHelpers) schedulePushDebounced(); else state.pendingOps.push('push'); }
  function ensureTimestamps(obj){ const n=nowISO(); obj.createdAt=obj.createdAt||n; obj.updatedAt=n; obj.deviceId=obj.deviceId||DEVICE_ID; }

  function applyTransactionEffects(d, tx){
    const amount=Number(tx.amount)||0;
    const bank=d.banks.find(b=>b.id===tx.bankId && !isDeleted(b));
    if(bank){ bank.balance=(Number(bank.balance)||0) + (tx.type==='Egreso' ? -amount : amount); ensureTimestamps(bank); }
    if(tx.debtId && tx.type==='Egreso'){
      const debt=d.debts.find(x=>x.id===tx.debtId && !isDeleted(x));
      if(debt){ debt.outstanding=Math.max(0,(Number(debt.outstanding)||0)-amount); ensureTimestamps(debt); }
    }
    if(tx.assetId && tx.type==='Ingreso'){
      const asset=d.assets.find(a=>a.id===tx.assetId && !isDeleted(a));
      if(asset){
        asset.accumulatedGain=(Number(asset.accumulatedGain)||0)+amount;
        asset.incomeRecords=asset.incomeRecords||[];
        asset.incomeRecords.unshift({id:uid('ag'),txId:tx.id,dateStr:tx.dateStr,amount,desc:tx.description||'',createdAt:nowISO(),updatedAt:nowISO(),deviceId:DEVICE_ID});
        ensureTimestamps(asset);
      }
    }
  }
  function reverseTransactionEffects(d, tx){
    const amount=Number(tx.amount)||0;
    const bank=d.banks.find(b=>b.id===tx.bankId && !isDeleted(b));
    if(bank){ bank.balance=(Number(bank.balance)||0) + (tx.type==='Egreso' ? amount : -amount); ensureTimestamps(bank); }
    if(tx.debtId && tx.type==='Egreso'){
      const debt=d.debts.find(x=>x.id===tx.debtId && !isDeleted(x));
      if(debt){ debt.outstanding=(Number(debt.outstanding)||0)+amount; ensureTimestamps(debt); }
    }
    if(tx.assetId && tx.type==='Ingreso'){
      const asset=d.assets.find(a=>a.id===tx.assetId && !isDeleted(a));
      if(asset){
        asset.accumulatedGain=Math.max(0,(Number(asset.accumulatedGain)||0)-amount);
        asset.incomeRecords=(asset.incomeRecords||[]).filter(r=>r.txId!==tx.id);
        ensureTimestamps(asset);
      }
    }
  }

  function addBank(obj){ ensureTimestamps(obj); obj.id=obj.id||uid('b'); obj.balance=Number(obj.balance)||0; pushAndRender(d=>d.banks.unshift(obj)); }
  function addCategory(obj){ ensureTimestamps(obj); obj.id=obj.id||uid('cat'); pushAndRender(d=>d.categories.unshift(obj)); }
  function addAsset(obj){ ensureTimestamps(obj); obj.id=obj.id||uid('asset'); obj.estimatedValue=Number(obj.estimatedValue)||0; obj.accumulatedGain=Number(obj.accumulatedGain)||0; obj.incomeRecords=obj.incomeRecords||[]; pushAndRender(d=>d.assets.unshift(obj)); }
  function addLiability(obj){ ensureTimestamps(obj); obj.id=obj.id||uid('liab'); obj.amount=Number(obj.amount)||0; pushAndRender(d=>d.liabilities.unshift(obj)); }
  function addBusiness(obj){ ensureTimestamps(obj); obj.id=obj.id||uid('biz'); obj.estimateValue=Number(obj.estimateValue)||0; pushAndRender(d=>d.businesses.unshift(obj)); }
  function addFixed(obj){ ensureTimestamps(obj); obj.id=obj.id||uid('fix'); obj.amount=Number(obj.amount)||0; pushAndRender(d=>d.fixed.unshift(obj)); }
  function addDebt(obj){ ensureTimestamps(obj); obj.id=obj.id||uid('debt'); obj.outstanding=Number(obj.outstanding)||0; obj.monthlyPayment=Number(obj.monthlyPayment)||0; pushAndRender(d=>d.debts.unshift(obj)); }

  async function addTransaction(tx){
    if(!parseDateDDMMYYYY(tx.dateStr)) throw new Error('Fecha inválida (dd/mm/yyyy)');
    if(!tx.bankId) throw new Error('Seleccione una cuenta bancaria');
    tx.id=tx.id||uid('t'); tx.amount=Number(tx.amount)||0; ensureTimestamps(tx);
    pushAndRender(d=>{ d.transactions.unshift(tx); applyTransactionEffects(d, tx); });
  }
  function updateTransaction(txId, updates){
    pushAndRender(d=>{
      const tx=d.transactions.find(x=>x.id===txId);
      if(!tx || isDeleted(tx)) return;
      reverseTransactionEffects(d, tx);
      Object.assign(tx, updates);
      ensureTimestamps(tx);
      applyTransactionEffects(d, tx);
    });
  }
  function removeTransaction(txId){
    pushAndRender(d=>{
      const idx=d.transactions.findIndex(t=>t.id===txId);
      if(idx<0) return;
      const tx=d.transactions[idx];
      if(isDeleted(tx)) return;
      reverseTransactionEffects(d, tx);
      markDeleted(tx);
    });
  }

  function applyMonthlyFixed(){
    const today=toDDMMYYYY(new Date());
    pushAndRender(d=>{
      activeItems(d.fixed).forEach(f=>{
        const tx={id:uid('t'),type:'Egreso',dateStr:today,amount:Number(f.amount)||0,bankId:f.bankId||null,categoryId:f.categoryId||null,description:'Gasto fijo: '+f.name,createdAt:nowISO(),updatedAt:nowISO(),deviceId:DEVICE_ID,meta:{fromFixed:f.id}};
        d.transactions.unshift(tx);
        applyTransactionEffects(d, tx);
      });
    });
    showToast('Gastos fijos aplicados');
  }

  function exportCSV(){
    const rows=activeItems(state.data.transactions).map(t=>{
      const b=activeItems(state.data.banks).find(b=>b.id===t.bankId);
      const c=activeItems(state.data.categories).find(c=>c.id===t.categoryId);
      const a=activeItems(state.data.assets).find(a=>a.id===t.assetId);
      return [t.dateStr||'', b?b.name:'', t.type||'', c?c.name:(t.categoryName||''), a?('ACT:'+a.name):'', (t.description||'').replace(/\"/g,'\"\"'), t.amount||0];
    });
    const csv=['fecha,cuenta,tipo,categoria,activo,descripcion,monto', ...rows.map(r=>r.map((c,i)=> i===5?`\"${c}\"`:c).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='transacciones.csv'; a.click(); URL.revokeObjectURL(url);
  }
  function exportJSON(){ const blob=new Blob([JSON.stringify(state.data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='backup.json'; a.click(); URL.revokeObjectURL(url); }

  async function importFile(file){
    if(!file) return alert('Selecciona archivo');
    const text=await file.text();
    if(file.name.toLowerCase().endsWith('.csv')){
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const headers = lines.shift().split(',').map(h=>h.toLowerCase());
      for(const ln of lines){
        const parts=ln.match(/(\".*?\"|[^,]+)(?=\s*,|\s*$)/g).map(p=>p.replace(/^\"|\"$/g,'').replace(/\"\"/g,'\"'));
        const obj={}; headers.forEach((h,i)=> obj[h]=parts[i]||'');
        const bank=activeItems(state.data.banks).find(b=>b.name===obj.cuenta);
        const cat=activeItems(state.data.categories).find(c=>c.name===obj.categoria);
        const asset=activeItems(state.data.assets).find(a=> obj.activo && obj.activo.includes(a.name));
        try{ await addTransaction({ type: obj.tipo||'Ingreso', amount: Number(obj.monto)||0, bankId: bank?bank.id:null, categoryId: cat?cat.id:null, assetId: asset?asset.id:null, categoryName: obj.categoria||'', description: obj.descripcion||'', dateStr: obj.fecha }); } catch(e){ console.warn('import tx fail', e); }
      }
      showToast('CSV importado');
    } else {
      try{ const d=JSON.parse(text); state.data=normalizeData(mergeFullDatasets(d, state.data)); persistLocal(); if(state.fsHelpers) schedulePushDebounced(400); renderAll(); showToast('JSON importado y fusionado'); } catch(e){ alert('JSON inválido'); }
    }
  }

  async function exportPDF(){
    const banksTotal=activeItems(state.data.banks).reduce((s,b)=>s+(Number(b.balance)||0),0);
    const assetsTotal=activeItems(state.data.assets).reduce((s,a)=>s+(Number(a.estimatedValue)||0),0);
    const liabilitiesTotal=activeItems(state.data.liabilities).reduce((s,l)=>s+(Number(l.amount)||0),0);
    const debtsTotal=activeItems(state.data.debts).reduce((s,d)=>s+(Number(d.outstanding)||0),0);
    const incomeTotal=activeItems(state.data.transactions).reduce((s,t)=> s+(t.type==='Egreso'?0:(Number(t.amount)||0)),0);
    const expenseTotal=activeItems(state.data.transactions).reduce((s,t)=> s+(t.type==='Egreso'?(Number(t.amount)||0):0),0);
    const savingsRate=incomeTotal>0?Math.max(0,((incomeTotal-expenseTotal)/incomeTotal)*100).toFixed(1):'0.0';
    let chartImg=null; try{ if(window.flowsChart) chartImg=window.flowsChart.toBase64Image(); }catch{}

    const node=document.createElement('div');
    node.innerHTML=`
      <style>
        .pdf-root{font-family:Arial,Helvetica,sans-serif;color:#111;background:#fff;padding:18px}
        .pdf-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .pdf-title{font-weight:900;font-size:12pt}
        .pdf-sub{font-weight:700;font-size:11pt;margin-top:8px;margin-bottom:6px}
        .pdf-text{font-size:10pt;line-height:1.45}
      </style>
      <div class="pdf-root">
        <div class="pdf-header">
          <div>
            <div class="pdf-title">REPORTE FINANCIERO — JHONATAN ORELLANA</div>
            <div class="pdf-sub">Org: ${ORG_ID} · Fecha: ${toDDMMYYYY(new Date())}</div>
          </div>
          <div style="text-align:right"><div class="pdf-text">Resumen técnico</div></div>
        </div>
        <section><div class="pdf-sub">Resumen ejecutivo</div>
          <p class="pdf-text">Saldo cuentas: <strong>${fmtMoney(banksTotal)}</strong><br/>Bienes (activos+empresas): <strong>${fmtMoney(assetsTotal + activeItems(state.data.businesses).reduce((s,b)=>s+(Number(b.estimateValue)||0),0))}</strong><br/>Pasivos+Deudas: <strong>${fmtMoney(liabilitiesTotal + debtsTotal)}</strong><br/>Tasa de ahorro: <strong>${savingsRate}%</strong></p>
        </section>
        <section><div class="pdf-sub">Gráfica</div>${chartImg?`<div style="text-align:center"><img src="${chartImg}" style="max-width:100%;height:auto;border:1px solid #ddd"/></div>`:'<p class="pdf-text">Gráfica no disponible</p>'}</section>
        <div style="margin-top:12px;font-size:9pt;color:#666">Generado por JHONATAN ORELLANA · Títulos 12pt · Subtítulos 11pt · Texto 10pt</div>
      </div>`;
    if(window.html2pdf){
      html2pdf().set({ margin:12, filename:`reporte_${(new Date()).toISOString().slice(0,10)}.pdf`, image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(node).save();
    } else alert('html2pdf no disponible');
  }

  function toLocalISODate(d){
    const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function ensureHabitsStore(){ state.data.habitsByDate ||= {}; }
  function ensureHabitsDay(dateKey, create=false){
    ensureHabitsStore();
    let rec = state.data.habitsByDate[dateKey];
    if(!rec && create){
      rec = { updatedAt: nowISO(), deviceId: DEVICE_ID };
      HABITS_CFG.forEach(g=> g.items.forEach(it=> { rec[it.key]=0; }));
      state.data.habitsByDate[dateKey] = rec;
    }
    if(rec){
      HABITS_CFG.forEach(g=> g.items.forEach(it=> { if(rec[it.key]==null || rec[it.key]==='') rec[it.key]=0; }));
      if(!rec.updatedAt) rec.updatedAt = nowISO();
      if(!rec.deviceId) rec.deviceId = DEVICE_ID;
    }
    return rec;
  }
  function calcHabitsDay(dateKey){
    ensureHabitsStore();
    const rec = state.data.habitsByDate[dateKey] || {};
    let possible = 0; let earned = 0;
    HABITS_CFG.forEach(g=> g.items.forEach(it=>{
      possible += it.max;
      const raw = Number(rec[it.key])||0;
      const v = Math.max(0, Math.min(it.max, Math.round(raw)));
      earned += v;
    }));
    const pct = possible ? Math.round((earned/possible)*100) : 0;
    return { earned, possible, pct };
  }
  function calcStreak(){
    const today = new Date();
    let streak = 0;
    for(let i=0;i<3650;i++){
      const d = new Date(today); d.setDate(today.getDate()-i);
      const key = toLocalISODate(d);
      if(!state.data.habitsByDate || !state.data.habitsByDate[key]) break;
      const { pct } = calcHabitsDay(key);
      if(pct >= 70) streak++; else break;
    }
    return streak;
  }
  function renderHabits(){
    const section = $('#view-habits'); if(!section) return;
    ensureHabitsStore();
    if(!habitsSelectedDate) habitsSelectedDate = toLocalISODate(new Date());
    const dateInput = $('#habitsDate'); if(dateInput && dateInput.value !== habitsSelectedDate) dateInput.value = habitsSelectedDate;
    const { earned, possible, pct } = calcHabitsDay(habitsSelectedDate);
    $('#habitsScore').textContent = `${earned}/${possible}`;
    $('#habitsPct').textContent = `${pct}%`;
    $('#habitsStreak').textContent = String(calcStreak());
    const badge = $('#habitsBadge');
    if(badge){
      badge.textContent = `${pct}%`;
      badge.className = 'badge ' + (pct>=80?'green':(pct>=55?'amber':'red'));
    }
    const tbody = $('#habitsTable tbody');
    if(tbody){
      tbody.innerHTML = '';
      const rec = state.data.habitsByDate[habitsSelectedDate] || {};
      HABITS_CFG.forEach(group=>{
        group.items.forEach(it=>{
          const raw = Number(rec[it.key])||0;
          const val = Math.max(0, Math.min(it.max, Math.round(raw)));
          const rowPct = it.max ? Math.round((val/it.max)*100) : 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td><span class="habits-pill">${group.area}</span></td><td>${it.label}</td><td class="right habits-range">0–${it.max}</td><td class="right"><input type="number" min="0" max="${it.max}" data-key="${it.key}" value="${val}"/></td><td class="right"><strong>${rowPct}%</strong></td>`;
          tbody.appendChild(tr);
        });
      });
    }
    $$('#habitsTable input').forEach(inp=>{
      inp.oninput = ()=>{
        const key = inp.dataset.key;
        const max = Number(inp.max)||0;
        let v = Math.round(Number(inp.value)||0);
        if(v < 0) v = 0;
        if(v > max) v = max;
        inp.value = v;
        pushAndRender(d=>{
          ensureHabitsStore();
          const rec = ensureHabitsDay(habitsSelectedDate, true);
          rec[key] = v;
          rec.updatedAt = nowISO();
          rec.deviceId = DEVICE_ID;
        });
      };
    });
    const hist = $('#habitsHistory');
    if(hist){
      const lines = [];
      for(let i=0;i<14;i++){
        const d = new Date(); d.setDate(d.getDate()-i);
        const key = toLocalISODate(d);
        const has = !!state.data.habitsByDate[key];
        const { pct: p } = calcHabitsDay(key);
        lines.push(`<div style="display:flex;align-items:center;gap:8px;margin:4px 0"><div style="min-width:92px">${key}</div><div class="progress-wrap" style="flex:1"><div class="progress-fill" style="width:${has?p:0}%"></div></div><div style="min-width:44px;text-align:right"><strong>${has ? (p+'%') : '—'}</strong></div></div>`);
      }
      hist.innerHTML = lines.join('') || '—';
    }
    feather.replace();
  }
  function resetHabitsDay(dateKey){
    const key = dateKey || toLocalISODate(new Date());
    pushAndRender(d=>{
      ensureHabitsStore();
      const rec = ensureHabitsDay(key, true);
      HABITS_CFG.forEach(g=> g.items.forEach(it=> { rec[it.key]=0; }));
      rec.updatedAt = nowISO();
      rec.deviceId = DEVICE_ID;
    });
  }
  function exportHabitsJSON(){
    ensureHabitsStore();
    const date = toLocalISODate(new Date());
    const blob = new Blob([JSON.stringify(state.data.habitsByDate, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `habits_${date}.json`; a.click();
    URL.revokeObjectURL(url);
  }

  let flowsChart=null; window.flowsChart=null;
  function renderFlowsChart(){
    const el=document.getElementById('chartFlows'); if(!el) return;
    const labels=[], incData=[], egData=[]; const now=new Date();
    for(let i=11;i>=0;i--){ const d=new Date(now.getFullYear(),now.getMonth()-i,1);
      labels.push(d.toLocaleString('es-PE',{month:'short',year:'2-digit'}));
      let inc=0,eg=0; activeItems(state.data.transactions).forEach(t=>{ const td=parseDateDDMMYYYY(t.dateStr||''); if(!td) return; if(td.getMonth()===d.getMonth()&&td.getFullYear()===d.getFullYear()){ if(t.type==='Egreso') eg+=Number(t.amount)||0; else inc+=Number(t.amount)||0; } });
      incData.push(inc); egData.push(eg);
    }
    const data={labels,datasets:[
      {label:'Ingresos',type:'line',data:incData,borderColor:'#34d399',backgroundColor:'rgba(52,211,153,0.08)',tension:0.25,yAxisID:'y'},
      {label:'Egresos',type:'bar',data:egData,backgroundColor:'#ef4444',yAxisID:'y'}
    ]};
    if(flowsChart){ flowsChart.data=data; flowsChart.update(); }
    else { flowsChart=new Chart(el,{data,type:'bar',options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true},x:{stacked:false}}}}); window.flowsChart=flowsChart; }
  }

  function dashboardMetrics(){
    const banksTotal=activeItems(state.data.banks).reduce((s,b)=>s+(Number(b.balance)||0),0);
    const assetsTotal=activeItems(state.data.assets).reduce((s,a)=>s+(Number(a.estimatedValue)||0),0);
    const businessesTotal=activeItems(state.data.businesses).reduce((s,b)=>s+(Number(b.estimateValue)||0),0);
    const goodsTotal=assetsTotal+businessesTotal;
    const liabilitiesTotal=activeItems(state.data.liabilities).reduce((s,l)=>s+(Number(l.amount)||0),0);
    const debtsTotal=activeItems(state.data.debts).reduce((s,d)=>s+(Number(d.outstanding)||0),0);
    const obligations=liabilitiesTotal+debtsTotal;
    const net=(banksTotal+goodsTotal)-obligations;
    $('#kpi-money').textContent=fmtMoney(banksTotal);
    $('#kpi-goods').textContent=fmtMoney(goodsTotal);
    $('#kpi-liab').textContent=fmtMoney(obligations);
    $('#kpi-net').textContent=fmtMoney(net);
    $('#patrimony').textContent=fmtMoney(net);
    const now=new Date(), month=now.getMonth(), year=now.getFullYear(); const alerts=[];
    activeItems(state.data.categories).forEach(cat=>{
      if(!cat.limitMonthly||Number(cat.limitMonthly)<=0) return;
      const spent=activeItems(state.data.transactions).reduce((acc,t)=>{ const td=parseDateDDMMYYYY(t.dateStr||''); if(!td) return acc; if(td.getMonth()===month&&td.getFullYear()===year&&t.categoryId===cat.id) acc+=Number(t.amount)||0; return acc; },0);
      if(spent>Number(cat.limitMonthly)) alerts.push(`⚠ ${cat.name} superó límite ${fmtMoney(spent)} / ${fmtMoney(cat.limitMonthly)}`);
      else if(spent>=Number(cat.limitMonthly)*0.8) alerts.push(`! ${cat.name} cerca del límite ${fmtMoney(spent)} / ${fmtMoney(cat.limitMonthly)}`);
    });
    activeItems(state.data.banks).forEach(b=>{ if(Number(b.balance)<0) alerts.push(`❗ ${b.name} saldo negativo ${fmtMoney(b.balance)}`); });
    $('#alertsArea').innerHTML = alerts.length?alerts.join('<br/>'):'<span class="small">Sin alertas</span>';
    $('#todayDate').textContent='Hoy: '+toDDMMYYYY(new Date());
    const last=activeItems(state.data.transactions).slice(0,6).map(t=> `${t.dateStr} · ${t.type} · ${fmtMoney(t.amount)} · ${(t.description||'')}`).join('<br/>')||'—';
    $('#smallTxList').innerHTML=last;
    renderFlowsChart();
  }

  function renderTransactions(){
    const tbody=$('#txTable tbody'); if(!tbody) return; tbody.innerHTML='';
    const q=($('#search')?.value||'').trim().toLowerCase(); const filter=$('#filterAccount')?$('#filterAccount').value:'';
    const activeTx=activeItems(state.data.transactions);
    const activeCats=activeItems(state.data.categories);
    const activeAssets=activeItems(state.data.assets);
    const activeBanks=activeItems(state.data.banks);
    activeTx.filter(t=>{
      if(filter && t.bankId!==filter) return false;
      if(q){
        const cat=activeCats.find(c=>c.id===t.categoryId);
        const asset=activeAssets.find(a=>a.id===t.assetId);
        const txt=`${t.description||''} ${cat?cat.name:''} ${asset?asset.name:''}`.toLowerCase();
        if(!txt.includes(q)) return false;
      }
      return true;
    }).forEach(t=>{
      const bank=activeBanks.find(b=>b.id===t.bankId);
      const cat=activeCats.find(c=>c.id===t.categoryId);
      const asset=activeAssets.find(a=>a.id===t.assetId);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.dateStr||''}</td><td>${bank?bank.name:'-'}</td><td>${t.type}</td><td>${cat?cat.name:(asset?('ACT:'+asset.name):(t.categoryName||'-'))}</td><td class="right">${fmtMoney(t.amount)}</td><td><button data-id="${t.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${t.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td>`;
      tbody.appendChild(tr);
    });
    $$('#txTable button').forEach(btn=> btn.onclick=()=>{
      const {id,act}=btn.dataset;
      if(act==='del'){ if(confirm('Eliminar transacción?')) removeTransaction(id); }
      if(act==='edit'){ const tx=state.data.transactions.find(x=>x.id===id); if(tx) openTxModal(tx); }
      feather.replace();
    });
    feather.replace();
  }

  function renderBanks(){
    const wrap=$('#banksArea'); if(!wrap) return;
    const activeBanks=activeItems(state.data.banks);
    if(!activeBanks.length){ wrap.innerHTML='<div class="small">No hay cuentas registradas</div>'; return; }
    const rows=activeBanks.map(b=>`<tr><td><strong>${b.name}</strong><div class="small">${b.type||''}</div></td><td class="right">${fmtMoney(Number(b.balance)||0)}</td><td><button data-id="${b.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${b.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('');
    wrap.innerHTML=`<table style="width:100%"><thead><tr><th>Cuenta</th><th class="right">Saldo</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`;
    $$('#banksArea button').forEach(btn=> btn.onclick=()=>{
      const {id,act}=btn.dataset;
      if(act==='del'){ if(confirm('Eliminar cuenta?')){ const b=state.data.banks.find(x=>x.id===id); markDeleted(b); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } }
      if(act==='edit'){ const b=state.data.banks.find(x=>x.id===id); openBankModal(b); }
      feather.replace();
    });
    $('#filterAccount').innerHTML='<option value="">Todas</option>'+activeBanks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    feather.replace();
  }

  function renderAssets(){ const wrap=$('#assetsArea'); if(!wrap) return; const activeAssets=activeItems(state.data.assets); if(!activeAssets.length){ wrap.innerHTML='<div class="small">Sin activos</div>'; return; }
    wrap.innerHTML=activeAssets.map(a=>`<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.05)"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${a.name}</strong><div class="small">${a.subtype||'-'} · Valor: ${fmtMoney(a.estimatedValue)}</div></div><div style="display:flex;gap:8px"><button data-id="${a.id}" data-act="view" class="btn ghost"><i data-feather="eye"></i></button><button data-id="${a.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button><button data-id="${a.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></div></div></div>`).join('');
    $$('#assetsArea button').forEach(btn=> btn.onclick=()=>{ const {id,act}=btn.dataset; if(act==='del'){ if(confirm('Eliminar activo?')){ const a=state.data.assets.find(x=>x.id===id); markDeleted(a); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } } if(act==='edit'){ openAssetModal(state.data.assets.find(x=>x.id===id)); } if(act==='view'){ openAssetViewModal(state.data.assets.find(x=>x.id===id)); } feather.replace(); });
    feather.replace();
  }

  function renderLiabilities(){ const wrap=$('#liabilitiesArea'); if(!wrap) return; const activeLiabs=activeItems(state.data.liabilities); if(!activeLiabs.length){ wrap.innerHTML='<div class="small">Sin pasivos</div>'; return; }
    wrap.innerHTML=activeLiabs.map(l=>`<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.05)"><div style="display:flex;justify-content:space-between"><div><strong>${l.name}</strong><div class="small">Tasa: ${l.interestRate||0}% · Venc: ${l.maturityDate||'-'}</div></div><div style="display:flex;gap:8px"><button data-id="${l.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button><button data-id="${l.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></div></div></div>`).join('');
    $$('#liabilitiesArea button').forEach(btn=> btn.onclick=()=>{ const {id,act}=btn.dataset; if(act==='del'){ if(confirm('Eliminar pasivo?')){ const l=state.data.liabilities.find(x=>x.id===id); markDeleted(l); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } } if(act==='edit'){ openLiabilityModal(state.data.liabilities.find(x=>x.id===id)); } feather.replace(); });
    feather.replace();
  }

  function renderDebts(){ const wrap=$('#debtsArea'); if(!wrap) return; const activeDebts=activeItems(state.data.debts); if(!activeDebts.length){ wrap.innerHTML='<div class="small">Sin deudas</div>'; return; }
    const activeBanks=activeItems(state.data.banks);
    wrap.innerHTML=`<table style="width:100%"><thead><tr><th>Deuda</th><th>Banco</th><th class="right">Saldo</th><th class="right">Cuota</th><th>Acc</th></tr></thead><tbody>${activeDebts.map(d=>`<tr><td>${d.name}</td><td>${(activeBanks.find(b=>b.id===d.bankId)||{name:'-'}) .name}</td><td class="right">${fmtMoney(Number(d.outstanding)||0)}</td><td class="right">${fmtMoney(Number(d.monthlyPayment)||0)}</td><td><button data-id="${d.id}" data-act="pay" class="btn positive"><i data-feather="dollar-sign"></i> Pagar</button> <button data-id="${d.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('')}</tbody></table>`;
    $$('#debtsArea button').forEach(btn=> btn.onclick=()=>{ const {id,act}=btn.dataset; if(act==='del'){ if(confirm('Eliminar deuda?')){ const d=state.data.debts.find(x=>x.id===id); markDeleted(d); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } } if(act==='pay'){ openDebtPayModal(state.data.debts.find(x=>x.id===id)); } feather.replace(); });
    feather.replace();
  }

  function renderFixed(){ const wrap=$('#fixedArea'); if(!wrap) return; const activeFixed=activeItems(state.data.fixed); if(!activeFixed.length){ wrap.innerHTML='<div class="small">Sin gastos fijos</div>'; return; }
    const activeBanks=activeItems(state.data.banks);
    wrap.innerHTML=`<table style="width:100%"><thead><tr><th>Nombre</th><th class="right">Monto</th><th>Cuenta</th><th>Acc</th></tr></thead><tbody>${activeFixed.map(f=>`<tr><td>${f.name}</td><td class="right">${fmtMoney(Number(f.amount)||0)}</td><td>${(activeBanks.find(b=>b.id===f.bankId)||{name:'-'}) .name}</td><td><button data-id="${f.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${f.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('')}</tbody></table>`;
    $$('#fixedArea button').forEach(btn=> btn.onclick=()=>{ const {id,act}=btn.dataset; if(act==='del'){ if(confirm('Eliminar gasto fijo?')){ const f=state.data.fixed.find(x=>x.id===id); markDeleted(f); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } } if(act==='edit'){ openFixedModal(state.data.fixed.find(x=>x.id===id)); } feather.replace(); });
    feather.replace();
  }

  function renderCategories(){ const wrap=$('#categoriesArea'); if(!wrap) return; const activeCats=activeItems(state.data.categories); if(!activeCats.length){ wrap.innerHTML='<div class="small">Sin categorías</div>'; return; }
    wrap.innerHTML=`<table style="width:100%"><thead><tr><th>Categoría</th><th class="right">Límite</th><th>Acc</th></tr></thead><tbody>${activeCats.map(c=>`<tr><td>${c.name}</td><td class="right">${c.limitMonthly?fmtMoney(Number(c.limitMonthly)||0):'Sin límite'}</td><td><button data-id="${c.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${c.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('')}</tbody></table>`;
    $$('#categoriesArea button').forEach(btn=> btn.onclick=()=>{ const {id,act}=btn.dataset; if(act==='del'){ if(confirm('Eliminar categoría?')){ const c=state.data.categories.find(x=>x.id===id); markDeleted(c); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } } if(act==='edit'){ openCategoryModal(state.data.categories.find(x=>x.id===id)); } feather.replace(); });
    feather.replace();
  }

  function renderBusinesses(){ const wrap=$('#businessesArea'); if(!wrap) return; const activeBiz=activeItems(state.data.businesses); if(!activeBiz.length){ wrap.innerHTML='<div class="small">Sin empresas</div>'; return; }
    wrap.innerHTML=`<table style="width:100%"><thead><tr><th>Empresa</th><th class="right">Valor estimado</th><th>Notas</th><th>Acc</th></tr></thead><tbody>${activeBiz.map(b=>`<tr><td><strong>${b.name}</strong><div class="small">${b.role||'-'}</div></td><td class="right">${fmtMoney(Number(b.estimateValue)||0)}</td><td>${b.notes||''}</td><td><button data-id="${b.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${b.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('')}</tbody></table>`;
    $$('#businessesArea button').forEach(btn=> btn.onclick=()=>{ const {id,act}=btn.dataset; if(act==='del'){ if(confirm('Eliminar empresa?')){ const bz=state.data.businesses.find(x=>x.id===id); markDeleted(bz); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } } if(act==='edit'){ openBusinessModal(state.data.businesses.find(x=>x.id===id)); } feather.replace(); });
    feather.replace();
  }

  function renderAll(){
    renderFlowsChart(); dashboardMetrics();
    renderTransactions(); renderBanks(); renderAssets(); renderLiabilities(); renderDebts(); renderFixed(); renderCategories(); renderBusinesses(); renderHabits();
    $('#orgBadge').textContent=ORG_ID; $('#orgShort').textContent=ORG_ID;
  }

  const modalRoot=()=>$('#panelRoot');
  const showModal = html => { modalRoot().innerHTML=html; $('#overlay').style.display='flex'; $('#overlay').setAttribute('aria-hidden','false'); feather.replace(); };
  const closeModal = ()=>{ modalRoot().innerHTML=''; $('#overlay').style.display='none'; $('#overlay').setAttribute('aria-hidden','true'); };

  function openTxModal(existing){
    const bankOpt='<option value="">-- seleccionar cuenta --</option>'+activeItems(state.data.banks).map(b=>`<option value="${b.id}">${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const catOpt='<option value="">-- categoría --</option>'+activeItems(state.data.categories).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    const assetOpt='<option value="">-- Ninguno --</option>'+activeItems(state.data.assets).map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    const def=existing||{type:'Egreso',amount:0,dateStr:toDDMMYYYY(new Date()),bankId:'',categoryId:'',assetId:'',description:''};
    const html=`
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:900">${existing? 'Editar transacción':'Nueva transacción'}</div>
        <div class="small">Formato fecha dd/mm/yyyy</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Tipo</label><select id="txType"><option ${def.type==='Ingreso'?'selected':''}>Ingreso</option><option ${def.type==='Egreso'?'selected':''}>Egreso</option></select></div>
        <div><label>Monto</label><input id="txAmount" type="number" value="${def.amount||0}" /></div>
        <div style="grid-column:1/3"><label>Cuenta</label><select id="txBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label>Categoría</label><select id="txCat">${catOpt}</select></div>
        <div><label>Activo (opcional)</label><select id="txAsset">${assetOpt}</select></div>
        <div><label>Fecha</label><input id="txDate" value="${def.dateStr}" /></div>
        <div style="grid-column:1/3"><label>Descripción</label><input id="txDesc" value="${(def.description||'').replace(/\"/g,'&quot;')}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:14px">
        <button id="txCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button>
        <button id="txSave" class="btn primary"><i data-feather="save"></i> Guardar y cerrar</button>
      </div>
    `;
    showModal(html);
    setTimeout(()=>{ if(existing){ $('#txBank').value = existing.bankId||''; $('#txCat').value = existing.categoryId||''; $('#txAsset').value = existing.assetId||''; } },40);
    $('#txCancel').onclick = closeModal;
    $('#txSave').onclick = async ()=>{
      try{
        const type = $('#txType').value;
        const amount = Number($('#txAmount').value)||0;
        const bankId = $('#txBank').value || null;
        const categoryId = $('#txCat').value || null;
        const assetId = $('#txAsset').value || null;
        const dateStr = $('#txDate').value.trim();
        const desc = $('#txDesc').value.trim();
        if(!amount || amount<=0) return alert('Monto inválido');
        if(!parseDateDDMMYYYY(dateStr)) return alert('Fecha inválida (dd/mm/yyyy)');
        if(existing){
          updateTransaction(existing.id, { type, amount, bankId, categoryId, assetId, description: desc, dateStr });
        } else {
          await addTransaction({ type, amount, bankId, categoryId, assetId, description: desc, dateStr });
        }
        closeModal();
      } catch(e){ alert('Error: ' + (e.message||e)); }
    };
  }

  function openBankModal(b){
    const def = b || { name:'', balance:0, type:'Cuenta', notes:'' };
    const html = `<div style="font-weight:900;margin-bottom:8px">${b? 'Editar cuenta' : 'Nueva cuenta'}</div>
      <label>Nombre</label><input id="bName" value="${def.name}" />
      <label>Tipo</label><input id="bType" value="${def.type}" />
      <label>Saldo inicial</label><input id="bBalance" type="number" value="${Number(def.balance)||0}" />
      <label>Notas</label><input id="bNotes" value="${(def.notes||'').replace(/\"/g,'&quot;')}" />
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="bCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="bSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    $('#bCancel').onclick = closeModal;
    $('#bSave').onclick = ()=> {
      const name = $('#bName').value.trim(), type = $('#bType').value.trim(), balance = Number($('#bBalance').value)||0, notes = $('#bNotes').value.trim();
      if(!name) return alert('Nombre requerido');
      if(b){ Object.assign(b,{name,type,balance,notes}); ensureTimestamps(b); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); }
      else addBank({name,type,balance,notes});
      closeModal();
    };
  }

  function openAssetModal(a){
    const subtypes = ['Inmueble','Maquinaria','Inversión','Patrimonio','Vehículo','Otro'];
    const bankOpt = '<option value="">-- Ninguna --</option>' + activeItems(state.data.banks).map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = a || { name:'', estimatedValue:0, subtype:'Inmueble', purchaseDate:'', depreciationRate:0, usefulLife:0, salvageValue:0, linkedBankId:'', notes:'', accumulatedGain:0 };
    const html = `<div style="font-weight:900;margin-bottom:8px">${a? 'Editar activo':'Nuevo activo'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Nombre</label><input id="aName" value="${def.name}" /></div>
        <div><label>Subtipo</label><select id="aSubtype">${subtypes.map(s=>`<option ${def.subtype===s?'selected':''}>${s}</option>`).join('')}</select></div>
        <div><label>Valor estimado</label><input id="aValue" type="number" value="${Number(def.estimatedValue)||0}" /></div>
        <div><label>Fecha compra (dd/mm/yyyy)</label><input id="aPurchase" value="${def.purchaseDate||''}" /></div>
        <div><label>Depreciación anual (%)</label><input id="aDep" type="number" value="${Number(def.depreciationRate)||0}" /></div>
        <div><label>Vida útil (años)</label><input id="aLife" type="number" value="${Number(def.usefulLife)||0}" /></div>
        <div style="grid-column:1/3"><label>Valor residual</label><input id="aSalvage" type="number" value="${Number(def.salvageValue)||0}" /></div>
        <div style="grid-column:1/3"><label>Vinculado a cuenta</label><select id="aBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label>Notas</label><textarea id="aNotes">${(def.notes||'')}</textarea></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="aCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="aSave" class="btn primary"><i data-feather="save"></i> Guardar activo</button></div>`;
    showModal(html);
    if(a) setTimeout(()=> $('#aBank').value = a.linkedBankId||'',40);
    $('#aCancel').onclick = closeModal;
    $('#aSave').onclick = ()=> {
      const name=$('#aName').value.trim(), subtype=$('#aSubtype').value, val=Number($('#aValue').value)||0, purchase=$('#aPurchase').value.trim(), dep=Number($('#aDep').value)||0, life=Number($('#aLife').value)||0, salvage=Number($('#aSalvage').value)||0, bankId=$('#aBank').value||null, notes=$('#aNotes').value.trim();
      if(!name) return alert('Nombre requerido');
      const obj = { name, subtype, estimatedValue:val, purchaseDate:purchase, depreciationRate:dep, usefulLife:life, salvageValue:salvage, linkedBankId:bankId, notes, accumulatedGain: a ? a.accumulatedGain : 0, incomeRecords: a ? a.incomeRecords : [] };
      if(a){ Object.assign(a,obj); ensureTimestamps(a); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } else addAsset(obj);
      closeModal();
    };
  }

  function openLiabilityModal(l){
    const subtypes=['Préstamo Bancario','Hipoteca','Tarjeta','Proveedor','Garantía','Otro'];
    const bankOpt = '<option value="">-- Ninguna --</option>' + activeItems(state.data.banks).map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = l || { name:'', amount:0, subtype:'Préstamo Bancario', interestRate:0, maturityDate:'', collateral:'', linkedBankId:'', notes:'' };
    const html = `<div style="font-weight:900;margin-bottom:8px">${l? 'Editar pasivo':'Nuevo pasivo'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Nombre</label><input id="liName" value="${def.name}" /></div>
        <div><label>Subtipo</label><select id="liSubtype">${subtypes.map(s=>`<option ${def.subtype===s?'selected':''}>${s}</option>`).join('')}</select></div>
        <div><label>Monto</label><input id="liAmount" type="number" value="${Number(def.amount)||0}" /></div>
        <div><label>Tasa interés (%)</label><input id="liInterest" type="number" value="${Number(def.interestRate)||0}" /></div>
        <div><label>Fecha venc. (dd/mm/yyyy)</label><input id="liMaturity" value="${def.maturityDate||''}" /></div>
        <div><label>Colateral</label><input id="liCollateral" value="${(def.collateral||'')}" /></div>
        <div style="grid-column:1/3"><label>Vinculado a cuenta</label><select id="liBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label>Notas</label><textarea id="liNotes">${(def.notes||'')}</textarea></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="liCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="liSave" class="btn primary"><i data-feather="save"></i> Guardar pasivo</button></div>`;
    showModal(html);
    if(l) setTimeout(()=> $('#liBank').value = l.linkedBankId||'',40);
    $('#liCancel').onclick = closeModal;
    $('#liSave').onclick = ()=> {
      const name=$('#liName').value.trim(), subtype=$('#liSubtype').value, amount=Number($('#liAmount').value)||0, interest=Number($('#liInterest').value)||0, maturity=$('#liMaturity').value.trim(), collateral=$('#liCollateral').value.trim(), bankId=$('#liBank').value||null, notes=$('#liNotes').value.trim();
      if(!name) return alert('Nombre requerido');
      const obj = { name, subtype, amount, interestRate:interest, maturityDate:maturity, collateral, linkedBankId:bankId, notes };
      if(l){ Object.assign(l,obj); ensureTimestamps(l); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } else addLiability(obj);
      closeModal();
    };
  }

  function openBusinessModal(bz){
    const def = bz || { name:'', estimateValue:0, contribution:0, role:'Propietario', notes:'' };
    const html = `<div style="font-weight:900;margin-bottom:8px">${bz? 'Editar empresa':'Nueva empresa'}</div>
      <label>Nombre</label><input id="bzName" value="${def.name}" />
      <label>Rol</label><input id="bzRole" value="${def.role}" />
      <label>Valor estimado</label><input id="bzValue" type="number" value="${Number(def.estimateValue)||0}" />
      <label>Aporte</label><input id="bzContribution" type="number" value="${Number(def.contribution)||0}" />
      <label>Notas</label><textarea id="bzNotes">${(def.notes||'')}</textarea>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="bzCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="bzSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    $('#bzCancel').onclick = closeModal;
    $('#bzSave').onclick = ()=> { const name=$('#bzName').value.trim(), role=$('#bzRole').value, val=Number($('#bzValue').value)||0, contrib=Number($('#bzContribution').value)||0, notes=$('#bzNotes').value.trim(); if(!name) return alert('Nombre requerido'); const obj={name,estimateValue:val,contribution:contrib,role,notes}; if(bz){ Object.assign(bz,obj); ensureTimestamps(bz); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } else addBusiness(obj); closeModal(); };
  }

  function openFixedModal(f){
    const def = f || { name:'', amount:0, bankId:'', categoryId:'', frequency:'monthly' };
    const bankOpt = '<option value="">-- Ninguna --</option>' + activeItems(state.data.banks).map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const catOpt = '<option value="">-- Ninguna --</option>' + activeItems(state.data.categories).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    const html = `<div style="font-weight:900;margin-bottom:8px">${f? 'Editar gasto fijo':'Nuevo gasto fijo'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>Nombre</label><input id="fName" value="${def.name}" /></div><div><label>Monto</label><input id="fAmount" type="number" value="${Number(def.amount)||0}" /></div><div><label>Cuenta</label><select id="fBank">${bankOpt}</select></div><div><label>Categoría</label><select id="fCat">${catOpt}</select></div><div><label>Frecuencia</label><select id="fFreq"><option ${def.frequency==='monthly'?'selected':''} value="monthly">Mensual</option><option ${def.frequency==='weekly'?'selected':''} value="weekly">Semanal</option><option ${def.frequency==='annual'?'selected':''} value="annual">Anual</option></select></div></div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="fCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="fSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    if(f) setTimeout(()=>{ $('#fBank').value=f.bankId||''; $('#fCat').value=f.categoryId||''; },50);
    $('#fCancel').onclick = closeModal;
    $('#fSave').onclick = ()=> { const name=$('#fName').value.trim(), amount=Number($('#fAmount').value)||0, bankId=$('#fBank').value||null, categoryId=$('#fCat').value||null, freq=$('#fFreq').value||'monthly'; if(!name) return alert('Nombre requerido'); if(f){ Object.assign(f,{name,amount,bankId,categoryId,frequency:freq}); ensureTimestamps(f); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } else addFixed({name,amount,bankId,categoryId,frequency:freq}); closeModal(); };
  }

  function openCategoryModal(c){
    const def = c || { name:'', limitMonthly:0 };
    const html = `<div style="font-weight:900;margin-bottom:8px">${c? 'Editar categoría':'Nueva categoría'}</div>
      <label>Nombre</label><input id="catName" value="${def.name}" />
      <label>Límite mensual (0 = sin límite)</label><input id="catLimit" type="number" value="${def.limitMonthly||0}" />
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="catCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="catSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    $('#catCancel').onclick = closeModal;
    $('#catSave').onclick = ()=>{ const name=$('#catName').value.trim(), limit=Number($('#catLimit').value)||0; if(!name) return alert('Nombre requerido'); if(c){ Object.assign(c,{name,limitMonthly:limit}); ensureTimestamps(c); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } else addCategory({name,limitMonthly:limit}); closeModal(); };
  }

  function openDebtModal(d){
    const bankOpt = '<option value="">-- Ninguna --</option>' + activeItems(state.data.banks).map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = d || { name:'', bankId:'', outstanding:0, monthlyPayment:0, interestRate:0, notes:'' };
    const html = `<div style="font-weight:900;margin-bottom:8px">${d? 'Editar deuda':'Nueva deuda'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Nombre</label><input id="dName" value="${def.name}" /></div>
        <div><label>Banco</label><select id="dBank">${bankOpt}</select></div>
        <div><label>Saldo pendiente</label><input id="dOut" type="number" value="${Number(def.outstanding)||0}" /></div>
        <div><label>Cuota mensual</label><input id="dPay" type="number" value="${Number(def.monthlyPayment)||0}" /></div>
        <div><label>Tasa interés (%)</label><input id="dInterest" type="number" value="${Number(def.interestRate)||0}" /></div>
        <div style="grid-column:1/3"><label>Notas</label><input id="dNotes" value="${(def.notes||'').replace(/\"/g,'&quot;')}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="dCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="dSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    if(d) setTimeout(()=> $('#dBank').value = d.bankId||'',40);
    $('#dCancel').onclick = closeModal;
    $('#dSave').onclick = ()=> { const name=$('#dName').value.trim(), bankId=$('#dBank').value||null, out=Number($('#dOut').value)||0, pay=Number($('#dPay').value)||0, interest=Number($('#dInterest').value)||0, notes=$('#dNotes').value.trim(); if(!name) return alert('Nombre requerido'); if(d){ Object.assign(d,{name,bankId,outstanding:out,monthlyPayment:pay,interestRate:interest,notes}); ensureTimestamps(d); persistLocal(); if(state.fsHelpers) schedulePushDebounced(); renderAll(); } else addDebt({name,bankId,outstanding:out,monthlyPayment:pay,interestRate:interest,notes}); closeModal(); };
  }

  function openDebtPayModal(debt){
    if(!debt) return alert('Deuda no encontrada');
    const bankOpt = activeItems(state.data.banks).map(b=>`<option value="${b.id}">${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const html = `<div style="font-weight:900;margin-bottom:8px">Registrar pago · ${debt.name}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Monto</label><input id="payAmount" type="number" value="${Math.min(Number(debt.monthlyPayment)||0, Number(debt.outstanding)||0)}" /></div>
        <div><label>Cuenta</label><select id="payBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label>Descripción</label><input id="payDesc" value="Pago deuda ${debt.name}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="payCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="paySave" class="btn positive"><i data-feather="check-circle"></i> Registrar pago</button></div>`;
    showModal(html);
    $('#payCancel').onclick = closeModal;
    $('#paySave').onclick = async ()=> { const amt=Number($('#payAmount').value)||0; const bankId=$('#payBank').value; const desc=$('#payDesc').value.trim(); if(!amt||amt<=0) return alert('Monto inválido'); await addTransaction({ type:'Egreso', amount:amt, bankId, debtId:debt.id, dateStr: toDDMMYYYY(new Date()), description: desc }); closeModal(); };
  }

  function openAssetViewModal(asset){
    if(!asset) return;
    const rows=(asset.incomeRecords||[]).map(r=>`<tr><td>${r.dateStr}</td><td>${fmtMoney(r.amount)}</td><td>${r.desc||''}</td></tr>`).join('')||'<tr><td colspan="3" class="small">Sin ingresos registrados</td></tr>';
    showModal(`<div style="font-weight:900;margin-bottom:8px">Ingresos del activo: ${asset.name}</div>
      <table style="width:100%;border-collapse:collapse;font-size:13px">
        <thead><tr><th>Fecha</th><th>Monto</th><th>Descripción</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn ghost" id="assetViewClose"><i data-feather="x"></i> Cerrar</button></div>`);
    $('#assetViewClose').onclick=closeModal; feather.replace();
  }

  function bindUI(){
    $$('.nav-btn').forEach(b=> b.addEventListener('click', ()=>{
      $$('.nav-btn').forEach(x=> x.classList.toggle('active', x===b));
      document.querySelectorAll('.app > section').forEach(s=> s.style.display='none');
      const view=document.getElementById('view-'+b.dataset.view); if(view) view.style.display='block';
    }));
    $('#btnNewTx').onclick=()=>openTxModal(null);
    $('#btnAddTx').onclick=()=>openTxModal(null);
    $('#fab').onclick=()=>openTxModal(null);
    $('#btnNewBank').onclick=()=>openBankModal(null);
    $('#btnAddBankTop').onclick=()=>openBankModal(null);
    $('#btnAddAssetTop').onclick=()=>openAssetModal(null);
    $('#btnAddLiabTop').onclick=()=>openLiabilityModal(null);
    $('#btnAddDebtTop').onclick=()=>openDebtModal(null);
    $('#btnAddFixedTop').onclick=()=>openFixedModal(null);
    $('#btnAddCategoryTop').onclick=()=>openCategoryModal(null);
    $('#btnAddBizTop').onclick=()=>openBusinessModal(null);
    $('#btnApplyFixedTop').onclick=()=>{ if(confirm('Aplicar gastos fijos?')) applyMonthlyFixed(); };
    $('#btnApplyFixedQuick').onclick=()=>{ if(confirm('Aplicar gastos fijos?')) applyMonthlyFixed(); };
    $('#btnExportCSV').onclick=exportCSV;
    $('#btnExportJSON').onclick=exportJSON;
    $('#btnImport').onclick=()=> importFile($('#fileImport').files[0]);
    $('#btnExportPDF').onclick=exportPDF;
    $('#btnPDF').onclick=exportPDF;
    $('#btnSyncNow').onclick=manualSync;
    const habitsDate = $('#habitsDate');
    if(habitsDate){
      habitsDate.onchange = ()=>{ habitsSelectedDate = habitsDate.value || toLocalISODate(new Date()); renderHabits(); };
    }
    const btnHabitsReset = $('#btnHabitsReset');
    if(btnHabitsReset){ btnHabitsReset.onclick = ()=>{ if(confirm('Reset día?')) resetHabitsDay(habitsSelectedDate); }; }
    const btnHabitsExport = $('#btnHabitsExport');
    if(btnHabitsExport){ btnHabitsExport.onclick = exportHabitsJSON; }
    $('#fileImport').onchange=e=> importFile(e.target.files[0]);
    $('#search').oninput=renderTransactions;
    window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='n' && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) openTxModal(null); if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); manualSync(); }});
    $('#overlay').addEventListener('click', e=>{ if(e.target.id==='overlay') closeModal(); });
    feather.replace();
  }

  async function manualSync(){
    setSyncStatus('working');
    try{
      if(!state.fsHelpers){ await initFirestore(firebaseConfig); startRealtime(); showToast('Firestore activado'); }
      const remote=await fsFetch();
      if(remote.data){ state.data=normalizeData(mergeFullDatasets(remote.data,state.data)); persistLocal(); await fsSaveWithMerge(state.data); showToast('Sincronización manual completa'); }
      else { await fsSaveWithMerge(state.data); showToast('Nube inicializada con datos locales'); }
    }catch(e){ showToast('Error sync: '+(e.message||e),true); } finally{ setSyncStatus('idle'); renderAll(); flushPending(); }
  }

  function attachLocalLogin(){
    const tryLogin=()=>{ const u=prompt('Usuario (local):','JHONATAN'); const p=prompt('Contraseña (local):','JHONATAN');
      if(u===LOCAL_LOGIN.user && p===LOCAL_LOGIN.pass){ state.user=u; initApp(); showToast('Bienvenido '+u); }
      else { alert('Credenciales incorrectas. Intente de nuevo.'); tryLogin(); }
    };
    setTimeout(tryLogin,200);
  }

  function updateNetStatus(){ const online=navigator.onLine; $('#netStatus').textContent=online?'online':'offline'; $('#netStatus').className='badge '+(online?'green':'red'); if(online) flushPending(); }
  window.addEventListener('online', updateNetStatus); window.addEventListener('offline', updateNetStatus);

  async function initApp(){
    loadLocal(); bindUI(); renderAll(); updateNetStatus();
    try{
      await initFirestore(firebaseConfig); startRealtime(); setSyncStatus('syncing');
      const remote=await fsFetch();
      if(remote.data){ state.data=normalizeData(mergeFullDatasets(remote.data,state.data)); persistLocal(); await fsSaveWithMerge(state.data); showToast('Sincronización automática completa'); }
      else { await fsSaveWithMerge(state.data); showToast('Nube inicializada con datos locales'); }
    }catch(e){ showToast('No se pudo conectar a la nube (modo local)',true); }
    finally{ setSyncStatus('idle'); renderAll(); flushPending(); }
  }

  loadLocal();
  if(!state.data.categories.length){
    state.data.categories=[
      {id:uid('cat'),name:'Alimentos',limitMonthly:1500,createdAt:nowISO(),updatedAt:nowISO(),deviceId:DEVICE_ID},
      {id:uid('cat'),name:'Operaciones',limitMonthly:5000,createdAt:nowISO(),updatedAt:nowISO(),deviceId:DEVICE_ID},
      {id:uid('cat'),name:'Marketing',limitMonthly:3000,createdAt:nowISO(),updatedAt:nowISO(),deviceId:DEVICE_ID}
    ];
    persistLocal();
  }
  attachLocalLogin();
  </script>
  <script>document.addEventListener('DOMContentLoaded', ()=> { if(window.feather) feather.replace(); });</script>
</body>
</html>

