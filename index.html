<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JHONATAN ORELLANA — Suite Empresarial (Transferencias)</title>

<!-- Fuente y librerías -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<!-- Feather icons -->
<script src="https://unpkg.com/feather-icons"></script>

<style>
  /* ===========================
     Paleta didáctica + fondo "plomizo" (paneles un poco opacos/grisados)
     =========================== */
  :root{
    --bg: #eef4f8;
    --panel: rgba(248,250,252,0.92); /* un blanco levemente opaco/plomizo */
    --panel-2: rgba(241,244,247,0.92);
    --muted: #5b6b76;
    --text: #072033;
    --accent: #0b6fd1;
    --accent-2: #5b8ef0;
    --positive: #10b981;
    --warn: #f59e0b;
    --danger: #ef4444;
    --violet: #6b46c1;
    --glass: rgba(11,24,32,0.04);
    --card-shadow: 0 10px 30px rgba(11,24,32,0.06);
    --maxw: 1400px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#fbfdff);color:var(--text);-webkit-font-smoothing:antialiased}
  .app-root{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
  .app{width:100%;max-width:var(--maxw);display:grid;grid-template-columns:320px 1fr;gap:20px;border-radius:14px;padding:18px;background:linear-gradient(180deg,var(--panel-2),#fbfeff);box-shadow:0 30px 80px rgba(2,6,23,0.06)}
  /* SIDEBAR */
  .sidebar{background:var(--panel);border-radius:12px;padding:18px;border:1px solid var(--glass);box-shadow:var(--card-shadow);display:flex;flex-direction:column;gap:14px;min-height:640px}
  .brand{display:flex;gap:12px;align-items:center}
  .brand .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:900;font-size:18px;box-shadow:0 8px 30px rgba(11,118,209,0.12)}
  .brand h1{font-size:15px;margin:0;line-height:1.05}
  .brand p{margin:0;color:var(--muted);font-size:12px}
  nav.side{display:flex;flex-direction:column;gap:8px;margin-top:6px}
  nav.side button{display:flex;align-items:center;gap:12px;border-radius:10px;padding:10px;border:0;background:transparent;cursor:pointer;font-weight:700;color:var(--muted);text-align:left;transition:all .16s}
  nav.side button:hover{background:rgba(11,110,209,0.04);color:var(--accent)}
  nav.side button.active{background:linear-gradient(90deg, rgba(11,110,209,0.08), rgba(91,142,240,0.03));color:var(--accent);box-shadow:inset 0 0 0 1px rgba(11,118,209,0.02)}
  nav.side button svg{stroke-width:1.6}
  .meta{margin-top:auto;font-size:13px;color:var(--muted)}
  .meta small{display:block;color:var(--muted);margin-top:8px}
  /* MAIN */
  .main{display:flex;flex-direction:column;gap:14px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .kpigrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi{background:var(--panel);border-radius:12px;padding:14px;border:1px solid var(--glass);box-shadow:var(--card-shadow);display:flex;flex-direction:column;gap:8px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .value{font-weight:900;font-size:20px;color:var(--text)}
  .kpi .trend{font-size:12px;color:var(--muted)}
  .card{background:var(--panel);border-radius:12px;padding:16px;border:1px solid var(--glass);box-shadow:var(--card-shadow);overflow:auto}
  .flex{display:flex;gap:12px;align-items:center}
  .controls{display:flex;gap:10px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;display:inline-flex;gap:8px;align-items:center}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 8px 24px rgba(11,118,209,0.12)}
  .btn.ghost{background:transparent;border:1px solid var(--glass);color:var(--muted)}
  .btn.positive{background:linear-gradient(90deg,#34d399,#10b981);color:white}
  .btn.warn{background:linear-gradient(90deg,var(--warn),#f97316);color:white}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(11,24,32,0.04);text-align:left}
  td.right{text-align:right}
  /* Modal overlay */
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
  .modal{width:920px;max-width:100%;background:var(--panel);border-radius:12px;padding:18px;box-shadow:0 30px 80px rgba(2,6,23,0.12);border:1px solid rgba(2,6,23,0.04)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(11,24,32,0.06);font-size:14px;background:transparent}
  textarea{min-height:90px}
  .small{font-size:12px;color:var(--muted)}
  .fab{position:fixed;right:28px;bottom:28px;background:linear-gradient(135deg,var(--violet),#8b5cf6);color:white;border-radius:18px;padding:14px 18px;font-weight:900;box-shadow:0 20px 50px rgba(107,70,193,0.12);cursor:pointer;z-index:1100;display:flex;gap:10px;align-items:center}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .badge.pos{background:rgba(16,185,129,0.12);color:var(--positive)}
  .badge.neg{background:rgba(239,68,68,0.08);color:var(--danger)}
  /* responsive */
  @media (max-width:1100px){ .app{grid-template-columns:1fr; padding:12px} .sidebar{flex-direction:row;overflow:auto;height:92px;padding:10px;border-radius:10px} .kpigrid{grid-template-columns:repeat(2,1fr)} .fab{display:none} .topbar{flex-direction:column;align-items:flex-start} }
  /* PDF styles */
  .pdf-root{font-family:Arial,Helvetica,sans-serif;color:#111;background:#fff;padding:18px}
  .pdf-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .pdf-title{font-weight:900;font-size:12pt}
  .pdf-sub{font-weight:700;font-size:11pt;margin-top:8px;margin-bottom:6px}
  .pdf-text{font-size:10pt;line-height:1.45}
  .pdf-table{width:100%;border-collapse:collapse;margin-top:6px;font-size:10pt}
  .pdf-table th, .pdf-table td{border:1px solid #ddd;padding:6px;text-align:left}
</style>
</head>
<body>
  <!-- APP -->
  <div class="app-root">
    <div class="app" role="application" aria-label="Suite Empresarial Finanzas - Transferencias">
      <!-- SIDEBAR -->
      <aside class="sidebar" aria-label="Navegación lateral">
        <div class="brand">
          <div class="logo">JO</div>
          <div>
            <h1>JHONATAN ORELLANA</h1>
            <p class="small">Control financiero centralizado • UNA DATA</p>
          </div>
        </div>

        <nav class="side" aria-label="Menú">
          <button data-view="dashboard" class="active"><i data-feather="bar-chart-2"></i> <span>Resumen</span></button>
          <button data-view="transactions"><i data-feather="credit-card"></i> <span>Transacciones</span></button>
          <button data-view="banks"><i data-feather="bank"></i> <span>Bancos</span></button>
          <button data-view="assets"><i data-feather="layers"></i> <span>Activos/Pasivos</span></button>
          <button data-view="debts"><i data-feather="briefcase"></i> <span>Deudas</span></button>
          <button data-view="fixed"><i data-feather="calendar"></i> <span>Gastos Mensuales</span></button>
          <button data-view="categories"><i data-feather="tag"></i> <span>Categorías</span></button>
          <button data-view="businesses"><i data-feather="briefcase"></i> <span>Empresas</span></button>
          <button data-view="export"><i data-feather="download-cloud"></i> <span>Export / Cloud</span></button>
        </nav>

        <div class="meta">
          <div class="small">orgId: <strong id="orgBadge">oxIgjNwqNPiAneP5alpM</strong></div>
          <small id="cloudMode">Cloud: —</small>
          <small id="syncStatus">Estado: idle</small>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="sidebarSync" class="btn ghost"><i data-feather="refresh-cw"></i> Sync</button>
            <button id="sidebarLogout" class="btn ghost"><i data-feather="log-out"></i> Cerrar</button>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <div class="topbar">
          <div>
            <div style="font-weight:900;font-size:18px">Panel Empresarial — Transferencias</div>
            <div class="small" id="currentUser">Usuario: Invitado</div>
          </div>
          <div class="controls">
            <button id="btnNewTx" class="btn primary"><i data-feather="plus"></i> Nueva transacción</button>
            <button id="btnNewBank" class="btn ghost"><i data-feather="plus-circle"></i> Nueva cuenta</button>
            <button id="btnPDF" class="btn positive"><i data-feather="file-text"></i> Generar PDF</button>
          </div>
        </div>

        <!-- KPIs -->
        <section class="kpigrid">
          <div class="kpi">
            <div class="label">Saldo Neto</div>
            <div class="value" id="kpi-net">S/ 0.00</div>
            <div class="trend small" id="kpi-net-trend">Activos - Pasivos</div>
          </div>
          <div class="kpi">
            <div class="label">Ingresos (12m)</div>
            <div class="value" id="kpi-inc">S/ 0.00</div>
            <div class="trend small" id="kpi-inc-trend">Tendencia</div>
          </div>
          <div class="kpi">
            <div class="label">Gastos (12m)</div>
            <div class="value" id="kpi-exp">S/ 0.00</div>
            <div class="trend small" id="kpi-exp-trend">Límites</div>
          </div>
          <div class="kpi">
            <div class="label">Runway</div>
            <div class="value" id="kpi-runway">∞ meses</div>
            <div class="trend small" id="kpi-runway-trend">Liquidez vs Deudas</div>
          </div>
        </section>

        <!-- DASHBOARD -->
        <section id="view-dashboard" class="card" style="display:block">
          <div style="display:flex;gap:18px;align-items:flex-start">
            <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:800">Flujo de caja</div>
                <div class="small" id="todayDate">Hoy: --</div>
              </div>
              <div style="margin-top:12px">
                <canvas id="chartFlows" height="200"></canvas>
              </div>

              <div style="display:flex;gap:12px;margin-top:16px">
                <div style="flex:1" class="card">
                  <div style="font-weight:800">Top categorías (mes)</div>
                  <div id="topCategories" class="small" style="margin-top:8px;color:var(--muted)">—</div>
                </div>
                <div style="width:320px" class="card">
                  <div style="font-weight:800">Saldo por cuentas</div>
                  <div id="bankBreakdown" class="small" style="margin-top:8px;color:var(--muted)">—</div>
                </div>
              </div>
            </div>

            <div style="width:360px">
              <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-weight:800">Resumen ejecutivo</div>
                  <div class="small" id="orgShort">Org: oxIgjNwqNPiAneP5alpM</div>
                </div>
                <div style="margin-top:12px">
                  <div class="small">Patrimonio neto</div>
                  <div style="font-weight:900;font-size:18px" id="patrimony">S/ 0.00</div>

                  <div style="margin-top:12px" class="small">Alertas</div>
                  <div id="alertsArea" class="small" style="margin-top:8px;color:var(--muted)">Sin alertas</div>

                  <div style="margin-top:12px" class="small">Acciones rápidas</div>
                  <div style="display:flex;gap:8px;margin-top:8px">
                    <button id="applyFixed" class="btn ghost"><i data-feather="repeat"></i> Aplicar fijos</button>
                    <button id="syncAuto" class="btn ghost"><i data-feather="cloud"></i> Forzar cloud</button>
                  </div>
                </div>
              </div>

              <div style="margin-top:12px" class="card">
                <div style="font-weight:800">Últimas transacciones</div>
                <div id="smallTxList" style="margin-top:10px;color:var(--muted)" class="small">—</div>
              </div>
            </div>
          </div>
        </section>

        <!-- TRANSACTIONS -->
        <section id="view-transactions" class="card" style="display:none;min-height:360px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Transacciones</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="search" placeholder="Buscar descripción, categoría..." style="padding:10px;border-radius:10px;border:1px solid var(--glass)" />
              <select id="filterAccount" style="padding:10px;border-radius:10px;border:1px solid var(--glass)"><option value="">Todas cuentas</option></select>
              <button id="btnAddTx" class="btn primary"><i data-feather="plus"></i> Agregar</button>
            </div>
          </div>
          <div style="margin-top:12px;overflow:auto;height:380px">
            <table id="txTable">
              <thead><tr><th>Fecha</th><th>Cuenta</th><th>Tipo</th><th>Categoría / Activo</th><th class="right">Monto</th><th>Acciones</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- BANKS (incluye Transferencias) -->
        <section id="view-banks" class="card" style="display:none;min-height:300px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Cuentas Bancarias</div>
            <div style="display:flex;gap:8px">
              <button id="btnAddBankTop" class="btn primary"><i data-feather="plus-circle"></i> Nueva cuenta</button>
              <button id="btnTransferTop" class="btn warn"><i data-feather="repeat"></i> Transferir</button>
              <button id="btnExportBanks" class="btn ghost"><i data-feather="download"></i> Export</button>
            </div>
          </div>
          <div id="banksArea" style="margin-top:12px;overflow:auto;height:260px"></div>
        </section>

        <!-- ASSETS -->
        <section id="view-assets" class="card" style="display:none;min-height:300px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Activos y Pasivos</div>
            <div style="display:flex;gap:8px">
              <button id="btnAddAssetTop" class="btn primary"><i data-feather="plus-square"></i> Nuevo activo</button>
              <button id="btnAddLiabTop" class="btn ghost"><i data-feather="minus-square"></i> Nuevo pasivo</button>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1;overflow:auto;height:260px" id="assetsArea"></div>
            <div style="width:420px;overflow:auto;height:260px" id="liabilitiesArea"></div>
          </div>
        </section>

        <!-- DEBTS -->
        <section id="view-debts" class="card" style="display:none;min-height:220px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Deudas</div>
            <div><button id="btnAddDebtTop" class="btn primary"><i data-feather="credit-card"></i> Nueva deuda</button></div>
          </div>
          <div id="debtsArea" style="margin-top:12px;overflow:auto;height:180px"></div>
        </section>

        <!-- FIXED -->
        <section id="view-fixed" class="card" style="display:none;min-height:220px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Gastos Mensuales</div>
            <div style="display:flex;gap:8px">
              <button id="btnAddFixedTop" class="btn primary"><i data-feather="clock"></i> Agregar fijo</button>
              <button id="btnApplyFixedTop" class="btn ghost"><i data-feather="play"></i> Aplicar ahora</button>
            </div>
          </div>
          <div id="fixedArea" style="margin-top:12px;overflow:auto;height:180px"></div>
        </section>

        <!-- CATEGORIES -->
        <section id="view-categories" class="card" style="display:none;min-height:220px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Categorías & Límites</div>
            <div><button id="btnAddCategoryTop" class="btn primary"><i data-feather="tag"></i> Nueva categoría</button></div>
          </div>
          <div id="categoriesArea" style="margin-top:12px;overflow:auto;height:180px"></div>
        </section>

        <!-- BUSINESSES -->
        <section id="view-businesses" class="card" style="display:none;min-height:220px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Empresas / Proyectos</div>
            <div><button id="btnAddBizTop" class="btn primary"><i data-feather="briefcase"></i> Nueva empresa</button></div>
          </div>
          <div id="businessesArea" style="margin-top:12px;overflow:auto;height:180px"></div>
        </section>

        <!-- EXPORT -->
        <section id="view-export" class="card" style="display:none;min-height:220px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Export / Import / PDF</div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="btnExportCSV" class="btn primary"><i data-feather="download"></i> Export CSV</button>
              <button id="btnExportJSON" class="btn ghost"><i data-feather="cloud"></i> Export JSON</button>
              <input id="fileImport" type="file" accept=".csv,application/json" />
              <button id="btnImport" class="btn primary"><i data-feather="upload"></i> Importar</button>
              <button id="btnExportPDF" class="btn positive"><i data-feather="file-text"></i> Generar PDF</button>
            </div>
          </div>
          <div style="margin-top:12px" class="small">PDF técnico: Título 12pt · Subtítulos 11pt · Texto 10pt</div>
        </section>
      </main>
    </div>
  </div>

  <!-- Overlay modal -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" id="panelRoot"></div>
  </div>

  <!-- FAB -->
  <button id="fab" class="fab" title="Nueva transacción"><i data-feather="plus"></i> Nueva Tx</button>

  <!-- Toast -->
  <div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:#ffffff;padding:10px;border-radius:10px;display:none;z-index:1200;box-shadow:var(--card-shadow)"></div>

  <!-- ======================
       FIREBASE CONFIG (tuya actualizada)
       ====================== -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBVppNAicRPFXEUdErmHd24se_9bjXiqcM",
      authDomain: "jhona-1b398.firebaseapp.com",
      databaseURL: "https://jhona-1b398-default-rtdb.firebaseio.com",
      projectId: "jhona-1b398",
      storageBucket: "jhona-1b398.firebasestorage.app",
      messagingSenderId: "981136306223",
      appId: "1:981136306223:web:d8948acdb119f0facc56da",
      measurementId: "G-44TXK10R9R"
    };
    const ORG_ID = "oxIgjNwqNPiAneP5alpM";
    const LOCAL_LOGIN = { user: "JHONATAN", pass: "JHONATAN" };
  </script>

  <!-- ======================
       Lógica (vanilla ES modules)
       ====================== -->
  <script type="module">
  /* ------------------------
     Helpers & state
     ------------------------ */
  const $ = (s,r=document)=> r.querySelector(s);
  const $$ = (s,r=document)=> Array.from((r||document).querySelectorAll(s));
  const nowISO = ()=> new Date().toISOString();
  function uid(pref){ return `${pref}_${Date.now()}_${Math.floor(Math.random()*90000)}`; }
  function fmtMoney(v){ v = Number(v)||0; return 'S/ ' + v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function parseDateDDMMYYYY(s){ if(!s) return null; const p=s.split('/'); if(p.length!==3) return null; const d=Number(p[0]), m=Number(p[1])-1, y=Number(p[2]); const D=new Date(y,m,d); return isNaN(D)?null:D; }
  function toDDMMYYYY(d){ if(!d) return ''; return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear(); }
  function showToast(msg,err=false){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; t.style.background= err ? '#fff1f0' : '#f6fffb'; t.style.color = err ? 'var(--danger)' : 'var(--text)'; clearTimeout(window.__to); window.__to=setTimeout(()=> t.style.display='none', err?7000:3500); }

  const STORAGE_KEY = 'jona_business_single_data_v4';
  const state = {
    user:null, fsHelpers:null, unsubscribeRealtime:null,
    data: { transactions:[], banks:[], debts:[], fixed:[], categories:[], assets:[], liabilities:[], businesses:[], meta:{ updatedAt:null } }
  };

  /* ------------------------
     Local persistence
     ------------------------ */
  function loadLocal(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) try { state.data = JSON.parse(raw); } catch(e){ console.warn(e); }
    state.data.transactions = state.data.transactions || [];
    state.data.banks = state.data.banks || [];
    state.data.debts = state.data.debts || [];
    state.data.fixed = state.data.fixed || [];
    state.data.categories = state.data.categories || [];
    state.data.assets = state.data.assets || [];
    state.data.liabilities = state.data.liabilities || [];
    state.data.businesses = state.data.businesses || [];
  }
  function persistLocal(){ state.data.meta.updatedAt = nowISO(); localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data)); }

  /* ------------------------
     Firestore dynamic init (v9 modular via CDN import)
     ------------------------ */
  async function initFirestore(cfg){
    if(state.fsHelpers) return;
    try{
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
      const { getFirestore, doc, getDoc, setDoc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
      const app = initializeApp(cfg);
      const firestore = getFirestore(app);
      state.fsHelpers = { doc, getDoc, setDoc, onSnapshot, firestore };
      console.info('Firestore initialized');
    } catch(e){ throw e; }
  }
  async function fsFetch(){
    const { doc, getDoc, firestore } = state.fsHelpers;
    const ref = doc(firestore, 'organizations', ORG_ID, 'DATA', 'DATA');
    const snap = await getDoc(ref);
    if(!snap.exists()) return { data:null, updatedAt:null };
    const payload = snap.data();
    return { data: payload.data || null, updatedAt: payload.updatedAt || null };
  }
  async function fsSave(data){
    const { doc, setDoc, firestore } = state.fsHelpers;
    const ref = doc(firestore, 'organizations', ORG_ID, 'DATA', 'DATA');
    const updatedAt = nowISO();
    await setDoc(ref, { data, updatedAt }, { merge: true });
    return updatedAt;
  }

  /* ------------------------
     Realtime listener (merge remote)
     ------------------------ */
  function startRealtime(){
    if(!state.fsHelpers) return;
    const { doc, onSnapshot, firestore } = state.fsHelpers;
    const ref = doc(firestore, 'organizations', ORG_ID, 'DATA', 'DATA');
    if(state.unsubscribeRealtime) try{ state.unsubscribeRealtime(); }catch(e){}
    state.unsubscribeRealtime = onSnapshot(ref, snap=>{
      if(!snap.exists()) return;
      const payload = snap.data();
      if(!payload) return;
      const remote = payload.data || null;
      if(remote){
        state.data = mergeDatasets(state.data, remote);
        persistLocal();
        renderAll();
        showToast('Sincronizado desde la nube');
      }
    }, err=> console.warn('Realtime err', err));
  }

  /* ------------------------
     Merge logic
     ------------------------ */
  function mergeCollections(localArr=[], remoteArr=[], timeField='createdAt'){
    const map = new Map();
    (localArr||[]).forEach(item => { if(!item) return; if(!item.id) item.id = uid('x'); map.set(item.id, item); });
    (remoteArr||[]).forEach(r => {
      if(!r) return;
      if(!r.id) r.id = uid('x');
      const existing = map.get(r.id);
      if(!existing){ map.set(r.id, r); return; }
      const tLocal = existing[timeField] ? Date.parse(existing[timeField]) : 0;
      const tRemote = r[timeField] ? Date.parse(r[timeField]) : 0;
      if(tRemote >= tLocal) map.set(r.id, r);
    });
    return Array.from(map.values()).sort((a,b)=> (b[timeField] ? Date.parse(b[timeField]) : 0) - (a[timeField] ? Date.parse(a[timeField]) : 0));
  }
  function mergeDatasets(local, remote){
    if(!remote) return JSON.parse(JSON.stringify(local || {}));
    return {
      transactions: mergeCollections(local.transactions, remote.transactions, 'createdAt'),
      banks: mergeCollections(local.banks, remote.banks, 'createdAt'),
      debts: mergeCollections(local.debts, remote.debts, 'createdAt'),
      fixed: mergeCollections(local.fixed, remote.fixed, 'createdAt'),
      categories: mergeCollections(local.categories, remote.categories, 'createdAt'),
      assets: mergeCollections(local.assets, remote.assets, 'createdAt'),
      liabilities: mergeCollections(local.liabilities, remote.liabilities, 'createdAt'),
      businesses: mergeCollections(local.businesses, remote.businesses, 'createdAt'),
      meta: { updatedAt: nowISO() }
    };
  }

  /* ------------------------
     Auto push (debounced)
     ------------------------ */
  let pushTimer=null;
  function schedulePush(delay=900){
    if(!state.fsHelpers) return;
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(async ()=>{
      try{
        $('#syncStatus').textContent = 'pushing';
        await fsSave(state.data);
        $('#syncStatus').textContent = 'idle';
        showToast('Cambios subidos a la nube');
      } catch(e){ console.error(e); showToast('Error subir: '+(e.message||e), true); $('#syncStatus').textContent='idle'; }
    }, delay);
  }

  /* ------------------------
     CRUD y reglas del negocio
     ------------------------ */
  function pushAndRender(mut){
    mut(state.data);
    persistLocal();
    renderAll();
    if(state.fsHelpers) schedulePush();
  }
  function addBank(obj){ obj.id=uid('b'); obj.balance=Number(obj.balance)||0; obj.createdAt=nowISO(); pushAndRender(d=>d.banks.unshift(obj)); }
  function addCategory(obj){ obj.id=uid('cat'); obj.createdAt=nowISO(); pushAndRender(d=>d.categories.unshift(obj)); }
  function addAsset(obj){ obj.id=uid('asset'); obj.estimatedValue=Number(obj.estimatedValue)||0; obj.accumulatedGain=Number(obj.accumulatedGain)||0; obj.incomeRecords=obj.incomeRecords||[]; obj.createdAt=nowISO(); pushAndRender(d=>d.assets.unshift(obj)); }
  function addLiability(obj){ obj.id=uid('liab'); obj.amount=Number(obj.amount)||0; obj.createdAt=nowISO(); pushAndRender(d=>d.liabilities.unshift(obj)); }
  function addBusiness(obj){ obj.id=uid('biz'); obj.estimateValue=Number(obj.estimateValue)||0; obj.createdAt=nowISO(); pushAndRender(d=>d.businesses.unshift(obj)); }
  function addFixed(obj){ obj.id=uid('fix'); obj.amount=Number(obj.amount)||0; obj.createdAt=nowISO(); pushAndRender(d=>d.fixed.unshift(obj)); }
  function addDebt(obj){ obj.id=uid('debt'); obj.outstanding=Number(obj.outstanding)||0; obj.monthlyPayment=Number(obj.monthlyPayment)||0; obj.createdAt=nowISO(); pushAndRender(d=>d.debts.unshift(obj)); }

  async function addTransaction(tx){
    if(!parseDateDDMMYYYY(tx.dateStr)) throw new Error('Fecha inválida (dd/mm/yyyy)');
    if(!tx.bankId) throw new Error('Seleccione una cuenta bancaria');
    tx.id = uid('t'); tx.amount = Number(tx.amount)||0; tx.createdAt = nowISO();
    pushAndRender(d=>{
      d.transactions.unshift(tx);
      const bank = d.banks.find(b=>b.id===tx.bankId);
      if(bank) bank.balance = (Number(bank.balance)||0) + (tx.type==='Egreso' ? -tx.amount : tx.amount);
      if(tx.debtId && tx.type==='Egreso'){ const debt = d.debts.find(x=>x.id===tx.debtId); if(debt) debt.outstanding = Math.max(0,(Number(debt.outstanding)||0)-tx.amount); }
      if(tx.assetId && tx.type==='Ingreso'){ const asset = d.assets.find(a=>a.id===tx.assetId); if(asset){ asset.accumulatedGain = (Number(asset.accumulatedGain)||0) + tx.amount; asset.incomeRecords = asset.incomeRecords||[]; asset.incomeRecords.unshift({id:uid('ag'),txId:tx.id,dateStr:tx.dateStr,amount:tx.amount,desc:tx.description||''}); } }
    });
  }

  // Añadimos transferencia entre bancos: crea dos transacciones y actualiza saldos
  function transferBetweenBanks(fromId,toId,amount,dateStr,note){
    amount = Number(amount)||0; if(amount<=0) throw new Error('Monto inválido');
    if(!fromId || !toId) throw new Error('Seleccione ambas cuentas');
    if(fromId === toId) throw new Error('Las cuentas deben ser diferentes');
    pushAndRender(d=>{
      const from = d.banks.find(b=>b.id===fromId), to = d.banks.find(b=>b.id===toId);
      if(from) from.balance = (Number(from.balance)||0) - amount;
      if(to) to.balance = (Number(to.balance)||0) + amount;
      // registro de salida y entrada, con meta para vinculación
      const idOut = uid('t'), idIn = uid('t');
      const out = { id:idOut, type:'Egreso', dateStr, amount, bankId:fromId, description: (note ? note : `Transferencia a ${to?to.name:''}`), createdAt:nowISO(), meta:{ transferTo: toId, transferPair: idIn } };
      const inc = { id:idIn, type:'Ingreso', dateStr, amount, bankId:toId, description: (note ? note : `Transferencia desde ${from?from.name:''}`), createdAt:nowISO(), meta:{ transferFrom: fromId, transferPair: idOut } };
      d.transactions.unshift(inc);
      d.transactions.unshift(out);
    });
  }

  function applyMonthlyFixed(){
    const today = toDDMMYYYY(new Date());
    pushAndRender(d=>{
      d.fixed.forEach(f=>{
        const tx = { id:uid('t'), type:'Egreso', dateStr:today, amount:Number(f.amount)||0, bankId:f.bankId||null, categoryId:f.categoryId||null, description:'Gasto fijo: '+f.name, createdAt:nowISO(), meta:{fromFixed:f.id} };
        d.transactions.unshift(tx);
        if(f.bankId){ const b = d.banks.find(x=>x.id===f.bankId); if(b) b.balance = (Number(b.balance)||0) - tx.amount; }
      });
    });
    showToast('Gastos fijos aplicados');
  }

  /* ------------------------
     Export/Import/PDF
     ------------------------ */
  function exportCSV(){
    const rows = state.data.transactions.map(t=>{
      const b = state.data.banks.find(b=>b.id===t.bankId);
      const c = state.data.categories.find(c=>c.id===t.categoryId);
      const a = state.data.assets.find(a=>a.id===t.assetId);
      return [t.dateStr||'', b?b.name:'', t.type||'', c?c.name:(t.categoryName||''), a?('ACT:'+a.name):'', (t.description||'').replace(/"/g,'""'), t.amount||0];
    });
    const csv = ['fecha,cuenta,tipo,categoria,activo,descripcion,monto', ...rows.map(r=> r.map((c,i)=> i===5?`"${c}"`:c).join(',') )].join('\n');
    const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='transacciones.csv'; a.click(); URL.revokeObjectURL(url);
  }

  function exportJSON(){ const blob = new Blob([JSON.stringify(state.data,null,2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='backup.json'; a.click(); URL.revokeObjectURL(url); }

  async function importFile(file){
    if(!file) return alert('Selecciona archivo');
    const text = await file.text();
    if(file.name.toLowerCase().endsWith('.csv')){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const headers = lines.shift().split(',').map(h=>h.toLowerCase());
      for(const ln of lines){
        const parts = ln.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g).map(p=>p.replace(/^"|"$/g,'').replace(/""/g,'"'));
        const obj = {}; headers.forEach((h,i)=> obj[h]=parts[i]||'');
        const bank = state.data.banks.find(b=>b.name===obj.cuenta);
        const cat = state.data.categories.find(c=>c.name===obj.categoria);
        const asset = state.data.assets.find(a=> obj.activo && obj.activo.includes(a.name));
        try{ await addTransaction({ type: obj.tipo||'Ingreso', amount: Number(obj.monto)||0, bankId: bank?bank.id:null, categoryId: cat?cat.id:null, assetId: asset?asset.id:null, categoryName: obj.categoria||'', description: obj.descripcion||'', dateStr: obj.fecha }); } catch(e){ console.warn('import tx fail', e); }
      }
      showToast('CSV importado');
    } else {
      try{ const d = JSON.parse(text); state.data = mergeDatasets(state.data, d); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); showToast('JSON importado y fusionado'); } catch(e){ alert('JSON inválido'); }
    }
  }

  async function exportPDF(){
    const banksTotal = state.data.banks.reduce((s,b)=>s + (Number(b.balance)||0),0);
    const assetsTotal = state.data.assets.reduce((s,a)=>s + (Number(a.estimatedValue)||0),0);
    const liabilitiesTotal = state.data.liabilities.reduce((s,l)=>s + (Number(l.amount)||0),0);
    const debtsTotal = state.data.debts.reduce((s,d)=>s + (Number(d.outstanding)||0),0);
    const incomeTotal = state.data.transactions.reduce((s,t)=> s + ((t.type==='Egreso')?0:(Number(t.amount)||0)),0);
    const expenseTotal = state.data.transactions.reduce((s,t)=> s + ((t.type==='Egreso')?(Number(t.amount)||0):0),0);
    const savingsRate = incomeTotal > 0 ? Math.max(0, ((incomeTotal - expenseTotal)/incomeTotal)*100).toFixed(1) : '0.0';
    let chartImg = null;
    try{ if(window.flowsChart) chartImg = window.flowsChart.toBase64Image(); } catch(e){ chartImg = null; }

    const node = document.createElement('div'); node.className='pdf-root';
    node.innerHTML = `
      <div class="pdf-header">
        <div>
          <div class="pdf-title">REPORTE FINANCIERO — JHONATAN ORELLANA</div>
          <div class="pdf-sub">Organización: ${ORG_ID} · Fecha: ${toDDMMYYYY(new Date())}</div>
        </div>
        <div style="text-align:right">
          <div class="pdf-text">Resumen técnico clasificado</div>
        </div>
      </div>

      <section>
        <div class="pdf-sub">1. Resumen ejecutivo</div>
        <p class="pdf-text">Saldo en cuentas: <strong>${fmtMoney(banksTotal)}</strong><br/>
        Patrimonio neto: <strong>${fmtMoney(assetsTotal + banksTotal - (liabilitiesTotal + debtsTotal))}</strong><br/>
        Ingresos totales: <strong>${fmtMoney(incomeTotal)}</strong> · Gastos totales: <strong>${fmtMoney(expenseTotal)}</strong><br/>
        Tasa de ahorro estimada: <strong>${savingsRate}%</strong></p>
      </section>

      <section>
        <div class="pdf-sub">2. Gráfica Ingresos vs Egresos (12 meses)</div>
        ${chartImg ? `<div style="text-align:center;margin-top:8px"><img src="${chartImg}" style="max-width:100%;height:auto;border:1px solid #ddd"/></div>` : '<p class="pdf-text">Gráfica no disponible.</p>'}
      </section>

      <section>
        <div class="pdf-sub">3. Bancos</div>
        <table class="pdf-table"><thead><tr><th>Cuenta</th><th>Tipo</th><th style="text-align:right">Saldo</th></tr></thead>
          <tbody>${state.data.banks.map(b=>`<tr><td>${b.name}</td><td>${b.type||'-'}</td><td style="text-align:right">${fmtMoney(b.balance)}</td></tr>`).join('')}</tbody></table>
      </section>

      <section>
        <div class="pdf-sub">4. Activos clave</div>
        <table class="pdf-table"><thead><tr><th>Activo</th><th>Subtipo</th><th style="text-align:right">Valor</th><th style="text-align:right">Ganancias</th></tr></thead>
          <tbody>${state.data.assets.map(a=>`<tr><td>${a.name}</td><td>${a.subtype||'-'}</td><td style="text-align:right">${fmtMoney(a.estimatedValue)}</td><td style="text-align:right">${fmtMoney(a.accumulatedGain||0)}</td></tr>`).join('')}</tbody></table>
      </section>

      <section>
        <div class="pdf-sub">5. Deudas y pasivos</div>
        <table class="pdf-table"><thead><tr><th>Nombre</th><th>Vinculado</th><th style="text-align:right">Saldo</th><th style="text-align:right">Cuota</th></tr></thead>
          <tbody>
            ${state.data.debts.map(d=>`<tr><td>${d.name}</td><td>${(state.data.banks.find(b=>b.id===d.bankId)||{name:'-'}) .name}</td><td style="text-align:right">${fmtMoney(d.outstanding)}</td><td style="text-align:right">${fmtMoney(d.monthlyPayment)}</td></tr>`).join('')}
            ${state.data.liabilities.map(l=>`<tr><td>${l.name}</td><td>${(state.data.banks.find(b=>b.id===l.linkedBankId)||{name:'-'}) .name}</td><td style="text-align:right">${fmtMoney(l.amount)}</td><td style="text-align:right">-</td></tr>`).join('')}
          </tbody></table>
      </section>

      <div style="margin-top:12px;font-size:9pt;color:#666">Generado por JHONATAN ORELLANA — Suite Empresarial · Títulos 12pt · Subtítulos 11pt · Texto 10pt</div>
    `;
    if(window.html2pdf){
      html2pdf().set({ margin:12, filename:`reporte_financiero_${(new Date()).toISOString().slice(0,10)}.pdf`, image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(node).save();
    } else alert('html2pdf no disponible');
  }

  /* ------------------------
     Charts & dashboard
     ------------------------ */
  let flowsChart = null;
  window.flowsChart = null;
  function renderFlowsChart(){
    if(!document.getElementById('chartFlows')) return;
    const labels=[], incData=[], egData=[];
    const now = new Date();
    for(let i=11;i>=0;i--){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      labels.push(d.toLocaleString('es-PE',{month:'short',year:'2-digit'}));
      let inc=0, eg=0;
      state.data.transactions.forEach(t=>{
        const td=parseDateDDMMYYYY(t.dateStr||'');
        if(!td) return;
        if(td.getMonth()===d.getMonth() && td.getFullYear()===d.getFullYear()){
          if(t.type==='Egreso') eg += Number(t.amount)||0; else inc += Number(t.amount)||0;
        }
      });
      incData.push(inc); egData.push(eg);
    }
    const ctx = document.getElementById('chartFlows');
    const data = { labels, datasets:[ { label:'Ingresos', type:'line', data:incData, borderColor: '#0b6fd1', backgroundColor: 'rgba(11,111,209,0.06)', tension:0.3, yAxisID:'y' }, { label:'Egresos', type:'bar', data:egData, backgroundColor:'#ef4444', yAxisID:'y' } ] };
    if(flowsChart){ flowsChart.data = data; flowsChart.update(); } else {
      flowsChart = new Chart(ctx, { data, type:'bar', options:{
        responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'top'}}, scales:{ y:{ beginAtZero:true }, x:{ stacked:false } }
      }});
      window.flowsChart = flowsChart;
    }
  }

  function dashboardMetrics(){
    const now = new Date(), month = now.getMonth(), year = now.getFullYear();
    const banksTotal = state.data.banks.reduce((s,b)=>s + (Number(b.balance)||0),0);
    const assetsTotal = state.data.assets.reduce((s,a)=>s + (Number(a.estimatedValue)||0),0);
    const liabilitiesTotal = state.data.liabilities.reduce((s,l)=>s + (Number(l.amount)||0),0);
    const debtsTotal = state.data.debts.reduce((s,d)=>s + (Number(d.outstanding)||0),0);
    const incomeTotal = state.data.transactions.reduce((s,t)=> s + ((t.type==='Egreso')?0:(Number(t.amount)||0)),0);
    const expenseTotal = state.data.transactions.reduce((s,t)=> s + ((t.type==='Egreso')?(Number(t.amount)||0):0),0);
    const avgExpenses = (expenseTotal / 12) || 0;
    const runway = avgExpenses>0 ? (banksTotal/avgExpenses).toFixed(1) : '∞';
    const net = assetsTotal + banksTotal - (liabilitiesTotal + debtsTotal);

    $('#kpi-net').textContent = fmtMoney(net);
    $('#kpi-inc').textContent = fmtMoney(incomeTotal);
    $('#kpi-exp').textContent = fmtMoney(expenseTotal);
    $('#kpi-runway').textContent = `${runway} meses`;
    $('#patrimony').textContent = fmtMoney(net);
    $('#kpi-net-trend').textContent = `Activos ${fmtMoney(assetsTotal)} · Pasivos ${fmtMoney(liabilitiesTotal + debtsTotal)}`;

    // top categories this month
    const catSums = {};
    state.data.transactions.forEach(t=>{
      const td=parseDateDDMMYYYY(t.dateStr||''); if(!td) return;
      if(td.getMonth()===month && td.getFullYear()===year && t.type==='Egreso'){
        const cid = t.categoryId || t.categoryName || 'Sin categoría';
        catSums[cid] = (catSums[cid]||0) + (Number(t.amount)||0);
      }
    });
    const topCats = Object.entries(catSums).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=> `${k}: ${fmtMoney(v)}`).join('<br/>') || '—';
    $('#topCategories').innerHTML = topCats;

    $('#bankBreakdown').innerHTML = state.data.banks.map(b=>`${b.name}: <strong>${fmtMoney(b.balance)}</strong>`).join('<br/>') || '—';

    const alerts = [];
    state.data.categories.forEach(cat=>{
      if(!cat.limitMonthly || Number(cat.limitMonthly)<=0) return;
      const spent = state.data.transactions.reduce((acc,t)=>{ const td=parseDateDDMMYYYY(t.dateStr||''); if(!td) return acc; if(td.getMonth()===month && td.getFullYear()===year && t.categoryId===cat.id) acc += Number(t.amount)||0; return acc; },0);
      if(spent > Number(cat.limitMonthly)) alerts.push(`<span class="badge neg">⚠ ${cat.name} superó límite ${fmtMoney(spent)}</span>`);
      else if(spent >= Number(cat.limitMonthly)*0.8) alerts.push(`<span class="badge" style="background:rgba(245,158,11,0.12);color:var(--warn)">¡${cat.name} cerca del límite!</span>`);
    });
    state.data.banks.forEach(b=>{ if(Number(b.balance) < 0) alerts.push(`<span class="badge neg">❗ ${b.name} saldo negativo ${fmtMoney(b.balance)}</span>`); });

    $('#alertsArea').innerHTML = alerts.length ? alerts.join('<br/>') : '<span class="small">Sin alertas</span>';
    $('#todayDate').textContent = 'Hoy: ' + toDDMMYYYY(new Date());

    // last tx list
    const last = state.data.transactions.slice(0,6).map(t=>{
      const meta = t.meta && (t.meta.transferTo || t.meta.transferFrom) ? ' ⚡' : '';
      return `${t.dateStr} · ${t.type}${meta} · ${fmtMoney(t.amount)} · ${(t.description||'')}`;
    }).join('<br/>') || '—';
    $('#smallTxList').innerHTML = last;
    $('#kpi-inc-trend').textContent = `Ingresos anuales: ${fmtMoney(incomeTotal)}`;
    $('#kpi-exp-trend').textContent = `Gastos anuales: ${fmtMoney(expenseTotal)}`;
    renderFlowsChart();
  }

  /* ------------------------
     Render tables & lists (incluye botón Transferir)
     ------------------------ */
  function renderTransactions(){
    const tbody = $('#txTable tbody'); if(!tbody) return; tbody.innerHTML='';
    const q = ($('#search') && $('#search').value || '').trim().toLowerCase();
    const filter = $('#filterAccount') ? $('#filterAccount').value : '';
    const rows = state.data.transactions.filter(t=>{ if(filter && t.bankId !== filter) return false; if(q){ const cat = state.data.categories.find(c=>c.id===t.categoryId); const asset = state.data.assets.find(a=>a.id===t.assetId); const txt = `${t.description||''} ${cat?cat.name:''} ${asset?asset.name:''}`.toLowerCase(); if(!txt.includes(q)) return false; } return true; });
    rows.forEach(t=>{
      const bank = state.data.banks.find(b=>b.id===t.bankId);
      const cat = state.data.categories.find(c=>c.id===t.categoryId);
      const asset = state.data.assets.find(a=>a.id===t.assetId);
      const isTransfer = t.meta && (t.meta.transferTo || t.meta.transferFrom);
      const transferLabel = isTransfer ? `<span class="small">⚡ ${ t.meta.transferTo ? '->' + (state.data.banks.find(x=>x.id===t.meta.transferTo)||{name:'?' }).name : '<-' + (state.data.banks.find(x=>x.id===t.meta.transferFrom)||{name:'?' }).name}</span>` : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.dateStr||''}</td><td>${bank?bank.name:'-'}</td><td>${t.type}</td><td>${cat?cat.name:(asset?('ACT:'+asset.name):(t.categoryName||'-'))} ${transferLabel}</td><td class="right">${fmtMoney(t.amount)}</td><td><button data-id="${t.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${t.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td>`;
      tbody.appendChild(tr);
    });
    $$('#txTable button').forEach(btn=> btn.onclick = ()=>{
      const id = btn.dataset.id, act = btn.dataset.act;
      if(act==='del'){ if(confirm('Eliminar transacción?')){ state.data.transactions = state.data.transactions.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } }
      if(act==='edit'){ const tx = state.data.transactions.find(x=>x.id===id); if(tx) openTxModal(tx); }
      feather.replace();
    });
    feather.replace();
  }

  function renderBanks(){
    const wrap = $('#banksArea'); if(!wrap) return;
    if(state.data.banks.length===0){ wrap.innerHTML = '<div class="small">No hay cuentas registradas</div>'; return; }
    const rows = state.data.banks.map(b=>`<tr><td><strong>${b.name}</strong><div class="small">${b.type||''}</div></td><td class="right">${fmtMoney(Number(b.balance)||0)}</td><td style="white-space:nowrap"><button data-id="${b.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${b.id}" data-act="transfer" class="btn warn"><i data-feather="repeat"></i> Transferir</button> <button data-id="${b.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('');
    wrap.innerHTML = `<table style="width:100%"><thead><tr><th>Cuenta</th><th class="right">Saldo</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`;
    $$('#banksArea button').forEach(btn=> btn.onclick = ()=>{
      const id = btn.dataset.id, act = btn.dataset.act;
      if(act==='del'){ if(confirm('Eliminar cuenta?')){ state.data.banks = state.data.banks.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } }
      if(act==='edit'){ const b = state.data.banks.find(x=>x.id===id); openBankModal(b); }
      if(act==='transfer'){ openTransferModal(id); }
      feather.replace();
    });
    $('#filterAccount').innerHTML = '<option value="">Todas cuentas</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    feather.replace();
  }

  function renderAssets(){ const wrap=$('#assetsArea'); if(!wrap) return; if(state.data.assets.length===0){ wrap.innerHTML='<div class="small">Sin activos</div>'; return; } const rows = state.data.assets.map(a=>`<div style="padding:10px;border-bottom:1px solid rgba(11,24,32,0.04)"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${a.name}</strong><div class="small">${a.subtype||'-'} · Valor: ${fmtMoney(a.estimatedValue)}</div></div><div style="display:flex;gap:8px"><button data-id="${a.id}" data-act="view" class="btn ghost"><i data-feather="eye"></i></button><button data-id="${a.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button><button data-id="${a.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></div></div></div>`).join('');
    wrap.innerHTML = rows; $$('#assetsArea button').forEach(btn=> btn.onclick = ()=> { const id=btn.dataset.id, act=btn.dataset.act; if(act==='del'){ if(confirm('Eliminar activo?')){ state.data.assets = state.data.assets.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } } if(act==='edit'){ const a=state.data.assets.find(x=>x.id===id); openAssetModal(a); } if(act==='view'){ openAssetViewModal(state.data.assets.find(x=>x.id===id)); } feather.replace(); }); feather.replace(); }

  function renderLiabilities(){ const wrap=$('#liabilitiesArea'); if(!wrap) return; if(state.data.liabilities.length===0){ wrap.innerHTML='<div class="small">Sin pasivos</div>'; return; } const rows = state.data.liabilities.map(l=>`<div style="padding:10px;border-bottom:1px solid rgba(11,24,32,0.04)"><div style="display:flex;justify-content:space-between"><div><strong>${l.name}</strong><div class="small">Tasa: ${l.interestRate||0}% · Venc: ${l.maturityDate||'-'}</div></div><div style="display:flex;gap:8px"><button data-id="${l.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button><button data-id="${l.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></div></div></div>`).join('');
    wrap.innerHTML = rows; $$('#liabilitiesArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar pasivo?')){ state.data.liabilities = state.data.liabilities.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } } if(act==='edit'){ const l=state.data.liabilities.find(x=>x.id===id); openLiabilityModal(l); } feather.replace(); }); feather.replace(); }

  function renderDebts(){ const wrap=$('#debtsArea'); if(!wrap) return; if(state.data.debts.length===0){ wrap.innerHTML='<div class="small">Sin deudas</div>'; return; } const rows = state.data.debts.map(d=>`<tr><td>${d.name}</td><td>${(state.data.banks.find(b=>b.id===d.bankId)||{name:'-'}) .name}</td><td class="right">${fmtMoney(Number(d.outstanding)||0)}</td><td class="right">${fmtMoney(Number(d.monthlyPayment)||0)}</td><td><button data-id="${d.id}" data-act="pay" class="btn positive"><i data-feather="dollar-sign"></i> Pagar</button> <button data-id="${d.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('');
    wrap.innerHTML = `<table style="width:100%"><thead><tr><th>Deuda</th><th>Banco</th><th class="right">Saldo</th><th class="right">Cuota</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`; $$('#debtsArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar deuda?')){ state.data.debts = state.data.debts.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } } if(act==='pay'){ const d=state.data.debts.find(x=>x.id===id); openDebtPayModal(d); } feather.replace(); }); feather.replace(); }

  function renderFixed(){ const wrap=$('#fixedArea'); if(!wrap) return; if(state.data.fixed.length===0){ wrap.innerHTML='<div class="small">Sin gastos fijos</div>'; return; } const rows = state.data.fixed.map(f=>`<tr><td>${f.name}</td><td class="right">${fmtMoney(Number(f.amount)||0)}</td><td>${(state.data.banks.find(b=>b.id===f.bankId)||{name:'-'}) .name}</td><td><button data-id="${f.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${f.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('');
    wrap.innerHTML = `<table style="width:100%"><thead><tr><th>Nombre</th><th class="right">Monto</th><th>Cuenta</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`; $$('#fixedArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar gasto fijo?')){ state.data.fixed = state.data.fixed.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } } if(act==='edit'){ const f=state.data.fixed.find(x=>x.id===id); openFixedModal(f); } feather.replace(); }); feather.replace(); }

  function renderCategories(){ const wrap=$('#categoriesArea'); if(!wrap) return; if(state.data.categories.length===0){ wrap.innerHTML='<div class="small">Sin categorías</div>'; return; } const rows = state.data.categories.map(c=>`<tr><td>${c.name}</td><td class="right">${c.limitMonthly?fmtMoney(Number(c.limitMonthly)||0):'Sin límite'}</td><td><button data-id="${c.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${c.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('');
    wrap.innerHTML = `<table style="width:100%"><thead><tr><th>Categoría</th><th class="right">Límite</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`; $$('#categoriesArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar categoría?')){ state.data.categories = state.data.categories.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } } if(act==='edit'){ const c=state.data.categories.find(x=>x.id===id); openCategoryModal(c); } feather.replace(); }); feather.replace(); }

  function renderBusinesses(){ const wrap=$('#businessesArea'); if(!wrap) return; if(state.data.businesses.length===0){ wrap.innerHTML='<div class="small">Sin empresas</div>'; return; } const rows = state.data.businesses.map(b=>`<tr><td><strong>${b.name}</strong><div class="small">${b.role||'-'}</div></td><td class="right">${fmtMoney(Number(b.estimateValue)||0)}</td><td>${b.notes||''}</td><td><button data-id="${b.id}" data-act="edit" class="btn ghost"><i data-feather="edit-2"></i></button> <button data-id="${b.id}" data-act="del" class="btn" style="color:var(--danger)"><i data-feather="trash-2"></i></button></td></tr>`).join('');
    wrap.innerHTML = `<table style="width:100%"><thead><tr><th>Empresa</th><th class="right">Valor estimado</th><th>Notas</th><th>Acc</th></tr></thead><tbody>${rows}</tbody></table>`; $$('#businessesArea button').forEach(b=> b.onclick = ()=> { const id=b.dataset.id, act=b.dataset.act; if(act==='del'){ if(confirm('Eliminar empresa?')){ state.data.businesses = state.data.businesses.filter(x=>x.id!==id); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } } if(act==='edit'){ const bz=state.data.businesses.find(x=>x.id===id); openBusinessModal(bz); } feather.replace(); }); feather.replace(); }

  function renderAll(){
    renderFlowsChart(); dashboardMetrics();
    renderTransactions(); renderBanks(); renderAssets(); renderLiabilities(); renderDebts(); renderFixed(); renderCategories(); renderBusinesses();
    $('#cloudMode').textContent = state.fsHelpers ? 'CLOUD' : 'LOCAL';
    $('#currentUser').textContent = state.user || 'Invitado';
    $('#orgBadge').textContent = ORG_ID; $('#orgShort').textContent = ORG_ID;
  }

  /* ------------------------
     Modales: CRUD + Transfer modal
     ------------------------ */
  function showModal(html){
    $('#panelRoot').innerHTML = html;
    $('#overlay').style.display = 'flex';
    $('#overlay').setAttribute('aria-hidden','false');
    feather.replace();
  }
  function closeModal(){ $('#panelRoot').innerHTML=''; $('#overlay').style.display='none'; $('#overlay').setAttribute('aria-hidden','true'); }

  function openTxModal(existing){
    const bankOpt = '<option value="">-- seleccionar cuenta --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const catOpt = '<option value="">-- categoría --</option>' + state.data.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    const assetOpt = '<option value="">-- Ninguno --</option>' + state.data.assets.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    const def = existing || { type:'Egreso', amount:0, dateStr: toDDMMYYYY(new Date()), bankId:'', categoryId:'', assetId:'', description:'' };
    const html = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:900">${existing? 'Editar transacción':'Nueva transacción'}</div>
        <div class="small">Formato fecha dd/mm/yyyy</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Tipo</label><select id="txType"><option ${def.type==='Ingreso'?'selected':''}>Ingreso</option><option ${def.type==='Egreso'?'selected':''}>Egreso</option></select></div>
        <div><label>Monto</label><input id="txAmount" type="number" value="${def.amount||0}" /></div>
        <div style="grid-column:1/3"><label>Cuenta</label><select id="txBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label>Categoría</label><select id="txCat">${catOpt}</select></div>
        <div><label>Activo (opcional)</label><select id="txAsset">${assetOpt}</select></div>
        <div><label>Fecha</label><input id="txDate" value="${def.dateStr}" /></div>
        <div style="grid-column:1/3"><label>Descripción</label><input id="txDesc" value="${(def.description||'').replace(/"/g,'&quot;')}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:14px">
        <button id="txCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button>
        <button id="txSave" class="btn primary"><i data-feather="save"></i> Guardar y cerrar</button>
      </div>
    `;
    showModal(html);
    setTimeout(()=>{ if(existing){ $('#txBank').value = existing.bankId||''; $('#txCat').value = existing.categoryId||''; $('#txAsset').value = existing.assetId||''; } },40);
    $('#txCancel').onclick = closeModal;
    $('#txSave').onclick = async ()=>{
      try{
        const type = $('#txType').value; const amount = Number($('#txAmount').value)||0; const bankId = $('#txBank').value || null; const categoryId = $('#txCat').value || null; const assetId = $('#txAsset').value || null; const dateStr = $('#txDate').value.trim(); const desc = $('#txDesc').value.trim();
        if(!amount || amount<=0) return alert('Monto inválido');
        if(!parseDateDDMMYYYY(dateStr)) return alert('Fecha inválida (dd/mm/yyyy)');
        await addTransaction({ type, amount, bankId, categoryId, assetId, description: desc, dateStr });
        closeModal();
      } catch(e){ alert('Error: ' + (e.message||e)); }
    };
  }

  function openBankModal(b){
    const def = b || { name:'', balance:0, type:'Cuenta', notes:'' };
    const html = `<div style="font-weight:900;margin-bottom:8px">${b? 'Editar cuenta' : 'Nueva cuenta'}</div>
      <label>Nombre</label><input id="bName" value="${def.name}" />
      <label>Tipo</label><input id="bType" value="${def.type}" />
      <label>Saldo inicial</label><input id="bBalance" type="number" value="${Number(def.balance)||0}" />
      <label>Notas</label><input id="bNotes" value="${(def.notes||'').replace(/"/g,'&quot;')}" />
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="bCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="bSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    $('#bCancel').onclick = closeModal;
    $('#bSave').onclick = ()=> {
      const name = $('#bName').value.trim(), type = $('#bType').value.trim(), balance = Number($('#bBalance').value)||0, notes = $('#bNotes').value.trim();
      if(!name) return alert('Nombre requerido');
      if(b){ Object.assign(b,{name,type,balance,notes}); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } else addBank({name,type,balance,notes});
      closeModal();
    };
  }

  function openTransferModal(fromId){
    // modal to transfer between accounts
    const fromOpt = state.data.banks.map(b=>`<option value="${b.id}" ${b.id===fromId?'selected':''}>${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const toOpt = state.data.banks.map(b=>`<option value="${b.id}">${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const html = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:900">Transferencia entre cuentas</div>
        <div class="small">Registra la transferencia y actualiza saldos</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Desde (origen)</label><select id="trFrom"><option value="">-- seleccionar --</option>${fromOpt}</select></div>
        <div><label>Hacia (destino)</label><select id="trTo"><option value="">-- seleccionar --</option>${toOpt}</select></div>
        <div><label>Monto</label><input id="trAmount" type="number" value="0" /></div>
        <div><label>Fecha (dd/mm/yyyy)</label><input id="trDate" value="${toDDMMYYYY(new Date())}" /></div>
        <div style="grid-column:1/3"><label>Nota / descripción</label><input id="trNote" placeholder="Ej: Transferencia entre cuentas" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px">
        <button id="trCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button>
        <button id="trSave" class="btn warn"><i data-feather="check"></i> Transferir</button>
      </div>
    `;
    showModal(html);
    setTimeout(()=>{ if(fromId) $('#trFrom').value = fromId; feather.replace(); },40);
    $('#trCancel').onclick = closeModal;
    $('#trSave').onclick = ()=> {
      const from = $('#trFrom').value, to = $('#trTo').value, amount = Number($('#trAmount').value)||0, dateStr = $('#trDate').value.trim(), note = $('#trNote').value.trim();
      if(!from || !to) return alert('Seleccione ambas cuentas');
      if(from === to) return alert('Cuentas deben ser diferentes');
      if(!amount || amount<=0) return alert('Monto inválido');
      if(!parseDateDDMMYYYY(dateStr)) return alert('Fecha inválida (dd/mm/yyyy)');
      try{
        transferBetweenBanks(from,to,amount,dateStr,note);
        closeModal();
        showToast('Transferencia registrada');
      } catch(e){ alert('Error: '+(e.message||e)); }
    };
  }

  function openAssetModal(a){
    const subtypes = ['Inmueble','Maquinaria','Inversión','Patrimonio','Vehículo','Otro'];
    const bankOpt = '<option value="">-- Ninguna --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = a || { name:'', estimatedValue:0, subtype:'Inmueble', purchaseDate:'', depreciationRate:0, usefulLife:0, salvageValue:0, linkedBankId:'', notes:'', accumulatedGain:0 };
    const html = `<div style="font-weight:900;margin-bottom:8px">${a? 'Editar activo':'Nuevo activo'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Nombre</label><input id="aName" value="${def.name}" /></div>
        <div><label>Subtipo</label><select id="aSubtype">${subtypes.map(s=>`<option ${def.subtype===s?'selected':''}>${s}</option>`).join('')}</select></div>
        <div><label>Valor estimado</label><input id="aValue" type="number" value="${Number(def.estimatedValue)||0}" /></div>
        <div><label>Fecha compra (dd/mm/yyyy)</label><input id="aPurchase" value="${def.purchaseDate||''}" /></div>
        <div><label>Depreciación anual (%)</label><input id="aDep" type="number" value="${Number(def.depreciationRate)||0}" /></div>
        <div><label>Vida útil (años)</label><input id="aLife" type="number" value="${Number(def.usefulLife)||0}" /></div>
        <div style="grid-column:1/3"><label>Valor residual</label><input id="aSalvage" type="number" value="${Number(def.salvageValue)||0}" /></div>
        <div style="grid-column:1/3"><label>Vinculado a cuenta</label><select id="aBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label>Notas</label><textarea id="aNotes">${(def.notes||'')}</textarea></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="aCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="aSave" class="btn primary"><i data-feather="save"></i> Guardar activo</button></div>`;
    showModal(html);
    if(a) setTimeout(()=> $('#aBank').value = a.linkedBankId||'',40);
    $('#aCancel').onclick = closeModal;
    $('#aSave').onclick = ()=> {
      const name=$('#aName').value.trim(), subtype=$('#aSubtype').value, val=Number($('#aValue').value)||0, purchase=$('#aPurchase').value.trim(), dep=Number($('#aDep').value)||0, life=Number($('#aLife').value)||0, salvage=Number($('#aSalvage').value)||0, bankId=$('#aBank').value||null, notes=$('#aNotes').value.trim();
      if(!name) return alert('Nombre requerido');
      const obj = { name, subtype, estimatedValue:val, purchaseDate:purchase, depreciationRate:dep, usefulLife:life, salvageValue:salvage, linkedBankId:bankId, notes, accumulatedGain: a ? a.accumulatedGain : 0, incomeRecords: a ? a.incomeRecords : [] };
      if(a){ Object.assign(a,obj); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } else addAsset(obj);
      closeModal();
    };
  }

  function openAssetViewModal(a){
    if(!a) return alert('Activo no encontrado');
    const incomeHtml = (a.incomeRecords||[]).slice(0,20).map(r=>`<li>${r.dateStr} · ${fmtMoney(r.amount)} · ${r.desc||''}</li>`).join('');
    const html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><h3 style="margin:0">${a.name}</h3><div class="small">${a.subtype||''}</div></div><div><button id="avClose" class="btn ghost"><i data-feather="x"></i> Cerrar</button></div></div>
      <div style="margin-top:10px"><div class="small">Valor estimado</div><div style="font-weight:900">${fmtMoney(a.estimatedValue)}</div><div style="margin-top:8px" class="small">Ganancia acumulada</div><div style="font-weight:700">${fmtMoney(a.accumulatedGain||0)}</div><div style="margin-top:12px"><div class="small">Registros</div><ul>${incomeHtml||'<li class="small">Sin registros</li>'}</ul></div></div>`;
    showModal(html);
    $('#avClose').onclick = closeModal;
  }

  function openLiabilityModal(l){
    const subtypes=['Préstamo Bancario','Hipoteca','Tarjeta','Proveedor','Garantía','Otro'];
    const bankOpt = '<option value="">-- Ninguna --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = l || { name:'', amount:0, subtype:'Préstamo Bancario', interestRate:0, maturityDate:'', collateral:'', linkedBankId:'', notes:'' };
    const html = `<div style="font-weight:900;margin-bottom:8px">${l? 'Editar pasivo':'Nuevo pasivo'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Nombre</label><input id="liName" value="${def.name}" /></div>
        <div><label>Subtipo</label><select id="liSubtype">${subtypes.map(s=>`<option ${def.subtype===s?'selected':''}>${s}</option>`).join('')}</select></div>
        <div><label>Monto</label><input id="liAmount" type="number" value="${Number(def.amount)||0}" /></div>
        <div><label>Tasa interés (%)</label><input id="liInterest" type="number" value="${Number(def.interestRate)||0}" /></div>
        <div><label>Fecha venc. (dd/mm/yyyy)</label><input id="liMaturity" value="${def.maturityDate||''}" /></div>
        <div><label>Colateral</label><input id="liCollateral" value="${(def.collateral||'')}" /></div>
        <div style="grid-column:1/3"><label>Vinculado a cuenta</label><select id="liBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label>Notas</label><textarea id="liNotes">${(def.notes||'')}</textarea></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="liCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="liSave" class="btn primary"><i data-feather="save"></i> Guardar pasivo</button></div>`;
    showModal(html);
    if(l) setTimeout(()=> $('#liBank').value = l.linkedBankId||'',40);
    $('#liCancel').onclick = closeModal;
    $('#liSave').onclick = ()=> {
      const name=$('#liName').value.trim(), subtype=$('#liSubtype').value, amount=Number($('#liAmount').value)||0, interest=Number($('#liInterest').value)||0, maturity=$('#liMaturity').value.trim(), collateral=$('#liCollateral').value.trim(), bankId=$('#liBank').value||null, notes=$('#liNotes').value.trim();
      if(!name) return alert('Nombre requerido');
      const obj = { name, subtype, amount, interestRate:interest, maturityDate:maturity, collateral, linkedBankId:bankId, notes };
      if(l){ Object.assign(l,obj); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } else addLiability(obj);
      closeModal();
    };
  }

  function openBusinessModal(bz){
    const def = bz || { name:'', estimateValue:0, contribution:0, role:'Propietario', notes:'' };
    const html = `<div style="font-weight:900;margin-bottom:8px">${bz? 'Editar empresa':'Nueva empresa'}</div>
      <label>Nombre</label><input id="bzName" value="${def.name}" />
      <label>Rol</label><input id="bzRole" value="${def.role}" />
      <label>Valor estimado</label><input id="bzValue" type="number" value="${Number(def.estimateValue)||0}" />
      <label>Aporte</label><input id="bzContribution" type="number" value="${Number(def.contribution)||0}" />
      <label>Notas</label><textarea id="bzNotes">${(def.notes||'')}</textarea>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="bzCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="bzSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    $('#bzCancel').onclick = closeModal;
    $('#bzSave').onclick = ()=> { const name=$('#bzName').value.trim(), role=$('#bzRole').value, val=Number($('#bzValue').value)||0, contrib=Number($('#bzContribution').value)||0, notes=$('#bzNotes').value.trim(); if(!name) return alert('Nombre requerido'); const obj={name,estimateValue:val,contribution:contrib,role,notes}; if(bz){ Object.assign(bz,obj); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } else addBusiness(obj); closeModal(); };
  }

  function openFixedModal(f){
    const def = f || { name:'', amount:0, bankId:'', categoryId:'', frequency:'monthly' };
    const bankOpt = '<option value="">-- Ninguna --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const catOpt = '<option value="">-- Ninguna --</option>' + state.data.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    const html = `<div style="font-weight:900;margin-bottom:8px">${f? 'Editar gasto fijo':'Nuevo gasto fijo'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>Nombre</label><input id="fName" value="${def.name}" /></div><div><label>Monto</label><input id="fAmount" type="number" value="${Number(def.amount)||0}" /></div><div><label>Cuenta</label><select id="fBank">${bankOpt}</select></div><div><label>Categoría</label><select id="fCat">${catOpt}</select></div><div><label>Frecuencia</label><select id="fFreq"><option ${def.frequency==='monthly'?'selected':''} value="monthly">Mensual</option><option ${def.frequency==='weekly'?'selected':''} value="weekly">Semanal</option><option ${def.frequency==='annual'?'selected':''} value="annual">Anual</option></select></div></div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="fCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="fSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    if(f) setTimeout(()=>{ $('#fBank').value=f.bankId||''; $('#fCat').value=f.categoryId||''; },50);
    $('#fCancel').onclick = closeModal;
    $('#fSave').onclick = ()=> { const name=$('#fName').value.trim(), amount=Number($('#fAmount').value)||0, bankId=$('#fBank').value||null, categoryId=$('#fCat').value||null, freq=$('#fFreq').value||'monthly'; if(!name) return alert('Nombre requerido'); if(f){ Object.assign(f,{name,amount,bankId,categoryId,frequency:freq}); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } else addFixed({name,amount,bankId,categoryId,frequency:freq}); closeModal(); };
  }

  function openCategoryModal(c){
    const def = c || { name:'', limitMonthly:0 };
    const html = `<div style="font-weight:900;margin-bottom:8px">${c? 'Editar categoría':'Nueva categoría'}</div>
      <label>Nombre</label><input id="catName" value="${def.name}" />
      <label>Límite mensual (0 = sin límite)</label><input id="catLimit" type="number" value="${def.limitMonthly||0}" />
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="catCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="catSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    $('#catCancel').onclick = closeModal;
    $('#catSave').onclick = ()=>{ const name=$('#catName').value.trim(), limit=Number($('#catLimit').value)||0; if(!name) return alert('Nombre requerido'); if(c){ Object.assign(c,{name,limitMonthly:limit}); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } else addCategory({name,limitMonthly:limit}); closeModal(); };
  }

  function openDebtModal(d){
    const bankOpt = '<option value="">-- Ninguna --</option>' + state.data.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
    const def = d || { name:'', bankId:'', outstanding:0, monthlyPayment:0, interestRate:0, notes:'' };
    const html = `<div style="font-weight:900;margin-bottom:8px">${d? 'Editar deuda':'Nueva deuda'}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Nombre</label><input id="dName" value="${def.name}" /></div>
        <div><label>Banco</label><select id="dBank">${bankOpt}</select></div>
        <div><label>Saldo pendiente</label><input id="dOut" type="number" value="${Number(def.outstanding)||0}" /></div>
        <div><label>Cuota mensual</label><input id="dPay" type="number" value="${Number(def.monthlyPayment)||0}" /></div>
        <div><label>Tasa interés (%)</label><input id="dInterest" type="number" value="${Number(def.interestRate)||0}" /></div>
        <div style="grid-column:1/3"><label>Notas</label><input id="dNotes" value="${(def.notes||'').replace(/"/g,'&quot;')}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="dCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="dSave" class="btn primary"><i data-feather="save"></i> Guardar</button></div>`;
    showModal(html);
    if(d) setTimeout(()=> $('#dBank').value = d.bankId||'',40);
    $('#dCancel').onclick = closeModal;
    $('#dSave').onclick = ()=> { const name=$('#dName').value.trim(), bankId=$('#dBank').value||null, out=Number($('#dOut').value)||0, pay=Number($('#dPay').value)||0, interest=Number($('#dInterest').value)||0, notes=$('#dNotes').value.trim(); if(!name) return alert('Nombre requerido'); if(d){ Object.assign(d,{name,bankId,outstanding:out,monthlyPayment:pay,interestRate:interest,notes}); persistLocal(); if(state.fsHelpers) schedulePush(); renderAll(); } else addDebt({name,bankId,outstanding:out,monthlyPayment:pay,interestRate:interest,notes}); closeModal(); };
  }

  function openDebtPayModal(debt){
    if(!debt) return alert('Deuda no encontrada');
    const bankOpt = state.data.banks.map(b=>`<option value="${b.id}">${b.name} (${fmtMoney(b.balance)})</option>`).join('');
    const html = `<div style="font-weight:900;margin-bottom:8px">Registrar pago · ${debt.name}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Monto</label><input id="payAmount" type="number" value="${Math.min(Number(debt.monthlyPayment)||0, Number(debt.outstanding)||0)}" /></div>
        <div><label>Cuenta</label><select id="payBank">${bankOpt}</select></div>
        <div style="grid-column:1/3"><label>Descripción</label><input id="payDesc" value="Pago deuda ${debt.name}" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px"><button id="payCancel" class="btn ghost"><i data-feather="x"></i> Cancelar</button><button id="paySave" class="btn positive"><i data-feather="check-circle"></i> Registrar pago</button></div>`;
    showModal(html);
    $('#payCancel').onclick = closeModal;
    $('#paySave').onclick = async ()=> { const amt=Number($('#payAmount').value)||0; const bankId=$('#payBank').value; const desc=$('#payDesc').value.trim(); if(!amt||amt<=0) return alert('Monto inválido'); await addTransaction({ type:'Egreso', amount:amt, bankId, debtId:debt.id, dateStr: toDDMMYYYY(new Date()), description: desc }); closeModal(); };
  }

  /* ------------------------
     UI bindings
     ------------------------ */
  function bindUI(){
    // navigation
    $$('nav.side button').forEach(b=> b.addEventListener('click', ()=>{
      $$('nav.side button').forEach(x=> x.classList.toggle('active', x===b));
      document.querySelectorAll('main section').forEach(s=> s.style.display='none');
      const view = document.getElementById('view-'+b.dataset.view);
      if(view) view.style.display = 'block';
    }));
    // buttons
    $('#btnNewTx').onclick = ()=> openTxModal(null);
    $('#btnAddTx').onclick = ()=> openTxModal(null);
    $('#fab').onclick = ()=> openTxModal(null);
    $('#btnNewBank').onclick = ()=> openBankModal(null);
    $('#btnAddBankTop').onclick = ()=> openBankModal(null);
    $('#btnAddAssetTop').onclick = ()=> openAssetModal(null);
    $('#btnAddLiabTop').onclick = ()=> openLiabilityModal(null);
    $('#btnAddDebtTop').onclick = ()=> openDebtModal(null);
    $('#btnAddFixedTop').onclick = ()=> openFixedModal(null);
    $('#btnAddCategoryTop').onclick = ()=> openCategoryModal(null);
    $('#btnAddBizTop').onclick = ()=> openBusinessModal(null);
    $('#btnTransferTop').onclick = ()=> openTransferModal(null);
    $('#applyFixed').onclick = ()=> { if(confirm('Aplicar gastos fijos?')) applyMonthlyFixed(); };
    $('#btnApplyFixedTop').onclick = ()=> { if(confirm('Aplicar gastos fijos?')) applyMonthlyFixed(); };
    $('#btnExportCSV').onclick = exportCSV;
    $('#btnExportJSON').onclick = exportJSON;
    $('#btnImport').onclick = ()=> importFile($('#fileImport').files[0]);
    $('#btnExportPDF').onclick = exportPDF;
    $('#btnPDF').onclick = exportPDF;
    $('#fileImport').onchange = e => importFile(e.target.files[0]);
    $('#sidebarSync').onclick = async ()=> {
      $('#syncStatus').textContent='syncing';
      try{
        if(!state.fsHelpers){ await initFirestore(firebaseConfig); startRealtime(); showToast('Firestore activado'); }
        const remote = await fsFetch();
        if(remote.data){ state.data = mergeDatasets(state.data, remote.data); persistLocal(); await fsSave(state.data); showToast('Sincronización manual completa'); }
        else { await fsSave(state.data); showToast('Nube inicializada con datos locales'); }
      } catch(e){ console.error(e); showToast('Error sync: '+(e.message||e), true); } finally{ $('#syncStatus').textContent='idle'; renderAll(); }
    };
    $('#sidebarLogout').onclick = ()=> { if(confirm('Cerrar sesión?')) location.reload(); };
    $('#search').oninput = renderTransactions;

    // keyboard: N -> new tx
    window.addEventListener('keydown', (e)=> { if(e.key.toLowerCase()==='n' && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) openTxModal(null); });

    $('#overlay').addEventListener('click', (e)=> { if(e.target.id === 'overlay') closeModal(); });

    feather.replace();
  }

  /* ------------------------
     Login (local) & init
     ------------------------ */
  function attachLocalLogin(){
    const tryLogin = ()=> {
      const u = prompt('Usuario (local):','JHONATAN');
      const p = prompt('Contraseña (local):','JHONATAN');
      if(u === LOCAL_LOGIN.user && p === LOCAL_LOGIN.pass){
        state.user = u; initApp(); showToast('Bienvenido ' + u);
      } else {
        alert('Credenciales incorrectas. Intente de nuevo.'); tryLogin();
      }
    };
    setTimeout(tryLogin, 200);
  }

  async function initApp(){
    loadLocal();
    bindUI();
    renderAll();
    try{
      await initFirestore(firebaseConfig);
      startRealtime();
      $('#syncStatus').textContent = 'syncing';
      const remote = await fsFetch();
      if(remote.data){
        state.data = mergeDatasets(state.data, remote.data);
        persistLocal();
        await fsSave(state.data);
        showToast('Sincronización automática completa');
      } else {
        await fsSave(state.data);
        showToast('Nube inicializada con datos locales');
      }
    } catch(e){
      console.warn('Firestore auto failed', e);
      showToast('No se pudo conectar a la nube (modo local)', true);
    } finally { $('#syncStatus').textContent='idle'; renderAll(); }
  }

  // seed categories if empty
  loadLocal();
  if(!state.data.categories || state.data.categories.length===0){
    state.data.categories = [{ id: uid('cat'), name:'Alimentos', limitMonthly:1500, createdAt: nowISO() }, { id: uid('cat'), name:'Operaciones', limitMonthly:5000, createdAt: nowISO() }, { id: uid('cat'), name:'Marketing', limitMonthly:3000, createdAt: nowISO() }];
    persistLocal();
  }

  // start login flow
  attachLocalLogin();

  /* ------------------------
     Firestore rules sugeridas (comentadas)
     ------------------------
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /organizations/{orgId}/DATA/DATA {
          // Requiere autenticación + claim orgId (mejor práctica):
          allow read, write: if request.auth != null && request.auth.token.orgId == orgId;
        }
      }
    }

    // Alternativa (UID específico):
    allow read, write: if request.auth != null && request.auth.uid == 'x9k6xvQAqGdS4MrIuivaLqPFbHR2';

    // Desarrollo (NO recomendado): allow read, write: if true;
  ------------------------ */
  </script>

  <!-- Initialize Feather icons -->
  <script>
    document.addEventListener('DOMContentLoaded', ()=> {
      if(window.feather) feather.replace();
    });
  </script>
</body>
</html>
